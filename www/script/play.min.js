webpackJsonp([2],{

/***/ 154:
/***/ (function(module, exports, __webpack_require__) {

"use strict";


var _chimee = __webpack_require__(155);

var _chimee2 = _interopRequireDefault(_chimee);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var play = new _chimee2.default({
    wrapper: '#wrapper',
    src: 'http://192.168.204.61/media/1fb433aa2aee9b7ad3d3957b582787de.f4v',

    controls: true,
    autoplay: true,
    box: "flv",
    events: {
        play: function play() {
            console.log('play!!');
        }
    }
});

/***/ }),

/***/ 155:
/***/ (function(module, exports, __webpack_require__) {

"use strict";
var __WEBPACK_AMD_DEFINE_FACTORY__, __WEBPACK_AMD_DEFINE_RESULT__;var _typeof2=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(global,factory){( false?'undefined':_typeof2(exports))==='object'&&typeof module!=='undefined'?module.exports=factory(): true?!(__WEBPACK_AMD_DEFINE_FACTORY__ = (factory),
				__WEBPACK_AMD_DEFINE_RESULT__ = (typeof __WEBPACK_AMD_DEFINE_FACTORY__ === 'function' ?
				(__WEBPACK_AMD_DEFINE_FACTORY__.call(exports, __webpack_require__, exports, module)) :
				__WEBPACK_AMD_DEFINE_FACTORY__),
				__WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__)):global.Chimee=factory();})(undefined,function(){'use strict';function unwrapExports(x){return x&&x.__esModule?x['default']:x;}function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports;}var _global=createCommonjsModule(function(module){var global=module.exports=typeof window!='undefined'&&window.Math==Math?window:typeof self!='undefined'&&self.Math==Math?self:Function('return this')();if(typeof __g=='number')__g=global;});var _core=createCommonjsModule(function(module){var core=module.exports={version:'2.4.0'};if(typeof __e=='number')__e=core;});var _aFunction=function _aFunction(it){if(typeof it!='function')throw TypeError(it+' is not a function!');return it;};var _ctx=function _ctx(fn,that,length){_aFunction(fn);if(that===undefined)return fn;switch(length){case 1:return function(a){return fn.call(that,a);};case 2:return function(a,b){return fn.call(that,a,b);};case 3:return function(a,b,c){return fn.call(that,a,b,c);};}return function(){return fn.apply(that,arguments);};};var _isObject=function _isObject(it){return(typeof it==='undefined'?'undefined':_typeof2(it))==='object'?it!==null:typeof it==='function';};var _anObject=function _anObject(it){if(!_isObject(it))throw TypeError(it+' is not an object!');return it;};var _fails=function _fails(exec){try{return!!exec();}catch(e){return true;}};var _descriptors=!_fails(function(){return Object.defineProperty({},'a',{get:function get(){return 7;}}).a!=7;});var document$1=_global.document;var is=_isObject(document$1)&&_isObject(document$1.createElement);var _domCreate=function _domCreate(it){return is?document$1.createElement(it):{};};var _ie8DomDefine=!_descriptors&&!_fails(function(){return Object.defineProperty(_domCreate('div'),'a',{get:function get(){return 7;}}).a!=7;});var _toPrimitive=function _toPrimitive(it,S){if(!_isObject(it))return it;var fn,val;if(S&&typeof(fn=it.toString)=='function'&&!_isObject(val=fn.call(it)))return val;if(typeof(fn=it.valueOf)=='function'&&!_isObject(val=fn.call(it)))return val;if(!S&&typeof(fn=it.toString)=='function'&&!_isObject(val=fn.call(it)))return val;throw TypeError("Can't convert object to primitive value");};var dP=Object.defineProperty;var f=_descriptors?Object.defineProperty:function defineProperty(O,P,Attributes){_anObject(O);P=_toPrimitive(P,true);_anObject(Attributes);if(_ie8DomDefine)try{return dP(O,P,Attributes);}catch(e){}if('get'in Attributes||'set'in Attributes)throw TypeError('Accessors not supported!');if('value'in Attributes)O[P]=Attributes.value;return O;};var _objectDp={f:f};var _propertyDesc=function _propertyDesc(bitmap,value){return{enumerable:!(bitmap&1),configurable:!(bitmap&2),writable:!(bitmap&4),value:value};};var _hide=_descriptors?function(object,key,value){return _objectDp.f(object,key,_propertyDesc(1,value));}:function(object,key,value){object[key]=value;return object;};var PROTOTYPE='prototype';var $export=function $export(type,name,source){var IS_FORCED=type&$export.F,IS_GLOBAL=type&$export.G,IS_STATIC=type&$export.S,IS_PROTO=type&$export.P,IS_BIND=type&$export.B,IS_WRAP=type&$export.W,exports=IS_GLOBAL?_core:_core[name]||(_core[name]={}),expProto=exports[PROTOTYPE],target=IS_GLOBAL?_global:IS_STATIC?_global[name]:(_global[name]||{})[PROTOTYPE],key,own,out;if(IS_GLOBAL)source=name;for(key in source){own=!IS_FORCED&&target&&target[key]!==undefined;if(own&&key in exports)continue;out=own?target[key]:source[key];exports[key]=IS_GLOBAL&&typeof target[key]!='function'?source[key]:IS_BIND&&own?_ctx(out,_global):IS_WRAP&&target[key]==out?function(C){var F=function F(a,b,c){if(this instanceof C){switch(arguments.length){case 0:return new C();case 1:return new C(a);case 2:return new C(a,b);}return new C(a,b,c);}return C.apply(this,arguments);};F[PROTOTYPE]=C[PROTOTYPE];return F;}(out):IS_PROTO&&typeof out=='function'?_ctx(Function.call,out):out;if(IS_PROTO){(exports.virtual||(exports.virtual={}))[key]=out;if(type&$export.R&&expProto&&!expProto[key])_hide(expProto,key,out);}}};$export.F=1;$export.G=2;$export.S=4;$export.P=8;$export.B=16;$export.W=32;$export.U=64;$export.R=128;var _export=$export;_export(_export.S+_export.F*!_descriptors,'Object',{defineProperty:_objectDp.f});var $Object=_core.Object;var defineProperty$1=function defineProperty(it,key,desc){return $Object.defineProperty(it,key,desc);};var defineProperty=createCommonjsModule(function(module){module.exports={"default":defineProperty$1,__esModule:true};});var _Object$defineProperty=unwrapExports(defineProperty);var toString={}.toString;var _cof=function _cof(it){return toString.call(it).slice(8,-1);};var _iobject=Object('z').propertyIsEnumerable(0)?Object:function(it){return _cof(it)=='String'?it.split(''):Object(it);};var _defined=function _defined(it){if(it==undefined)throw TypeError("Can't call method on  "+it);return it;};var _toIobject=function _toIobject(it){return _iobject(_defined(it));};var f$2={}.propertyIsEnumerable;var _objectPie={f:f$2};var hasOwnProperty={}.hasOwnProperty;var _has=function _has(it,key){return hasOwnProperty.call(it,key);};var gOPD=Object.getOwnPropertyDescriptor;var f$1=_descriptors?gOPD:function getOwnPropertyDescriptor(O,P){O=_toIobject(O);P=_toPrimitive(P,true);if(_ie8DomDefine)try{return gOPD(O,P);}catch(e){}if(_has(O,P))return _propertyDesc(!_objectPie.f.call(O,P),O[P]);};var _objectGopd={f:f$1};var _objectSap=function _objectSap(KEY,exec){var fn=(_core.Object||{})[KEY]||Object[KEY],exp={};exp[KEY]=exec(fn);_export(_export.S+_export.F*_fails(function(){fn(1);}),'Object',exp);};var $getOwnPropertyDescriptor=_objectGopd.f;_objectSap('getOwnPropertyDescriptor',function(){return function getOwnPropertyDescriptor(it,key){return $getOwnPropertyDescriptor(_toIobject(it),key);};});var $Object$1=_core.Object;var getOwnPropertyDescriptor$1=function getOwnPropertyDescriptor(it,key){return $Object$1.getOwnPropertyDescriptor(it,key);};var getOwnPropertyDescriptor=createCommonjsModule(function(module){module.exports={"default":getOwnPropertyDescriptor$1,__esModule:true};});var _Object$getOwnPropertyDescriptor=unwrapExports(getOwnPropertyDescriptor);var ceil=Math.ceil;var floor=Math.floor;var _toInteger=function _toInteger(it){return isNaN(it=+it)?0:(it>0?floor:ceil)(it);};var _stringAt=function _stringAt(TO_STRING){return function(that,pos){var s=String(_defined(that)),i=_toInteger(pos),l=s.length,a,b;if(i<0||i>=l)return TO_STRING?'':undefined;a=s.charCodeAt(i);return a<0xd800||a>0xdbff||i+1===l||(b=s.charCodeAt(i+1))<0xdc00||b>0xdfff?TO_STRING?s.charAt(i):a:TO_STRING?s.slice(i,i+2):(a-0xd800<<10)+(b-0xdc00)+0x10000;};};var _library=true;var _redefine=_hide;var _iterators={};var min=Math.min;var _toLength=function _toLength(it){return it>0?min(_toInteger(it),0x1fffffffffffff):0;};var max=Math.max;var min$1=Math.min;var _toIndex=function _toIndex(index,length){index=_toInteger(index);return index<0?max(index+length,0):min$1(index,length);};var _arrayIncludes=function _arrayIncludes(IS_INCLUDES){return function($this,el,fromIndex){var O=_toIobject($this),length=_toLength(O.length),index=_toIndex(fromIndex,length),value;if(IS_INCLUDES&&el!=el)while(length>index){value=O[index++];if(value!=value)return true;}else for(;length>index;index++){if(IS_INCLUDES||index in O){if(O[index]===el)return IS_INCLUDES||index||0;}}return!IS_INCLUDES&&-1;};};var SHARED='__core-js_shared__';var store=_global[SHARED]||(_global[SHARED]={});var _shared=function _shared(key){return store[key]||(store[key]={});};var id=0;var px=Math.random();var _uid=function _uid(key){return'Symbol('.concat(key===undefined?'':key,')_',(++id+px).toString(36));};var shared=_shared('keys');var _sharedKey=function _sharedKey(key){return shared[key]||(shared[key]=_uid(key));};var arrayIndexOf=_arrayIncludes(false);var IE_PROTO$1=_sharedKey('IE_PROTO');var _objectKeysInternal=function _objectKeysInternal(object,names){var O=_toIobject(object),i=0,result=[],key;for(key in O){if(key!=IE_PROTO$1)_has(O,key)&&result.push(key);}while(names.length>i){if(_has(O,key=names[i++])){~arrayIndexOf(result,key)||result.push(key);}}return result;};var _enumBugKeys='constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf'.split(',');var _objectKeys=Object.keys||function keys(O){return _objectKeysInternal(O,_enumBugKeys);};var _objectDps=_descriptors?Object.defineProperties:function defineProperties(O,Properties){_anObject(O);var keys=_objectKeys(Properties),length=keys.length,i=0,P;while(length>i){_objectDp.f(O,P=keys[i++],Properties[P]);}return O;};var _html=_global.document&&document.documentElement;var IE_PROTO=_sharedKey('IE_PROTO');var Empty=function Empty(){};var PROTOTYPE$1='prototype';var _createDict=function createDict(){var iframe=_domCreate('iframe'),i=_enumBugKeys.length,lt='<',gt='>',iframeDocument;iframe.style.display='none';_html.appendChild(iframe);iframe.src='javascript:';iframeDocument=iframe.contentWindow.document;iframeDocument.open();iframeDocument.write(lt+'script'+gt+'document.F=Object'+lt+'/script'+gt);iframeDocument.close();_createDict=iframeDocument.F;while(i--){delete _createDict[PROTOTYPE$1][_enumBugKeys[i]];}return _createDict();};var _objectCreate=Object.create||function create(O,Properties){var result;if(O!==null){Empty[PROTOTYPE$1]=_anObject(O);result=new Empty();Empty[PROTOTYPE$1]=null;result[IE_PROTO]=O;}else result=_createDict();return Properties===undefined?result:_objectDps(result,Properties);};var _wks=createCommonjsModule(function(module){var store=_shared('wks'),_Symbol=_global.Symbol,USE_SYMBOL=typeof _Symbol=='function';var $exports=module.exports=function(name){return store[name]||(store[name]=USE_SYMBOL&&_Symbol[name]||(USE_SYMBOL?_Symbol:_uid)('Symbol.'+name));};$exports.store=store;});var def=_objectDp.f;var TAG=_wks('toStringTag');var _setToStringTag=function _setToStringTag(it,tag,stat){if(it&&!_has(it=stat?it:it.prototype,TAG))def(it,TAG,{configurable:true,value:tag});};var IteratorPrototype={};_hide(IteratorPrototype,_wks('iterator'),function(){return this;});var _iterCreate=function _iterCreate(Constructor,NAME,next){Constructor.prototype=_objectCreate(IteratorPrototype,{next:_propertyDesc(1,next)});_setToStringTag(Constructor,NAME+' Iterator');};var _toObject=function _toObject(it){return Object(_defined(it));};var IE_PROTO$2=_sharedKey('IE_PROTO');var ObjectProto=Object.prototype;var _objectGpo=Object.getPrototypeOf||function(O){O=_toObject(O);if(_has(O,IE_PROTO$2))return O[IE_PROTO$2];if(typeof O.constructor=='function'&&O instanceof O.constructor){return O.constructor.prototype;}return O instanceof Object?ObjectProto:null;};var ITERATOR=_wks('iterator');var BUGGY=!([].keys&&'next'in[].keys());var FF_ITERATOR='@@iterator';var KEYS='keys';var VALUES='values';var returnThis=function returnThis(){return this;};var _iterDefine=function _iterDefine(Base,NAME,Constructor,next,DEFAULT,IS_SET,FORCED){_iterCreate(Constructor,NAME,next);var getMethod=function getMethod(kind){if(!BUGGY&&kind in proto)return proto[kind];switch(kind){case KEYS:return function keys(){return new Constructor(this,kind);};case VALUES:return function values(){return new Constructor(this,kind);};}return function entries(){return new Constructor(this,kind);};};var TAG=NAME+' Iterator',DEF_VALUES=DEFAULT==VALUES,VALUES_BUG=false,proto=Base.prototype,$native=proto[ITERATOR]||proto[FF_ITERATOR]||DEFAULT&&proto[DEFAULT],$default=$native||getMethod(DEFAULT),$entries=DEFAULT?!DEF_VALUES?$default:getMethod('entries'):undefined,$anyNative=NAME=='Array'?proto.entries||$native:$native,methods,key,IteratorPrototype;if($anyNative){IteratorPrototype=_objectGpo($anyNative.call(new Base()));if(IteratorPrototype!==Object.prototype){_setToStringTag(IteratorPrototype,TAG,true);if(!_library&&!_has(IteratorPrototype,ITERATOR))_hide(IteratorPrototype,ITERATOR,returnThis);}}if(DEF_VALUES&&$native&&$native.name!==VALUES){VALUES_BUG=true;$default=function values(){return $native.call(this);};}if((!_library||FORCED)&&(BUGGY||VALUES_BUG||!proto[ITERATOR])){_hide(proto,ITERATOR,$default);}_iterators[NAME]=$default;_iterators[TAG]=returnThis;if(DEFAULT){methods={values:DEF_VALUES?$default:getMethod(VALUES),keys:IS_SET?$default:getMethod(KEYS),entries:$entries};if(FORCED)for(key in methods){if(!(key in proto))_redefine(proto,key,methods[key]);}else _export(_export.P+_export.F*(BUGGY||VALUES_BUG),NAME,methods);}return methods;};var $at=_stringAt(true);_iterDefine(String,'String',function(iterated){this._t=String(iterated);this._i=0;},function(){var O=this._t,index=this._i,point;if(index>=O.length)return{value:undefined,done:true};point=$at(O,index);this._i+=point.length;return{value:point,done:false};});var _iterCall=function _iterCall(iterator,fn,value,entries){try{return entries?fn(_anObject(value)[0],value[1]):fn(value);}catch(e){var ret=iterator['return'];if(ret!==undefined)_anObject(ret.call(iterator));throw e;}};var ITERATOR$1=_wks('iterator');var ArrayProto=Array.prototype;var _isArrayIter=function _isArrayIter(it){return it!==undefined&&(_iterators.Array===it||ArrayProto[ITERATOR$1]===it);};var _createProperty=function _createProperty(object,index,value){if(index in object)_objectDp.f(object,index,_propertyDesc(0,value));else object[index]=value;};var TAG$1=_wks('toStringTag');var ARG=_cof(function(){return arguments;}())=='Arguments';var tryGet=function tryGet(it,key){try{return it[key];}catch(e){}};var _classof=function _classof(it){var O,T,B;return it===undefined?'Undefined':it===null?'Null':typeof(T=tryGet(O=Object(it),TAG$1))=='string'?T:ARG?_cof(O):(B=_cof(O))=='Object'&&typeof O.callee=='function'?'Arguments':B;};var ITERATOR$2=_wks('iterator');var core_getIteratorMethod=_core.getIteratorMethod=function(it){if(it!=undefined)return it[ITERATOR$2]||it['@@iterator']||_iterators[_classof(it)];};var ITERATOR$3=_wks('iterator');var SAFE_CLOSING=false;try{var riter=[7][ITERATOR$3]();riter['return']=function(){SAFE_CLOSING=true;};Array.from(riter,function(){throw 2;});}catch(e){}var _iterDetect=function _iterDetect(exec,skipClosing){if(!skipClosing&&!SAFE_CLOSING)return false;var safe=false;try{var arr=[7],iter=arr[ITERATOR$3]();iter.next=function(){return{done:safe=true};};arr[ITERATOR$3]=function(){return iter;};exec(arr);}catch(e){}return safe;};_export(_export.S+_export.F*!_iterDetect(function(iter){Array.from(iter);}),'Array',{from:function from(arrayLike){var O=_toObject(arrayLike),C=typeof this=='function'?this:Array,aLen=arguments.length,mapfn=aLen>1?arguments[1]:undefined,mapping=mapfn!==undefined,index=0,iterFn=core_getIteratorMethod(O),length,result,step,iterator;if(mapping)mapfn=_ctx(mapfn,aLen>2?arguments[2]:undefined,2);if(iterFn!=undefined&&!(C==Array&&_isArrayIter(iterFn))){for(iterator=iterFn.call(O),result=new C();!(step=iterator.next()).done;index++){_createProperty(result,index,mapping?_iterCall(iterator,mapfn,[step.value,index],true):step.value);}}else{length=_toLength(O.length);for(result=new C(length);length>index;index++){_createProperty(result,index,mapping?mapfn(O[index],index):O[index]);}}result.length=index;return result;}});var from$1=_core.Array.from;var from=createCommonjsModule(function(module){module.exports={"default":from$1,__esModule:true};});var _Array$from=unwrapExports(from);var toConsumableArray=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;var _from2=_interopRequireDefault(from);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return(0,_from2.default)(arr);}};});var _toConsumableArray=unwrapExports(toConsumableArray);_objectSap('getPrototypeOf',function(){return function getPrototypeOf(it){return _objectGpo(_toObject(it));};});var getPrototypeOf$1=_core.Object.getPrototypeOf;var getPrototypeOf=createCommonjsModule(function(module){module.exports={"default":getPrototypeOf$1,__esModule:true};});var _Object$getPrototypeOf=unwrapExports(getPrototypeOf);var classCallCheck=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;exports.default=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}};});var _classCallCheck=unwrapExports(classCallCheck);var createClass=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;var _defineProperty2=_interopRequireDefault(defineProperty);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;(0,_defineProperty2.default)(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();});var _createClass=unwrapExports(createClass);var _addToUnscopables=function _addToUnscopables(){};var _iterStep=function _iterStep(done,value){return{value:value,done:!!done};};var es6_array_iterator=_iterDefine(Array,'Array',function(iterated,kind){this._t=_toIobject(iterated);this._i=0;this._k=kind;},function(){var O=this._t,kind=this._k,index=this._i++;if(!O||index>=O.length){this._t=undefined;return _iterStep(1);}if(kind=='keys')return _iterStep(0,index);if(kind=='values')return _iterStep(0,O[index]);return _iterStep(0,[index,O[index]]);},'values');_iterators.Arguments=_iterators.Array;_addToUnscopables('keys');_addToUnscopables('values');_addToUnscopables('entries');var TO_STRING_TAG=_wks('toStringTag');for(var collections=['NodeList','DOMTokenList','MediaList','StyleSheetList','CSSRuleList'],i=0;i<5;i++){var NAME=collections[i],Collection=_global[NAME],proto=Collection&&Collection.prototype;if(proto&&!proto[TO_STRING_TAG])_hide(proto,TO_STRING_TAG,NAME);_iterators[NAME]=_iterators.Array;}var f$3=_wks;var _wksExt={f:f$3};var iterator$2=_wksExt.f('iterator');var iterator=createCommonjsModule(function(module){module.exports={"default":iterator$2,__esModule:true};});var _meta=createCommonjsModule(function(module){var META=_uid('meta'),setDesc=_objectDp.f,id=0;var isExtensible=Object.isExtensible||function(){return true;};var FREEZE=!_fails(function(){return isExtensible(Object.preventExtensions({}));});var setMeta=function setMeta(it){setDesc(it,META,{value:{i:'O'+ ++id,w:{}}});};var fastKey=function fastKey(it,create){if(!_isObject(it))return(typeof it==='undefined'?'undefined':_typeof2(it))=='symbol'?it:(typeof it=='string'?'S':'P')+it;if(!_has(it,META)){if(!isExtensible(it))return'F';if(!create)return'E';setMeta(it);}return it[META].i;};var getWeak=function getWeak(it,create){if(!_has(it,META)){if(!isExtensible(it))return true;if(!create)return false;setMeta(it);}return it[META].w;};var onFreeze=function onFreeze(it){if(FREEZE&&meta.NEED&&isExtensible(it)&&!_has(it,META))setMeta(it);return it;};var meta=module.exports={KEY:META,NEED:false,fastKey:fastKey,getWeak:getWeak,onFreeze:onFreeze};});var defineProperty$3=_objectDp.f;var _wksDefine=function _wksDefine(name){var $Symbol=_core.Symbol||(_core.Symbol=_library?{}:_global.Symbol||{});if(name.charAt(0)!='_'&&!(name in $Symbol))defineProperty$3($Symbol,name,{value:_wksExt.f(name)});};var _keyof=function _keyof(object,el){var O=_toIobject(object),keys=_objectKeys(O),length=keys.length,index=0,key;while(length>index){if(O[key=keys[index++]]===el)return key;}};var f$4=Object.getOwnPropertySymbols;var _objectGops={f:f$4};var _enumKeys=function _enumKeys(it){var result=_objectKeys(it),getSymbols=_objectGops.f;if(getSymbols){var symbols=getSymbols(it),isEnum=_objectPie.f,i=0,key;while(symbols.length>i){if(isEnum.call(it,key=symbols[i++]))result.push(key);}}return result;};var _isArray=Array.isArray||function isArray(arg){return _cof(arg)=='Array';};var hiddenKeys=_enumBugKeys.concat('length','prototype');var f$6=Object.getOwnPropertyNames||function getOwnPropertyNames(O){return _objectKeysInternal(O,hiddenKeys);};var _objectGopn={f:f$6};var gOPN$1=_objectGopn.f;var toString$1={}.toString;var windowNames=(typeof window==='undefined'?'undefined':_typeof2(window))=='object'&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];var getWindowNames=function getWindowNames(it){try{return gOPN$1(it);}catch(e){return windowNames.slice();}};var f$5=function getOwnPropertyNames(it){return windowNames&&toString$1.call(it)=='[object Window]'?getWindowNames(it):gOPN$1(_toIobject(it));};var _objectGopnExt={f:f$5};var META=_meta.KEY;var gOPD$2=_objectGopd.f;var dP$1=_objectDp.f;var gOPN=_objectGopnExt.f;var $Symbol=_global.Symbol;var $JSON=_global.JSON;var _stringify=$JSON&&$JSON.stringify;var PROTOTYPE$2='prototype';var HIDDEN=_wks('_hidden');var TO_PRIMITIVE=_wks('toPrimitive');var isEnum={}.propertyIsEnumerable;var SymbolRegistry=_shared('symbol-registry');var AllSymbols=_shared('symbols');var OPSymbols=_shared('op-symbols');var ObjectProto$1=Object[PROTOTYPE$2];var USE_NATIVE=typeof $Symbol=='function';var QObject=_global.QObject;var setter=!QObject||!QObject[PROTOTYPE$2]||!QObject[PROTOTYPE$2].findChild;var setSymbolDesc=_descriptors&&_fails(function(){return _objectCreate(dP$1({},'a',{get:function get(){return dP$1(this,'a',{value:7}).a;}})).a!=7;})?function(it,key,D){var protoDesc=gOPD$2(ObjectProto$1,key);if(protoDesc)delete ObjectProto$1[key];dP$1(it,key,D);if(protoDesc&&it!==ObjectProto$1)dP$1(ObjectProto$1,key,protoDesc);}:dP$1;var wrap=function wrap(tag){var sym=AllSymbols[tag]=_objectCreate($Symbol[PROTOTYPE$2]);sym._k=tag;return sym;};var isSymbol=USE_NATIVE&&_typeof2($Symbol.iterator)=='symbol'?function(it){return(typeof it==='undefined'?'undefined':_typeof2(it))=='symbol';}:function(it){return it instanceof $Symbol;};var $defineProperty=function defineProperty(it,key,D){if(it===ObjectProto$1)$defineProperty(OPSymbols,key,D);_anObject(it);key=_toPrimitive(key,true);_anObject(D);if(_has(AllSymbols,key)){if(!D.enumerable){if(!_has(it,HIDDEN))dP$1(it,HIDDEN,_propertyDesc(1,{}));it[HIDDEN][key]=true;}else{if(_has(it,HIDDEN)&&it[HIDDEN][key])it[HIDDEN][key]=false;D=_objectCreate(D,{enumerable:_propertyDesc(0,false)});}return setSymbolDesc(it,key,D);}return dP$1(it,key,D);};var $defineProperties=function defineProperties(it,P){_anObject(it);var keys=_enumKeys(P=_toIobject(P)),i=0,l=keys.length,key;while(l>i){$defineProperty(it,key=keys[i++],P[key]);}return it;};var $create=function create(it,P){return P===undefined?_objectCreate(it):$defineProperties(_objectCreate(it),P);};var $propertyIsEnumerable=function propertyIsEnumerable(key){var E=isEnum.call(this,key=_toPrimitive(key,true));if(this===ObjectProto$1&&_has(AllSymbols,key)&&!_has(OPSymbols,key))return false;return E||!_has(this,key)||!_has(AllSymbols,key)||_has(this,HIDDEN)&&this[HIDDEN][key]?E:true;};var $getOwnPropertyDescriptor$1=function getOwnPropertyDescriptor(it,key){it=_toIobject(it);key=_toPrimitive(key,true);if(it===ObjectProto$1&&_has(AllSymbols,key)&&!_has(OPSymbols,key))return;var D=gOPD$2(it,key);if(D&&_has(AllSymbols,key)&&!(_has(it,HIDDEN)&&it[HIDDEN][key]))D.enumerable=true;return D;};var $getOwnPropertyNames=function getOwnPropertyNames(it){var names=gOPN(_toIobject(it)),result=[],i=0,key;while(names.length>i){if(!_has(AllSymbols,key=names[i++])&&key!=HIDDEN&&key!=META)result.push(key);}return result;};var $getOwnPropertySymbols=function getOwnPropertySymbols(it){var IS_OP=it===ObjectProto$1,names=gOPN(IS_OP?OPSymbols:_toIobject(it)),result=[],i=0,key;while(names.length>i){if(_has(AllSymbols,key=names[i++])&&(IS_OP?_has(ObjectProto$1,key):true))result.push(AllSymbols[key]);}return result;};if(!USE_NATIVE){$Symbol=function _Symbol2(){if(this instanceof $Symbol)throw TypeError('Symbol is not a constructor!');var tag=_uid(arguments.length>0?arguments[0]:undefined);var $set=function $set(value){if(this===ObjectProto$1)$set.call(OPSymbols,value);if(_has(this,HIDDEN)&&_has(this[HIDDEN],tag))this[HIDDEN][tag]=false;setSymbolDesc(this,tag,_propertyDesc(1,value));};if(_descriptors&&setter)setSymbolDesc(ObjectProto$1,tag,{configurable:true,set:$set});return wrap(tag);};_redefine($Symbol[PROTOTYPE$2],'toString',function toString(){return this._k;});_objectGopd.f=$getOwnPropertyDescriptor$1;_objectDp.f=$defineProperty;_objectGopn.f=_objectGopnExt.f=$getOwnPropertyNames;_objectPie.f=$propertyIsEnumerable;_objectGops.f=$getOwnPropertySymbols;if(_descriptors&&!_library){_redefine(ObjectProto$1,'propertyIsEnumerable',$propertyIsEnumerable,true);}_wksExt.f=function(name){return wrap(_wks(name));};}_export(_export.G+_export.W+_export.F*!USE_NATIVE,{Symbol:$Symbol});for(var symbols='hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables'.split(','),i$1=0;symbols.length>i$1;){_wks(symbols[i$1++]);}for(var symbols=_objectKeys(_wks.store),i$1=0;symbols.length>i$1;){_wksDefine(symbols[i$1++]);}_export(_export.S+_export.F*!USE_NATIVE,'Symbol',{'for':function _for(key){return _has(SymbolRegistry,key+='')?SymbolRegistry[key]:SymbolRegistry[key]=$Symbol(key);},keyFor:function keyFor(key){if(isSymbol(key))return _keyof(SymbolRegistry,key);throw TypeError(key+' is not a symbol!');},useSetter:function useSetter(){setter=true;},useSimple:function useSimple(){setter=false;}});_export(_export.S+_export.F*!USE_NATIVE,'Object',{create:$create,defineProperty:$defineProperty,defineProperties:$defineProperties,getOwnPropertyDescriptor:$getOwnPropertyDescriptor$1,getOwnPropertyNames:$getOwnPropertyNames,getOwnPropertySymbols:$getOwnPropertySymbols});$JSON&&_export(_export.S+_export.F*(!USE_NATIVE||_fails(function(){var S=$Symbol();return _stringify([S])!='[null]'||_stringify({a:S})!='{}'||_stringify(Object(S))!='{}';})),'JSON',{stringify:function stringify(it){if(it===undefined||isSymbol(it))return;var args=[it],i=1,replacer,$replacer;while(arguments.length>i){args.push(arguments[i++]);}replacer=args[1];if(typeof replacer=='function')$replacer=replacer;if($replacer||!_isArray(replacer))replacer=function replacer(key,value){if($replacer)value=$replacer.call(this,key,value);if(!isSymbol(value))return value;};args[1]=replacer;return _stringify.apply($JSON,args);}});$Symbol[PROTOTYPE$2][TO_PRIMITIVE]||_hide($Symbol[PROTOTYPE$2],TO_PRIMITIVE,$Symbol[PROTOTYPE$2].valueOf);_setToStringTag($Symbol,'Symbol');_setToStringTag(Math,'Math',true);_setToStringTag(_global.JSON,'JSON',true);_wksDefine('asyncIterator');_wksDefine('observable');var index=_core.Symbol;var symbol=createCommonjsModule(function(module){module.exports={"default":index,__esModule:true};});var _typeof_1=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;var _iterator2=_interopRequireDefault(iterator);var _symbol2=_interopRequireDefault(symbol);var _typeof=typeof _symbol2.default==="function"&&_typeof2(_iterator2.default)==="symbol"?function(obj){return typeof obj==='undefined'?'undefined':_typeof2(obj);}:function(obj){return obj&&typeof _symbol2.default==="function"&&obj.constructor===_symbol2.default&&obj!==_symbol2.default.prototype?"symbol":typeof obj==='undefined'?'undefined':_typeof2(obj);};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=typeof _symbol2.default==="function"&&_typeof(_iterator2.default)==="symbol"?function(obj){return typeof obj==="undefined"?"undefined":_typeof(obj);}:function(obj){return obj&&typeof _symbol2.default==="function"&&obj.constructor===_symbol2.default&&obj!==_symbol2.default.prototype?"symbol":typeof obj==="undefined"?"undefined":_typeof(obj);};});var _typeof=unwrapExports(_typeof_1);var possibleConstructorReturn=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;var _typeof3=_interopRequireDefault(_typeof_1);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==="undefined"?"undefined":(0,_typeof3.default)(call))==="object"||typeof call==="function")?call:self;};});var _possibleConstructorReturn=unwrapExports(possibleConstructorReturn);var get$1=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;var _getPrototypeOf2=_interopRequireDefault(getPrototypeOf);var _getOwnPropertyDescriptor2=_interopRequireDefault(getOwnPropertyDescriptor);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=(0,_getOwnPropertyDescriptor2.default)(object,property);if(desc===undefined){var parent=(0,_getPrototypeOf2.default)(object);if(parent===null){return undefined;}else{return get(parent,property,receiver);}}else if("value"in desc){return desc.value;}else{var getter=desc.get;if(getter===undefined){return undefined;}return getter.call(receiver);}};});var _get=unwrapExports(get$1);var check=function check(O,proto){_anObject(O);if(!_isObject(proto)&&proto!==null)throw TypeError(proto+": can't set as prototype!");};var _setProto={set:Object.setPrototypeOf||('__proto__'in{}?function(test,buggy,set){try{set=_ctx(Function.call,_objectGopd.f(Object.prototype,'__proto__').set,2);set(test,[]);buggy=!(test instanceof Array);}catch(e){buggy=true;}return function setPrototypeOf(O,proto){check(O,proto);if(buggy)O.__proto__=proto;else set(O,proto);return O;};}({},false):undefined),check:check};_export(_export.S,'Object',{setPrototypeOf:_setProto.set});var setPrototypeOf$2=_core.Object.setPrototypeOf;var setPrototypeOf=createCommonjsModule(function(module){module.exports={"default":setPrototypeOf$2,__esModule:true};});_export(_export.S,'Object',{create:_objectCreate});var $Object$2=_core.Object;var create$2=function create(P,D){return $Object$2.create(P,D);};var create$1=createCommonjsModule(function(module){module.exports={"default":create$2,__esModule:true};});var _Object$create=unwrapExports(create$1);var inherits=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;var _setPrototypeOf2=_interopRequireDefault(setPrototypeOf);var _create2=_interopRequireDefault(create$1);var _typeof3=_interopRequireDefault(_typeof_1);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==="undefined"?"undefined":(0,_typeof3.default)(superClass)));}subClass.prototype=(0,_create2.default)(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)_setPrototypeOf2.default?(0,_setPrototypeOf2.default)(subClass,superClass):subClass.__proto__=superClass;};});var _inherits=unwrapExports(inherits);var _anInstance=function _anInstance(it,Constructor,name,forbiddenField){if(!(it instanceof Constructor)||forbiddenField!==undefined&&forbiddenField in it){throw TypeError(name+': incorrect invocation!');}return it;};var _forOf=createCommonjsModule(function(module){var BREAK={},RETURN={};var exports=module.exports=function(iterable,entries,fn,that,ITERATOR){var iterFn=ITERATOR?function(){return iterable;}:core_getIteratorMethod(iterable),f=_ctx(fn,that,entries?2:1),index=0,length,step,iterator,result;if(typeof iterFn!='function')throw TypeError(iterable+' is not iterable!');if(_isArrayIter(iterFn))for(length=_toLength(iterable.length);length>index;index++){result=entries?f(_anObject(step=iterable[index])[0],step[1]):f(iterable[index]);if(result===BREAK||result===RETURN)return result;}else for(iterator=iterFn.call(iterable);!(step=iterator.next()).done;){result=_iterCall(iterator,f,step.value,entries);if(result===BREAK||result===RETURN)return result;}};exports.BREAK=BREAK;exports.RETURN=RETURN;});var SPECIES=_wks('species');var _speciesConstructor=function _speciesConstructor(O,D){var C=_anObject(O).constructor,S;return C===undefined||(S=_anObject(C)[SPECIES])==undefined?D:_aFunction(S);};var _invoke=function _invoke(fn,args,that){var un=that===undefined;switch(args.length){case 0:return un?fn():fn.call(that);case 1:return un?fn(args[0]):fn.call(that,args[0]);case 2:return un?fn(args[0],args[1]):fn.call(that,args[0],args[1]);case 3:return un?fn(args[0],args[1],args[2]):fn.call(that,args[0],args[1],args[2]);case 4:return un?fn(args[0],args[1],args[2],args[3]):fn.call(that,args[0],args[1],args[2],args[3]);}return fn.apply(that,args);};var process$1=_global.process;var setTask=_global.setImmediate;var clearTask=_global.clearImmediate;var MessageChannel=_global.MessageChannel;var counter=0;var queue={};var ONREADYSTATECHANGE='onreadystatechange';var defer;var channel;var port;var run=function run(){var id=+this;if(queue.hasOwnProperty(id)){var fn=queue[id];delete queue[id];fn();}};var listener=function listener(event){run.call(event.data);};if(!setTask||!clearTask){setTask=function setImmediate(fn){var args=[],i=1;while(arguments.length>i){args.push(arguments[i++]);}queue[++counter]=function(){_invoke(typeof fn=='function'?fn:Function(fn),args);};defer(counter);return counter;};clearTask=function clearImmediate(id){delete queue[id];};if(_cof(process$1)=='process'){defer=function defer(id){process$1.nextTick(_ctx(run,id,1));};}else if(MessageChannel){channel=new MessageChannel();port=channel.port2;channel.port1.onmessage=listener;defer=_ctx(port.postMessage,port,1);}else if(_global.addEventListener&&typeof postMessage=='function'&&!_global.importScripts){defer=function defer(id){_global.postMessage(id+'','*');};_global.addEventListener('message',listener,false);}else if(ONREADYSTATECHANGE in _domCreate('script')){defer=function defer(id){_html.appendChild(_domCreate('script'))[ONREADYSTATECHANGE]=function(){_html.removeChild(this);run.call(id);};};}else{defer=function defer(id){setTimeout(_ctx(run,id,1),0);};}}var _task={set:setTask,clear:clearTask};var macrotask=_task.set;var Observer=_global.MutationObserver||_global.WebKitMutationObserver;var process$2=_global.process;var Promise=_global.Promise;var isNode$1=_cof(process$2)=='process';var _microtask=function _microtask(){var head,last,notify;var flush=function flush(){var parent,fn;if(isNode$1&&(parent=process$2.domain))parent.exit();while(head){fn=head.fn;head=head.next;try{fn();}catch(e){if(head)notify();else last=undefined;throw e;}}last=undefined;if(parent)parent.enter();};if(isNode$1){notify=function notify(){process$2.nextTick(flush);};}else if(Observer){var toggle=true,node=document.createTextNode('');new Observer(flush).observe(node,{characterData:true});notify=function notify(){node.data=toggle=!toggle;};}else if(Promise&&Promise.resolve){var promise=Promise.resolve();notify=function notify(){promise.then(flush);};}else{notify=function notify(){macrotask.call(_global,flush);};}return function(fn){var task={fn:fn,next:undefined};if(last)last.next=task;if(!head){head=task;notify();}last=task;};};var _redefineAll=function _redefineAll(target,src,safe){for(var key in src){if(safe&&target[key])target[key]=src[key];else _hide(target,key,src[key]);}return target;};var SPECIES$1=_wks('species');var _setSpecies=function _setSpecies(KEY){var C=typeof _core[KEY]=='function'?_core[KEY]:_global[KEY];if(_descriptors&&C&&!C[SPECIES$1])_objectDp.f(C,SPECIES$1,{configurable:true,get:function get(){return this;}});};var task=_task.set;var microtask=_microtask();var PROMISE='Promise';var TypeError$1=_global.TypeError;var process=_global.process;var $Promise=_global[PROMISE];var process=_global.process;var isNode=_classof(process)=='process';var empty=function empty(){};var Internal;var GenericPromiseCapability;var Wrapper;var USE_NATIVE$1=!!function(){try{var promise=$Promise.resolve(1),FakePromise=(promise.constructor={})[_wks('species')]=function(exec){exec(empty,empty);};return(isNode||typeof PromiseRejectionEvent=='function')&&promise.then(empty)instanceof FakePromise;}catch(e){}}();var sameConstructor=function sameConstructor(a,b){return a===b||a===$Promise&&b===Wrapper;};var isThenable=function isThenable(it){var then;return _isObject(it)&&typeof(then=it.then)=='function'?then:false;};var newPromiseCapability=function newPromiseCapability(C){return sameConstructor($Promise,C)?new PromiseCapability(C):new GenericPromiseCapability(C);};var PromiseCapability=GenericPromiseCapability=function GenericPromiseCapability(C){var resolve,reject;this.promise=new C(function($$resolve,$$reject){if(resolve!==undefined||reject!==undefined)throw TypeError$1('Bad Promise constructor');resolve=$$resolve;reject=$$reject;});this.resolve=_aFunction(resolve);this.reject=_aFunction(reject);};var perform=function perform(exec){try{exec();}catch(e){return{error:e};}};var notify=function notify(promise,isReject){if(promise._n)return;promise._n=true;var chain=promise._c;microtask(function(){var value=promise._v,ok=promise._s==1,i=0;var run=function run(reaction){var handler=ok?reaction.ok:reaction.fail,resolve=reaction.resolve,reject=reaction.reject,domain=reaction.domain,result,then;try{if(handler){if(!ok){if(promise._h==2)onHandleUnhandled(promise);promise._h=1;}if(handler===true)result=value;else{if(domain)domain.enter();result=handler(value);if(domain)domain.exit();}if(result===reaction.promise){reject(TypeError$1('Promise-chain cycle'));}else if(then=isThenable(result)){then.call(result,resolve,reject);}else resolve(result);}else reject(value);}catch(e){reject(e);}};while(chain.length>i){run(chain[i++]);}promise._c=[];promise._n=false;if(isReject&&!promise._h)onUnhandled(promise);});};var onUnhandled=function onUnhandled(promise){task.call(_global,function(){var value=promise._v,abrupt,handler,console;if(isUnhandled(promise)){abrupt=perform(function(){if(isNode){process.emit('unhandledRejection',value,promise);}else if(handler=_global.onunhandledrejection){handler({promise:promise,reason:value});}else if((console=_global.console)&&console.error){console.error('Unhandled promise rejection',value);}});promise._h=isNode||isUnhandled(promise)?2:1;}promise._a=undefined;if(abrupt)throw abrupt.error;});};var isUnhandled=function isUnhandled(promise){if(promise._h==1)return false;var chain=promise._a||promise._c,i=0,reaction;while(chain.length>i){reaction=chain[i++];if(reaction.fail||!isUnhandled(reaction.promise))return false;}return true;};var onHandleUnhandled=function onHandleUnhandled(promise){task.call(_global,function(){var handler;if(isNode){process.emit('rejectionHandled',promise);}else if(handler=_global.onrejectionhandled){handler({promise:promise,reason:promise._v});}});};var $reject=function $reject(value){var promise=this;if(promise._d)return;promise._d=true;promise=promise._w||promise;promise._v=value;promise._s=2;if(!promise._a)promise._a=promise._c.slice();notify(promise,true);};var $resolve=function $resolve(value){var promise=this,then;if(promise._d)return;promise._d=true;promise=promise._w||promise;try{if(promise===value)throw TypeError$1("Promise can't be resolved itself");if(then=isThenable(value)){microtask(function(){var wrapper={_w:promise,_d:false};try{then.call(value,_ctx($resolve,wrapper,1),_ctx($reject,wrapper,1));}catch(e){$reject.call(wrapper,e);}});}else{promise._v=value;promise._s=1;notify(promise,false);}}catch(e){$reject.call({_w:promise,_d:false},e);}};if(!USE_NATIVE$1){$Promise=function Promise(executor){_anInstance(this,$Promise,PROMISE,'_h');_aFunction(executor);Internal.call(this);try{executor(_ctx($resolve,this,1),_ctx($reject,this,1));}catch(err){$reject.call(this,err);}};Internal=function Promise(executor){this._c=[];this._a=undefined;this._s=0;this._d=false;this._v=undefined;this._h=0;this._n=false;};Internal.prototype=_redefineAll($Promise.prototype,{then:function then(onFulfilled,onRejected){var reaction=newPromiseCapability(_speciesConstructor(this,$Promise));reaction.ok=typeof onFulfilled=='function'?onFulfilled:true;reaction.fail=typeof onRejected=='function'&&onRejected;reaction.domain=isNode?process.domain:undefined;this._c.push(reaction);if(this._a)this._a.push(reaction);if(this._s)notify(this,false);return reaction.promise;},'catch':function _catch(onRejected){return this.then(undefined,onRejected);}});PromiseCapability=function PromiseCapability(){var promise=new Internal();this.promise=promise;this.resolve=_ctx($resolve,promise,1);this.reject=_ctx($reject,promise,1);};}_export(_export.G+_export.W+_export.F*!USE_NATIVE$1,{Promise:$Promise});_setToStringTag($Promise,PROMISE);_setSpecies(PROMISE);Wrapper=_core[PROMISE];_export(_export.S+_export.F*!USE_NATIVE$1,PROMISE,{reject:function reject(r){var capability=newPromiseCapability(this),$$reject=capability.reject;$$reject(r);return capability.promise;}});_export(_export.S+_export.F*(_library||!USE_NATIVE$1),PROMISE,{resolve:function resolve(x){if(x instanceof $Promise&&sameConstructor(x.constructor,this))return x;var capability=newPromiseCapability(this),$$resolve=capability.resolve;$$resolve(x);return capability.promise;}});_export(_export.S+_export.F*!(USE_NATIVE$1&&_iterDetect(function(iter){$Promise.all(iter)['catch'](empty);})),PROMISE,{all:function all(iterable){var C=this,capability=newPromiseCapability(C),resolve=capability.resolve,reject=capability.reject;var abrupt=perform(function(){var values=[],index=0,remaining=1;_forOf(iterable,false,function(promise){var $index=index++,alreadyCalled=false;values.push(undefined);remaining++;C.resolve(promise).then(function(value){if(alreadyCalled)return;alreadyCalled=true;values[$index]=value;--remaining||resolve(values);},reject);});--remaining||resolve(values);});if(abrupt)reject(abrupt.error);return capability.promise;},race:function race(iterable){var C=this,capability=newPromiseCapability(C),reject=capability.reject;var abrupt=perform(function(){_forOf(iterable,false,function(promise){C.resolve(promise).then(capability.resolve,reject);});});if(abrupt)reject(abrupt.error);return capability.promise;}});var promise$1=_core.Promise;var promise=createCommonjsModule(function(module){module.exports={"default":promise$1,__esModule:true};});var _Promise=unwrapExports(promise);_objectSap('keys',function(){return function keys(it){return _objectKeys(_toObject(it));};});var keys$1=_core.Object.keys;var keys=createCommonjsModule(function(module){module.exports={"default":keys$1,__esModule:true};});var _Object$keys=unwrapExports(keys);var floor$1=Math.floor;var _isInteger=function isInteger(it){return!_isObject(it)&&isFinite(it)&&floor$1(it)===it;};_export(_export.S,'Number',{isInteger:_isInteger});var isInteger$2=_core.Number.isInteger;var isInteger$1=createCommonjsModule(function(module){module.exports={"default":isInteger$2,__esModule:true};});var _Number$isInteger=unwrapExports(isInteger$1);var _stringWs='\t\n\x0B\f\r \xA0\u1680\u180E\u2000\u2001\u2002\u2003'+'\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF';var space='['+_stringWs+']';var non='\u200B\x85';var ltrim=RegExp('^'+space+space+'*');var rtrim=RegExp(space+space+'*$');var exporter=function exporter(KEY,exec,ALIAS){var exp={};var FORCE=_fails(function(){return!!_stringWs[KEY]()||non[KEY]()!=non;});var fn=exp[KEY]=FORCE?exec(trim):_stringWs[KEY];if(ALIAS)exp[ALIAS]=fn;_export(_export.P+_export.F*FORCE,'String',exp);};var trim=exporter.trim=function(string,TYPE){string=String(_defined(string));if(TYPE&1)string=string.replace(ltrim,'');if(TYPE&2)string=string.replace(rtrim,'');return string;};var _stringTrim=exporter;var $parseFloat=_global.parseFloat;var $trim=_stringTrim.trim;var _parseFloat$3=1/$parseFloat(_stringWs+'-0')!==-Infinity?function parseFloat(str){var string=$trim(String(str),3),result=$parseFloat(string);return result===0&&string.charAt(0)=='-'?-0:result;}:$parseFloat;_export(_export.S+_export.F*(Number.parseFloat!=_parseFloat$3),'Number',{parseFloat:_parseFloat$3});var _parseFloat$1=parseFloat;var _parseFloat=createCommonjsModule(function(module){module.exports={"default":_parseFloat$1,__esModule:true};});function isVoid(obj){return obj===undefined||obj===null;}function isArray$1(arr){return Array.isArray(arr);}function isFunction(obj){return typeof obj==='function';}function isObject$1(obj){return Object(obj)===obj&&String(obj)==='[object Object]'&&!isFunction(obj)&&!isArray$1(obj);}function isNumber(obj){return typeof obj==='number';}function isInteger(num){return _Number$isInteger(num);}function isEmpty(obj){if(isArray$1(obj)){return obj.length===0;}else if(isObject$1(obj)){return _Object$keys(obj).length===0;}else{return!obj;}}function isString(str){return typeof str==='string'||str instanceof String;}function isBoolean(bool){return typeof bool==='boolean';}function isPromise(obj){return!!obj&&((typeof obj==='undefined'?'undefined':_typeof(obj))==='object'||typeof obj==='function')&&typeof obj.then==='function';}function isPrimitive(val){return isVoid(val)||isBoolean(val)||isString(val)||isNumber(val);}function isNode$2(obj){return!!((typeof Node==='undefined'?'undefined':_typeof(Node))==='object'?obj instanceof Node:obj&&(typeof obj==='undefined'?'undefined':_typeof(obj))==='object'&&typeof obj.nodeType==='number'&&typeof obj.nodeName==='string');}function isElement(obj){return!!((typeof HTMLElement==='undefined'?'undefined':_typeof(HTMLElement))==='object'?obj instanceof HTMLElement:obj&&(typeof obj==='undefined'?'undefined':_typeof(obj))==='object'&&obj!==null&&obj.nodeType===1&&typeof obj.nodeName==='string');}function isPosterityNode(parent,child){if(!isNode$2(parent)||!isNode$2(child)){return false;}while(child.parentNode){child=child.parentNode;if(child===parent){return true;}}return false;}function isHTMLString(str){return /<[^>]+?>/.test(str);}function isError(val){return val instanceof Error;}function formatter(tag,msg){if(!isString(tag))throw new TypeError("Log's method only acccept string as argument");if(!isString(msg))return'['+Log.GLOBAL_TAG+'] > '+tag;tag=Log.FORCE_GLOBAL_TAG?Log.GLOBAL_TAG:tag||Log.GLOBAL_TAG;return'['+tag+'] > '+msg;}var Log=function(){function Log(){_classCallCheck(this,Log);}_createClass(Log,null,[{key:'error',value:function error(tag,msg){if(!Log.ENABLE_ERROR){return;}(console.error||console.warn||console.log)(formatter(tag,msg));}},{key:'info',value:function info(tag,msg){if(!Log.ENABLE_INFO){return;}(console.info||console.log)(formatter(tag,msg));}},{key:'warn',value:function warn(tag,msg){if(!Log.ENABLE_WARN){return;}(console.warn||console.log)(formatter(tag,msg));}},{key:'debug',value:function debug(tag,msg){if(!Log.ENABLE_DEBUG){return;}(console.debug||console.log)(formatter(tag,msg));}},{key:'verbose',value:function verbose(tag,msg){if(!Log.ENABLE_VERBOSE){return;}console.log(formatter(tag,msg));}}]);return Log;}();Log.GLOBAL_TAG='chimee';Log.FORCE_GLOBAL_TAG=false;Log.ENABLE_ERROR=true;Log.ENABLE_INFO=true;Log.ENABLE_WARN=true;Log.ENABLE_DEBUG=true;Log.ENABLE_VERBOSE=true;function genTraversalHandler(fn){function recursiveFn(source,target,key){if(isArray$1(source)||isObject$1(source)){target=target||(isObject$1(source)?{}:[]);for(var _key in source){target[_key]=recursiveFn(source[_key],target[_key],_key);}return target;}return fn(source,target,key);}return recursiveFn;}var _deepAssign=genTraversalHandler(function(val){return val;});function deepClone(source){if(isPrimitive(source)){throw new TypeError('deepClone only accept non primitive type');}return _deepAssign(source);}function deepAssign(){for(var _len=arguments.length,args=Array(_len),_key2=0;_key2<_len;_key2++){args[_key2]=arguments[_key2];}if(args.length<2){throw new Error('deepAssign accept two and more argument');}for(var i=args.length-1;i>-1;i--){if(isPrimitive(args[i])){throw new TypeError('deepAssign only accept non primitive type');}}var target=args.shift();args.forEach(function(source){return _deepAssign(source,target);});return target;}function camelize(str,isBig){return str.replace(/(^|[^a-zA-Z]+)([a-zA-Z])/g,function(match,spilt,initials,index){return!isBig&&index===0?initials.toLowerCase():initials.toUpperCase();});}function hypenate(str){return camelize(str).replace(/([A-Z])/g,function(match){return'-'+match.toLowerCase();});}function bind(fn,context){if(fn.bind){return fn.bind(context);}else if(fn.apply){return function __autobind__(){for(var _len2=arguments.length,args=Array(_len2),_key3=0;_key3<_len2;_key3++){args[_key3]=arguments[_key3];}return fn.apply(context,args);};}else{return function __autobind__(){for(var _len3=arguments.length,args=Array(_len3),_key4=0;_key4<_len3;_key4++){args[_key4]=arguments[_key4];}return fn.call.apply(fn,[context].concat(_toConsumableArray(args)));};}}function getDeepProperty(obj,keys){var _ref=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},_ref$throwError=_ref.throwError,throwError=_ref$throwError===undefined?false:_ref$throwError,backup=_ref.backup;if(isString(keys)){keys=keys.split('.');}if(!isArray$1(keys)){throw new TypeError('keys of getDeepProperty must be string or Array<string>');}var read=[];var target=obj;for(var i=0,len=keys.length;i<len;i++){var key=keys[i];if(isVoid(target)){if(throwError){throw new Error('obj'+(read.length>0?'.'+read.join('.'):' itself')+' is '+target);}else{return backup;}}target=target[key];read.push(key);}return target;}var inBrowser=typeof window!=='undefined'&&Object.prototype.toString.call(window)!=='[object Object]';function transObjectAttrIntoArray(obj){var fn=arguments.length>1&&arguments[1]!==undefined?arguments[1]:function(a,b){return+a-+b;};return _Object$keys(obj).sort(fn).reduce(function(order,key){return order.concat(obj[key]);},[]);}function runRejectableQueue(queue){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}return new _Promise(function(resolve,reject){var step=function step(index){if(index>=queue.length){resolve();return;}var result=isFunction(queue[index])?queue[index].apply(queue,_toConsumableArray(args)):queue[index];if(result===false)return reject('stop');return _Promise.resolve(result).then(function(){return step(index+1);}).catch(function(err){return reject(err||'stop');});};step(0);});}function runStoppableQueue(queue){for(var _len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2];}var step=function step(index){if(index>=queue.length){return true;}var result=isFunction(queue[index])?queue[index].apply(queue,_toConsumableArray(args)):queue[index];if(result===false)return false;return step(++index);};return step(0);}function throttle(func,wait,options,cxt){var context=void 0,args=void 0,result=void 0;var timeout=null;var previous=0;if(!options)options={};var later=function later(){previous=options.leading===false?0:new Date()-0;timeout=null;result=func.apply(context,args);if(!timeout)context=args=null;};wait=wait||0;return function(){var now=new Date();if(!previous&&options.leading===false)previous=now;var remaining=wait-(now-previous);if(cxt){context=cxt;}else{context=this;}args=arguments;if(remaining<=0||remaining>wait){if(timeout){clearTimeout(timeout);timeout=null;}previous=now;result=func.apply(context,args);if(!timeout)context=args=null;}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining);}return result;};}var $assign=Object.assign;var _objectAssign=!$assign||_fails(function(){var A={},B={},S=Symbol(),K='abcdefghijklmnopqrst';A[S]=7;K.split('').forEach(function(k){B[k]=k;});return $assign({},A)[S]!=7||Object.keys($assign({},B)).join('')!=K;})?function assign(target,source){var T=_toObject(target),aLen=arguments.length,index=1,getSymbols=_objectGops.f,isEnum=_objectPie.f;while(aLen>index){var S=_iobject(arguments[index++]),keys=getSymbols?_objectKeys(S).concat(getSymbols(S)):_objectKeys(S),length=keys.length,j=0,key;while(length>j){if(isEnum.call(S,key=keys[j++]))T[key]=S[key];}}return T;}:$assign;_export(_export.S+_export.F,'Object',{assign:_objectAssign});var assign$1=_core.Object.assign;var assign=createCommonjsModule(function(module){module.exports={"default":assign$1,__esModule:true};});var _Object$assign=unwrapExports(assign);var _evtListenerCache=_Object$create(null);_evtListenerCache.count=0;function getEvtTypeCache(target,type){var evtId=target.__evt_id;if(!evtId){Object.defineProperty(target,'__evt_id',{writable:true,enumerable:false,configurable:true});evtId=target.__evt_id=++_evtListenerCache.count;}var typeCacheKey=evtId+'_'+type;var evtTypeCache=_evtListenerCache[typeCacheKey];if(!evtTypeCache){evtTypeCache=_evtListenerCache[typeCacheKey]=[];}return evtTypeCache;}function emitEventCache(target,type,eventObj){var evt=_Object$create(null);evt.type=type;evt.target=target;if(eventObj){_Object$assign(evt,isObject$1(eventObj)?eventObj:{data:eventObj});}getEvtTypeCache(target,type).forEach(function(item){(item[1]||item[0]).apply(target,[evt]);});}function addEventCache(target,type,handler){var isOnce=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var handlerWrap=arguments[4];if(isFunction(isOnce)&&!handlerWrap){handlerWrap=isOnce;isOnce=undefined;}var handlers=[handler,undefined,isOnce];if(isOnce&&!handlerWrap){handlerWrap=function handlerWrap(){removeEventCache(target,type,handler,isOnce);for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}handler.apply(target,args);};}if(handlerWrap){handlers[1]=handlerWrap;}getEvtTypeCache(target,type).push(handlers);}function removeEventCache(target,type,handler){var isOnce=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var typeCache=getEvtTypeCache(target,type);if(handler||isOnce){var handlerId=-1;var handlerWrap=void 0;typeCache.find(function(item,i){if((!handler||item[0]===handler)&&(!isOnce||item[2])){handlerId=i;handlerWrap=item[1];return true;}});if(handlerId!==-1){typeCache.splice(handlerId,1);}return handlerWrap;}else{typeCache.length=0;}}var CustEvent=function(){function CustEvent(target,assign$$1){var _this=this;_classCallCheck(this,CustEvent);Object.defineProperty(this,'__target',{writable:true,enumerable:false,configurable:true});this.__target=this;if(target){if((typeof target==='undefined'?'undefined':_typeof(target))!=='object'){throw new Error('CusEvent target are not object');}this.__target=target;if(assign$$1){['on','once','off','emit'].forEach(function(mth){target[mth]=_this[mth];});}}}_createClass(CustEvent,[{key:'on',value:function on(type,handler){var isOnce=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;addEventCache(this.__target,type,handler,isOnce);return this;}},{key:'once',value:function once(type,handler){return this.on(type,handler,true);}},{key:'off',value:function off(type,handler){var isOnce=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;removeEventCache(this.__target,type,handler,isOnce);return this;}},{key:'emit',value:function emit(type,data){emitEventCache(this.__target,type,{data:data});return this;}}]);return CustEvent;}();var _evtListenerCache$1=_Object$create(null);_evtListenerCache$1.count=0;function getEvtTypeCache$1(target,type){var evtId=target.__evt_id;if(!evtId){Object.defineProperty(target,'__evt_id',{writable:true,enumerable:false,configurable:true});evtId=target.__evt_id=++_evtListenerCache$1.count;}var typeCacheKey=evtId+'_'+type;var evtTypeCache=_evtListenerCache$1[typeCacheKey];if(!evtTypeCache){evtTypeCache=_evtListenerCache$1[typeCacheKey]=[];}return evtTypeCache;}function emitEventCache$1(target,type,eventObj){var evt=_Object$create(null);evt.type=type;evt.target=target;if(eventObj){_Object$assign(evt,isObject$1(eventObj)?eventObj:{data:eventObj});}getEvtTypeCache$1(target,type).forEach(function(item){(item[1]||item[0]).apply(target,[evt]);});}function addEventCache$1(target,type,handler){var isOnce=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var handlerWrap=arguments[4];if(isFunction(isOnce)&&!handlerWrap){handlerWrap=isOnce;isOnce=undefined;}var handlers=[handler,undefined,isOnce];if(isOnce&&!handlerWrap){handlerWrap=function handlerWrap(){removeEventCache$1(target,type,handler,isOnce);for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}handler.apply(target,args);};}if(handlerWrap){handlers[1]=handlerWrap;}getEvtTypeCache$1(target,type).push(handlers);}function removeEventCache$1(target,type,handler){var isOnce=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var typeCache=getEvtTypeCache$1(target,type);if(handler||isOnce){var handlerId=-1;var handlerWrap=void 0;typeCache.find(function(item,i){if((!handler||item[0]===handler)&&(!isOnce||item[2])){handlerId=i;handlerWrap=item[1];return true;}});if(handlerId!==-1){typeCache.splice(handlerId,1);}return handlerWrap;}else{typeCache.length=0;}}var CustEvent$1=function(){function CustEvent(target,assign$$1){var _this=this;_classCallCheck(this,CustEvent);Object.defineProperty(this,'__target',{writable:true,enumerable:false,configurable:true});this.__target=this;if(target){if((typeof target==='undefined'?'undefined':_typeof(target))!=='object'){throw new Error('CusEvent target are not object');}this.__target=target;if(assign$$1){['on','once','off','emit'].forEach(function(mth){target[mth]=_this[mth];});}}}_createClass(CustEvent,[{key:'on',value:function on(type,handler){var isOnce=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;addEventCache$1(this.__target,type,handler,isOnce);return this;}},{key:'once',value:function once(type,handler){return this.on(type,handler,true);}},{key:'off',value:function off(type,handler){var isOnce=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;removeEventCache$1(this.__target,type,handler,isOnce);return this;}},{key:'emit',value:function emit(type,data){emitEventCache$1(this.__target,type,{data:data});return this;}}]);return CustEvent;}();var inBrowser$1=typeof window!=='undefined'&&Object.prototype.toString.call(window)!=='[object Object]';function makeArray$1(obj){return _Array$from(obj);}var _divEl=document.createElement('div');var _textAttrName='innerText';'textContent'in _divEl&&(_textAttrName='textContent');var _arrPrototype=Array.prototype;function getAttr(el,attrName){return el.getAttribute(attrName);}function setAttr(el,attrName,attrVal){if(attrVal===undefined){el.removeAttribute(attrName);}else{el.setAttribute(attrName,attrVal);}}function addClassName(el,cls){if(!cls||!(cls=cls.trim())){return;}var clsArr=cls.split(/\s+/);if(el.classList){clsArr.forEach(function(c){return el.classList.add(c);});}else{var curCls=' '+(el.className||'')+' ';clsArr.forEach(function(c){curCls.indexOf(' '+c+' ')===-1&&(curCls+=' '+c);});el.className=curCls.trim();}}function removeClassName(el,cls){if(!cls||!(cls=cls.trim())){return;}var clsArr=cls.split(/\s+/);if(el.classList){clsArr.forEach(function(c){return el.classList.remove(c);});}else{var curCls=' '+el.className+' ';clsArr.forEach(function(c){var tar=' '+c+' ';while(curCls.indexOf(tar)!==-1){curCls=curCls.replace(tar,' ');}});el.className=curCls.trim();}}function hasClassName(el,className){return new RegExp('(?:^|\\s)'+className+'(?=\\s|$)').test(el.className);}function removeEvent(el,type,handler){var once=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var capture=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;if(once){var handlerWrap=removeEventCache$1(el,type+'_once',handler);if(handlerWrap){handler=handlerWrap;}}el.removeEventListener(type,handler,capture);}function addEvent(el,type,handler){var once=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var capture=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;if(once){var oldHandler=handler;handler=function(){return function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}oldHandler.apply(this,args);removeEvent(el,type,handler,once,capture);};}();addEventCache$1(el,type+'_once',oldHandler,handler);}el.addEventListener(type,handler,capture);}function addDelegate(el,selector,type,handler){var capture=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var handlerWrap=function handlerWrap(e){var targetEls=findParents(e.srcElement,el,true);var targetEl=query(selector,el,true).find(function(seEl){return targetEls.find(function(tgEl){return seEl===tgEl;});});targetEl&&handler.apply(targetEl,arguments);};addEventCache$1(el,type+'_delegate_'+selector,handler,handlerWrap);el.addEventListener(type,handlerWrap,capture);}function removeDelegate(el,selector,type,handler){var capture=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var handlerWrap=removeEventCache$1(el,type+'_delegate_'+selector,handler);handlerWrap&&el.removeEventListener(type,handlerWrap,capture);}function getStyle(el,key){return(el.currentStyle||document.defaultView.getComputedStyle(el,null))[key]||el.style[key];}function setStyle(el,key,val){if(isObject$1(key)){for(var k in key){setStyle(el,k,key[k]);}}else{el.style[key]=val;}}function query(selector){var container=arguments.length>1&&arguments[1]!==undefined?arguments[1]:document;var toArray=arguments[2];var retNodeList=container.querySelectorAll(selector);return toArray?_Array$from(retNodeList):retNodeList;}function removeEl(el){el.parentNode.removeChild(el);}function findParents(el){var endEl=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var haveEl=arguments[2];var haveEndEl=arguments[3];var retEls=[];if(haveEl){retEls.push(el);}while(el&&el.parentNode!==endEl){el=el.parentNode;el&&retEls.push(el);}if(haveEndEl){retEls.push(endEl);}return retEls;}function $(selector,container){return selector.constructor===NodeWrap?selector:new NodeWrap(selector,container);}var NodeWrap=function(){function NodeWrap(selector){var container=arguments.length>1&&arguments[1]!==undefined?arguments[1]:document;_classCallCheck(this,NodeWrap);var _this=this;_this.selector=selector;var elsArr=void 0;if(selector&&selector.constructor===NodeList){elsArr=makeArray$1(selector);}else if(isArray$1(selector)){elsArr=selector;}else if(isString(selector)){if(selector.indexOf('<')===0){_divEl.innerHTML=selector;elsArr=query('*',_divEl,true);}else{elsArr=query(selector,container,true);}}else{elsArr=[selector];}_Object$assign(_this,elsArr);_this.length=elsArr.length;}_createClass(NodeWrap,[{key:'each',value:function each(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}_arrPrototype.forEach.apply(this,args);return this;}},{key:'push',value:function push(){for(var _len3=arguments.length,args=Array(_len3),_key3=0;_key3<_len3;_key3++){args[_key3]=arguments[_key3];}_arrPrototype.push.apply(this,args);return this;}},{key:'splice',value:function splice(){for(var _len4=arguments.length,args=Array(_len4),_key4=0;_key4<_len4;_key4++){args[_key4]=arguments[_key4];}return $(_arrPrototype.splice.apply(this,args));}},{key:'find',value:function find(selector){var childs=[];this.each(function(el){childs=childs.concat(query(selector,el,true));});var childsWrap=$(childs);childsWrap.parent=this;childsWrap.selector=selector;return childsWrap;}},{key:'append',value:function append(childEls){var childsWrap=$(childEls);var firstEl=this[0];childsWrap.each(function(newEl){return firstEl.appendChild(newEl);});return this;}},{key:'appendTo',value:function appendTo(parentEl){$(parentEl).append(this);return this;}},{key:'text',value:function text(val){if(arguments.length===0){return this[0][_textAttrName];}return this.each(function(el){el[_textAttrName]=val;});}},{key:'html',value:function html(_html){if(arguments.length===0){return this[0].innerHTML;}return this.each(function(el){el.innerHTML=_html;});}},{key:'attr',value:function attr(name,val){if(arguments.length===1){return getAttr(this[0],name);}return this.each(function(el){return setAttr(el,name,val);});}},{key:'data',value:function data(key,val){if(arguments.length===0){return this[0].dataset||{};}if(arguments.length===1){return(this[0].dataset||{})[key];}return this.each(function(el){(el.dataset||(el.dataset={}))[key]=val;});}},{key:'css',value:function css(key,val){if(arguments.length===1&&!isObject$1(key)){return getStyle(this[0],key);}return this.each(function(el){return setStyle(el,key,val);});}},{key:'addClass',value:function addClass(cls){return this.each(function(el){return addClassName(el,cls);});}},{key:'removeClass',value:function removeClass(cls){return this.each(function(el){return removeClassName(el,cls);});}},{key:'hasClass',value:function hasClass(cls){return hasClassName(this[0],cls);}},{key:'on',value:function on(type,handler){var once=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var capture=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;return this.each(function(el){return addEvent(el,type,handler,once,capture);});}},{key:'off',value:function off(type,handler){var once=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var capture=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;return this.each(function(el){return removeEvent(el,type,handler,once,capture);});}},{key:'delegate',value:function delegate(selector,type,handler){var capture=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;return this.each(function(el){return addDelegate(el,selector,type,handler,capture);});}},{key:'undelegate',value:function undelegate(selector,type,handler){var capture=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;return this.each(function(el){return removeDelegate(el,selector,type,handler,capture);});}},{key:'remove',value:function remove(){return this.each(function(el){return removeEl(el);});}}]);return NodeWrap;}();var bundleFn=arguments[3];var sources=arguments[4];var cache=arguments[5];var stringify=JSON.stringify;var index$2=function index$2(fn,options){var wkey;var cacheKeys=Object.keys(cache);for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];var exp=cache[key].exports;if(exp===fn||exp&&exp.default===fn){wkey=key;break;}}if(!wkey){wkey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var wcache={};for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];wcache[key]=key;}sources[wkey]=[Function(['require','module','exports'],'('+fn+')(self)'),wcache];}var skey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var scache={};scache[wkey]=wkey;sources[skey]=[Function(['require'],'var f = require('+stringify(wkey)+');'+'(f.default ? f.default : f)(self);'),scache];var workerSources={};resolveSources(skey);function resolveSources(key){workerSources[key]=true;for(var depPath in sources[key][1]){var depKey=sources[key][1][depPath];if(!workerSources[depKey]){resolveSources(depKey);}}}var src='('+bundleFn+')({'+Object.keys(workerSources).map(function(key){return stringify(key)+':['+sources[key][0]+','+stringify(sources[key][1])+']';}).join(',')+'},{},['+stringify(skey)+'])';var URL=window.URL||window.webkitURL||window.mozURL||window.msURL;var blob=new Blob([src],{type:'text/javascript'});if(options&&options.bare){return blob;}var workerUrl=URL.createObjectURL(blob);var worker=new Worker(workerUrl);worker.objectURL=workerUrl;return worker;};var defaultConfig={type:'vod',autoPlay:false,box:'mp4',lockInternalProperty:false,debug:true};var Mp4=function(_CustEvent){_inherits(Mp4,_CustEvent);function Mp4(videodom,config){_classCallCheck(this,Mp4);var _this2=_possibleConstructorReturn(this,(Mp4.__proto__||_Object$getPrototypeOf(Mp4)).call(this));_this2.video=videodom;_this2.box='mp4';_this2.config=defaultConfig;deepAssign(_this2.config,config);_this2.bindEvents();return _this2;}_createClass(Mp4,[{key:'internalPropertyHandle',value:function internalPropertyHandle(){if(!_Object$getOwnPropertyDescriptor){return;}var _this=this;var time=_Object$getOwnPropertyDescriptor(HTMLMediaElement.prototype,'currentTime');Object.defineProperty(this.video,'currentTime',{get:function get(){return time.get.call(_this.video);},set:function set(t){if(!_this.currentTimeLock){throw new Error('can not set currentTime by youself');}else{return time.set.call(_this.video,t);}}});}},{key:'bindEvents',value:function bindEvents(){var _this3=this;if(this.video&&this.config.lockInternalProperty){this.video.addEventListener('canplay',function(){_this3.internalPropertyHandle();});}}},{key:'load',value:function load(src){this.config.src=src||this.config.src;this.video.src=this.config.src;}},{key:'unload',value:function unload(){this.video.src='';this.video.removeAttribute('src');}},{key:'destroy',value:function destroy(){if(this.video){this.unload();}}},{key:'play',value:function play(){return this.video.play();}},{key:'pause',value:function pause(){return this.video.pause();}},{key:'attachMedia',value:function attachMedia(){}},{key:'seek',value:function seek(seconds){this.currentTimeLock=true;this.video.currentTime=seconds;this.currentTimeLock=false;}}]);return Mp4;}(CustEvent);var MSEController=function(_CustEvent){_inherits(MSEController,_CustEvent);function MSEController(videoElement,config){_classCallCheck(this,MSEController);var _this=_possibleConstructorReturn(this,(MSEController.__proto__||_Object$getPrototypeOf(MSEController)).call(this));_this.video=videoElement;_this.config=config;_this.tag='mse-controller';_this.e={onSourceOpen:_this.onSourceOpen.bind(_this),onSourceEnded:_this.onSourceEnded.bind(_this),onSourceClose:_this.onSourceClose.bind(_this),onSourceBufferError:_this.onSourceBufferError.bind(_this)};_this.queue=[];_this.removeRangesList=[];_this.mimeCodec='video/mp4; codecs="avc1.640020,mp4a.40.2"';_this.init();return _this;}_createClass(MSEController,[{key:'init',value:function init(){if(this.mediaSource){Log.Error(this.tag,'MediaSource has been attached to an HTMLMediaElement!');throw new Error('MediaSource has been attached to an HTMLMediaElement!');}var ms=this.mediaSource=new window.MediaSource();ms.addEventListener('sourceopen',this.e.onSourceOpen);ms.addEventListener('sourceended',this.e.onSourceEnded);ms.addEventListener('sourceclose',this.e.onSourceClose);}},{key:'onSourceOpen',value:function onSourceOpen(){var _this2=this;Log.verbose(this.tag,'MediaSource onSourceOpen');this.mediaSource.removeEventListener('sourceopen',this.e.onSourceOpen);this.sourceBuffer=this.mediaSource.addSourceBuffer(this.mimeCodec);this.sourceBuffer.addEventListener('error',this.e.onSourceBufferError);this.sourceBuffer.addEventListener('abort',function(){return console.log('sourceBuffer: abort');});this.sourceBuffer.addEventListener('updateend',function(){if(_this2.queue.length>=1){if(!_this2.sourceBuffer.updating){var data=_this2.queue.shift();_this2.appendBuffer(data);}}_this2.emit('updateend');});this.emit('source_open');this.sourceBufferEvent();}},{key:'sourceBufferEvent',value:function sourceBufferEvent(){var _this3=this;this.on('mediaSegment',function(handler){var data=handler.data;if(_this3.sourceBuffer.updating||_this3.queue.length>0){_this3.queue.push(data);}else{_this3.appendBuffer(data);}});this.on('mediaSegmentInit',function(handler){var data=handler.data;if(_this3.sourceBuffer.updating||_this3.queue.length>0){_this3.queue.push(data);}else{_this3.appendBuffer(data);}});}},{key:'needCleanupSourceBuffer',value:function needCleanupSourceBuffer(){var currentTime=this.video.currentTime;var sb=this.sourceBuffer;var buffered=sb.buffered;if(buffered.length>=1){if(currentTime-buffered.start(0)>=this.config.autoCleanupMaxBackwardDuration){return true;}}return false;}},{key:'doCleanupSourceBuffer',value:function doCleanupSourceBuffer(){Log.verbose('');var currentTime=this.video.currentTime;var sb=this.sourceBuffer;var buffered=sb.buffered;var doRemove=false;for(var i=0;i<buffered.length;i++){var start=buffered.start(i);var end=buffered.end(i);if(start<=currentTime&&currentTime<end+3){if(currentTime-start>=this.config.autoCleanupMaxBackwardDuration){doRemove=true;var removeEnd=currentTime-this._config.autoCleanupMinBackwardDuration;this.removeRangesList.push({start:start,end:removeEnd});}}else if(end<currentTime){doRemove=true;this.removeRangesList.push({start:start,end:end});}}if(doRemove&&!this.sourceBuffer.updating){this.removeRangesList();}}},{key:'removeRangesList',value:function removeRangesList(){for(var i=0;i<this.removeRangesListi.length;i++){if(this.sourceBuffer.updating){continue;}var sb=this.sourceBuffer;var ranges=this.removeRangesList[i];while(ranges.length&&!sb.updating){var range=ranges.shift();sb.remove(range.start,range.end);}}}},{key:'appendBuffer',value:function appendBuffer(data){if(this.needCleanupSourceBuffer()){this.doCleanupSourceBuffer();}try{this.sourceBuffer.appendBuffer(data);}catch(e){if(e.code===22){Log.verbose(this.TAG,'MediaSource bufferFull');this.emit('bufferFull');}}}},{key:'onSourceEnded',value:function onSourceEnded(){Log.verbose(this.TAG,'MediaSource onSourceEnded');}},{key:'onSourceClose',value:function onSourceClose(){Log.verbose(this.TAG,'MediaSource onSourceClose');if(this.mediaSource&&this.e!==null){this.mediaSource.removeEventListener('sourceopen',this.e.onSourceOpen);this.mediaSource.removeEventListener('sourceended',this.e.onSourceEnded);this.mediaSource.removeEventListener('sourceclose',this.e.onSourceClose);}}},{key:'onSourceBufferError',value:function onSourceBufferError(e){Log.Error(this.tag,'SourceBuffer Error: '+e);}},{key:'seek',value:function seek(currentTime){}},{key:'destroy',value:function destroy(){if(this.mediaSource){var ms=this.mediaSource;this.queue=[];var sb=this.sourceBuffer;if(sb){if(ms.readyState!=='closed'){ms.removeSourceBuffer(sb);sb.removeEventListener('error',this.e.onSourceBufferError);sb.removeEventListener('updateend',this.e.onSourceBufferUpdateEnd);}this.sourceBuffer=null;}if(ms.readyState==='open'){try{ms.endOfStream();}catch(error){Log.e(this.TAG,error.message);}}ms.removeEventListener('sourceopen',this.e.onSourceOpen);ms.removeEventListener('sourceended',this.e.onSourceEnded);ms.removeEventListener('sourceclose',this.e.onSourceClose);this.mediaSource=null;}if(this._mediaElement){this._mediaElement.src='';this._mediaElement.removeAttribute('src');this._mediaElement=null;}if(this._mediaSourceObjectURL){window.URL.revokeObjectURL(this._mediaSourceObjectURL);this._mediaSourceObjectURL=null;}}}]);return MSEController;}(CustEvent);var handleRange=function handleRange(range){var headers={};var param=void 0;if(range.to!==-1){param='bytes='+range.from.toString()+'-'+range.to.toString();}else{param='bytes='+range.from.toString()+'-';}headers['Range']=param;return{headers:headers};};var FetchLoader=function(_CustEvent){_inherits(FetchLoader,_CustEvent);_createClass(FetchLoader,null,[{key:'isSupport',value:function isSupport(){if(window.fetch&&window.ReadableStream){return true;}else{return false;}}}]);function FetchLoader(src,config){_classCallCheck(this,FetchLoader);var _this=_possibleConstructorReturn(this,(FetchLoader.__proto__||_Object$getPrototypeOf(FetchLoader)).call(this));_this.fetching=false;_this.config=config;_this.range={from:0,to:500000};_this.src=src;_this.totalRange=null;_this.block=500000;_this.reader=null;_this.requestAbort=false;_this.arrivalDataCallback=null;_this.bytesStart=0;return _this;}_createClass(FetchLoader,[{key:'open',value:function open(range,keyframePoint){var _this2=this;this.requestAbort=false;var reqHeaders=new Headers();var r=range||{from:0,to:-1};if(this.config.type==='vod'){this.range.from=r.from;this.range.to=r.to;var headers=handleRange(r).headers;for(var i in headers){reqHeaders.append(i,headers[i]);}}if(keyframePoint){this.bytesStart=0;}this.req=new Request(this.src,{headers:reqHeaders});fetch(this.req).then(function(res){if(res.ok){var reader=res.body.getReader();return _this2.pump(reader,keyframePoint);}});}},{key:'pause',value:function pause(){this.requestAbort=true;}},{key:'pump',value:function pump(reader,keyframePoint){var _this3=this;return reader.read().then(function(result){if(result.done){Log.ver;}else{if(_this3.requestAbort===true){return reader.cancel();}var chunk=result.value.buffer;if(_this3.arrivalDataCallback){_this3.arrivalDataCallback(chunk,_this3.bytesStart,keyframePoint);_this3.bytesStart+=chunk.byteLength;}return _this3.pump(reader);}});}}]);return FetchLoader;}(CustEvent);var RangeLoader=function(_CustEvent){_inherits(RangeLoader,_CustEvent);_createClass(RangeLoader,null,[{key:'isSupport',value:function isSupport(){try{var xhr=new XMLHttpRequest();xhr.open('GET','https://example.com',true);xhr.responseType='arraybuffer';return xhr.responseType==='arraybuffer';}catch(e){return false;}}}]);function RangeLoader(src,config){_classCallCheck(this,RangeLoader);var _this=_possibleConstructorReturn(this,(RangeLoader.__proto__||_Object$getPrototypeOf(RangeLoader)).call(this));_this.tag='RangeLoader';_this.xhr=null;_this.src=src;_this.totalLength=null;_this.chunkSizeKB=393216;_this.range={};_this.bytesStart=0;return _this;}_createClass(RangeLoader,[{key:'open',value:function open(range){var xhr=this.xhr=new XMLHttpRequest();xhr.open('GET',this.src,true);xhr.responseType='arraybuffer';xhr.onreadystatechange=this.onReadyStateChange.bind(this);xhr.onprogress=this.onProgress.bind(this);xhr.onload=this.onLoad.bind(this);xhr.onerror=this.onXhrError.bind(this);var r=range||{from:0,to:-1};this.range.from=r.from;this.range.to=r.to;var headers=handleRange(r).headers;for(var i in headers){xhr.setRequestHeader(i,headers[i]);}xhr.send();}},{key:'abort',value:function abort(){this.xhr.onreadystatechange=null;this.xhr.onprogress=null;this.xhr.onload=null;this.xhr.onerror=null;this.xhr.abort();this.xhr=null;}},{key:'destroy',value:function destroy(){if(this.xhr){this.abort();this.xhr.onreadystatechange=null;this.xhr.onprogress=null;this.xhr.onload=null;this.xhr.onerror=null;this.xhr=null;}this.totalLength=null;this.bytesStart=null;this.range={};}},{key:'onReadyStateChange',value:function onReadyStateChange(e){var xhr=this.xhr;if(xhr.readyState===2){if(xhr.status<200&&xhr.status>299){var info={from:this.range.from,to:this.range.to,url:this.src,msg:'http Error: http code '+xhr.status};this.emit(this.tag,info);}}}},{key:'onProgress',value:function onProgress(e){if(!this.totalLength){this.totalLength=e.total;this.abort();this.open({from:0,to:this.chunkSizeKB});}}},{key:'onLoad',value:function onLoad(e){if(!this.totalLength){return;}if(this.range.to<this.totalLength){}if(this.arrivalDataCallback){var chunk=e.target.response;this.arrivalDataCallback(chunk,this.bytesStart);this.bytesStart+=chunk.byteLength;}}},{key:'onXhrError',value:function onXhrError(e){var info={from:this.range.from,to:this.range.to,url:this.src,msg:e.constructor.name+' '+e.type};this.emit(this.tag,info);}}]);return RangeLoader;}(CustEvent);var MozChunkLoader=function(_CustEvent){_inherits(MozChunkLoader,_CustEvent);_createClass(MozChunkLoader,null,[{key:'isSupport',value:function isSupport(){try{var xhr=new XMLHttpRequest();xhr.open('GET','https://example.com',true);xhr.responseType='moz-chunked-arraybuffer';return xhr.responseType==='moz-chunked-arraybuffer';}catch(e){return false;}}}]);function MozChunkLoader(src,config){_classCallCheck(this,MozChunkLoader);var _this=_possibleConstructorReturn(this,(MozChunkLoader.__proto__||_Object$getPrototypeOf(MozChunkLoader)).call(this));_this.tag='mozChunkLoader';_this.xhr=null;_this.src=src;_this.config=config;_this.totalLength=null;_this.chunkSizeKB=393216;_this.range={};_this.bytesStart=0;return _this;}_createClass(MozChunkLoader,[{key:'open',value:function open(range){var xhr=this.xhr=new XMLHttpRequest();xhr.open('GET',this.src,true);xhr.responseType='moz-chunked-arraybuffer';xhr.onreadystatechange=this.onReadyStateChange.bind(this);xhr.onprogress=this.onProgress.bind(this);xhr.onload=this.onLoadEnd.bind(this);xhr.onerror=this.onXhrError.bind(this);if(this.config.type==='vod'){var r=range||{from:0,to:-1};this.range.from=r.from;this.range.to=r.to;var headers=handleRange(r).headers;for(var i in headers){xhr.setRequestHeader(i,headers[i]);}}xhr.send();}},{key:'abort',value:function abort(){this.xhr.onreadystatechange=null;this.xhr.onprogress=null;this.xhr.onload=null;this.xhr.onerror=null;this.xhr.abort();this.xhr=null;}},{key:'destroy',value:function destroy(){if(this.xhr){this.abort();this.xhr.onreadystatechange=null;this.xhr.onprogress=null;this.xhr.onload=null;this.xhr.onerror=null;this.xhr=null;}this.totalLength=null;this.bytesStart=null;this.range={};}},{key:'onReadyStateChange',value:function onReadyStateChange(e){var xhr=this.xhr;if(xhr.readyState===2){if(xhr.status<200&&xhr.status>299){var info={from:this.range.from,to:this.range.to,url:this.src,msg:'http Error: http code '+xhr.status};this.emit(this.tag,info);}}}},{key:'onProgress',value:function onProgress(e){if(!this.totalLength){this.totalLength=e.total;if(e.total!==null&&e.total!==0){this.totalLength=e.total;}}var chunk=e.target.response;this.arrivalDataCallback(chunk,this.bytesStart);this.bytesStart+=chunk.byteLength;}},{key:'onLoadEnd',value:function onLoadEnd(e){this.emit(this.tag,'video load end');}},{key:'onXhrError',value:function onXhrError(e){var info={from:this.range.from,to:this.range.to,url:this.src,msg:e.constructor.name+' '+e.type};this.emit(this.tag,info);}}]);return MozChunkLoader;}(CustEvent);var Ioloader=function(_CustEvent){_inherits(Ioloader,_CustEvent);function Ioloader(config){_classCallCheck(this,Ioloader);var _this=_possibleConstructorReturn(this,(Ioloader.__proto__||_Object$getPrototypeOf(Ioloader)).call(this));_this.loader=null;_this.config={};_Object$assign(_this.config,config);_this.selectLoader();_this.bufferSize=1024*1024*3;_this.cacheBuffer=new ArrayBuffer(_this.bufferSize);_this.cacheRemain=0;_this.stashByteStart=0;_this.enableStash=true;_this.stashSize=1024*384;_this.resumeFrom=0;_this.currentRange={};_this.totalReceive=0;_this.seekPonit=0;return _this;}_createClass(Ioloader,[{key:'selectLoader',value:function selectLoader(){var config=this.config;var url=this.config.src;if(FetchLoader.isSupport()){this.loader=new FetchLoader(url,config);}else if(MozChunkLoader.isSupport()){this.loader=new MozChunkLoader(url,config);}else if(RangeLoader.isSupport()){this.loader=new RangeLoader(url,config);}this.loader.arrivalDataCallback=this.onLoaderChunkArrival.bind(this);}},{key:'onLoaderChunkArrival',value:function onLoaderChunkArrival(chunk,byteStart,keyframePoint){if(keyframePoint){this.seekPonit=keyframePoint;}if(this.arrivalDataCallback){this.totalReceive+=chunk.byteLength;if(this.cacheRemain===0&&this.stashByteStart===0){this.stashByteStart=byteStart;}if(this.cacheRemain+chunk.byteLength<=this.stashSize){var stashArray=new Uint8Array(this.cacheBuffer,0,this.stashSize);stashArray.set(new Uint8Array(chunk),this.cacheRemain);this.cacheRemain+=chunk.byteLength;}else{var _stashArray=new Uint8Array(this.cacheBuffer,0,this.bufferSize);if(this.cacheRemain>0){var buffer=this.cacheBuffer.slice(0,this.cacheRemain);var consumed=0;if(this.seekPonit){consumed=this.arrivalDataCallback(buffer,this.stashByteStart,this.seekPonit);this.seekPonit=0;}else{consumed=this.arrivalDataCallback(buffer,this.stashByteStart);}if(consumed<buffer.byteLength){if(consumed>0){var remainArray=new Uint8Array(buffer,consumed);_stashArray.set(remainArray,0);this.cacheRemain=remainArray.byteLength;this.stashByteStart+=consumed;}}else{this.cacheRemain=0;this.stashByteStart+=consumed;}if(this.cacheRemain+chunk.byteLength>this.bufferSize){this.expandBuffer(this.cacheRemain+chunk.byteLength);_stashArray=new Uint8Array(this.cacheBuffer,0,this.bufferSize);}_stashArray.set(new Uint8Array(chunk),this.cacheRemain);this.cacheRemain+=chunk.byteLength;}else{var _consumed=0;if(this.seekPonit){_consumed=this.arrivalDataCallback(chunk,byteStart,this.seekPonit);this.seekPonit=0;}else{_consumed=this.arrivalDataCallback(chunk,byteStart);}if(_consumed<chunk.byteLength){var remain=chunk.byteLength-_consumed;if(remain>this.bufferSize){this.expandBuffer(remain);_stashArray=new Uint8Array(this.cacheBuffer,0,this.bufferSize);}_stashArray.set(new Uint8Array(chunk,_consumed),0);this.cacheRemain+=remain;this.stashByteStart=byteStart+_consumed;}}}}}},{key:'initCacheBuffer',value:function initCacheBuffer(){this.cacheBuffer=new ArrayBuffer(this.bufferSize);}},{key:'expandBuffer',value:function expandBuffer(expectedBytes){var bufferNewSize=this.bufferSize;if(bufferNewSize<expectedBytes){bufferNewSize=expectedBytes;}this.cacheBuffer=new ArrayBuffer(bufferNewSize);this.bufferSize=bufferNewSize;}},{key:'pause',value:function pause(){this.loader.pause();}},{key:'open',value:function open(StartBytes){if(StartBytes===undefined){StartBytes=0;}this.loader.open({from:StartBytes,to:-1});}},{key:'resume',value:function resume(){this.paused=false;var bytes=this.totalReceive;this.open(bytes);}},{key:'seek',value:function seek(bytes,dropCache,keyframePoint){this.loader.open({from:bytes,to:-1},keyframePoint);}},{key:'destroy',value:function destroy(){this.pause();this.cacheBuffer=null;}}]);return Ioloader;}(CustEvent);var FlvTag=function(){function FlvTag(){_classCallCheck(this,FlvTag);this.tagType=-1;this.dataSize=-1;this.Timestamp=-1;this.StreamID=-1;this.body=-1;this.time=-1;this.arr=[];}_createClass(FlvTag,[{key:'getTime',value:function getTime(){this.arr=[];for(var i=0;i<this.Timestamp.length;i++){this.arr.push(this.Timestamp[i].toString(16).length==1?'0'+this.Timestamp[i].toString(16):this.Timestamp[i].toString(16));}this.arr.pop();var time=this.arr.join('');this.time=parseInt(time,16);return parseInt(time,16);}}]);return FlvTag;}();function decodeUTF8$1(uint8array){var out=[];var input=uint8array;var i=0;var length=uint8array.length;while(i<length){if(input[i]<0x80){out.push(String.fromCharCode(input[i]));++i;continue;}else if(input[i]<0xC0){}else if(input[i]<0xE0){if(checkContinuation$1(input,i,1)){var ucs4=(input[i]&0x1F)<<6|input[i+1]&0x3F;if(ucs4>=0x80){out.push(String.fromCharCode(ucs4&0xFFFF));i+=2;continue;}}}else if(input[i]<0xF0){if(checkContinuation$1(input,i,2)){var _ucs=(input[i]&0xF)<<12|(input[i+1]&0x3F)<<6|input[i+2]&0x3F;if(_ucs>=0x800&&(_ucs&0xF800)!==0xD800){out.push(String.fromCharCode(_ucs&0xFFFF));i+=3;continue;}}}else if(input[i]<0xF8){if(checkContinuation$1(input,i,3)){var _ucs2=(input[i]&0x7)<<18|(input[i+1]&0x3F)<<12|(input[i+2]&0x3F)<<6|input[i+3]&0x3F;if(_ucs2>0x10000&&_ucs2<0x110000){_ucs2-=0x10000;out.push(String.fromCharCode(_ucs2>>>10|0xD800));out.push(String.fromCharCode(_ucs2&0x3FF|0xDC00));i+=4;continue;}}}out.push(String.fromCharCode(0xFFFD));++i;}return out.join('');}function checkContinuation$1(uint8array,start,checkLength){var array=uint8array;if(start+checkLength<array.length){while(checkLength--){if((array[++start]&0xC0)!==0x80)return false;}return true;}else{return false;}}var ExpGolomb=function(){function ExpGolomb(uint8array){_classCallCheck(this,ExpGolomb);this.TAG=this.constructor.name;this._buffer=uint8array;this._buffer_index=0;this._total_bytes=uint8array.byteLength;this._total_bits=uint8array.byteLength*8;this._current_word=0;this._current_word_bits_left=0;}_createClass(ExpGolomb,[{key:'destroy',value:function destroy(){this._buffer=null;}},{key:'_fillCurrentWord',value:function _fillCurrentWord(){var buffer_bytes_left=this._total_bytes-this._buffer_index;if(buffer_bytes_left<=0){throw new IllegalStateException('ExpGolomb: _fillCurrentWord() but no bytes available');}var bytes_read=Math.min(4,buffer_bytes_left);var word=new Uint8Array(4);word.set(this._buffer.subarray(this._buffer_index,this._buffer_index+bytes_read));this._current_word=new DataView(word.buffer).getUint32(0,false);this._buffer_index+=bytes_read;this._current_word_bits_left=bytes_read*8;}},{key:'readBits',value:function readBits(bits){if(bits>32){throw new InvalidArgumentException('ExpGolomb: readBits() bits exceeded max 32bits!');}if(bits<=this._current_word_bits_left){var _result=this._current_word>>>32-bits;this._current_word<<=bits;this._current_word_bits_left-=bits;return _result;}var result=this._current_word_bits_left?this._current_word:0;result=result>>>32-this._current_word_bits_left;var bits_need_left=bits-this._current_word_bits_left;this._fillCurrentWord();var bits_read_next=Math.min(bits_need_left,this._current_word_bits_left);var result2=this._current_word>>>32-bits_read_next;this._current_word<<=bits_read_next;this._current_word_bits_left-=bits_read_next;result=result<<bits_read_next|result2;return result;}},{key:'readBool',value:function readBool(){return this.readBits(1)===1;}},{key:'readByte',value:function readByte(){return this.readBits(8);}},{key:'_skipLeadingZero',value:function _skipLeadingZero(){var zero_count=void 0;for(zero_count=0;zero_count<this._current_word_bits_left;zero_count++){if((this._current_word&0x80000000>>>zero_count)!==0){this._current_word<<=zero_count;this._current_word_bits_left-=zero_count;return zero_count;}}this._fillCurrentWord();return zero_count+this._skipLeadingZero();}},{key:'readUEG',value:function readUEG(){var leading_zeros=this._skipLeadingZero();return this.readBits(leading_zeros+1)-1;}},{key:'readSEG',value:function readSEG(){var value=this.readUEG();if(value&0x01){return value+1>>>1;}else{return-1*(value>>>1);}}}]);return ExpGolomb;}();var SPSParser=function(){function SPSParser(){_classCallCheck(this,SPSParser);}_createClass(SPSParser,null,[{key:'_ebsp2rbsp',value:function _ebsp2rbsp(uint8array){var src=uint8array;var src_length=src.byteLength;var dst=new Uint8Array(src_length);var dst_idx=0;for(var i=0;i<src_length;i++){if(i>=2){if(src[i]===0x03&&src[i-1]===0x00&&src[i-2]===0x00){continue;}}dst[dst_idx]=src[i];dst_idx++;}return new Uint8Array(dst.buffer,0,dst_idx);}},{key:'parseSPS',value:function parseSPS(uint8array){var rbsp=SPSParser._ebsp2rbsp(uint8array);var gb=new ExpGolomb(rbsp);gb.readByte();var profile_idc=gb.readByte();gb.readByte();var level_idc=gb.readByte();gb.readUEG();var profile_string=SPSParser.getProfileString(profile_idc);var level_string=SPSParser.getLevelString(level_idc);var chroma_format_idc=1;var chroma_format=420;var chroma_format_table=[0,420,422,444];var bit_depth=8;if(profile_idc===100||profile_idc===110||profile_idc===122||profile_idc===244||profile_idc===44||profile_idc===83||profile_idc===86||profile_idc===118||profile_idc===128||profile_idc===138||profile_idc===144){chroma_format_idc=gb.readUEG();if(chroma_format_idc===3){gb.readBits(1);}if(chroma_format_idc<=3){chroma_format=chroma_format_table[chroma_format_idc];}bit_depth=gb.readUEG()+8;gb.readUEG();gb.readBits(1);if(gb.readBool()){var scaling_list_count=chroma_format_idc!==3?8:12;for(var i=0;i<scaling_list_count;i++){if(gb.readBool()){if(i<6){SPSParser._skipScalingList(gb,16);}else{SPSParser._skipScalingList(gb,64);}}}}}gb.readUEG();var pic_order_cnt_type=gb.readUEG();if(pic_order_cnt_type===0){gb.readUEG();}else if(pic_order_cnt_type===1){gb.readBits(1);gb.readSEG();gb.readSEG();var num_ref_frames_in_pic_order_cnt_cycle=gb.readUEG();for(var _i=0;_i<num_ref_frames_in_pic_order_cnt_cycle;_i++){gb.readSEG();}}gb.readUEG();gb.readBits(1);var pic_width_in_mbs_minus1=gb.readUEG();var pic_height_in_map_units_minus1=gb.readUEG();var frame_mbs_only_flag=gb.readBits(1);if(frame_mbs_only_flag===0){gb.readBits(1);}gb.readBits(1);var frame_crop_left_offset=0;var frame_crop_right_offset=0;var frame_crop_top_offset=0;var frame_crop_bottom_offset=0;var frame_cropping_flag=gb.readBool();if(frame_cropping_flag){frame_crop_left_offset=gb.readUEG();frame_crop_right_offset=gb.readUEG();frame_crop_top_offset=gb.readUEG();frame_crop_bottom_offset=gb.readUEG();}var sar_width=1,sar_height=1;var fps=0,fps_fixed=true,fps_num=0,fps_den=0;var vui_parameters_present_flag=gb.readBool();if(vui_parameters_present_flag){if(gb.readBool()){var aspect_ratio_idc=gb.readByte();var sar_w_table=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2];var sar_h_table=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];if(aspect_ratio_idc>0&&aspect_ratio_idc<16){sar_width=sar_w_table[aspect_ratio_idc-1];sar_height=sar_h_table[aspect_ratio_idc-1];}else if(aspect_ratio_idc===255){sar_width=gb.readByte()<<8|gb.readByte();sar_height=gb.readByte()<<8|gb.readByte();}}if(gb.readBool()){gb.readBool();}if(gb.readBool()){gb.readBits(4);if(gb.readBool()){gb.readBits(24);}}if(gb.readBool()){gb.readUEG();gb.readUEG();}if(gb.readBool()){var num_units_in_tick=gb.readBits(32);var time_scale=gb.readBits(32);fps_fixed=gb.readBool();fps_num=time_scale;fps_den=num_units_in_tick*2;fps=fps_num/fps_den;}}var sarScale=1;if(sar_width!==1||sar_height!==1){sarScale=sar_width/sar_height;}var crop_unit_x=0,crop_unit_y=0;if(chroma_format_idc===0){crop_unit_x=1;crop_unit_y=2-frame_mbs_only_flag;}else{var sub_wc=chroma_format_idc===3?1:2;var sub_hc=chroma_format_idc===1?2:1;crop_unit_x=sub_wc;crop_unit_y=sub_hc*(2-frame_mbs_only_flag);}var codec_width=(pic_width_in_mbs_minus1+1)*16;var codec_height=(2-frame_mbs_only_flag)*((pic_height_in_map_units_minus1+1)*16);codec_width-=(frame_crop_left_offset+frame_crop_right_offset)*crop_unit_x;codec_height-=(frame_crop_top_offset+frame_crop_bottom_offset)*crop_unit_y;var present_width=Math.ceil(codec_width*sarScale);gb.destroy();gb=null;return{profile_string:profile_string,level_string:level_string,bit_depth:bit_depth,chroma_format:chroma_format,chroma_format_string:SPSParser.getChromaFormatString(chroma_format),frame_rate:{fixed:fps_fixed,fps:fps,fps_den:fps_den,fps_num:fps_num},sar_ratio:{width:sar_width,height:sar_height},codec_size:{width:codec_width,height:codec_height},present_size:{width:present_width,height:codec_height}};}},{key:'_skipScalingList',value:function _skipScalingList(gb,count){var last_scale=8,next_scale=8;var delta_scale=0;for(var i=0;i<count;i++){if(next_scale!==0){delta_scale=gb.readSEG();next_scale=(last_scale+delta_scale+256)%256;}last_scale=next_scale===0?last_scale:next_scale;}}},{key:'getProfileString',value:function getProfileString(profile_idc){switch(profile_idc){case 66:return'Baseline';case 77:return'Main';case 88:return'Extended';case 100:return'High';case 110:return'High10';case 122:return'High422';case 244:return'High444';default:return'Unknown';}}},{key:'getLevelString',value:function getLevelString(level_idc){return(level_idc/10).toFixed(1);}},{key:'getChromaFormatString',value:function getChromaFormatString(chroma){switch(chroma){case 420:return'4:2:0';case 422:return'4:2:2';case 444:return'4:4:4';default:return'Unknown';}}}]);return SPSParser;}();var le=function(){var buf=new ArrayBuffer(2);new DataView(buf).setInt16(0,256,true);return new Int16Array(buf)[0]===256;}();var flvDemux=function(){function flvDemux(){_classCallCheck(this,flvDemux);}_createClass(flvDemux,null,[{key:'parseObject',value:function parseObject(arrayBuffer,dataOffset,dataSize){var name=flvDemux.parseString(arrayBuffer,dataOffset,dataSize);var value=flvDemux.parseScript(arrayBuffer,dataOffset+name.size);var isObjectEnd=value.objectEnd;return{data:{name:name.data,value:value.data},size:value.size,objectEnd:isObjectEnd};}},{key:'parseVariable',value:function parseVariable(arrayBuffer,dataOffset,dataSize){return flvDemux.parseObject(arrayBuffer,dataOffset,dataSize);}},{key:'parseLongString',value:function parseLongString(arrayBuffer,dataOffset,dataSize){var v=new DataView(arrayBuffer,dataOffset);var length=v.getUint32(0,!le);var str=void 0;if(length>0){str=decodeUTF8$1(new Uint8Array(arrayBuffer,dataOffset+4,length));}else{str='';}return{data:str,size:4+length};}},{key:'parseDate',value:function parseDate(arrayBuffer,dataOffset,dataSize){var v=new DataView(arrayBuffer,dataOffset);var timestamp=v.getFloat64(0,!le);var localTimeOffset=v.getInt16(8,!le);timestamp+=localTimeOffset*60*1000;return{data:new Date(timestamp),size:8+2};}},{key:'parseString',value:function parseString(arrayBuffer,dataOffset,dataSize){var v=new DataView(arrayBuffer,dataOffset);var length=v.getUint16(0,!le);var str=void 0;if(length>0){str=decodeUTF8$1(new Uint8Array(arrayBuffer,dataOffset+2,length));}else{str='';}return{data:str,size:2+length};}},{key:'parseMetadata',value:function parseMetadata(arr){var name=flvDemux.parseScript(arr,0);var value=flvDemux.parseScript(arr,name.size,arr.length-name.size);var data={};data[name.data]=value.data;return data;}},{key:'parseScript',value:function parseScript(arr,offset,dataSize){var dataOffset=offset;var object={};var uint8=new Uint8Array(arr);var buffer=uint8.buffer;var dv=new DataView(buffer,0,dataSize);var value=null;var objectEnd=false;var type=dv.getUint8(dataOffset);dataOffset+=1;switch(type){case 0:value=dv.getFloat64(dataOffset,!le);dataOffset+=8;break;case 1:{var b=dv.getUint8(dataOffset);value=!!b;dataOffset+=1;break;}case 2:{var amfstr=flvDemux.parseString(buffer,dataOffset);value=amfstr.data;dataOffset+=amfstr.size;break;}case 3:{value={};var terminal=0;if((dv.getUint32(dataSize-4,!le)&0x00FFFFFF)===9){terminal=3;}while(dataOffset<dataSize-4){var amfobj=flvDemux.parseObject(buffer,dataOffset,dataSize-offset-terminal);if(amfobj.objectEnd){break;}value[amfobj.data.name]=amfobj.data.value;dataOffset=amfobj.size;}if(dataOffset<=dataSize-3){var marker=v.getUint32(dataOffset-1,!le)&0x00FFFFFF;if(marker===9){dataOffset+=3;}}break;}case 8:{value={};dataOffset+=4;var _terminal=0;if((dv.getUint32(dataSize-4,!le)&0x00FFFFFF)===9){_terminal=3;}while(dataOffset<dataSize-8){var amfvar=flvDemux.parseVariable(buffer,dataOffset);if(amfvar.objectEnd){break;}value[amfvar.data.name]=amfvar.data.value;dataOffset=amfvar.size;}if(dataOffset<=dataSize-3){var _marker=dv.getUint32(dataOffset-1,!le)&0x00FFFFFF;if(_marker===9){dataOffset+=3;}}break;}case 9:value=undefined;dataOffset=1;objectEnd=true;break;case 10:{value=[];var strictArrayLength=dv.getUint32(dataOffset,!le);dataOffset+=4;for(var i=0;i<strictArrayLength;i++){var val=flvDemux.parseScript(buffer,dataOffset);value.push(val.data);dataOffset=val.size;}break;}case 11:{var date=flvDemux.parseDate(buffer,dataOffset+1,dataSize-1);value=date.data;dataOffset+=date.size;break;}case 12:{var amfLongStr=flvDemux.parseString(buffer,dataOffset+1,dataSize-1);value=amfLongStr.data;dataOffset+=amfLongStr.size;break;}default:dataOffset=dataSize;console.log('AMF','Unsupported AMF value type '+type);}return{data:value,size:dataOffset};}}]);return flvDemux;}();var MediaInfo=function(){function MediaInfo(){_classCallCheck(this,MediaInfo);this.mimeType=null;this.duration=null;this.hasAudio=null;this.hasVideo=null;this.audioCodec=null;this.videoCodec=null;this.audioDataRate=null;this.videoDataRate=null;this.audioSampleRate=null;this.audioChannelCount=null;this.width=null;this.height=null;this.fps=null;this.profile=null;this.level=null;this.chromaFormat=null;this.sarNum=null;this.sarDen=null;this.metadata=null;this.segments=null;this.segmentCount=null;this.hasKeyframesIndex=null;this.keyframesIndex=null;}_createClass(MediaInfo,[{key:"isComplete",value:function isComplete(){var audioInfoComplete=this.hasAudio===false||this.hasAudio===true&&this.audioCodec!=null&&this.audioSampleRate!=null&&this.audioChannelCount!=null;var videoInfoComplete=this.hasVideo===false||this.hasVideo===true&&this.videoCodec!=null&&this.width!=null&&this.height!=null&&this.fps!=null&&this.profile!=null&&this.level!=null&&this.chromaFormat!=null&&this.sarNum!=null&&this.sarDen!=null;return this.mimeType!=null&&this.duration!=null&&this.metadata!=null&&this.hasKeyframesIndex!=null&&audioInfoComplete&&videoInfoComplete;}},{key:"isSeekable",value:function isSeekable(){return this.hasKeyframesIndex===true;}}]);return MediaInfo;}();var Error$1=function Error(type){_classCallCheck(this,Error);this.type=type;};var tagDemux=function(){function tagDemux(){_classCallCheck(this,tagDemux);this.TAG=this.constructor.name;this._config={};this._onError=null;this._onMediaInfo=null;this._onTrackMetadata=null;this._onDataAvailable=null;this._dataOffset=0;this._firstParse=true;this._dispatch=false;this._hasAudio=false;this._hasVideo=false;this._audioInitialMetadataDispatched=false;this._videoInitialMetadataDispatched=false;this._mediaInfo=new MediaInfo();this._mediaInfo.hasAudio=this._hasAudio;this._mediaInfo.hasVideo=this._hasVideo;this._metadata=null;this._audioMetadata=null;this._videoMetadata=null;this._naluLengthSize=4;this._timestampBase=0;this._timescale=1000;this._duration=0;this._durationOverrided=false;this._referenceFrameRate={fixed:true,fps:23.976,fps_num:23976,fps_den:1000};this._videoTrack={type:'video',id:1,sequenceNumber:0,addcoefficient:2,samples:[],length:0};this._audioTrack={type:'audio',id:2,sequenceNumber:1,addcoefficient:2,samples:[],length:0};this._littleEndian=function(){var buf=new ArrayBuffer(2);new DataView(buf).setInt16(0,256,true);return new Int16Array(buf)[0]===256;}();}_createClass(tagDemux,[{key:'onMediaInfo',value:function onMediaInfo(callback){this._onMediaInfo=callback;}},{key:'parseMetadata',value:function parseMetadata(arr){var data=flvDemux.parseMetadata(arr);this._parseScriptData(data);}},{key:'_parseScriptData',value:function _parseScriptData(obj){var scriptData=obj;if(scriptData.hasOwnProperty('onMetaData')){if(this._metadata){console.log(this.TAG,'Found another onMetaData tag!');}this._metadata=scriptData;var onMetaData=this._metadata.onMetaData;if(typeof onMetaData.hasAudio==='boolean'){this._hasAudio=onMetaData.hasAudio;this._mediaInfo.hasAudio=this._hasAudio;}if(typeof onMetaData.hasVideo==='boolean'){this._hasVideo=onMetaData.hasVideo;this._mediaInfo.hasVideo=this._hasVideo;}if(typeof onMetaData.audiodatarate==='number'){this._mediaInfo.audioDataRate=onMetaData.audiodatarate;}if(typeof onMetaData.videodatarate==='number'){this._mediaInfo.videoDataRate=onMetaData.videodatarate;}if(typeof onMetaData.width==='number'){this._mediaInfo.width=onMetaData.width;}if(typeof onMetaData.height==='number'){this._mediaInfo.height=onMetaData.height;}if(typeof onMetaData.duration==='number'){if(!this._durationOverrided){var duration=Math.floor(onMetaData.duration*this._timescale);this._duration=duration;this._mediaInfo.duration=duration;}}else{this._mediaInfo.duration=0;}if(typeof onMetaData.framerate==='number'){var fps_num=Math.floor(onMetaData.framerate*1000);if(fps_num>0){var fps=fps_num/1000;this._referenceFrameRate.fixed=true;this._referenceFrameRate.fps=fps;this._referenceFrameRate.fps_num=fps_num;this._referenceFrameRate.fps_den=1000;this._mediaInfo.fps=fps;}}if(_typeof(onMetaData.keyframes)==='object'){this._mediaInfo.hasKeyframesIndex=true;var keyframes=onMetaData.keyframes;keyframes.times=onMetaData.times;keyframes.filepositions=onMetaData.filepositions;this._mediaInfo.keyframesIndex=this._parseKeyframesIndex(keyframes);onMetaData.keyframes=null;}else{this._mediaInfo.hasKeyframesIndex=false;}this._dispatch=false;this._mediaInfo.metadata=onMetaData;console.log(this.TAG,'Parsed onMetaData');return this._mediaInfo;}}},{key:'_parseKeyframesIndex',value:function _parseKeyframesIndex(keyframes){var times=[];var filepositions=[];for(var i=1;i<keyframes.times.length;i++){var time=this._timestampBase+Math.floor(keyframes.times[i]*1000);times.push(time);filepositions.push(keyframes.filepositions[i]);}return{times:times,filepositions:filepositions};}},{key:'moofTag',value:function moofTag(tags){for(var i=0;i<tags.length;i++){this._dispatch=true;this.parseChunks(tags[i]);}if(this._isInitialMetadataDispatched()){if(this._dispatch&&(this._audioTrack.length||this._videoTrack.length)){this._onDataAvailable(this._audioTrack,this._videoTrack);}}}},{key:'parseChunks',value:function parseChunks(flvtag){switch(flvtag.tagType){case 8:this._parseAudioData(flvtag.body.buffer,0,flvtag.body.length,flvtag.getTime());break;case 9:this._parseVideoData(flvtag.body.buffer,0,flvtag.body.length,flvtag.getTime(),0);break;case 18:this.parseMetadata(flvtag.body);break;}}},{key:'_parseVideoData',value:function _parseVideoData(arrayBuffer,dataOffset,dataSize,tagTimestamp,tagPosition){if(tagTimestamp==this._timestampBase&&this._timestampBase!=0){throw new Error$1(tagTimestamp+this._timestampBase+'0');}if(dataSize<=1){console.log(this.TAG,'Flv: Invalid video packet, missing VideoData payload!');return;}var spec=new Uint8Array(arrayBuffer,dataOffset,dataSize)[0];var frameType=(spec&240)>>>4;var codecId=spec&15;if(codecId!==7){throw new Error$1('Flv: Unsupported codec in video frame: '+codecId);}this._parseAVCVideoPacket(arrayBuffer,dataOffset+1,dataSize-1,tagTimestamp,tagPosition,frameType);}},{key:'_parseAVCVideoPacket',value:function _parseAVCVideoPacket(arrayBuffer,dataOffset,dataSize,tagTimestamp,tagPosition,frameType){if(dataSize<4){console.log(this.TAG,'Flv: Invalid AVC packet, missing AVCPacketType or/and CompositionTime');return;}var le=this._littleEndian;var v=new DataView(arrayBuffer,dataOffset,dataSize);var packetType=v.getUint8(0);var cts=v.getUint32(0,!le)&0x00FFFFFF;if(packetType===0){this._parseAVCDecoderConfigurationRecord(arrayBuffer,dataOffset+4,dataSize-4);}else if(packetType===1){this._parseAVCVideoData(arrayBuffer,dataOffset+4,dataSize-4,tagTimestamp,tagPosition,frameType,cts);}else if(packetType===2){}else{throw new Error$1('Flv: Invalid video packet type '+packetType);}}},{key:'_parseAVCDecoderConfigurationRecord',value:function _parseAVCDecoderConfigurationRecord(arrayBuffer,dataOffset,dataSize){if(dataSize<7){console.log(this.TAG,'Flv: Invalid AVCDecoderConfigurationRecord, lack of data!');return;}var meta=this._videoMetadata;var track=this._videoTrack;var le=this._littleEndian;var v=new DataView(arrayBuffer,dataOffset,dataSize);if(!meta){meta=this._videoMetadata={};meta.type='video';meta.id=track.id;meta.timescale=this._timescale;meta.duration=this._duration;}else{if(typeof meta.avcc!=='undefined'){console.log(this.TAG,'Found another AVCDecoderConfigurationRecord!');}}var version=v.getUint8(0);var avcProfile=v.getUint8(1);var profileCompatibility=v.getUint8(2);var avcLevel=v.getUint8(3);if(version!==1||avcProfile===0){this._onError(DemuxErrors.FORMAT_ERROR,'Flv: Invalid AVCDecoderConfigurationRecord');return;}this._naluLengthSize=(v.getUint8(4)&3)+1;if(this._naluLengthSize!==3&&this._naluLengthSize!==4){this._onError(DemuxErrors.FORMAT_ERROR,'Flv: Strange NaluLengthSizeMinusOne: '+(this._naluLengthSize-1));return;}var spsCount=v.getUint8(5)&31;if(spsCount===0||spsCount>1){this._onError(DemuxErrors.FORMAT_ERROR,'Flv: Invalid H264 SPS count: '+spsCount);return;}var offset=6;for(var i=0;i<spsCount;i++){var len=v.getUint16(offset,!le);offset+=2;if(len===0){continue;}var sps=new Uint8Array(arrayBuffer,dataOffset+offset,len);offset+=len;var config=SPSParser.parseSPS(sps);meta.codecWidth=config.codec_size.width;meta.codecHeight=config.codec_size.height;meta.presentWidth=config.present_size.width;meta.presentHeight=config.present_size.height;meta.profile=config.profile_string;meta.level=config.level_string;meta.bitDepth=config.bit_depth;meta.chromaFormat=config.chroma_format;meta.sarRatio=config.sar_ratio;meta.frameRate=config.frame_rate;if(config.frame_rate.fixed===false||config.frame_rate.fps_num===0||config.frame_rate.fps_den===0){meta.frameRate=this._referenceFrameRate;}var fps_den=meta.frameRate.fps_den;var fps_num=meta.frameRate.fps_num;meta.refSampleDuration=Math.floor(meta.timescale*(fps_den/fps_num));var codecArray=sps.subarray(1,4);var codecString='avc1.';for(var j=0;j<3;j++){var h=codecArray[j].toString(16);if(h.length<2){h='0'+h;}codecString+=h;}meta.codec=codecString;var mi=this._mediaInfo;mi.width=meta.codecWidth;mi.height=meta.codecHeight;mi.fps=meta.frameRate.fps;mi.profile=meta.profile;mi.level=meta.level;mi.chromaFormat=config.chroma_format_string;mi.sarNum=meta.sarRatio.width;mi.sarDen=meta.sarRatio.height;mi.videoCodec=codecString;if(mi.hasAudio){if(mi.audioCodec!=null){mi.mimeType='video/x-flv; codecs="'+mi.videoCodec+','+mi.audioCodec+'"';}}else{mi.mimeType='video/x-flv; codecs="'+mi.videoCodec+'"';}if(mi.isComplete()){this._onMediaInfo(mi);}}var ppsCount=v.getUint8(offset);if(ppsCount===0||ppsCount>1){this._onError(DemuxErrors.FORMAT_ERROR,'Flv: Invalid H264 PPS count: '+ppsCount);return;}offset++;for(var _i=0;_i<ppsCount;_i++){var _len=v.getUint16(offset,!le);offset+=2;if(_len===0){continue;}offset+=_len;}meta.avcc=new Uint8Array(dataSize);meta.avcc.set(new Uint8Array(arrayBuffer,dataOffset,dataSize),0);console.log(this.TAG,'Parsed AVCDecoderConfigurationRecord');if(this._isInitialMetadataDispatched()){if(this._dispatch&&(this._audioTrack.length||this._videoTrack.length)){this._onDataAvailable(this._audioTrack,this._videoTrack);}}else{this._videoInitialMetadataDispatched=true;}this._dispatch=false;this._onTrackMetadata('video',meta);}},{key:'timestampBase',value:function timestampBase(i){this._timestampBase=i;}},{key:'_parseAVCVideoData',value:function _parseAVCVideoData(arrayBuffer,dataOffset,dataSize,tagTimestamp,tagPosition,frameType,cts){var le=this._littleEndian;var v=new DataView(arrayBuffer,dataOffset,dataSize);var units=[],length=0;var offset=0;var lengthSize=this._naluLengthSize;var dts=this._timestampBase+tagTimestamp;var keyframe=frameType===1;while(offset<dataSize){if(offset+4>=dataSize){console.log(this.TAG,'Malformed Nalu near timestamp '+dts+', offset = '+offset+', dataSize = '+dataSize);break;}var naluSize=v.getUint32(offset,!le);if(lengthSize===3){naluSize>>>=8;}if(naluSize>dataSize-lengthSize){console.log(this.TAG,'Malformed Nalus near timestamp '+dts+', NaluSize > DataSize!');return;}var unitType=v.getUint8(offset+lengthSize)&0x1F;if(unitType===5){keyframe=true;}var data=new Uint8Array(arrayBuffer,dataOffset+offset,lengthSize+naluSize);var unit={type:unitType,data:data};units.push(unit);length+=data.byteLength;offset+=lengthSize+naluSize;}if(units.length){var track=this._videoTrack;var avcSample={units:units,length:length,isKeyframe:keyframe,dts:dts,cts:cts,pts:dts+cts};if(keyframe){avcSample.fileposition=tagPosition;}track.samples.push(avcSample);track.length+=length;}}},{key:'_parseAudioData',value:function _parseAudioData(arrayBuffer,dataOffset,dataSize,tagTimestamp){if(tagTimestamp==this._timestampBase&&this._timestampBase!=0){console.log(tagTimestamp,this._timestampBase,'0');}if(dataSize<=1){console.log(this.TAG,'Flv: Invalid audio packet, missing SoundData payload!');return;}var meta=this._audioMetadata;var track=this._audioTrack;if(!meta||!meta.codec){meta=this._audioMetadata={};meta.type='audio';meta.id=track.id;meta.timescale=this._timescale;meta.duration=this._duration;var le=this._littleEndian;var v=new DataView(arrayBuffer,dataOffset,dataSize);var soundSpec=v.getUint8(0);var soundFormat=soundSpec>>>4;if(soundFormat!==10){this._onError(DemuxErrors.CODEC_UNSUPPORTED,'Flv: Unsupported audio codec idx: '+soundFormat);return;}var soundRate=0;var soundRateIndex=(soundSpec&12)>>>2;var soundRateTable=[5500,11025,22050,44100,48000];if(soundRateIndex<soundRateTable.length){soundRate=soundRateTable[soundRateIndex];}else{this._onError(DemuxErrors.FORMAT_ERROR,'Flv: Invalid audio sample rate idx: '+soundRateIndex);return;}var soundSize=(soundSpec&2)>>>1;var soundType=soundSpec&1;meta.audioSampleRate=soundRate;meta.channelCount=soundType===0?1:2;meta.refSampleDuration=Math.floor(1024/meta.audioSampleRate*meta.timescale);meta.codec='mp4a.40.5';}var aacData=this._parseAACAudioData(arrayBuffer,dataOffset+1,dataSize-1);if(aacData==undefined){return;}if(aacData.packetType===0){if(meta.config){console.log(this.TAG,'Found another AudioSpecificConfig!');}var misc=aacData.data;meta.audioSampleRate=misc.samplingRate;meta.channelCount=misc.channelCount;meta.codec=misc.codec;meta.config=misc.config;meta.refSampleDuration=Math.floor(1024/meta.audioSampleRate*meta.timescale);console.log(this.TAG,'Parsed AudioSpecificConfig');if(this._isInitialMetadataDispatched()){if(this._dispatch&&(this._audioTrack.length||this._videoTrack.length)){this._onDataAvailable(this._audioTrack,this._videoTrack);}}else{this._audioInitialMetadataDispatched=true;}this._dispatch=false;this._onTrackMetadata('audio',meta);var mi=this._mediaInfo;mi.audioCodec='mp4a.40.'+misc.originalAudioObjectType;mi.audioSampleRate=meta.audioSampleRate;mi.audioChannelCount=meta.channelCount;if(mi.hasVideo){if(mi.videoCodec!=null){mi.mimeType='video/x-flv; codecs="'+mi.videoCodec+','+mi.audioCodec+'"';}}else{mi.mimeType='video/x-flv; codecs="'+mi.audioCodec+'"';}if(mi.isComplete()){this._onMediaInfo(mi);}return;}else if(aacData.packetType===1){var dts=this._timestampBase+tagTimestamp;var aacSample={unit:aacData.data,dts:dts,pts:dts};track.samples.push(aacSample);track.length+=aacData.data.length;}else{console.log(this.TAG,'Flv: Unsupported AAC data type '+aacData.packetType);}}},{key:'_parseAACAudioData',value:function _parseAACAudioData(arrayBuffer,dataOffset,dataSize){if(dataSize<=1){console.log(this.TAG,'Flv: Invalid AAC packet, missing AACPacketType or/and Data!');return;}var result={};var array=new Uint8Array(arrayBuffer,dataOffset,dataSize);result.packetType=array[0];if(array[0]===0){result.data=this._parseAACAudioSpecificConfig(arrayBuffer,dataOffset+1,dataSize-1);}else{result.data=array.subarray(1);}return result;}},{key:'_parseAACAudioSpecificConfig',value:function _parseAACAudioSpecificConfig(arrayBuffer,dataOffset,dataSize){var array=new Uint8Array(arrayBuffer,dataOffset,dataSize);var config=null;var mpegSamplingRates=[96000,88200,64000,48000,44100,32000,24000,22050,16000,12000,11025,8000,7350];var audioObjectType=0;var originalAudioObjectType=0;var audioExtensionObjectType=null;var samplingIndex=0;var extensionSamplingIndex=null;audioObjectType=originalAudioObjectType=array[0]>>>3;samplingIndex=(array[0]&0x07)<<1|array[1]>>>7;if(samplingIndex<0||samplingIndex>=mpegSamplingRates.length){this._onError(DemuxErrors.FORMAT_ERROR,'Flv: AAC invalid sampling frequency index!');return;}var samplingFrequence=mpegSamplingRates[samplingIndex];var channelConfig=(array[1]&0x78)>>>3;if(channelConfig<0||channelConfig>=8){this._onError(DemuxErrors.FORMAT_ERROR,'Flv: AAC invalid channel configuration');return;}if(audioObjectType===5){extensionSamplingIndex=(array[1]&0x07)<<1|array[2]>>>7;audioExtensionObjectType=(array[2]&0x7C)>>>2;}var userAgent=self.navigator.userAgent.toLowerCase();if(userAgent.indexOf('firefox')!==-1){if(samplingIndex>=6){audioObjectType=5;config=new Array(4);extensionSamplingIndex=samplingIndex-3;}else{audioObjectType=2;config=new Array(2);extensionSamplingIndex=samplingIndex;}}else if(userAgent.indexOf('android')!==-1){audioObjectType=2;config=new Array(2);extensionSamplingIndex=samplingIndex;}else{audioObjectType=5;extensionSamplingIndex=samplingIndex;config=new Array(4);if(samplingIndex>=6){extensionSamplingIndex=samplingIndex-3;}else if(channelConfig===1){audioObjectType=2;config=new Array(2);extensionSamplingIndex=samplingIndex;}}config[0]=audioObjectType<<3;config[0]|=(samplingIndex&0x0F)>>>1;config[1]=(samplingIndex&0x0F)<<7;config[1]|=(channelConfig&0x0F)<<3;if(audioObjectType===5){config[1]|=(extensionSamplingIndex&0x0F)>>>1;config[2]=(extensionSamplingIndex&0x01)<<7;config[2]|=2<<2;config[3]=0;}return{config:config,samplingRate:samplingFrequence,channelCount:channelConfig,codec:'mp4a.40.'+audioObjectType,originalAudioObjectType:originalAudioObjectType};}},{key:'_isInitialMetadataDispatched',value:function _isInitialMetadataDispatched(){if(this._hasAudio&&this._hasVideo){return this._audioInitialMetadataDispatched&&this._videoInitialMetadataDispatched;}if(this._hasAudio&&!this._hasVideo){return this._audioInitialMetadataDispatched;}if(!this._hasAudio&&this._hasVideo){return this._videoInitialMetadataDispatched;}}}]);return tagDemux;}();var tagdemux=new tagDemux();var FlvParse=function(){function FlvParse(){_classCallCheck(this,FlvParse);this.tempUint8=new Uint8Array();this.arrTag=[];this.index=0;this.tempArr=[];this.stop=false;this.offset=0;this.frist=true;this._hasAudio=false;this._hasVideo=false;}_createClass(FlvParse,[{key:'setFlv',value:function setFlv(uint8){this.stop=false;this.arrTag=[];this.index=0;this.tempUint8=uint8;if(this.tempUint8.length>13&&this.tempUint8[0]==70&&this.tempUint8[1]==76&&this.tempUint8[2]==86){this.probe(this.tempUint8.buffer);this.read(9);this.read(4);this.parse();this.frist=false;return this.offset;}else if(!this.frist){return this.parse();}else{return this.offset;}}},{key:'probe',value:function probe(buffer){var data=new Uint8Array(buffer);var mismatch={match:false};if(data[0]!==0x46||data[1]!==0x4C||data[2]!==0x56||data[3]!==0x01){return mismatch;}var hasAudio=(data[4]&4)>>>2!==0;var hasVideo=(data[4]&1)!==0;if(!hasAudio&&!hasVideo){return mismatch;}this._hasAudio=tagdemux._hasAudio=hasAudio;this._hasVideo=tagdemux._hasVideo=hasVideo;return{match:true,hasAudioTrack:hasAudio,hasVideoTrack:hasVideo};}},{key:'parse',value:function parse(){while(this.index<this.tempUint8.length&&!this.stop){this.offset=this.index;var t=new FlvTag();if(this.tempUint8.length-this.index>=11){t.tagType=this.read(1)[0];t.dataSize=this.read(3);t.Timestamp=this.read(4);t.StreamID=this.read(3);}else{this.stop=true;continue;}if(t.tagType==18||t.tagType==8||t.tagType==9){}else{throw new Error$1('wrong tagType'+t.tagType);}if(this.tempUint8.length-this.index>=this.getBodySum(t.dataSize)+4){t.body=this.read(this.getBodySum(t.dataSize));if(t.tagType==9&&this._hasVideo){this.arrTag.push(t);}if(t.tagType==8&&this._hasAudio){this.arrTag.push(t);}if(t.tagType==18){this.arrTag.push(t);}this.read(4);}else{this.stop=true;continue;}this.offset=this.index;}return this.offset;}},{key:'read',value:function read(length){var u8a=this.tempUint8.slice(this.index,this.index+length);this.index+=length;return u8a;}},{key:'getBodySum',value:function getBodySum(arr){var _str='';_str+=arr[0].toString(16).length==1?'0'+arr[0].toString(16):arr[0].toString(16);_str+=arr[1].toString(16).length==1?'0'+arr[1].toString(16):arr[1].toString(16);_str+=arr[2].toString(16).length==1?'0'+arr[2].toString(16):arr[2].toString(16);return parseInt(_str,16);}}]);return FlvParse;}();var flvparse=new FlvParse();var MP4=function(){function MP4(){_classCallCheck(this,MP4);}_createClass(MP4,null,[{key:'init',value:function init(){MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};for(var name in MP4.types){if(MP4.types.hasOwnProperty(name)){MP4.types[name]=[name.charCodeAt(0),name.charCodeAt(1),name.charCodeAt(2),name.charCodeAt(3)];}}var constants=MP4.constants={};constants.FTYP=new Uint8Array([0x69,0x73,0x6F,0x6D,0x0,0x0,0x0,0x1,0x69,0x73,0x6F,0x6D,0x61,0x76,0x63,0x31]);constants.STSD_PREFIX=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01]);constants.STTS=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);constants.STSC=constants.STCO=constants.STTS;constants.STSZ=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);constants.HDLR_VIDEO=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x76,0x69,0x64,0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x56,0x69,0x64,0x65,0x6F,0x48,0x61,0x6E,0x64,0x6C,0x65,0x72,0x00]);constants.HDLR_AUDIO=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x73,0x6F,0x75,0x6E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x53,0x6F,0x75,0x6E,0x64,0x48,0x61,0x6E,0x64,0x6C,0x65,0x72,0x00]);constants.DREF=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0C,0x75,0x72,0x6C,0x20,0x00,0x00,0x00,0x01]);constants.SMHD=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);constants.VMHD=new Uint8Array([0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);}},{key:'box',value:function box(type){var size=8;var result=null;var datas=Array.prototype.slice.call(arguments,1);var arrayCount=datas.length;for(var i=0;i<arrayCount;i++){size+=datas[i].byteLength;}result=new Uint8Array(size);result[0]=size>>>24&0xFF;result[1]=size>>>16&0xFF;result[2]=size>>>8&0xFF;result[3]=size&0xFF;result.set(type,4);var offset=8;for(var _i=0;_i<arrayCount;_i++){result.set(datas[_i],offset);offset+=datas[_i].byteLength;}return result;}},{key:'generateInitSegment',value:function generateInitSegment(meta){if(meta.constructor!=Array){meta=[meta];}var ftyp=MP4.box(MP4.types.ftyp,MP4.constants.FTYP);var moov=MP4.moov(meta);var result=new Uint8Array(ftyp.byteLength+moov.byteLength);result.set(ftyp,0);result.set(moov,ftyp.byteLength);return result;}},{key:'moov',value:function moov(meta){var mvhd=MP4.mvhd(meta[0].timescale,meta[0].duration);var vtrak=MP4.trak(meta[0]);var atrak=void 0;if(meta.length>1){atrak=MP4.trak(meta[1]);}var mvex=MP4.mvex(meta);if(meta.length>1){return MP4.box(MP4.types.moov,mvhd,vtrak,atrak,mvex);}else{return MP4.box(MP4.types.moov,mvhd,vtrak,mvex);}}},{key:'mvhd',value:function mvhd(timescale,duration){return MP4.box(MP4.types.mvhd,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,timescale>>>24&0xFF,timescale>>>16&0xFF,timescale>>>8&0xFF,timescale&0xFF,duration>>>24&0xFF,duration>>>16&0xFF,duration>>>8&0xFF,duration&0xFF,0x00,0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF]));}},{key:'trak',value:function trak(meta){return MP4.box(MP4.types.trak,MP4.tkhd(meta),MP4.mdia(meta));}},{key:'tkhd',value:function tkhd(meta){var trackId=meta.id,duration=meta.duration;var width=meta.presentWidth,height=meta.presentHeight;return MP4.box(MP4.types.tkhd,new Uint8Array([0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,trackId>>>24&0xFF,trackId>>>16&0xFF,trackId>>>8&0xFF,trackId&0xFF,0x00,0x00,0x00,0x00,duration>>>24&0xFF,duration>>>16&0xFF,duration>>>8&0xFF,duration&0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,width>>>8&0xFF,width&0xFF,0x00,0x00,height>>>8&0xFF,height&0xFF,0x00,0x00]));}},{key:'mdia',value:function mdia(meta){return MP4.box(MP4.types.mdia,MP4.mdhd(meta),MP4.hdlr(meta),MP4.minf(meta));}},{key:'mdhd',value:function mdhd(meta){var timescale=meta.timescale;var duration=meta.duration;return MP4.box(MP4.types.mdhd,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,timescale>>>24&0xFF,timescale>>>16&0xFF,timescale>>>8&0xFF,timescale&0xFF,duration>>>24&0xFF,duration>>>16&0xFF,duration>>>8&0xFF,duration&0xFF,0x55,0xC4,0x00,0x00]));}},{key:'hdlr',value:function hdlr(meta){var data=null;if(meta.type==='audio'){data=MP4.constants.HDLR_AUDIO;}else{data=MP4.constants.HDLR_VIDEO;}return MP4.box(MP4.types.hdlr,data);}},{key:'minf',value:function minf(meta){var xmhd=null;if(meta.type==='audio'){xmhd=MP4.box(MP4.types.smhd,MP4.constants.SMHD);}else{xmhd=MP4.box(MP4.types.vmhd,MP4.constants.VMHD);}return MP4.box(MP4.types.minf,xmhd,MP4.dinf(),MP4.stbl(meta));}},{key:'dinf',value:function dinf(){var result=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,MP4.constants.DREF));return result;}},{key:'stbl',value:function stbl(meta){var result=MP4.box(MP4.types.stbl,MP4.stsd(meta),MP4.box(MP4.types.stts,MP4.constants.STTS),MP4.box(MP4.types.stsc,MP4.constants.STSC),MP4.box(MP4.types.stsz,MP4.constants.STSZ),MP4.box(MP4.types.stco,MP4.constants.STCO));return result;}},{key:'stsd',value:function stsd(meta){if(meta.type==='audio'){return MP4.box(MP4.types.stsd,MP4.constants.STSD_PREFIX,MP4.mp4a(meta));}else{return MP4.box(MP4.types.stsd,MP4.constants.STSD_PREFIX,MP4.avc1(meta));}}},{key:'mp4a',value:function mp4a(meta){var channelCount=meta.channelCount;var sampleRate=meta.audioSampleRate;var data=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,channelCount,0x00,0x10,0x00,0x00,0x00,0x00,sampleRate>>>8&0xFF,sampleRate&0xFF,0x00,0x00]);return MP4.box(MP4.types.mp4a,data,MP4.esds(meta));}},{key:'esds',value:function esds(meta){var config=meta.config;var configSize=config.length;var data=new Uint8Array([0x00,0x00,0x00,0x00,0x03,0x17+configSize,0x00,0x01,0x00,0x04,0x0F+configSize,0x40,0x15,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05].concat([configSize]).concat(config).concat([0x06,0x01,0x02]));return MP4.box(MP4.types.esds,data);}},{key:'avc1',value:function avc1(meta){var avcc=meta.avcc;var width=meta.codecWidth,height=meta.codecHeight;var data=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,width>>>8&0xFF,width&0xFF,height>>>8&0xFF,height&0xFF,0x00,0x48,0x00,0x00,0x00,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x04,0x67,0x31,0x31,0x31,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0xFF,0xFF]);return MP4.box(MP4.types.avc1,data,MP4.box(MP4.types.avcC,avcc));}},{key:'mvex',value:function mvex(meta){if(meta.length>1){return MP4.box(MP4.types.mvex,MP4.trex(meta[0]),MP4.trex(meta[1]));}else{return MP4.box(MP4.types.mvex,MP4.trex(meta[0]));}}},{key:'trex',value:function trex(meta){var trackId=meta.id;var data=new Uint8Array([0x00,0x00,0x00,0x00,trackId>>>24&0xFF,trackId>>>16&0xFF,trackId>>>8&0xFF,trackId&0xFF,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01]);return MP4.box(MP4.types.trex,data);}},{key:'moof',value:function moof(track,baseMediaDecodeTime){return MP4.box(MP4.types.moof,MP4.mfhd(track.sequenceNumber),MP4.traf(track,baseMediaDecodeTime));}},{key:'mfhd',value:function mfhd(sequenceNumber){var data=new Uint8Array([0x00,0x00,0x00,0x00,sequenceNumber>>>24&0xFF,sequenceNumber>>>16&0xFF,sequenceNumber>>>8&0xFF,sequenceNumber&0xFF]);return MP4.box(MP4.types.mfhd,data);}},{key:'traf',value:function traf(track,baseMediaDecodeTime){var trackId=track.id;var tfhd=MP4.box(MP4.types.tfhd,new Uint8Array([0x00,0x00,0x00,0x00,trackId>>>24&0xFF,trackId>>>16&0xFF,trackId>>>8&0xFF,trackId&0xFF]));var tfdt=MP4.box(MP4.types.tfdt,new Uint8Array([0x00,0x00,0x00,0x00,baseMediaDecodeTime>>>24&0xFF,baseMediaDecodeTime>>>16&0xFF,baseMediaDecodeTime>>>8&0xFF,baseMediaDecodeTime&0xFF]));var sdtp=MP4.sdtp(track);var trun=MP4.trun(track,sdtp.byteLength+16+16+8+16+8+8);return MP4.box(MP4.types.traf,tfhd,tfdt,trun,sdtp);}},{key:'sdtp',value:function sdtp(track){var samples=track.samples||[];var sampleCount=samples.length;var data=new Uint8Array(4+sampleCount);for(var i=0;i<sampleCount;i++){var flags=samples[i].flags;data[i+4]=flags.isLeading<<6|flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;}return MP4.box(MP4.types.sdtp,data);}},{key:'trun',value:function trun(track,offset){var samples=track.samples||[];var sampleCount=samples.length;var dataSize=12+16*sampleCount;var data=new Uint8Array(dataSize);offset+=8+dataSize;data.set([0x00,0x00,0x0F,0x01,sampleCount>>>24&0xFF,sampleCount>>>16&0xFF,sampleCount>>>8&0xFF,sampleCount&0xFF,offset>>>24&0xFF,offset>>>16&0xFF,offset>>>8&0xFF,offset&0xFF],0);for(var i=0;i<sampleCount;i++){var duration=samples[i].duration;var size=samples[i].size;var flags=samples[i].flags;var cts=samples[i].cts;data.set([duration>>>24&0xFF,duration>>>16&0xFF,duration>>>8&0xFF,duration&0xFF,size>>>24&0xFF,size>>>16&0xFF,size>>>8&0xFF,size&0xFF,flags.isLeading<<2|flags.dependsOn,flags.isDependedOn<<6|flags.hasRedundancy<<4|flags.isNonSync,0x00,0x00,cts>>>24&0xFF,cts>>>16&0xFF,cts>>>8&0xFF,cts&0xFF],12+16*i);}return MP4.box(MP4.types.trun,data);}},{key:'mdat',value:function mdat(data){return MP4.box(MP4.types.mdat,data);}}]);return MP4;}();MP4.init();var AAC=function(){function AAC(){_classCallCheck(this,AAC);}_createClass(AAC,null,[{key:"getSilentFrame",value:function getSilentFrame(channelCount){if(channelCount===1){return new Uint8Array([0x00,0xc8,0x00,0x80,0x23,0x80]);}else if(channelCount===2){return new Uint8Array([0x21,0x00,0x49,0x90,0x02,0x19,0x00,0x23,0x80]);}else if(channelCount===3){return new Uint8Array([0x00,0xc8,0x00,0x80,0x20,0x84,0x01,0x26,0x40,0x08,0x64,0x00,0x8e]);}else if(channelCount===4){return new Uint8Array([0x00,0xc8,0x00,0x80,0x20,0x84,0x01,0x26,0x40,0x08,0x64,0x00,0x80,0x2c,0x80,0x08,0x02,0x38]);}else if(channelCount===5){return new Uint8Array([0x00,0xc8,0x00,0x80,0x20,0x84,0x01,0x26,0x40,0x08,0x64,0x00,0x82,0x30,0x04,0x99,0x00,0x21,0x90,0x02,0x38]);}else if(channelCount===6){return new Uint8Array([0x00,0xc8,0x00,0x80,0x20,0x84,0x01,0x26,0x40,0x08,0x64,0x00,0x82,0x30,0x04,0x99,0x00,0x21,0x90,0x02,0x00,0xb2,0x00,0x20,0x08,0xe0]);}return null;}}]);return AAC;}();var Browser={};function detect(){var ua=self.navigator.userAgent.toLowerCase();var match=/(edge)\/([\w.]+)/.exec(ua)||/(opr)[\/]([\w.]+)/.exec(ua)||/(chrome)[ \/]([\w.]+)/.exec(ua)||/(iemobile)[\/]([\w.]+)/.exec(ua)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf('trident')>=0&&/(rv)(?::| )([\w.]+)/.exec(ua)||ua.indexOf('compatible')<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[];var platform_match=/(ipad)/.exec(ua)||/(ipod)/.exec(ua)||/(windows phone)/.exec(ua)||/(iphone)/.exec(ua)||/(kindle)/.exec(ua)||/(android)/.exec(ua)||/(windows)/.exec(ua)||/(mac)/.exec(ua)||/(linux)/.exec(ua)||/(cros)/.exec(ua)||[];var matched={browser:match[5]||match[3]||match[1]||'',version:match[2]||match[4]||'0',majorVersion:match[4]||match[2]||'0',platform:platform_match[0]||''};var browser={};if(matched.browser){browser[matched.browser]=true;var versionArray=matched.majorVersion.split('.');browser.version={major:parseInt(matched.majorVersion,10),string:matched.version};if(versionArray.length>1){browser.version.minor=parseInt(versionArray[1],10);}if(versionArray.length>2){browser.version.build=parseInt(versionArray[2],10);}}if(matched.platform){browser[matched.platform]=true;}if(browser.chrome||browser.opr||browser.safari){browser.webkit=true;}if(browser.rv||browser.iemobile){if(browser.rv){delete browser.rv;}var msie='msie';matched.browser=msie;browser[msie]=true;}if(browser.edge){delete browser.edge;var msedge='msedge';matched.browser=msedge;browser[msedge]=true;}if(browser.opr){var opera='opera';matched.browser=opera;browser[opera]=true;}if(browser.safari&&browser.android){var android='android';matched.browser=android;browser[android]=true;}browser.name=matched.browser;browser.platform=matched.platform;for(var key in Browser){if(Browser.hasOwnProperty(key)){delete Browser[key];}}_Object$assign(Browser,browser);}detect();var SampleInfo=function SampleInfo(dts,pts,duration,originalDts,isSync){_classCallCheck(this,SampleInfo);this.dts=dts;this.pts=pts;this.duration=duration;this.originalDts=originalDts;this.isSyncPoint=isSync;this.fileposition=null;};var MediaSegmentInfo=function(){function MediaSegmentInfo(){_classCallCheck(this,MediaSegmentInfo);this.beginDts=0;this.endDts=0;this.beginPts=0;this.endPts=0;this.originalBeginDts=0;this.originalEndDts=0;this.syncPoints=[];this.firstSample=null;this.lastSample=null;}_createClass(MediaSegmentInfo,[{key:"appendSyncPoint",value:function appendSyncPoint(sampleInfo){sampleInfo.isSyncPoint=true;this.syncPoints.push(sampleInfo);}}]);return MediaSegmentInfo;}();var IDRSampleList=function(){function IDRSampleList(){_classCallCheck(this,IDRSampleList);this._list=[];}_createClass(IDRSampleList,[{key:"clear",value:function clear(){this._list=[];}},{key:"appendArray",value:function appendArray(syncPoints){var list=this._list;if(syncPoints.length===0){return;}if(list.length>0&&syncPoints[0].originalDts<list[list.length-1].originalDts){this.clear();}Array.prototype.push.apply(list,syncPoints);}},{key:"getLastSyncPointBeforeDts",value:function getLastSyncPointBeforeDts(dts){if(this._list.length==0){return null;}var list=this._list;var idx=0;var last=list.length-1;var mid=0;var lbound=0;var ubound=last;if(dts<list[0].dts){idx=0;lbound=ubound+1;}while(lbound<=ubound){mid=lbound+Math.floor((ubound-lbound)/2);if(mid===last||dts>=list[mid].dts&&dts<list[mid+1].dts){idx=mid;break;}else if(list[mid].dts<dts){lbound=mid+1;}else{ubound=mid-1;}}return this._list[idx];}}]);return IDRSampleList;}();var MediaSegmentInfoList=function(){function MediaSegmentInfoList(type){_classCallCheck(this,MediaSegmentInfoList);this._type=type;this._list=[];this._lastAppendLocation=-1;}_createClass(MediaSegmentInfoList,[{key:"isEmpty",value:function isEmpty$$1(){return this._list.length===0;}},{key:"clear",value:function clear(){this._list=[];this._lastAppendLocation=-1;}},{key:"_searchNearestSegmentBefore",value:function _searchNearestSegmentBefore(originalBeginDts){var list=this._list;if(list.length===0){return-2;}var last=list.length-1;var mid=0;var lbound=0;var ubound=last;var idx=0;if(originalBeginDts<list[0].originalBeginDts){idx=-1;return idx;}while(lbound<=ubound){mid=lbound+Math.floor((ubound-lbound)/2);if(mid===last||originalBeginDts>list[mid].lastSample.originalDts&&originalBeginDts<list[mid+1].originalBeginDts){idx=mid;break;}else if(list[mid].originalBeginDts<originalBeginDts){lbound=mid+1;}else{ubound=mid-1;}}return idx;}},{key:"_searchNearestSegmentAfter",value:function _searchNearestSegmentAfter(originalBeginDts){return this._searchNearestSegmentBefore(originalBeginDts)+1;}},{key:"append",value:function append(mediaSegmentInfo){var list=this._list;var msi=mediaSegmentInfo;var lastAppendIdx=this._lastAppendLocation;var insertIdx=0;if(lastAppendIdx!==-1&&lastAppendIdx<list.length&&msi.originalBeginDts>=list[lastAppendIdx].lastSample.originalDts&&(lastAppendIdx===list.length-1||lastAppendIdx<list.length-1&&msi.originalBeginDts<list[lastAppendIdx+1].originalBeginDts)){insertIdx=lastAppendIdx+1;}else{if(list.length>0){insertIdx=this._searchNearestSegmentBefore(msi.originalBeginDts)+1;}}this._lastAppendLocation=insertIdx;this._list.splice(insertIdx,0,msi);}},{key:"getLastSegmentBefore",value:function getLastSegmentBefore(originalBeginDts){var idx=this._searchNearestSegmentBefore(originalBeginDts);if(idx>=0){return this._list[idx];}else{return null;}}},{key:"getLastSampleBefore",value:function getLastSampleBefore(originalBeginDts){var segment=this.getLastSegmentBefore(originalBeginDts);if(segment!=null){return segment.lastSample;}else{return null;}}},{key:"getLastSyncPointBefore",value:function getLastSyncPointBefore(originalBeginDts){var segmentIdx=this._searchNearestSegmentBefore(originalBeginDts);var syncPoints=this._list[segmentIdx].syncPoints;while(syncPoints.length===0&&segmentIdx>0){segmentIdx--;syncPoints=this._list[segmentIdx].syncPoints;}if(syncPoints.length>0){return syncPoints[syncPoints.length-1];}else{return null;}}},{key:"type",get:function get(){return this._type;}},{key:"length",get:function get(){return this._list.length;}}]);return MediaSegmentInfoList;}();var MP4Remuxer=function(){function MP4Remuxer(config){_classCallCheck(this,MP4Remuxer);this.TAG=this.constructor.name;this._config=config;this._isLive=config.isLive===true;this._dtsBase=-1;this._dtsBaseInited=false;this._audioDtsBase=Infinity;this._videoDtsBase=Infinity;this._audioNextDts=undefined;this._videoNextDts=undefined;this._audioMeta=null;this._videoMeta=null;this._audioSegmentInfoList=new MediaSegmentInfoList('audio');this._videoSegmentInfoList=new MediaSegmentInfoList('video');this._onInitSegment=null;this._onMediaSegment=null;this._forceFirstIDR=!!(Browser.chrome&&(Browser.version.major<50||Browser.version.major===50&&Browser.version.build<2661));this._fillSilentAfterSeek=Browser.msedge||Browser.msie;}_createClass(MP4Remuxer,[{key:'destroy',value:function destroy(){this._dtsBase=-1;this._dtsBaseInited=false;this._audioMeta=null;this._videoMeta=null;this._audioSegmentInfoList.clear();this._audioSegmentInfoList=null;this._videoSegmentInfoList.clear();this._videoSegmentInfoList=null;this._onInitSegment=null;this._onMediaSegment=null;}},{key:'bindDataSource',value:function bindDataSource(producer){producer.onDataAvailable=this.remux.bind(this);producer.onTrackMetadata=this._onTrackMetadataReceived.bind(this);return this;}},{key:'insertDiscontinuity',value:function insertDiscontinuity(){this._audioNextDts=this._videoNextDts=undefined;}},{key:'seek',value:function seek(originalDts){this._videoSegmentInfoList.clear();this._audioSegmentInfoList.clear();}},{key:'remux',value:function remux(audioTrack,videoTrack){if(!this._onMediaSegment){throw new Error$1('MP4Remuxer: onMediaSegment callback must be specificed!');}if(!this._dtsBaseInited){this._calculateDtsBase(audioTrack,videoTrack);}this._remuxVideo(videoTrack);this._remuxAudio(audioTrack);}},{key:'_onTrackMetadataReceived',value:function _onTrackMetadataReceived(type,metadata){var metabox=null;if(type==='audio'){this._audioMeta=metadata;metabox=MP4.generateInitSegment(metadata);console.log('msg+audio',metadata);}else if(type==='video'){this._videoMeta=metadata;metabox=MP4.generateInitSegment(metadata);console.log('msg+video',metadata);}else{return;}if(!this._onInitSegment){throw new Error$1('MP4Remuxer: onInitSegment callback must be specified!');}this._onInitSegment(type,{type:type,data:metabox.buffer,codec:metadata.codec,container:type+'/mp4'});}},{key:'_calculateDtsBase',value:function _calculateDtsBase(audioTrack,videoTrack){if(this._dtsBaseInited){return;}if(audioTrack.samples&&audioTrack.samples.length){this._audioDtsBase=audioTrack.samples[0].dts;}if(videoTrack.samples&&videoTrack.samples.length){this._videoDtsBase=videoTrack.samples[0].dts;}this._dtsBase=Math.min(this._audioDtsBase,this._videoDtsBase);this._dtsBaseInited=true;}},{key:'_remuxAudio',value:function _remuxAudio(audioTrack){var track=audioTrack;var samples=track.samples;var dtsCorrection=void 0;var firstDts=-1,lastDts=-1,lastPts=-1;var remuxSilentFrame=false;var silentFrameDuration=-1;if(!samples||samples.length===0){return;}var bytes=8+track.length;var mdatbox=new Uint8Array(bytes);mdatbox[0]=bytes>>>24&0xFF;mdatbox[1]=bytes>>>16&0xFF;mdatbox[2]=bytes>>>8&0xFF;mdatbox[3]=bytes&0xFF;mdatbox.set(MP4.types.mdat,4);var offset=8;var mp4Samples=[];while(samples.length){var aacSample=samples.shift();var unit=aacSample.unit;var originalDts=aacSample.dts-this._dtsBase;if(dtsCorrection==undefined){if(this._audioNextDts==undefined){if(this._audioSegmentInfoList.isEmpty()){dtsCorrection=0;if(this._fillSilentAfterSeek&&!this._videoSegmentInfoList.isEmpty()){remuxSilentFrame=true;}}else{var lastSample=this._audioSegmentInfoList.getLastSampleBefore(originalDts);if(lastSample!=null){var distance=originalDts-(lastSample.originalDts+lastSample.duration);if(distance<=3){distance=0;}var expectedDts=lastSample.dts+lastSample.duration+distance;dtsCorrection=originalDts-expectedDts;}else{dtsCorrection=0;}}}else{dtsCorrection=originalDts-this._audioNextDts;}}var dts=originalDts-dtsCorrection;if(remuxSilentFrame){var videoSegment=this._videoSegmentInfoList.getLastSegmentBefore(originalDts);if(videoSegment!=null&&videoSegment.beginDts<dts){silentFrameDuration=dts-videoSegment.beginDts;dts=videoSegment.beginDts;}else{remuxSilentFrame=false;}}if(firstDts===-1){firstDts=dts;}if(remuxSilentFrame){remuxSilentFrame=false;samples.unshift(aacSample);var frame=this._generateSilentAudio(dts,silentFrameDuration);if(frame==null){continue;}var _mp4Sample=frame.mp4Sample;var _unit=frame.unit;mp4Samples.push(_mp4Sample);bytes+=_unit.byteLength;mdatbox=new Uint8Array(bytes);mdatbox[0]=bytes>>>24&0xFF;mdatbox[1]=bytes>>>16&0xFF;mdatbox[2]=bytes>>>8&0xFF;mdatbox[3]=bytes&0xFF;mdatbox.set(MP4.types.mdat,4);mdatbox.set(_unit,offset);offset+=_unit.byteLength;continue;}var sampleDuration=0;if(samples.length>=1){var nextDts=samples[0].dts-this._dtsBase-dtsCorrection;sampleDuration=nextDts-dts;}else{if(mp4Samples.length>=1){sampleDuration=mp4Samples[mp4Samples.length-1].duration;}else{sampleDuration=this._audioMeta.refSampleDuration;}}var mp4Sample={dts:dts,pts:dts,cts:0,size:unit.byteLength,duration:sampleDuration,originalDts:originalDts,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};mp4Samples.push(mp4Sample);mdatbox.set(unit,offset);offset+=unit.byteLength;}var latest=mp4Samples[mp4Samples.length-1];lastDts=latest.dts+latest.duration;this._audioNextDts=lastDts;var info=new MediaSegmentInfo();info.beginDts=firstDts;info.endDts=lastDts;info.beginPts=firstDts;info.endPts=lastDts;info.originalBeginDts=mp4Samples[0].originalDts;info.originalEndDts=latest.originalDts+latest.duration;info.firstSample=new SampleInfo(mp4Samples[0].dts,mp4Samples[0].pts,mp4Samples[0].duration,mp4Samples[0].originalDts,false);info.lastSample=new SampleInfo(latest.dts,latest.pts,latest.duration,latest.originalDts,false);if(!this._isLive){this._audioSegmentInfoList.append(info);}track.samples=mp4Samples;track.sequenceNumber+=track.addcoefficient;var moofbox=MP4.moof(track,firstDts);track.samples=[];track.length=0;this._onMediaSegment('audio',{type:'audio',data:this._mergeBoxes(moofbox,mdatbox).buffer,sampleCount:mp4Samples.length,info:info});}},{key:'_generateSilentAudio',value:function _generateSilentAudio(dts,frameDuration){console.log(this.TAG,'GenerateSilentAudio: dts = '+dts+', duration = '+frameDuration);var unit=AAC.getSilentFrame(this._audioMeta.channelCount);if(unit==null){console.log(this.TAG,'Cannot generate silent aac frame for channelCount = '+this._audioMeta.channelCount);return null;}var mp4Sample={dts:dts,pts:dts,cts:0,size:unit.byteLength,duration:frameDuration,originalDts:dts,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};return{unit:unit,mp4Sample:mp4Sample};}},{key:'_remuxVideo',value:function _remuxVideo(videoTrack){var track=videoTrack;var samples=track.samples;var dtsCorrection=void 0;var firstDts=-1,lastDts=-1;var firstPts=-1,lastPts=-1;if(!samples||samples.length===0){return;}var bytes=8+videoTrack.length;var mdatbox=new Uint8Array(bytes);mdatbox[0]=bytes>>>24&0xFF;mdatbox[1]=bytes>>>16&0xFF;mdatbox[2]=bytes>>>8&0xFF;mdatbox[3]=bytes&0xFF;mdatbox.set(MP4.types.mdat,4);var offset=8;var mp4Samples=[];var info=new MediaSegmentInfo();while(samples.length){var avcSample=samples.shift();var keyframe=avcSample.isKeyframe;var originalDts=avcSample.dts-this._dtsBase;if(dtsCorrection==undefined){if(this._videoNextDts==undefined){if(this._videoSegmentInfoList.isEmpty()){dtsCorrection=0;}else{var lastSample=this._videoSegmentInfoList.getLastSampleBefore(originalDts);if(lastSample!=null){var distance=originalDts-(lastSample.originalDts+lastSample.duration);if(distance<=3){distance=0;}var expectedDts=lastSample.dts+lastSample.duration+distance;dtsCorrection=originalDts-expectedDts;}else{dtsCorrection=0;}}}else{dtsCorrection=originalDts-this._videoNextDts;}}var dts=originalDts-dtsCorrection;var cts=avcSample.cts;var pts=dts+cts;if(firstDts===-1){firstDts=dts;firstPts=pts;}var sampleSize=0;while(avcSample.units.length){var unit=avcSample.units.shift();var data=unit.data;mdatbox.set(data,offset);offset+=data.byteLength;sampleSize+=data.byteLength;}var sampleDuration=0;if(samples.length>=1){var nextDts=samples[0].dts-this._dtsBase-dtsCorrection;sampleDuration=nextDts-dts;}else{if(mp4Samples.length>=1){sampleDuration=mp4Samples[mp4Samples.length-1].duration;}else{sampleDuration=this._videoMeta.refSampleDuration;}}if(keyframe){var syncPoint=new SampleInfo(dts,pts,sampleDuration,avcSample.dts,true);syncPoint.fileposition=avcSample.fileposition;info.appendSyncPoint(syncPoint);}var mp4Sample={dts:dts,pts:pts,cts:cts,size:sampleSize,isKeyframe:keyframe,duration:sampleDuration,originalDts:originalDts,flags:{isLeading:0,dependsOn:keyframe?2:1,isDependedOn:keyframe?1:0,hasRedundancy:0,isNonSync:keyframe?0:1}};mp4Samples.push(mp4Sample);}var latest=mp4Samples[mp4Samples.length-1];lastDts=latest.dts+latest.duration;lastPts=latest.pts+latest.duration;this._videoNextDts=lastDts;info.beginDts=firstDts;info.endDts=lastDts;info.beginPts=firstPts;info.endPts=lastPts;info.originalBeginDts=mp4Samples[0].originalDts;info.originalEndDts=latest.originalDts+latest.duration;info.firstSample=new SampleInfo(mp4Samples[0].dts,mp4Samples[0].pts,mp4Samples[0].duration,mp4Samples[0].originalDts,mp4Samples[0].isKeyframe);info.lastSample=new SampleInfo(latest.dts,latest.pts,latest.duration,latest.originalDts,latest.isKeyframe);if(!this._isLive){this._videoSegmentInfoList.append(info);}track.samples=mp4Samples;track.sequenceNumber+=track.addcoefficient;if(this._forceFirstIDR){var flags=mp4Samples[0].flags;flags.dependsOn=2;flags.isNonSync=0;}var moofbox=MP4.moof(track,firstDts);track.samples=[];track.length=0;this._onMediaSegment('video',{type:'video',data:this._mergeBoxes(moofbox,mdatbox).buffer,sampleCount:mp4Samples.length,info:info});}},{key:'_mergeBoxes',value:function _mergeBoxes(moof,mdat){var result=new Uint8Array(moof.byteLength+mdat.byteLength);result.set(moof,0);result.set(mdat,moof.byteLength);return result;}},{key:'onInitSegment',get:function get(){return this._onInitSegment;},set:function set(callback){this._onInitSegment=callback;}},{key:'onMediaSegment',get:function get(){return this._onMediaSegment;},set:function set(callback){this._onMediaSegment=callback;}}]);return MP4Remuxer;}();var flv2fmp4=function(){function flv2fmp4(config){_classCallCheck(this,flv2fmp4);this._config={_isLive:false};this._config=_Object$assign(this._config,config);this.onInitSegment=null;this.onMediaSegment=null;this.onMediaInfo=null;this.seekCallBack=null;this.loadmetadata=false;this.ftyp_moov=null;this.metaSuccRun=false;this.metas=[];this.parseChunk=null;this.hasVideo=false;this.hasAudio=false;this._error=null;this._pendingResolveSeekPoint=-1;this._tempBaseTime=0;this.setflvBase=this.setflvBasefrist;tagdemux._onTrackMetadata=this.Metadata.bind(this);tagdemux._onMediaInfo=this.metaSucc.bind(this);tagdemux._onDataAvailable=this.onDataAvailable.bind(this);tagdemux._onError=this.error.bind(this);this.m4mof=new MP4Remuxer(this._config);this.m4mof.onMediaSegment=this.onMdiaSegment.bind(this);}_createClass(flv2fmp4,[{key:'seek',value:function seek(baseTime){this.setflvBase=this.setflvBasefrist;if(baseTime==undefined||baseTime==0){baseTime=0;this._pendingResolveSeekPoint=-1;}if(this._tempBaseTime!=baseTime){this._tempBaseTime=baseTime;tagdemux._timestampBase=baseTime;this.m4mof.seek(baseTime);this.m4mof.insertDiscontinuity();this._pendingResolveSeekPoint=baseTime;}}},{key:'setflvBasefrist',value:function setflvBasefrist(arraybuff,baseTime){var offset=0;try{offset=flvparse.setFlv(new Uint8Array(arraybuff));}catch(error){this.error(error);}if(flvparse.arrTag.length>0){this.hasAudio=flvparse._hasAudio;this.hasVideo=flvparse._hasVideo;if(this._tempBaseTime!=0&&this._tempBaseTime==flvparse.arrTag[0].getTime()){tagdemux._timestampBase=0;}try{tagdemux.moofTag(flvparse.arrTag);}catch(error){this.error(error);}this.setflvBase=this.setflvBaseUsually;}return offset;}},{key:'setflvBaseUsually',value:function setflvBaseUsually(arraybuff,baseTime){var offset=0;try{offset=flvparse.setFlv(new Uint8Array(arraybuff));}catch(error){this.error(error);}if(flvparse.arrTag.length>0){try{tagdemux.moofTag(flvparse.arrTag);}catch(error){this.error(error);}}return offset;}},{key:'onMdiaSegment',value:function onMdiaSegment(track,value){if(this.onMediaSegment){this.onMediaSegment(new Uint8Array(value.data));}if(this._pendingResolveSeekPoint!=-1&&track=='video'){var seekpoint=this._pendingResolveSeekPoint;this._pendingResolveSeekPoint=-1;if(this.seekCallBack){this.seekCallBack(seekpoint);}}}},{key:'Metadata',value:function Metadata(type,meta){switch(type){case'video':this.metas.push(meta);this.m4mof._videoMeta=meta;if(this.hasVideo&&!this.hasAudio){this.metaSucc();return;}break;case'audio':this.metas.push(meta);this.m4mof._audioMeta=meta;if(!this.hasVideo&&this.hasAudio){this.metaSucc();return;}break;}if(this.hasVideo&&this.hasAudio&&this.metaSuccRun&&this.metas.length>1){this.metaSucc();}}},{key:'metaSucc',value:function metaSucc(mi){if(this.onMediaInfo){this.onMediaInfo(mi,{hasAudio:this.hasAudio,hasVideo:this.hasVideo});}if(this.metas.length==0){this.metaSuccRun=true;return;}this.ftyp_moov=MP4.generateInitSegment(this.metas);if(this.onInitSegment&&this.loadmetadata==false){this.onInitSegment(this.ftyp_moov);this.loadmetadata=true;}}},{key:'onDataAvailable',value:function onDataAvailable(audiotrack,videotrack){try{this.m4mof.remux(audiotrack,videotrack);}catch(e){this.error(e);}}},{key:'setflv',value:function setflv(arraybuff,baseTime){return this.setflvBase(arraybuff,baseTime);}},{key:'setflvloc',value:function setflvloc(arraybuff){var offset=flvparse.setFlv(new Uint8Array(arraybuff));if(flvparse.arrTag.length>0){return flvparse.arrTag;}}},{key:'error',value:function error(e){if(this._error){this._error(e);}}}]);return flv2fmp4;}();var foreign=function(_CustEvent){_inherits(foreign,_CustEvent);function foreign(config){_classCallCheck(this,foreign);var _this=_possibleConstructorReturn(this,(foreign.__proto__||_Object$getPrototypeOf(foreign)).call(this));_this.f2m=new flv2fmp4(config);_this.f2m._error=_this.error;_this._onInitSegment=null;_this._onMediaSegment=null;_this._onMediaInfo=null;_this._seekCallBack=null;return _this;}_createClass(foreign,[{key:'error',value:function error(e){this.emit('error',e.type);}},{key:'seek',value:function seek(basetime){this.f2m.seek(basetime);}},{key:'setflv',value:function setflv(arraybuff){return this.f2m.setflv(arraybuff,0);}},{key:'setflvloc',value:function setflvloc(arraybuff){return this.f2m.setflvloc(arraybuff);}},{key:'onInitSegment',set:function set(fun){this._onInitSegment=fun;this.f2m.onInitSegment=fun;}},{key:'onMediaSegment',set:function set(fun){this._onMediaSegment=fun;this.f2m.onMediaSegment=fun;}},{key:'onMediaInfo',set:function set(fun){this._onMediaInfo=fun;this.f2m.onMediaInfo=fun;}},{key:'seekCallBack',set:function set(fun){this._seekCallBack=fun;this.f2m.seekCallBack=fun;}}]);return foreign;}(CustEvent);var Transmuxer=function(_CustEvent){_inherits(Transmuxer,_CustEvent);function Transmuxer(mediaSource,config){_classCallCheck(this,Transmuxer);var _this=_possibleConstructorReturn(this,(Transmuxer.__proto__||_Object$getPrototypeOf(Transmuxer)).call(this));_this.config={};_this.tag='transmuxer';_this.loader=null;_this.CPU=null;_this.keyframePoint=false;_this.w=null;_Object$assign(_this.config,config);if(_this.config.webWorker){_this.w=index$2('./transmuxer-worker');_this.w.postMessage({cmd:'init'});_this.w.addEventListener('message',function(e){_this.parseCallback(e.data);});}return _this;}_createClass(Transmuxer,[{key:'loadSource',value:function loadSource(){if(this.config.webWorker){this.w.postMessage({cmd:'loadSource'});}else{this.loader=new Ioloader(this.config);this.loader.arrivalDataCallback=this.arrivalDataCallback.bind(this);this.loader.open();}}},{key:'arrivalDataCallback',value:function arrivalDataCallback(data,byteStart,keyframePoint){var consumed=0;if(!this.CPU){this.CPU=new foreign();this.CPU.onInitSegment=this.onRemuxerInitSegmentArrival.bind(this);this.CPU.onMediaSegment=this.onRemuxerMediaSegmentArrival.bind(this);this.CPU.onError=this.onCPUError.bind(this);this.CPU.onMediaInfo=this.onMediaInfo.bind(this);this.CPU.seekCallBack=this.seekCallBack.bind(this);}if(keyframePoint){this.keyframePoint=true;this.CPU.seek(keyframePoint);}consumed=this.CPU.setflv(data);return consumed;}},{key:'parseCallback',value:function parseCallback(data){switch(data.cmd){case'pipeCallback':data.source;break;case'mediaSegmentInit':this.emit('mediaSegmentInit',data.source);break;case'mediaSegment':this.emit('mediaSegment',data.source);break;case'mediainfo':this.emit('mediainfo',data.source);break;}}},{key:'onDemuxError',value:function onDemuxError(type,info){Log.error(this.tag,'DemuxError: type = '+type+', info = '+info);this.emit('DemuxError',type,info);}},{key:'onMediaInfo',value:function onMediaInfo(mediaInfo,o){this.mediaInfo=mediaInfo;this.emit('mediaInfo',mediaInfo);}},{key:'seekCallBack',value:function seekCallBack(t){}},{key:'onRemuxerInitSegmentArrival',value:function onRemuxerInitSegmentArrival(data){this.emit('mediaSegmentInit',data);}},{key:'onRemuxerMediaSegmentArrival',value:function onRemuxerMediaSegmentArrival(data){this.emit('mediaSegment',data);}},{key:'onCPUError',value:function onCPUError(handle){this.emit('ERROR',handle.data);}},{key:'getMediaInfo',value:function getMediaInfo(){return this.mediaInfo;}},{key:'pause',value:function pause(){this.loader.pause();}},{key:'resume',value:function resume(){this.loader.resume();}},{key:'isSeekable',value:function isSeekable(){return this.mediaInfo.hasKeyframesIndex;}},{key:'seek',value:function seek(keyframe){if(!this.isSeekable()){this.emit('ERROR','flvseek');return false;}this.loader=new Ioloader(this.config);this.loader.arrivalDataCallback=this.arrivalDataCallback.bind(this);this.loader.seek(keyframe.keyframePoint,false,keyframe.keyframetime);}},{key:'destroy',value:function destroy(){this.loader.destroy();this.loader=null;this.CPU=null;}},{key:'getNearlestKeyframe',value:function getNearlestKeyframe(times){if(this.mediaInfo&&this.mediaInfo.keyframesIndex){var keyframesList=this.mediaInfo.keyframesIndex.times;var keyframesPositions=this.mediaInfo.keyframesIndex.filepositions;var binarySearch=function binarySearch(list,val){var length=list.length;var index=Math.floor(length/2);if(length===1){var position=keyframesList.indexOf(list[0]);return{keyframetime:list[0],keyframePoint:keyframesPositions[position]};}else if(list[index]>val){return binarySearch(list.slice(0,index),val);}else if(list[index]<val){return binarySearch(list.slice(index),val);}else{var _position=keyframesList.indexOf(list[0]);return{keyframetime:list[0],keyframePoint:keyframesPositions[_position]};}};return binarySearch(keyframesList,times);}else{return 0;}}}]);return Transmuxer;}(CustEvent);var defaultConfig$1={type:'vod',autoPlay:false,box:'flv',prestrain:30,alwaysSeekKeyframe:true,lazyLoadMaxDuration:2*60,lazyLoadRecoverDuration:30,lockInternalProperty:false,debug:true,webWorker:false,autoCleanupSourceBuffer:true};var Flv=function(_CustEvent){_inherits(Flv,_CustEvent);function Flv(videodom,config){_classCallCheck(this,Flv);var _this2=_possibleConstructorReturn(this,(Flv.__proto__||_Object$getPrototypeOf(Flv)).call(this));_this2.tag='FLV-player';_this2.video=videodom;_this2.box='flv';_this2.config=defaultConfig$1;_this2.timer=null;deepAssign(_this2.config,config);_this2.requestSetTime=false;_this2.bindEvents();_this2.attachMedia();return _this2;}_createClass(Flv,[{key:'internalPropertyHandle',value:function internalPropertyHandle(){if(!_Object$getOwnPropertyDescriptor){return;}var _this=this;var time=_Object$getOwnPropertyDescriptor(HTMLMediaElement.prototype,'currentTime');Object.defineProperty(this.video,'currentTime',{get:function get(){return time.get.call(_this.video);},set:function set(t){if(!_this.currentTimeLock){throw new Error('can not set currentTime by youself');}else{return time.set.call(_this.video,t);}}});}},{key:'bindEvents',value:function bindEvents(){var _this3=this;if(this.video){this.video.addEventListener('canplay',function(){if(_this3.config.type==='live'){_this3.video.play();}if(_this3.config.lockInternalProperty){_this3.internalPropertyHandle();}});}}},{key:'attachMedia',value:function attachMedia(){var _this4=this;this.mediaSource=new MSEController(this.video,this.config);this.mediaSource.on('source_open',function(){_this4.transmuxer.loadSource();});this.mediaSource.on('bufferFull',function(){_this4.pauseTransmuxer();});this.mediaSource.on('mediaInfo',function(mediaInfo){_this4.emit('mediaInfo',mediaInfo);});this.mediaSource.on('updateend',this.onmseUpdateEnd.bind(this));}},{key:'load',value:function load(){var _this5=this;this.video.src=URL.createObjectURL(this.mediaSource.mediaSource);this.video.addEventListener('seeking',throttle(this._seek.bind(this),200,{leading:false}));this.transmuxer=new Transmuxer(this.mediaSource,this.config);this.transmuxer.on('mediaSegment',function(handle){_this5.mediaSource.emit('mediaSegment',handle.data);});this.transmuxer.on('mediaSegmentInit',function(handle){_this5.mediaSource.emit('mediaSegmentInit',handle.data);});this.transmuxer.on('error',function(handle){_this5.emit('error',handle.data);});}},{key:'isTimeinBuffered',value:function isTimeinBuffered(seconds){var buffered=this.video.buffered;for(var i=0;i<buffered.length;i++){var from=buffered.start(i);var to=buffered.end(i);if(seconds>=from&&seconds<to){return true;}}return false;}},{key:'getCurrentBufferEnd',value:function getCurrentBufferEnd(){var buffered=this.video.buffered;var currentTime=this.video.currentTime;var currentRangeEnd=0;for(var i=0;i<buffered.length;i++){var start=buffered.start(i);var end=buffered.end(i);if(start<=currentTime&&currentTime<end){currentRangeEnd=end;return currentRangeEnd;}}}},{key:'_seek',value:function _seek(e,seconds){this.currentTimeLock=true;this.timer=null;var currentTime=seconds?seconds:this.video.currentTime;if(this.requestSetTime){this.requestSetTime=false;this.currentTimeLock=false;return;}if(this.isTimeinBuffered(currentTime)){if(this.config.alwaysSeekKeyframe){var nearlestkeyframe=this.transmuxer.getNearlestKeyframe(Math.floor(currentTime*1000));if(nearlestkeyframe){this.requestSetTime=true;this.video.currentTime=nearlestkeyframe.keyframetime/1000;}}}else{this.transmuxer.pause();var _nearlestkeyframe=this.transmuxer.getNearlestKeyframe(Math.floor(currentTime*1000));currentTime=_nearlestkeyframe.keyframetime/1000;this.transmuxer.seek(_nearlestkeyframe);this.mediaSource.seek(currentTime);this.requestSetTime=true;this.video.currentTime=currentTime;window.clearInterval(this.timer);this.timer=null;}this.currentTimeLock=false;return currentTime;}},{key:'onmseUpdateEnd',value:function onmseUpdateEnd(){if(this.config.isLive){return;}var currentBufferEnd=this.getCurrentBufferEnd();var currentTime=this.video.currentTime;if(currentBufferEnd>=currentTime+this.config.lazyLoadMaxDuration&&this.timer===null){Log.verbose(this.tag,'Maximum buffering duration exceeded, suspend transmuxing task');this.pauseTransmuxer();}}},{key:'heartbeat',value:function heartbeat(){var currentTime=this.video.currentTime;var buffered=this.video.buffered;var needResume=false;for(var i=0;i<buffered.length;i++){var from=buffered.start(i);var to=buffered.end(i);if(currentTime>=from&&currentTime<to){if(currentTime>=to-this.config.lazyLoadRecoverDuration){needResume=true;}break;}}if(needResume){window.clearInterval(this.timer);this.timer=null;Log.verbose(this.TAG,'Continue loading from paused position');this.transmuxer.resume();}}},{key:'pauseTransmuxer',value:function pauseTransmuxer(){this.transmuxer.pause();if(!this.timer){this.timer=setInterval(this.heartbeat.bind(this),1000);}}},{key:'resume',value:function resume(){}},{key:'destroy',value:function destroy(){if(this.video){this.video.src='';this.video.removeAttribute('src');this.transmuxer.destroy();this.transmuxer=null;this.mediaSource.destroy();this.mediaSource=null;}}},{key:'seek',value:function seek(seconds){return this._seek(null,seconds);}},{key:'play',value:function play(){return this.video.play();}},{key:'pause',value:function pause(){return this.video.pause();}}]);return Flv;}(CustEvent);function commonjsRequire$1(){throw new Error('Dynamic requires are not currently supported by rollup-plugin-commonjs');}function unwrapExports$1(x){return x&&x.__esModule?x['default']:x;}function createCommonjsModule$1(fn,module){return module={exports:{}},fn(module,module.exports),module.exports;}var hls=createCommonjsModule$1(function(module,exports){(function(f){{module.exports=f();}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof commonjsRequire$1=="function"&&commonjsRequire$1;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f;}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e);},l,l.exports,e,t,n,r);}return n[o].exports;}var i=typeof commonjsRequire$1=="function"&&commonjsRequire$1;for(var o=0;o<r.length;o++){s(r[o]);}return s;}({1:[function(_dereq_,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined;}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber$$1(n)||n<0||isNaN(n))throw TypeError('n must be a positive number');this._maxListeners=n;return this;};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==='error'){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er;}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+')');err.context=er;throw err;}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction$$1(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args);}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++){listeners[i].apply(this,args);}}return true;};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction$$1(listener))throw TypeError('listener must be a function');if(!this._events)this._events={};if(this._events.newListener)this.emit('newListener',type,isFunction$$1(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners;}else{m=EventEmitter.defaultMaxListeners;}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error('(node) warning: possible EventEmitter memory '+'leak detected. %d listeners added. '+'Use emitter.setMaxListeners() to increase limit.',this._events[type].length);if(typeof console.trace==='function'){console.trace();}}}return this;};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction$$1(listener))throw TypeError('listener must be a function');var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments);}}g.listener=listener;this.on(type,g);return this;};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction$$1(listener))throw TypeError('listener must be a function');if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction$$1(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit('removeListener',type,listener);}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break;}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type];}else{list.splice(position,1);}if(this._events.removeListener)this.emit('removeListener',type,listener);}return this;};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this;}if(arguments.length===0){for(key in this._events){if(key==='removeListener')continue;this.removeAllListeners(key);}this.removeAllListeners('removeListener');this._events={};return this;}listeners=this._events[type];if(isFunction$$1(listeners)){this.removeListener(type,listeners);}else if(listeners){while(listeners.length){this.removeListener(type,listeners[listeners.length-1]);}}delete this._events[type];return this;};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction$$1(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret;};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction$$1(evlistener))return 1;else if(evlistener)return evlistener.length;}return 0;};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type);};function isFunction$$1(arg){return typeof arg==='function';}function isNumber$$1(arg){return typeof arg==='number';}function isObject(arg){return(typeof arg==='undefined'?'undefined':_typeof2(arg))==='object'&&arg!==null;}function isUndefined(arg){return arg===void 0;}},{}],2:[function(_dereq_,module,exports){(function(root){var URL_REGEX=/^((?:[^\/;?#]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/;var FIRST_SEGMENT_REGEX=/^([^\/;?#]*)(.*)$/;var SLASH_DOT_REGEX=/(?:\/|^)\.(?=\/)/g;var SLASH_DOT_DOT_REGEX=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g;var URLToolkit={buildAbsoluteURL:function buildAbsoluteURL(baseURL,relativeURL,opts){opts=opts||{};baseURL=baseURL.trim();relativeURL=relativeURL.trim();if(!relativeURL){if(!opts.alwaysNormalize){return baseURL;}var basePartsForNormalise=this.parseURL(baseURL);if(!baseParts){throw new Error('Error trying to parse base URL.');}basePartsForNormalise.path=URLToolkit.normalizePath(basePartsForNormalise.path);return URLToolkit.buildURLFromParts(basePartsForNormalise);}var relativeParts=this.parseURL(relativeURL);if(!relativeParts){throw new Error('Error trying to parse relative URL.');}if(relativeParts.scheme){if(!opts.alwaysNormalize){return relativeURL;}relativeParts.path=URLToolkit.normalizePath(relativeParts.path);return URLToolkit.buildURLFromParts(relativeParts);}var baseParts=this.parseURL(baseURL);if(!baseParts){throw new Error('Error trying to parse base URL.');}if(!baseParts.netLoc&&baseParts.path&&baseParts.path[0]!=='/'){var pathParts=FIRST_SEGMENT_REGEX.exec(baseParts.path);baseParts.netLoc=pathParts[1];baseParts.path=pathParts[2];}if(baseParts.netLoc&&!baseParts.path){baseParts.path='/';}var builtParts={scheme:baseParts.scheme,netLoc:relativeParts.netLoc,path:null,params:relativeParts.params,query:relativeParts.query,fragment:relativeParts.fragment};if(!relativeParts.netLoc){builtParts.netLoc=baseParts.netLoc;if(relativeParts.path[0]!=='/'){if(!relativeParts.path){builtParts.path=baseParts.path;if(!relativeParts.params){builtParts.params=baseParts.params;if(!relativeParts.query){builtParts.query=baseParts.query;}}}else{var baseURLPath=baseParts.path;var newPath=baseURLPath.substring(0,baseURLPath.lastIndexOf('/')+1)+relativeParts.path;builtParts.path=URLToolkit.normalizePath(newPath);}}}if(builtParts.path===null){builtParts.path=opts.alwaysNormalize?URLToolkit.normalizePath(relativeParts.path):relativeParts.path;}return URLToolkit.buildURLFromParts(builtParts);},parseURL:function parseURL(url){var parts=URL_REGEX.exec(url);if(!parts){return null;}return{scheme:parts[1]||'',netLoc:parts[2]||'',path:parts[3]||'',params:parts[4]||'',query:parts[5]||'',fragment:parts[6]||''};},normalizePath:function normalizePath(path){path=path.split('').reverse().join('').replace(SLASH_DOT_REGEX,'');while(path.length!==(path=path.replace(SLASH_DOT_DOT_REGEX,'')).length){}return path.split('').reverse().join('');},buildURLFromParts:function buildURLFromParts(parts){return parts.scheme+parts.netLoc+parts.path+parts.params+parts.query+parts.fragment;}};if((typeof exports==='undefined'?'undefined':_typeof2(exports))==='object'&&(typeof module==='undefined'?'undefined':_typeof2(module))==='object')module.exports=URLToolkit;else if(typeof define==='function'&&define.amd)define([],function(){return URLToolkit;});else if((typeof exports==='undefined'?'undefined':_typeof2(exports))==='object')exports["URLToolkit"]=URLToolkit;else root["URLToolkit"]=URLToolkit;})(this);},{}],3:[function(_dereq_,module,exports){var bundleFn=arguments[3];var sources=arguments[4];var cache=arguments[5];var stringify=JSON.stringify;module.exports=function(fn,options){var wkey;var cacheKeys=Object.keys(cache);for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];var exp=cache[key].exports;if(exp===fn||exp&&exp.default===fn){wkey=key;break;}}if(!wkey){wkey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var wcache={};for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];wcache[key]=key;}sources[wkey]=[Function(['require','module','exports'],'('+fn+')(self)'),wcache];}var skey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var scache={};scache[wkey]=wkey;sources[skey]=[Function(['require'],'var f = require('+stringify(wkey)+');'+'(f.default ? f.default : f)(self);'),scache];var workerSources={};resolveSources(skey);function resolveSources(key){workerSources[key]=true;for(var depPath in sources[key][1]){var depKey=sources[key][1][depPath];if(!workerSources[depKey]){resolveSources(depKey);}}}var src='('+bundleFn+')({'+Object.keys(workerSources).map(function(key){return stringify(key)+':['+sources[key][0]+','+stringify(sources[key][1])+']';}).join(',')+'},{},['+stringify(skey)+'])';var URL=window.URL||window.webkitURL||window.mozURL||window.msURL;var blob=new Blob([src],{type:'text/javascript'});if(options&&options.bare){return blob;}var workerUrl=URL.createObjectURL(blob);var worker=new Worker(workerUrl);worker.objectURL=workerUrl;return worker;};},{}],4:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.hlsDefaultConfig=undefined;var _abrController=_dereq_(5);var _abrController2=_interopRequireDefault(_abrController);var _bufferController=_dereq_(8);var _bufferController2=_interopRequireDefault(_bufferController);var _capLevelController=_dereq_(9);var _capLevelController2=_interopRequireDefault(_capLevelController);var _fpsController=_dereq_(10);var _fpsController2=_interopRequireDefault(_fpsController);var _xhrLoader=_dereq_(59);var _xhrLoader2=_interopRequireDefault(_xhrLoader);var _audioTrackController=_dereq_(7);var _audioTrackController2=_interopRequireDefault(_audioTrackController);var _audioStreamController=_dereq_(6);var _audioStreamController2=_interopRequireDefault(_audioStreamController);var _cues=_dereq_(50);var _cues2=_interopRequireDefault(_cues);var _timelineController=_dereq_(16);var _timelineController2=_interopRequireDefault(_timelineController);var _subtitleTrackController=_dereq_(15);var _subtitleTrackController2=_interopRequireDefault(_subtitleTrackController);var _subtitleStreamController=_dereq_(14);var _subtitleStreamController2=_interopRequireDefault(_subtitleStreamController);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var hlsDefaultConfig=exports.hlsDefaultConfig={autoStartLoad:true,startPosition:-1,defaultAudioCodec:undefined,debug:false,capLevelOnFPSDrop:false,capLevelToPlayerSize:false,initialLiveManifestSize:1,maxBufferLength:30,maxBufferSize:60*1000*1000,maxBufferHole:0.5,maxSeekHole:2,lowBufferWatchdogPeriod:0.5,highBufferWatchdogPeriod:3,nudgeOffset:0.1,nudgeMaxRetry:3,maxFragLookUpTolerance:0.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:Infinity,liveSyncDuration:undefined,liveMaxLatencyDuration:undefined,maxMaxBufferLength:600,enableWorker:true,enableSoftwareAES:true,manifestLoadingTimeOut:10000,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1000,manifestLoadingMaxRetryTimeout:64000,startLevel:undefined,levelLoadingTimeOut:10000,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1000,levelLoadingMaxRetryTimeout:64000,fragLoadingTimeOut:20000,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1000,fragLoadingMaxRetryTimeout:64000,fragLoadingLoopThreshold:3,startFragPrefetch:false,fpsDroppedMonitoringPeriod:5000,fpsDroppedMonitoringThreshold:0.2,appendErrorMaxRetry:3,loader:_xhrLoader2.default,fLoader:undefined,pLoader:undefined,xhrSetup:undefined,fetchSetup:undefined,abrController:_abrController2.default,bufferController:_bufferController2.default,capLevelController:_capLevelController2.default,fpsController:_fpsController2.default,audioStreamController:_audioStreamController2.default,audioTrackController:_audioTrackController2.default,subtitleStreamController:_subtitleStreamController2.default,subtitleTrackController:_subtitleTrackController2.default,timelineController:_timelineController2.default,cueHandler:_cues2.default,enableCEA708Captions:true,enableWebVTT:true,captionsTextTrack1Label:'English',captionsTextTrack1LanguageCode:'en',captionsTextTrack2Label:'Spanish',captionsTextTrack2LanguageCode:'es',stretchShortVideoTrack:false,forceKeyFrameOnDiscontinuity:true,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:0.95,abrBandWidthUpFactor:0.7,abrMaxWithRealBitrate:false,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0};},{"10":10,"14":14,"15":15,"16":16,"5":5,"50":50,"59":59,"6":6,"7":7,"8":8,"9":9}],5:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _bufferHelper=_dereq_(37);var _bufferHelper2=_interopRequireDefault(_bufferHelper);var _errors=_dereq_(33);var _logger=_dereq_(54);var _ewmaBandwidthEstimator=_dereq_(52);var _ewmaBandwidthEstimator2=_interopRequireDefault(_ewmaBandwidthEstimator);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var AbrController=function(_EventHandler){_inherits$$1(AbrController,_EventHandler);function AbrController(hls){_classCallCheck$$1(this,AbrController);var _this=_possibleConstructorReturn$$1(this,(AbrController.__proto__||Object.getPrototypeOf(AbrController)).call(this,hls,_events2.default.FRAG_LOADING,_events2.default.FRAG_LOADED,_events2.default.FRAG_BUFFERED,_events2.default.ERROR));_this.lastLoadedFragLevel=0;_this._nextAutoLevel=-1;_this.hls=hls;_this.timer=null;_this._bwEstimator=null;_this.onCheck=_this._abandonRulesCheck.bind(_this);return _this;}_createClass$$1(AbrController,[{key:'destroy',value:function destroy(){this.clearTimer();_eventHandler2.default.prototype.destroy.call(this);}},{key:'onFragLoading',value:function onFragLoading(data){var frag=data.frag;if(frag.type==='main'){if(!this.timer){this.timer=setInterval(this.onCheck,100);}if(!this._bwEstimator){var hls=this.hls,level=data.frag.level,isLive=hls.levels[level].details.live,config=hls.config,ewmaFast=void 0,ewmaSlow=void 0;if(isLive){ewmaFast=config.abrEwmaFastLive;ewmaSlow=config.abrEwmaSlowLive;}else{ewmaFast=config.abrEwmaFastVoD;ewmaSlow=config.abrEwmaSlowVoD;}this._bwEstimator=new _ewmaBandwidthEstimator2.default(hls,ewmaSlow,ewmaFast,config.abrEwmaDefaultEstimate);}this.fragCurrent=frag;}}},{key:'_abandonRulesCheck',value:function _abandonRulesCheck(){var hls=this.hls,v=hls.media,frag=this.fragCurrent,loader=frag.loader,minAutoLevel=hls.minAutoLevel;if(!loader||loader.stats&&loader.stats.aborted){_logger.logger.warn('frag loader destroy or aborted, disarm abandonRules');this.clearTimer();return;}var stats=loader.stats;if(v&&(!v.paused&&v.playbackRate!==0||!v.readyState)&&frag.autoLevel&&frag.level){var requestDelay=performance.now()-stats.trequest,playbackRate=Math.abs(v.playbackRate);if(requestDelay>500*frag.duration/playbackRate){var levels=hls.levels,loadRate=Math.max(1,stats.bw?stats.bw/8:stats.loaded*1000/requestDelay),level=levels[frag.level],levelBitrate=level.realBitrate?Math.max(level.realBitrate,level.bitrate):level.bitrate,expectedLen=stats.total?stats.total:Math.max(stats.loaded,Math.round(frag.duration*levelBitrate/8)),pos=v.currentTime,fragLoadedDelay=(expectedLen-stats.loaded)/loadRate,bufferStarvationDelay=(_bufferHelper2.default.bufferInfo(v,pos,hls.config.maxBufferHole).end-pos)/playbackRate;if(bufferStarvationDelay<2*frag.duration/playbackRate&&fragLoadedDelay>bufferStarvationDelay){var fragLevelNextLoadedDelay=void 0,nextLoadLevel=void 0;for(nextLoadLevel=frag.level-1;nextLoadLevel>minAutoLevel;nextLoadLevel--){var levelNextBitrate=levels[nextLoadLevel].realBitrate?Math.max(levels[nextLoadLevel].realBitrate,levels[nextLoadLevel].bitrate):levels[nextLoadLevel].bitrate;fragLevelNextLoadedDelay=frag.duration*levelNextBitrate/(8*0.8*loadRate);if(fragLevelNextLoadedDelay<bufferStarvationDelay){break;}}if(fragLevelNextLoadedDelay<fragLoadedDelay){_logger.logger.warn('loading too slow, abort fragment loading and switch to level '+nextLoadLevel+':fragLoadedDelay['+nextLoadLevel+']<fragLoadedDelay['+(frag.level-1)+'];bufferStarvationDelay:'+fragLevelNextLoadedDelay.toFixed(1)+'<'+fragLoadedDelay.toFixed(1)+':'+bufferStarvationDelay.toFixed(1));hls.nextLoadLevel=nextLoadLevel;this._bwEstimator.sample(requestDelay,stats.loaded);loader.abort();this.clearTimer();hls.trigger(_events2.default.FRAG_LOAD_EMERGENCY_ABORTED,{frag:frag,stats:stats});}}}}}},{key:'onFragLoaded',value:function onFragLoaded(data){var frag=data.frag;if(frag.type==='main'&&!isNaN(frag.sn)){this.clearTimer();this.lastLoadedFragLevel=frag.level;this._nextAutoLevel=-1;if(this.hls.config.abrMaxWithRealBitrate){var level=this.hls.levels[frag.level];var loadedBytes=(level.loaded?level.loaded.bytes:0)+data.stats.loaded;var loadedDuration=(level.loaded?level.loaded.duration:0)+data.frag.duration;level.loaded={bytes:loadedBytes,duration:loadedDuration};level.realBitrate=Math.round(8*loadedBytes/loadedDuration);}if(data.frag.bitrateTest){var stats=data.stats;stats.tparsed=stats.tbuffered=stats.tload;this.onFragBuffered(data);}}}},{key:'onFragBuffered',value:function onFragBuffered(data){var stats=data.stats,frag=data.frag;if(stats.aborted!==true&&frag.loadCounter===1&&frag.type==='main'&&!isNaN(frag.sn)&&(!frag.bitrateTest||stats.tload===stats.tbuffered)){var fragLoadingProcessingMs=stats.tparsed-stats.trequest;_logger.logger.log('latency/loading/parsing/append/kbps:'+Math.round(stats.tfirst-stats.trequest)+'/'+Math.round(stats.tload-stats.tfirst)+'/'+Math.round(stats.tparsed-stats.tload)+'/'+Math.round(stats.tbuffered-stats.tparsed)+'/'+Math.round(8*stats.loaded/(stats.tbuffered-stats.trequest)));this._bwEstimator.sample(fragLoadingProcessingMs,stats.loaded);stats.bwEstimate=this._bwEstimator.getEstimate();if(frag.bitrateTest){this.bitrateTestDelay=fragLoadingProcessingMs/1000;}else{this.bitrateTestDelay=0;}}}},{key:'onError',value:function onError(data){switch(data.details){case _errors.ErrorDetails.FRAG_LOAD_ERROR:case _errors.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer();break;default:break;}}},{key:'clearTimer',value:function clearTimer(){clearInterval(this.timer);this.timer=null;}},{key:'_findBestLevel',value:function _findBestLevel(currentLevel,currentFragDuration,currentBw,minAutoLevel,maxAutoLevel,maxFetchDuration,bwFactor,bwUpFactor,levels){for(var i=maxAutoLevel;i>=minAutoLevel;i--){var levelInfo=levels[i],levelDetails=levelInfo.details,avgDuration=levelDetails?levelDetails.totalduration/levelDetails.fragments.length:currentFragDuration,live=levelDetails?levelDetails.live:false,adjustedbw=void 0;if(i<=currentLevel){adjustedbw=bwFactor*currentBw;}else{adjustedbw=bwUpFactor*currentBw;}var bitrate=levels[i].realBitrate?Math.max(levels[i].realBitrate,levels[i].bitrate):levels[i].bitrate,fetchDuration=bitrate*avgDuration/adjustedbw;_logger.logger.trace('level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: '+i+'/'+Math.round(adjustedbw)+'/'+bitrate+'/'+avgDuration+'/'+maxFetchDuration+'/'+fetchDuration);if(adjustedbw>bitrate&&(!fetchDuration||live&&!this.bitrateTestDelay||fetchDuration<maxFetchDuration)){return i;}}return-1;}},{key:'nextAutoLevel',get:function get(){var forcedAutoLevel=this._nextAutoLevel;var bwEstimator=this._bwEstimator;if(forcedAutoLevel!==-1&&(!bwEstimator||!bwEstimator.canEstimate())){return forcedAutoLevel;}var nextABRAutoLevel=this._nextABRAutoLevel;if(forcedAutoLevel!==-1){nextABRAutoLevel=Math.min(forcedAutoLevel,nextABRAutoLevel);}return nextABRAutoLevel;},set:function set(nextLevel){this._nextAutoLevel=nextLevel;}},{key:'_nextABRAutoLevel',get:function get(){var hls=this.hls,maxAutoLevel=hls.maxAutoLevel,levels=hls.levels,config=hls.config,minAutoLevel=hls.minAutoLevel;var v=hls.media,currentLevel=this.lastLoadedFragLevel,currentFragDuration=this.fragCurrent?this.fragCurrent.duration:0,pos=v?v.currentTime:0,playbackRate=v&&v.playbackRate!==0?Math.abs(v.playbackRate):1.0,avgbw=this._bwEstimator?this._bwEstimator.getEstimate():config.abrEwmaDefaultEstimate,bufferStarvationDelay=(_bufferHelper2.default.bufferInfo(v,pos,config.maxBufferHole).end-pos)/playbackRate;var bestLevel=this._findBestLevel(currentLevel,currentFragDuration,avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,config.abrBandWidthFactor,config.abrBandWidthUpFactor,levels);if(bestLevel>=0){return bestLevel;}else{_logger.logger.trace('rebuffering expected to happen, lets try to find a quality level minimizing the rebuffering');var maxStarvationDelay=currentFragDuration?Math.min(currentFragDuration,config.maxStarvationDelay):config.maxStarvationDelay,bwFactor=config.abrBandWidthFactor,bwUpFactor=config.abrBandWidthUpFactor;if(bufferStarvationDelay===0){var bitrateTestDelay=this.bitrateTestDelay;if(bitrateTestDelay){var maxLoadingDelay=currentFragDuration?Math.min(currentFragDuration,config.maxLoadingDelay):config.maxLoadingDelay;maxStarvationDelay=maxLoadingDelay-bitrateTestDelay;_logger.logger.trace('bitrate test took '+Math.round(1000*bitrateTestDelay)+'ms, set first fragment max fetchDuration to '+Math.round(1000*maxStarvationDelay)+' ms');bwFactor=bwUpFactor=1;}}bestLevel=this._findBestLevel(currentLevel,currentFragDuration,avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay+maxStarvationDelay,bwFactor,bwUpFactor,levels);return Math.max(bestLevel,0);}}}]);return AbrController;}(_eventHandler2.default);exports.default=AbrController;},{"33":33,"34":34,"35":35,"37":37,"52":52,"54":54}],6:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _binarySearch=_dereq_(48);var _binarySearch2=_interopRequireDefault(_binarySearch);var _bufferHelper=_dereq_(37);var _bufferHelper2=_interopRequireDefault(_bufferHelper);var _demuxer=_dereq_(25);var _demuxer2=_interopRequireDefault(_demuxer);var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _levelHelper=_dereq_(38);var _levelHelper2=_interopRequireDefault(_levelHelper);var _timeRanges=_dereq_(55);var _timeRanges2=_interopRequireDefault(_timeRanges);var _errors=_dereq_(33);var _logger=_dereq_(54);var _discontinuities=_dereq_(51);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var State={STOPPED:'STOPPED',STARTING:'STARTING',IDLE:'IDLE',PAUSED:'PAUSED',KEY_LOADING:'KEY_LOADING',FRAG_LOADING:'FRAG_LOADING',FRAG_LOADING_WAITING_RETRY:'FRAG_LOADING_WAITING_RETRY',WAITING_TRACK:'WAITING_TRACK',PARSING:'PARSING',PARSED:'PARSED',BUFFER_FLUSHING:'BUFFER_FLUSHING',ENDED:'ENDED',ERROR:'ERROR',WAITING_INIT_PTS:'WAITING_INIT_PTS'};var AudioStreamController=function(_EventHandler){_inherits$$1(AudioStreamController,_EventHandler);function AudioStreamController(hls){_classCallCheck$$1(this,AudioStreamController);var _this=_possibleConstructorReturn$$1(this,(AudioStreamController.__proto__||Object.getPrototypeOf(AudioStreamController)).call(this,hls,_events2.default.MEDIA_ATTACHED,_events2.default.MEDIA_DETACHING,_events2.default.AUDIO_TRACKS_UPDATED,_events2.default.AUDIO_TRACK_SWITCHING,_events2.default.AUDIO_TRACK_LOADED,_events2.default.KEY_LOADED,_events2.default.FRAG_LOADED,_events2.default.FRAG_PARSING_INIT_SEGMENT,_events2.default.FRAG_PARSING_DATA,_events2.default.FRAG_PARSED,_events2.default.ERROR,_events2.default.BUFFER_CREATED,_events2.default.BUFFER_APPENDED,_events2.default.BUFFER_FLUSHED,_events2.default.INIT_PTS_FOUND));_this.config=hls.config;_this.audioCodecSwap=false;_this.ticks=0;_this._state=State.STOPPED;_this.ontick=_this.tick.bind(_this);_this.initPTS=[];_this.waitingFragment=null;_this.videoTrackCC=null;return _this;}_createClass$$1(AudioStreamController,[{key:'destroy',value:function destroy(){this.stopLoad();if(this.timer){clearInterval(this.timer);this.timer=null;}_eventHandler2.default.prototype.destroy.call(this);this.state=State.STOPPED;}},{key:'onInitPtsFound',value:function onInitPtsFound(data){var demuxerId=data.id,cc=data.frag.cc,initPTS=data.initPTS;if(demuxerId==='main'){this.initPTS[cc]=initPTS;this.videoTrackCC=cc;_logger.logger.log('InitPTS for cc:'+cc+' found from video track:'+initPTS);if(this.state===State.WAITING_INIT_PTS){this.tick();}}}},{key:'startLoad',value:function startLoad(startPosition){if(this.tracks){var lastCurrentTime=this.lastCurrentTime;this.stopLoad();if(!this.timer){this.timer=setInterval(this.ontick,100);}this.fragLoadError=0;if(lastCurrentTime>0&&startPosition===-1){_logger.logger.log('audio:override startPosition with lastCurrentTime @'+lastCurrentTime.toFixed(3));this.state=State.IDLE;}else{this.lastCurrentTime=this.startPosition?this.startPosition:startPosition;this.state=State.STARTING;}this.nextLoadPosition=this.startPosition=this.lastCurrentTime;this.tick();}else{this.startPosition=startPosition;this.state=State.STOPPED;}}},{key:'stopLoad',value:function stopLoad(){var frag=this.fragCurrent;if(frag){if(frag.loader){frag.loader.abort();}this.fragCurrent=null;}this.fragPrevious=null;if(this.demuxer){this.demuxer.destroy();this.demuxer=null;}this.state=State.STOPPED;}},{key:'tick',value:function tick(){this.ticks++;if(this.ticks===1){this.doTick();if(this.ticks>1){setTimeout(this.tick,1);}this.ticks=0;}}},{key:'doTick',value:function doTick(){var pos,track,trackDetails,hls=this.hls,config=hls.config;switch(this.state){case State.ERROR:case State.PAUSED:case State.BUFFER_FLUSHING:break;case State.STARTING:this.state=State.WAITING_TRACK;this.loadedmetadata=false;break;case State.IDLE:var tracks=this.tracks;if(!tracks){break;}if(!this.media&&(this.startFragRequested||!config.startFragPrefetch)){break;}if(this.loadedmetadata){pos=this.media.currentTime;}else{pos=this.nextLoadPosition;if(pos===undefined){break;}}var media=this.mediaBuffer?this.mediaBuffer:this.media,bufferInfo=_bufferHelper2.default.bufferInfo(media,pos,config.maxBufferHole),bufferLen=bufferInfo.len,bufferEnd=bufferInfo.end,fragPrevious=this.fragPrevious,maxBufLen=config.maxMaxBufferLength,audioSwitch=this.audioSwitch,trackId=this.trackId;if((bufferLen<maxBufLen||audioSwitch)&&trackId<tracks.length){trackDetails=tracks[trackId].details;if(typeof trackDetails==='undefined'){this.state=State.WAITING_TRACK;break;}if(!audioSwitch&&!trackDetails.live&&fragPrevious&&fragPrevious.sn===trackDetails.endSN){if(!this.media.seeking||this.media.duration-bufferEnd<fragPrevious.duration/2){this.hls.trigger(_events2.default.BUFFER_EOS,{type:'audio'});this.state=State.ENDED;break;}}var fragments=trackDetails.fragments,fragLen=fragments.length,start=fragments[0].start,end=fragments[fragLen-1].start+fragments[fragLen-1].duration,frag=void 0;if(audioSwitch){if(trackDetails.live&&!trackDetails.PTSKnown){_logger.logger.log('switching audiotrack, live stream, unknown PTS,load first fragment');bufferEnd=0;}else{bufferEnd=pos;if(trackDetails.PTSKnown&&pos<start){if(bufferInfo.end>start||bufferInfo.nextStart){_logger.logger.log('alt audio track ahead of main track, seek to start of alt audio track');this.media.currentTime=start+0.05;}else{return;}}}}if(trackDetails.initSegment&&!trackDetails.initSegment.data){frag=trackDetails.initSegment;}else if(bufferEnd<=start){frag=fragments[0];if(this.videoTrackCC!==null&&frag.cc!==this.videoTrackCC){frag=(0,_discontinuities.findFragWithCC)(fragments,this.videoTrackCC);}if(trackDetails.live&&frag.loadIdx&&frag.loadIdx===this.fragLoadIdx){var nextBuffered=bufferInfo.nextStart?bufferInfo.nextStart:start;_logger.logger.log('no alt audio available @currentTime:'+this.media.currentTime+', seeking @'+(nextBuffered+0.05));this.media.currentTime=nextBuffered+0.05;return;}}else{var foundFrag=void 0;var maxFragLookUpTolerance=config.maxFragLookUpTolerance;var fragNext=fragPrevious?fragments[fragPrevious.sn-fragments[0].sn+1]:undefined;var fragmentWithinToleranceTest=function fragmentWithinToleranceTest(candidate){var candidateLookupTolerance=Math.min(maxFragLookUpTolerance,candidate.duration);if(candidate.start+candidate.duration-candidateLookupTolerance<=bufferEnd){return 1;}else if(candidate.start-candidateLookupTolerance>bufferEnd&&candidate.start){return-1;}return 0;};if(bufferEnd<end){if(bufferEnd>end-maxFragLookUpTolerance){maxFragLookUpTolerance=0;}if(fragNext&&!fragmentWithinToleranceTest(fragNext)){foundFrag=fragNext;}else{foundFrag=_binarySearch2.default.search(fragments,fragmentWithinToleranceTest);}}else{foundFrag=fragments[fragLen-1];}if(foundFrag){frag=foundFrag;start=foundFrag.start;if(fragPrevious&&frag.level===fragPrevious.level&&frag.sn===fragPrevious.sn){if(frag.sn<trackDetails.endSN){frag=fragments[frag.sn+1-trackDetails.startSN];_logger.logger.log('SN just loaded, load next one: '+frag.sn);}else{frag=null;}}}}if(frag){if(frag.decryptdata&&frag.decryptdata.uri!=null&&frag.decryptdata.key==null){_logger.logger.log('Loading key for '+frag.sn+' of ['+trackDetails.startSN+' ,'+trackDetails.endSN+'],track '+trackId);this.state=State.KEY_LOADING;hls.trigger(_events2.default.KEY_LOADING,{frag:frag});}else{_logger.logger.log('Loading '+frag.sn+', cc: '+frag.cc+' of ['+trackDetails.startSN+' ,'+trackDetails.endSN+'],track '+trackId+', currentTime:'+pos+',bufferEnd:'+bufferEnd.toFixed(3));if(this.fragLoadIdx!==undefined){this.fragLoadIdx++;}else{this.fragLoadIdx=0;}if(frag.loadCounter){frag.loadCounter++;var maxThreshold=config.fragLoadingLoopThreshold;if(frag.loadCounter>maxThreshold&&Math.abs(this.fragLoadIdx-frag.loadIdx)<maxThreshold){hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR,fatal:false,frag:frag});return;}}else{frag.loadCounter=1;}frag.loadIdx=this.fragLoadIdx;this.fragCurrent=frag;this.startFragRequested=true;if(!isNaN(frag.sn)){this.nextLoadPosition=frag.start+frag.duration;}hls.trigger(_events2.default.FRAG_LOADING,{frag:frag});this.state=State.FRAG_LOADING;}}}break;case State.WAITING_TRACK:track=this.tracks[this.trackId];if(track&&track.details){this.state=State.IDLE;}break;case State.FRAG_LOADING_WAITING_RETRY:var now=performance.now();var retryDate=this.retryDate;media=this.media;var isSeeking=media&&media.seeking;if(!retryDate||now>=retryDate||isSeeking){_logger.logger.log('audioStreamController: retryDate reached, switch back to IDLE state');this.state=State.IDLE;}break;case State.WAITING_INIT_PTS:if(this.initPTS[this.videoTrackCC]===undefined){break;}var waitingFrag=this.waitingFragment;if(waitingFrag){var waitingFragCC=waitingFrag.frag.cc;if(this.videoTrackCC!==waitingFragCC){_logger.logger.warn('Waiting fragment CC ('+waitingFragCC+') does not match video track CC ('+this.videoTrackCC+')');this.waitingFragment=null;this.state=State.IDLE;}else{this.state=State.FRAG_LOADING;this.onFragLoaded(this.waitingFragment);this.waitingFragment=null;}}else{this.state=State.IDLE;}break;case State.STOPPED:case State.FRAG_LOADING:case State.PARSING:case State.PARSED:case State.ENDED:break;default:break;}}},{key:'onMediaAttached',value:function onMediaAttached(data){var media=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this);this.onvended=this.onMediaEnded.bind(this);media.addEventListener('seeking',this.onvseeking);media.addEventListener('ended',this.onvended);var config=this.config;if(this.tracks&&config.autoStartLoad){this.startLoad(config.startPosition);}}},{key:'onMediaDetaching',value:function onMediaDetaching(){var media=this.media;if(media&&media.ended){_logger.logger.log('MSE detaching and video ended, reset startPosition');this.startPosition=this.lastCurrentTime=0;}var tracks=this.tracks;if(tracks){tracks.forEach(function(track){if(track.details){track.details.fragments.forEach(function(fragment){fragment.loadCounter=undefined;});}});}if(media){media.removeEventListener('seeking',this.onvseeking);media.removeEventListener('ended',this.onvended);this.onvseeking=this.onvseeked=this.onvended=null;}this.media=this.mediaBuffer=null;this.loadedmetadata=false;this.stopLoad();}},{key:'onMediaSeeking',value:function onMediaSeeking(){if(this.state===State.ENDED){this.state=State.IDLE;}if(this.media){this.lastCurrentTime=this.media.currentTime;}if(this.fragLoadIdx!==undefined){this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold;}this.tick();}},{key:'onMediaEnded',value:function onMediaEnded(){this.startPosition=this.lastCurrentTime=0;}},{key:'onAudioTracksUpdated',value:function onAudioTracksUpdated(data){_logger.logger.log('audio tracks updated');this.tracks=data.audioTracks;}},{key:'onAudioTrackSwitching',value:function onAudioTrackSwitching(data){var altAudio=!!data.url;this.trackId=data.id;this.fragCurrent=null;this.state=State.PAUSED;this.waitingFragment=null;if(!altAudio){if(this.demuxer){this.demuxer.destroy();this.demuxer=null;}}else{if(!this.timer){this.timer=setInterval(this.ontick,100);}}if(altAudio){this.audioSwitch=true;this.state=State.IDLE;if(this.fragLoadIdx!==undefined){this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold;}}this.tick();}},{key:'onAudioTrackLoaded',value:function onAudioTrackLoaded(data){var newDetails=data.details,trackId=data.id,track=this.tracks[trackId],duration=newDetails.totalduration,sliding=0;_logger.logger.log('track '+trackId+' loaded ['+newDetails.startSN+','+newDetails.endSN+'],duration:'+duration);if(newDetails.live){var curDetails=track.details;if(curDetails&&newDetails.fragments.length>0){_levelHelper2.default.mergeDetails(curDetails,newDetails);sliding=newDetails.fragments[0].start;if(newDetails.PTSKnown){_logger.logger.log('live audio playlist sliding:'+sliding.toFixed(3));}else{_logger.logger.log('live audio playlist - outdated PTS, unknown sliding');}}else{newDetails.PTSKnown=false;_logger.logger.log('live audio playlist - first load, unknown sliding');}}else{newDetails.PTSKnown=false;}track.details=newDetails;if(!this.startFragRequested){if(this.startPosition===-1){var startTimeOffset=newDetails.startTimeOffset;if(!isNaN(startTimeOffset)){_logger.logger.log('start time offset found in playlist, adjust startPosition to '+startTimeOffset);this.startPosition=startTimeOffset;}else{this.startPosition=0;}}this.nextLoadPosition=this.startPosition;}if(this.state===State.WAITING_TRACK){this.state=State.IDLE;}this.tick();}},{key:'onKeyLoaded',value:function onKeyLoaded(){if(this.state===State.KEY_LOADING){this.state=State.IDLE;this.tick();}}},{key:'onFragLoaded',value:function onFragLoaded(data){var fragCurrent=this.fragCurrent,fragLoaded=data.frag;if(this.state===State.FRAG_LOADING&&fragCurrent&&fragLoaded.type==='audio'&&fragLoaded.level===fragCurrent.level&&fragLoaded.sn===fragCurrent.sn){var track=this.tracks[this.trackId],details=track.details,duration=details.totalduration,trackId=fragCurrent.level,sn=fragCurrent.sn,cc=fragCurrent.cc,audioCodec=this.config.defaultAudioCodec||track.audioCodec||'mp4a.40.2',stats=this.stats=data.stats;if(sn==='initSegment'){this.state=State.IDLE;stats.tparsed=stats.tbuffered=performance.now();details.initSegment.data=data.payload;this.hls.trigger(_events2.default.FRAG_BUFFERED,{stats:stats,frag:fragCurrent,id:'audio'});this.tick();}else{this.state=State.PARSING;this.appended=false;if(!this.demuxer){this.demuxer=new _demuxer2.default(this.hls,'audio');}var initPTS=this.initPTS[cc];var initSegmentData=details.initSegment?details.initSegment.data:[];if(details.initSegment||initPTS!==undefined){this.pendingBuffering=true;_logger.logger.log('Demuxing '+sn+' of ['+details.startSN+' ,'+details.endSN+'],track '+trackId);var accurateTimeOffset=false;this.demuxer.push(data.payload,initSegmentData,audioCodec,null,fragCurrent,duration,accurateTimeOffset,initPTS);}else{_logger.logger.log('unknown video PTS for continuity counter '+cc+', waiting for video PTS before demuxing audio frag '+sn+' of ['+details.startSN+' ,'+details.endSN+'],track '+trackId);this.waitingFragment=data;this.state=State.WAITING_INIT_PTS;}}}this.fragLoadError=0;}},{key:'onFragParsingInitSegment',value:function onFragParsingInitSegment(data){var fragCurrent=this.fragCurrent;var fragNew=data.frag;if(fragCurrent&&data.id==='audio'&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State.PARSING){var tracks=data.tracks,track=void 0;if(tracks.video){delete tracks.video;}track=tracks.audio;if(track){track.levelCodec=track.codec;track.id=data.id;this.hls.trigger(_events2.default.BUFFER_CODECS,tracks);_logger.logger.log('audio track:audio,container:'+track.container+',codecs[level/parsed]=['+track.levelCodec+'/'+track.codec+']');var initSegment=track.initSegment;if(initSegment){var appendObj={type:'audio',data:initSegment,parent:'audio',content:'initSegment'};if(this.audioSwitch){this.pendingData=[appendObj];}else{this.appended=true;this.pendingBuffering=true;this.hls.trigger(_events2.default.BUFFER_APPENDING,appendObj);}}this.tick();}}}},{key:'onFragParsingData',value:function onFragParsingData(data){var _this2=this;var fragCurrent=this.fragCurrent;var fragNew=data.frag;if(fragCurrent&&data.id==='audio'&&data.type==='audio'&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State.PARSING){var trackId=this.trackId,track=this.tracks[trackId],hls=this.hls;if(isNaN(data.endPTS)){data.endPTS=data.startPTS+fragCurrent.duration;data.endDTS=data.startDTS+fragCurrent.duration;}_logger.logger.log('parsed '+data.type+',PTS:['+data.startPTS.toFixed(3)+','+data.endPTS.toFixed(3)+'],DTS:['+data.startDTS.toFixed(3)+'/'+data.endDTS.toFixed(3)+'],nb:'+data.nb);_levelHelper2.default.updateFragPTSDTS(track.details,fragCurrent,data.startPTS,data.endPTS);var audioSwitch=this.audioSwitch,media=this.media,appendOnBufferFlush=false;if(audioSwitch&&media){if(media.readyState){var currentTime=media.currentTime;_logger.logger.log('switching audio track : currentTime:'+currentTime);if(currentTime>=data.startPTS){_logger.logger.log('switching audio track : flushing all audio');this.state=State.BUFFER_FLUSHING;hls.trigger(_events2.default.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:'audio'});appendOnBufferFlush=true;this.audioSwitch=false;hls.trigger(_events2.default.AUDIO_TRACK_SWITCHED,{id:trackId});}}else{this.audioSwitch=false;hls.trigger(_events2.default.AUDIO_TRACK_SWITCHED,{id:trackId});}}var pendingData=this.pendingData;if(!this.audioSwitch){[data.data1,data.data2].forEach(function(buffer){if(buffer&&buffer.length){pendingData.push({type:data.type,data:buffer,parent:'audio',content:'data'});}});if(!appendOnBufferFlush&&pendingData.length){pendingData.forEach(function(appendObj){if(_this2.state===State.PARSING){_this2.pendingBuffering=true;_this2.hls.trigger(_events2.default.BUFFER_APPENDING,appendObj);}});this.pendingData=[];this.appended=true;}}this.tick();}}},{key:'onFragParsed',value:function onFragParsed(data){var fragCurrent=this.fragCurrent;var fragNew=data.frag;if(fragCurrent&&data.id==='audio'&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State.PARSING){this.stats.tparsed=performance.now();this.state=State.PARSED;this._checkAppendedParsed();}}},{key:'onBufferCreated',value:function onBufferCreated(data){var audioTrack=data.tracks.audio;if(audioTrack){this.mediaBuffer=audioTrack.buffer;this.loadedmetadata=true;}}},{key:'onBufferAppended',value:function onBufferAppended(data){if(data.parent==='audio'){var state=this.state;if(state===State.PARSING||state===State.PARSED){this.pendingBuffering=data.pending>0;this._checkAppendedParsed();}}}},{key:'_checkAppendedParsed',value:function _checkAppendedParsed(){if(this.state===State.PARSED&&(!this.appended||!this.pendingBuffering)){var frag=this.fragCurrent,stats=this.stats,hls=this.hls;if(frag){this.fragPrevious=frag;stats.tbuffered=performance.now();hls.trigger(_events2.default.FRAG_BUFFERED,{stats:stats,frag:frag,id:'audio'});var media=this.mediaBuffer?this.mediaBuffer:this.media;_logger.logger.log('audio buffered : '+_timeRanges2.default.toString(media.buffered));if(this.audioSwitch&&this.appended){this.audioSwitch=false;hls.trigger(_events2.default.AUDIO_TRACK_SWITCHED,{id:this.trackId});}this.state=State.IDLE;}this.tick();}}},{key:'onError',value:function onError(data){var frag=data.frag;if(frag&&frag.type!=='audio'){return;}switch(data.details){case _errors.ErrorDetails.FRAG_LOAD_ERROR:case _errors.ErrorDetails.FRAG_LOAD_TIMEOUT:if(!data.fatal){var loadError=this.fragLoadError;if(loadError){loadError++;}else{loadError=1;}var config=this.config;if(loadError<=config.fragLoadingMaxRetry){this.fragLoadError=loadError;frag.loadCounter=0;var delay=Math.min(Math.pow(2,loadError-1)*config.fragLoadingRetryDelay,config.fragLoadingMaxRetryTimeout);_logger.logger.warn('audioStreamController: frag loading failed, retry in '+delay+' ms');this.retryDate=performance.now()+delay;this.state=State.FRAG_LOADING_WAITING_RETRY;}else{_logger.logger.error('audioStreamController: '+data.details+' reaches max retry, redispatch as fatal ...');data.fatal=true;this.state=State.ERROR;}}break;case _errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR:case _errors.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case _errors.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:case _errors.ErrorDetails.KEY_LOAD_ERROR:case _errors.ErrorDetails.KEY_LOAD_TIMEOUT:if(this.state!==State.ERROR){this.state=data.fatal?State.ERROR:State.IDLE;_logger.logger.warn('audioStreamController: '+data.details+' while loading frag,switch to '+this.state+' state ...');}break;case _errors.ErrorDetails.BUFFER_FULL_ERROR:if(data.parent==='audio'&&(this.state===State.PARSING||this.state===State.PARSED)){var media=this.mediaBuffer,currentTime=this.media.currentTime,mediaBuffered=media&&_bufferHelper2.default.isBuffered(media,currentTime)&&_bufferHelper2.default.isBuffered(media,currentTime+0.5);if(mediaBuffered){var _config=this.config;if(_config.maxMaxBufferLength>=_config.maxBufferLength){_config.maxMaxBufferLength/=2;_logger.logger.warn('audio:reduce max buffer length to '+_config.maxMaxBufferLength+'s');this.fragLoadIdx+=2*_config.fragLoadingLoopThreshold;}this.state=State.IDLE;}else{_logger.logger.warn('buffer full error also media.currentTime is not buffered, flush audio buffer');this.fragCurrent=null;this.state=State.BUFFER_FLUSHING;this.hls.trigger(_events2.default.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:'audio'});}}break;default:break;}}},{key:'onBufferFlushed',value:function onBufferFlushed(){var _this3=this;var pendingData=this.pendingData;if(pendingData&&pendingData.length){_logger.logger.log('appending pending audio data on Buffer Flushed');pendingData.forEach(function(appendObj){_this3.hls.trigger(_events2.default.BUFFER_APPENDING,appendObj);});this.appended=true;this.pendingData=[];this.state=State.PARSED;}else{this.state=State.IDLE;this.fragPrevious=null;this.tick();}}},{key:'state',set:function set(nextState){if(this.state!==nextState){var previousState=this.state;this._state=nextState;_logger.logger.log('audio stream:'+previousState+'->'+nextState);}},get:function get(){return this._state;}}]);return AudioStreamController;}(_eventHandler2.default);exports.default=AudioStreamController;},{"25":25,"33":33,"34":34,"35":35,"37":37,"38":38,"48":48,"51":51,"54":54,"55":55}],7:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var AudioTrackController=function(_EventHandler){_inherits$$1(AudioTrackController,_EventHandler);function AudioTrackController(hls){_classCallCheck$$1(this,AudioTrackController);var _this=_possibleConstructorReturn$$1(this,(AudioTrackController.__proto__||Object.getPrototypeOf(AudioTrackController)).call(this,hls,_events2.default.MANIFEST_LOADING,_events2.default.MANIFEST_LOADED,_events2.default.AUDIO_TRACK_LOADED));_this.ticks=0;_this.ontick=_this.tick.bind(_this);return _this;}_createClass$$1(AudioTrackController,[{key:'destroy',value:function destroy(){_eventHandler2.default.prototype.destroy.call(this);}},{key:'tick',value:function tick(){this.ticks++;if(this.ticks===1){this.doTick();if(this.ticks>1){setTimeout(this.tick,1);}this.ticks=0;}}},{key:'doTick',value:function doTick(){this.updateTrack(this.trackId);}},{key:'onManifestLoading',value:function onManifestLoading(){this.tracks=[];this.trackId=-1;}},{key:'onManifestLoaded',value:function onManifestLoaded(data){var _this2=this;var tracks=data.audioTracks||[];var defaultFound=false;this.tracks=tracks;this.hls.trigger(_events2.default.AUDIO_TRACKS_UPDATED,{audioTracks:tracks});var id=0;tracks.forEach(function(track){if(track.default){_this2.audioTrack=id;defaultFound=true;return;}id++;});if(defaultFound===false&&tracks.length){_logger.logger.log('no default audio track defined, use first audio track as default');this.audioTrack=0;}}},{key:'onAudioTrackLoaded',value:function onAudioTrackLoaded(data){if(data.id<this.tracks.length){_logger.logger.log('audioTrack '+data.id+' loaded');this.tracks[data.id].details=data.details;if(data.details.live&&!this.timer){this.timer=setInterval(this.ontick,1000*data.details.targetduration);}if(!data.details.live&&this.timer){clearInterval(this.timer);this.timer=null;}}}},{key:'setAudioTrackInternal',value:function setAudioTrackInternal(newId){if(newId>=0&&newId<this.tracks.length){if(this.timer){clearInterval(this.timer);this.timer=null;}this.trackId=newId;_logger.logger.log('switching to audioTrack '+newId);var audioTrack=this.tracks[newId],hls=this.hls,type=audioTrack.type,url=audioTrack.url,eventObj={id:newId,type:type,url:url};hls.trigger(_events2.default.AUDIO_TRACK_SWITCH,eventObj);hls.trigger(_events2.default.AUDIO_TRACK_SWITCHING,eventObj);var details=audioTrack.details;if(url&&(details===undefined||details.live===true)){_logger.logger.log('(re)loading playlist for audioTrack '+newId);hls.trigger(_events2.default.AUDIO_TRACK_LOADING,{url:url,id:newId});}}}},{key:'updateTrack',value:function updateTrack(newId){if(newId>=0&&newId<this.tracks.length){if(this.timer){clearInterval(this.timer);this.timer=null;}this.trackId=newId;_logger.logger.log('updating audioTrack '+newId);var audioTrack=this.tracks[newId],url=audioTrack.url;var details=audioTrack.details;if(url&&(details===undefined||details.live===true)){_logger.logger.log('(re)loading playlist for audioTrack '+newId);this.hls.trigger(_events2.default.AUDIO_TRACK_LOADING,{url:url,id:newId});}}}},{key:'audioTracks',get:function get(){return this.tracks;}},{key:'audioTrack',get:function get(){return this.trackId;},set:function set(audioTrackId){if(this.trackId!==audioTrackId||this.tracks[audioTrackId].details===undefined){this.setAudioTrackInternal(audioTrackId);}}}]);return AudioTrackController;}(_eventHandler2.default);exports.default=AudioTrackController;},{"34":34,"35":35,"54":54}],8:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _logger=_dereq_(54);var _errors=_dereq_(33);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var BufferController=function(_EventHandler){_inherits$$1(BufferController,_EventHandler);function BufferController(hls){_classCallCheck$$1(this,BufferController);var _this=_possibleConstructorReturn$$1(this,(BufferController.__proto__||Object.getPrototypeOf(BufferController)).call(this,hls,_events2.default.MEDIA_ATTACHING,_events2.default.MEDIA_DETACHING,_events2.default.MANIFEST_PARSED,_events2.default.BUFFER_RESET,_events2.default.BUFFER_APPENDING,_events2.default.BUFFER_CODECS,_events2.default.BUFFER_EOS,_events2.default.BUFFER_FLUSHING,_events2.default.LEVEL_PTS_UPDATED,_events2.default.LEVEL_UPDATED));_this._msDuration=null;_this._levelDuration=null;_this.onsbue=_this.onSBUpdateEnd.bind(_this);_this.onsbe=_this.onSBUpdateError.bind(_this);_this.pendingTracks={};_this.tracks={};return _this;}_createClass$$1(BufferController,[{key:'destroy',value:function destroy(){_eventHandler2.default.prototype.destroy.call(this);}},{key:'onLevelPtsUpdated',value:function onLevelPtsUpdated(data){var type=data.type;var audioTrack=this.tracks.audio;if(type==='audio'&&audioTrack&&audioTrack.container==='audio/mpeg'){var audioBuffer=this.sourceBuffer.audio;var delta=Math.abs(audioBuffer.timestampOffset-data.start);if(delta>0.1){var updating=audioBuffer.updating;try{audioBuffer.abort();}catch(err){updating=true;_logger.logger.warn('can not abort audio buffer: '+err);}if(!updating){_logger.logger.warn('change mpeg audio timestamp offset from '+audioBuffer.timestampOffset+' to '+data.start);audioBuffer.timestampOffset=data.start;}else{this.audioTimestampOffset=data.start;}}}}},{key:'onManifestParsed',value:function onManifestParsed(data){var audioExpected=data.audio,videoExpected=data.video,sourceBufferNb=0;if(data.altAudio&&(audioExpected||videoExpected)){sourceBufferNb=(audioExpected?1:0)+(videoExpected?1:0);_logger.logger.log(sourceBufferNb+' sourceBuffer(s) expected');}this.sourceBufferNb=sourceBufferNb;}},{key:'onMediaAttaching',value:function onMediaAttaching(data){var media=this.media=data.media;if(media){var ms=this.mediaSource=new MediaSource();this.onmso=this.onMediaSourceOpen.bind(this);this.onmse=this.onMediaSourceEnded.bind(this);this.onmsc=this.onMediaSourceClose.bind(this);ms.addEventListener('sourceopen',this.onmso);ms.addEventListener('sourceended',this.onmse);ms.addEventListener('sourceclose',this.onmsc);media.src=URL.createObjectURL(ms);}}},{key:'onMediaDetaching',value:function onMediaDetaching(){_logger.logger.log('media source detaching');var ms=this.mediaSource;if(ms){if(ms.readyState==='open'){try{ms.endOfStream();}catch(err){_logger.logger.warn('onMediaDetaching:'+err.message+' while calling endOfStream');}}ms.removeEventListener('sourceopen',this.onmso);ms.removeEventListener('sourceended',this.onmse);ms.removeEventListener('sourceclose',this.onmsc);if(this.media){URL.revokeObjectURL(this.media.src);this.media.removeAttribute('src');this.media.load();}this.mediaSource=null;this.media=null;this.pendingTracks={};this.tracks={};this.sourceBuffer={};this.flushRange=[];this.segments=[];this.appended=0;}this.onmso=this.onmse=this.onmsc=null;this.hls.trigger(_events2.default.MEDIA_DETACHED);}},{key:'onMediaSourceOpen',value:function onMediaSourceOpen(){_logger.logger.log('media source opened');this.hls.trigger(_events2.default.MEDIA_ATTACHED,{media:this.media});var mediaSource=this.mediaSource;if(mediaSource){mediaSource.removeEventListener('sourceopen',this.onmso);}this.checkPendingTracks();}},{key:'checkPendingTracks',value:function checkPendingTracks(){var pendingTracks=this.pendingTracks,pendingTracksNb=Object.keys(pendingTracks).length;if(pendingTracksNb&&(this.sourceBufferNb<=pendingTracksNb||this.sourceBufferNb===0)){this.createSourceBuffers(pendingTracks);this.pendingTracks={};this.doAppending();}}},{key:'onMediaSourceClose',value:function onMediaSourceClose(){_logger.logger.log('media source closed');}},{key:'onMediaSourceEnded',value:function onMediaSourceEnded(){_logger.logger.log('media source ended');}},{key:'onSBUpdateEnd',value:function onSBUpdateEnd(){if(this.audioTimestampOffset){var audioBuffer=this.sourceBuffer.audio;_logger.logger.warn('change mpeg audio timestamp offset from '+audioBuffer.timestampOffset+' to '+this.audioTimestampOffset);audioBuffer.timestampOffset=this.audioTimestampOffset;delete this.audioTimestampOffset;}if(this._needsFlush){this.doFlush();}if(this._needsEos){this.checkEos();}this.appending=false;var parent=this.parent;var pending=this.segments.reduce(function(counter,segment){return segment.parent===parent?counter+1:counter;},0);this.hls.trigger(_events2.default.BUFFER_APPENDED,{parent:parent,pending:pending});if(!this._needsFlush){this.doAppending();}this.updateMediaElementDuration();}},{key:'onSBUpdateError',value:function onSBUpdateError(event){_logger.logger.error('sourceBuffer error:',event);this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:false});}},{key:'onBufferReset',value:function onBufferReset(){var sourceBuffer=this.sourceBuffer;for(var type in sourceBuffer){var sb=sourceBuffer[type];try{this.mediaSource.removeSourceBuffer(sb);sb.removeEventListener('updateend',this.onsbue);sb.removeEventListener('error',this.onsbe);}catch(err){}}this.sourceBuffer={};this.flushRange=[];this.segments=[];this.appended=0;}},{key:'onBufferCodecs',value:function onBufferCodecs(tracks){if(Object.keys(this.sourceBuffer).length===0){for(var trackName in tracks){this.pendingTracks[trackName]=tracks[trackName];}var mediaSource=this.mediaSource;if(mediaSource&&mediaSource.readyState==='open'){this.checkPendingTracks();}}}},{key:'createSourceBuffers',value:function createSourceBuffers(tracks){var sourceBuffer=this.sourceBuffer,mediaSource=this.mediaSource;for(var trackName in tracks){if(!sourceBuffer[trackName]){var track=tracks[trackName];var codec=track.levelCodec||track.codec;var mimeType=track.container+';codecs='+codec;_logger.logger.log('creating sourceBuffer('+mimeType+')');try{var sb=sourceBuffer[trackName]=mediaSource.addSourceBuffer(mimeType);sb.addEventListener('updateend',this.onsbue);sb.addEventListener('error',this.onsbe);this.tracks[trackName]={codec:codec,container:track.container};track.buffer=sb;}catch(err){_logger.logger.error('error while trying to add sourceBuffer:'+err.message);this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:false,err:err,mimeType:mimeType});}}}this.hls.trigger(_events2.default.BUFFER_CREATED,{tracks:tracks});}},{key:'onBufferAppending',value:function onBufferAppending(data){if(!this._needsFlush){if(!this.segments){this.segments=[data];}else{this.segments.push(data);}this.doAppending();}}},{key:'onBufferAppendFail',value:function onBufferAppendFail(data){_logger.logger.error('sourceBuffer error:',data.event);this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:false});}},{key:'onBufferEos',value:function onBufferEos(data){var sb=this.sourceBuffer;var dataType=data.type;for(var type in sb){if(!dataType||type===dataType){if(!sb[type].ended){sb[type].ended=true;_logger.logger.log(type+' sourceBuffer now EOS');}}}this.checkEos();}},{key:'checkEos',value:function checkEos(){var sb=this.sourceBuffer,mediaSource=this.mediaSource;if(!mediaSource||mediaSource.readyState!=='open'){this._needsEos=false;return;}for(var type in sb){var sbobj=sb[type];if(!sbobj.ended){return;}if(sbobj.updating){this._needsEos=true;return;}}_logger.logger.log('all media data available, signal endOfStream() to MediaSource and stop loading fragment');try{mediaSource.endOfStream();}catch(e){_logger.logger.warn('exception while calling mediaSource.endOfStream()');}this._needsEos=false;}},{key:'onBufferFlushing',value:function onBufferFlushing(data){this.flushRange.push({start:data.startOffset,end:data.endOffset,type:data.type});this.flushBufferCounter=0;this.doFlush();}},{key:'onLevelUpdated',value:function onLevelUpdated(event){var details=event.details;if(details.fragments.length===0){return;}this._levelDuration=details.totalduration+details.fragments[0].start;this.updateMediaElementDuration();}},{key:'updateMediaElementDuration',value:function updateMediaElementDuration(){var media=this.media,mediaSource=this.mediaSource,sourceBuffer=this.sourceBuffer,levelDuration=this._levelDuration;if(levelDuration===null||!media||!mediaSource||!sourceBuffer||media.readyState===0||mediaSource.readyState!=='open'){return;}for(var type in sourceBuffer){if(sourceBuffer[type].updating){return;}}if(this._msDuration===null){this._msDuration=mediaSource.duration;}var duration=media.duration;if(levelDuration>this._msDuration&&levelDuration>duration||duration===Infinity||isNaN(duration)){_logger.logger.log('Updating mediasource duration to '+levelDuration.toFixed(3));this._msDuration=mediaSource.duration=levelDuration;}}},{key:'doFlush',value:function doFlush(){while(this.flushRange.length){var range=this.flushRange[0];if(this.flushBuffer(range.start,range.end,range.type)){this.flushRange.shift();this.flushBufferCounter=0;}else{this._needsFlush=true;return;}}if(this.flushRange.length===0){this._needsFlush=false;var appended=0;var sourceBuffer=this.sourceBuffer;try{for(var type in sourceBuffer){appended+=sourceBuffer[type].buffered.length;}}catch(error){_logger.logger.error('error while accessing sourceBuffer.buffered');}this.appended=appended;this.hls.trigger(_events2.default.BUFFER_FLUSHED);}}},{key:'doAppending',value:function doAppending(){var hls=this.hls,sourceBuffer=this.sourceBuffer,segments=this.segments;if(Object.keys(sourceBuffer).length){if(this.media.error){this.segments=[];_logger.logger.error('trying to append although a media error occured, flush segment and abort');return;}if(this.appending){return;}if(segments&&segments.length){var segment=segments.shift();try{var type=segment.type,sb=sourceBuffer[type];if(sb){if(!sb.updating){sb.ended=false;this.parent=segment.parent;sb.appendBuffer(segment.data);this.appendError=0;this.appended++;this.appending=true;}else{segments.unshift(segment);}}else{this.onSBUpdateEnd();}}catch(err){_logger.logger.error('error while trying to append buffer:'+err.message);segments.unshift(segment);var event={type:_errors.ErrorTypes.MEDIA_ERROR,parent:segment.parent};if(err.code!==22){if(this.appendError){this.appendError++;}else{this.appendError=1;}event.details=_errors.ErrorDetails.BUFFER_APPEND_ERROR;if(this.appendError>hls.config.appendErrorMaxRetry){_logger.logger.log('fail '+hls.config.appendErrorMaxRetry+' times to append segment in sourceBuffer');segments=[];event.fatal=true;hls.trigger(_events2.default.ERROR,event);return;}else{event.fatal=false;hls.trigger(_events2.default.ERROR,event);}}else{this.segments=[];event.details=_errors.ErrorDetails.BUFFER_FULL_ERROR;event.fatal=false;hls.trigger(_events2.default.ERROR,event);return;}}}}}},{key:'flushBuffer',value:function flushBuffer(startOffset,endOffset,typeIn){var sb,i,bufStart,bufEnd,flushStart,flushEnd,sourceBuffer=this.sourceBuffer;if(Object.keys(sourceBuffer).length){_logger.logger.log('flushBuffer,pos/start/end: '+this.media.currentTime.toFixed(3)+'/'+startOffset+'/'+endOffset);if(this.flushBufferCounter<this.appended){for(var type in sourceBuffer){if(typeIn&&type!==typeIn){continue;}sb=sourceBuffer[type];sb.ended=false;if(!sb.updating){try{for(i=0;i<sb.buffered.length;i++){bufStart=sb.buffered.start(i);bufEnd=sb.buffered.end(i);if(navigator.userAgent.toLowerCase().indexOf('firefox')!==-1&&endOffset===Number.POSITIVE_INFINITY){flushStart=startOffset;flushEnd=endOffset;}else{flushStart=Math.max(bufStart,startOffset);flushEnd=Math.min(bufEnd,endOffset);}if(Math.min(flushEnd,bufEnd)-flushStart>0.5){this.flushBufferCounter++;_logger.logger.log('flush '+type+' ['+flushStart+','+flushEnd+'], of ['+bufStart+','+bufEnd+'], pos:'+this.media.currentTime);sb.remove(flushStart,flushEnd);return false;}}}catch(e){_logger.logger.warn('exception while accessing sourcebuffer, it might have been removed from MediaSource');}}else{_logger.logger.warn('cannot flush, sb updating in progress');return false;}}}else{_logger.logger.warn('abort flushing too many retries');}_logger.logger.log('buffer flushed');}return true;}}]);return BufferController;}(_eventHandler2.default);exports.default=BufferController;},{"33":33,"34":34,"35":35,"54":54}],9:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var CapLevelController=function(_EventHandler){_inherits$$1(CapLevelController,_EventHandler);function CapLevelController(hls){_classCallCheck$$1(this,CapLevelController);return _possibleConstructorReturn$$1(this,(CapLevelController.__proto__||Object.getPrototypeOf(CapLevelController)).call(this,hls,_events2.default.FPS_DROP_LEVEL_CAPPING,_events2.default.MEDIA_ATTACHING,_events2.default.MANIFEST_PARSED));}_createClass$$1(CapLevelController,[{key:'destroy',value:function destroy(){if(this.hls.config.capLevelToPlayerSize){this.media=this.restrictedLevels=null;this.autoLevelCapping=Number.POSITIVE_INFINITY;if(this.timer){this.timer=clearInterval(this.timer);}}}},{key:'onFpsDropLevelCapping',value:function onFpsDropLevelCapping(data){if(CapLevelController.isLevelAllowed(data.droppedLevel,this.restrictedLevels)){this.restrictedLevels.push(data.droppedLevel);}}},{key:'onMediaAttaching',value:function onMediaAttaching(data){this.media=data.media instanceof HTMLVideoElement?data.media:null;}},{key:'onManifestParsed',value:function onManifestParsed(data){var hls=this.hls;this.restrictedLevels=[];if(hls.config.capLevelToPlayerSize){this.autoLevelCapping=Number.POSITIVE_INFINITY;this.levels=data.levels;hls.firstLevel=this.getMaxLevel(data.firstLevel);clearInterval(this.timer);this.timer=setInterval(this.detectPlayerSize.bind(this),1000);this.detectPlayerSize();}}},{key:'detectPlayerSize',value:function detectPlayerSize(){if(this.media){var levelsLength=this.levels?this.levels.length:0;if(levelsLength){var hls=this.hls;hls.autoLevelCapping=this.getMaxLevel(levelsLength-1);if(hls.autoLevelCapping>this.autoLevelCapping){hls.streamController.nextLevelSwitch();}this.autoLevelCapping=hls.autoLevelCapping;}}}},{key:'getMaxLevel',value:function getMaxLevel(capLevelIndex){var _this2=this;if(!this.levels){return-1;}var validLevels=this.levels.filter(function(level,index){return CapLevelController.isLevelAllowed(index,_this2.restrictedLevels)&&index<=capLevelIndex;});return CapLevelController.getMaxLevelByMediaSize(validLevels,this.mediaWidth,this.mediaHeight);}},{key:'mediaWidth',get:function get(){var width=void 0;var media=this.media;if(media){width=media.width||media.clientWidth||media.offsetWidth;width*=CapLevelController.contentScaleFactor;}return width;}},{key:'mediaHeight',get:function get(){var height=void 0;var media=this.media;if(media){height=media.height||media.clientHeight||media.offsetHeight;height*=CapLevelController.contentScaleFactor;}return height;}}],[{key:'isLevelAllowed',value:function isLevelAllowed(level){var restrictedLevels=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return restrictedLevels.indexOf(level)===-1;}},{key:'getMaxLevelByMediaSize',value:function getMaxLevelByMediaSize(levels,width,height){if(!levels||levels&&!levels.length){return-1;}var atGreatestBandiwdth=function atGreatestBandiwdth(curLevel,nextLevel){if(!nextLevel){return true;}return curLevel.width!==nextLevel.width||curLevel.height!==nextLevel.height;};var maxLevelIndex=levels.length-1;for(var i=0;i<levels.length;i+=1){var level=levels[i];if((level.width>=width||level.height>=height)&&atGreatestBandiwdth(level,levels[i+1])){maxLevelIndex=i;break;}}return maxLevelIndex;}},{key:'contentScaleFactor',get:function get(){var pixelRatio=1;try{pixelRatio=window.devicePixelRatio;}catch(e){}return pixelRatio;}}]);return CapLevelController;}(_eventHandler2.default);exports.default=CapLevelController;},{"34":34,"35":35}],10:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var FPSController=function(_EventHandler){_inherits$$1(FPSController,_EventHandler);function FPSController(hls){_classCallCheck$$1(this,FPSController);return _possibleConstructorReturn$$1(this,(FPSController.__proto__||Object.getPrototypeOf(FPSController)).call(this,hls,_events2.default.MEDIA_ATTACHING));}_createClass$$1(FPSController,[{key:'destroy',value:function destroy(){if(this.timer){clearInterval(this.timer);}this.isVideoPlaybackQualityAvailable=false;}},{key:'onMediaAttaching',value:function onMediaAttaching(data){var config=this.hls.config;if(config.capLevelOnFPSDrop){var video=this.video=data.media instanceof HTMLVideoElement?data.media:null;if(typeof video.getVideoPlaybackQuality==='function'){this.isVideoPlaybackQualityAvailable=true;}clearInterval(this.timer);this.timer=setInterval(this.checkFPSInterval.bind(this),config.fpsDroppedMonitoringPeriod);}}},{key:'checkFPS',value:function checkFPS(video,decodedFrames,droppedFrames){var currentTime=performance.now();if(decodedFrames){if(this.lastTime){var currentPeriod=currentTime-this.lastTime,currentDropped=droppedFrames-this.lastDroppedFrames,currentDecoded=decodedFrames-this.lastDecodedFrames,droppedFPS=1000*currentDropped/currentPeriod,hls=this.hls;hls.trigger(_events2.default.FPS_DROP,{currentDropped:currentDropped,currentDecoded:currentDecoded,totalDroppedFrames:droppedFrames});if(droppedFPS>0){if(currentDropped>hls.config.fpsDroppedMonitoringThreshold*currentDecoded){var currentLevel=hls.currentLevel;_logger.logger.warn('drop FPS ratio greater than max allowed value for currentLevel: '+currentLevel);if(currentLevel>0&&(hls.autoLevelCapping===-1||hls.autoLevelCapping>=currentLevel)){currentLevel=currentLevel-1;hls.trigger(_events2.default.FPS_DROP_LEVEL_CAPPING,{level:currentLevel,droppedLevel:hls.currentLevel});hls.autoLevelCapping=currentLevel;hls.streamController.nextLevelSwitch();}}}}this.lastTime=currentTime;this.lastDroppedFrames=droppedFrames;this.lastDecodedFrames=decodedFrames;}}},{key:'checkFPSInterval',value:function checkFPSInterval(){var video=this.video;if(video){if(this.isVideoPlaybackQualityAvailable){var videoPlaybackQuality=video.getVideoPlaybackQuality();this.checkFPS(video,videoPlaybackQuality.totalVideoFrames,videoPlaybackQuality.droppedVideoFrames);}else{this.checkFPS(video,video.webkitDecodedFrameCount,video.webkitDroppedFrameCount);}}}}]);return FPSController;}(_eventHandler2.default);exports.default=FPSController;},{"34":34,"35":35,"54":54}],11:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _id=_dereq_(27);var _id2=_interopRequireDefault(_id);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var ID3TrackController=function(_EventHandler){_inherits$$1(ID3TrackController,_EventHandler);function ID3TrackController(hls){_classCallCheck$$1(this,ID3TrackController);var _this=_possibleConstructorReturn$$1(this,(ID3TrackController.__proto__||Object.getPrototypeOf(ID3TrackController)).call(this,hls,_events2.default.MEDIA_ATTACHED,_events2.default.MEDIA_DETACHING,_events2.default.FRAG_PARSING_METADATA));_this.id3Track=undefined;_this.media=undefined;return _this;}_createClass$$1(ID3TrackController,[{key:'destroy',value:function destroy(){_eventHandler2.default.prototype.destroy.call(this);}},{key:'onMediaAttached',value:function onMediaAttached(data){this.media=data.media;if(!this.media){return;}this.id3Track=this.media.addTextTrack('metadata','id3');this.id3Track.mode='hidden';}},{key:'onMediaDetaching',value:function onMediaDetaching(){this.media=undefined;}},{key:'onFragParsingMetadata',value:function onFragParsingMetadata(data){var fragment=data.frag;var samples=data.samples;var Cue=window.WebKitDataCue||window.VTTCue||window.TextTrackCue;for(var i=0;i<samples.length;i++){var frames=_id2.default.getID3Frames(samples[i].data);if(frames){var startTime=samples[i].pts;var endTime=i<samples.length-1?samples[i+1].pts:fragment.endPTS;if(startTime===endTime){endTime+=0.0001;}for(var j=0;j<frames.length;j++){var frame=frames[j];if(!_id2.default.isTimeStampFrame(frame)){var cue=new Cue(startTime,endTime,'');cue.value=frame;this.id3Track.addCue(cue);}}}}}}]);return ID3TrackController;}(_eventHandler2.default);exports.default=ID3TrackController;},{"27":27,"34":34,"35":35}],12:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _logger=_dereq_(54);var _errors=_dereq_(33);var _bufferHelper=_dereq_(37);var _bufferHelper2=_interopRequireDefault(_bufferHelper);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var LevelController=function(_EventHandler){_inherits$$1(LevelController,_EventHandler);function LevelController(hls){_classCallCheck$$1(this,LevelController);var _this=_possibleConstructorReturn$$1(this,(LevelController.__proto__||Object.getPrototypeOf(LevelController)).call(this,hls,_events2.default.MANIFEST_LOADED,_events2.default.LEVEL_LOADED,_events2.default.FRAG_LOADED,_events2.default.ERROR));_this.ontick=_this.tick.bind(_this);_this._manualLevel=-1;return _this;}_createClass$$1(LevelController,[{key:'destroy',value:function destroy(){if(this.timer){clearTimeout(this.timer);this.timer=null;}this._manualLevel=-1;}},{key:'startLoad',value:function startLoad(){this.canload=true;var levels=this._levels;if(levels){levels.forEach(function(level){level.loadError=0;var levelDetails=level.details;if(levelDetails&&levelDetails.live){level.details=undefined;}});}if(this.timer){this.tick();}}},{key:'stopLoad',value:function stopLoad(){this.canload=false;}},{key:'onManifestLoaded',value:function onManifestLoaded(data){var levels0=[],levels=[],bitrateStart,bitrateSet={},videoCodecFound=false,audioCodecFound=false,hls=this.hls,brokenmp4inmp3=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),checkSupported=function checkSupported(type,codec){return MediaSource.isTypeSupported(type+'/mp4;codecs='+codec);};data.levels.forEach(function(level){if(level.videoCodec){videoCodecFound=true;}if(brokenmp4inmp3&&level.audioCodec&&level.audioCodec.indexOf('mp4a.40.34')!==-1){level.audioCodec=undefined;}if(level.audioCodec||level.attrs&&level.attrs.AUDIO){audioCodecFound=true;}var redundantLevelId=bitrateSet[level.bitrate];if(redundantLevelId===undefined){bitrateSet[level.bitrate]=levels0.length;level.url=[level.url];level.urlId=0;levels0.push(level);}else{levels0[redundantLevelId].url.push(level.url);}});if(videoCodecFound&&audioCodecFound){levels0.forEach(function(level){if(level.videoCodec){levels.push(level);}});}else{levels=levels0;}levels=levels.filter(function(level){var audioCodec=level.audioCodec,videoCodec=level.videoCodec;return(!audioCodec||checkSupported('audio',audioCodec))&&(!videoCodec||checkSupported('video',videoCodec));});if(levels.length){bitrateStart=levels[0].bitrate;levels.sort(function(a,b){return a.bitrate-b.bitrate;});this._levels=levels;for(var i=0;i<levels.length;i++){if(levels[i].bitrate===bitrateStart){this._firstLevel=i;_logger.logger.log('manifest loaded,'+levels.length+' level(s) found, first bitrate:'+bitrateStart);break;}}hls.trigger(_events2.default.MANIFEST_PARSED,{levels:levels,firstLevel:this._firstLevel,stats:data.stats,audio:audioCodecFound,video:videoCodecFound,altAudio:data.audioTracks.length>0});}else{hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:true,url:hls.url,reason:'no level with compatible codecs found in manifest'});}return;}},{key:'setLevelInternal',value:function setLevelInternal(newLevel){var levels=this._levels;var hls=this.hls;if(newLevel>=0&&newLevel<levels.length){if(this.timer){clearTimeout(this.timer);this.timer=null;}if(this._level!==newLevel){_logger.logger.log('switching to level '+newLevel);this._level=newLevel;var levelProperties=levels[newLevel];levelProperties.level=newLevel;hls.trigger(_events2.default.LEVEL_SWITCH,levelProperties);hls.trigger(_events2.default.LEVEL_SWITCHING,levelProperties);}var level=levels[newLevel],levelDetails=level.details;if(!levelDetails||levelDetails.live===true){var urlId=level.urlId;hls.trigger(_events2.default.LEVEL_LOADING,{url:level.url[urlId],level:newLevel,id:urlId});}}else{hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.OTHER_ERROR,details:_errors.ErrorDetails.LEVEL_SWITCH_ERROR,level:newLevel,fatal:false,reason:'invalid level idx'});}}},{key:'onError',value:function onError(data){if(data.fatal){return;}var details=data.details,hls=this.hls,levelId=void 0,level=void 0,levelError=false;switch(details){case _errors.ErrorDetails.FRAG_LOAD_ERROR:case _errors.ErrorDetails.FRAG_LOAD_TIMEOUT:case _errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR:case _errors.ErrorDetails.KEY_LOAD_ERROR:case _errors.ErrorDetails.KEY_LOAD_TIMEOUT:levelId=data.frag.level;break;case _errors.ErrorDetails.LEVEL_LOAD_ERROR:case _errors.ErrorDetails.LEVEL_LOAD_TIMEOUT:levelId=data.context.level;levelError=true;break;case _errors.ErrorDetails.REMUX_ALLOC_ERROR:levelId=data.level;break;default:break;}if(levelId!==undefined){level=this._levels[levelId];if(!level.loadError){level.loadError=1;}else{level.loadError++;}var nbRedundantLevel=level.url.length;if(nbRedundantLevel>1&&level.loadError<nbRedundantLevel){level.urlId=(level.urlId+1)%nbRedundantLevel;level.details=undefined;_logger.logger.warn('level controller,'+details+' for level '+levelId+': switching to redundant stream id '+level.urlId);}else{var recoverable=this._manualLevel===-1&&levelId;if(recoverable){_logger.logger.warn('level controller,'+details+': switch-down for next fragment');hls.nextAutoLevel=Math.max(0,levelId-1);}else if(level&&level.details&&level.details.live){_logger.logger.warn('level controller,'+details+' on live stream, discard');if(levelError){this._level=undefined;}}else if(details===_errors.ErrorDetails.LEVEL_LOAD_ERROR||details===_errors.ErrorDetails.LEVEL_LOAD_TIMEOUT){var media=hls.media,mediaBuffered=media&&_bufferHelper2.default.isBuffered(media,media.currentTime)&&_bufferHelper2.default.isBuffered(media,media.currentTime+0.5);if(mediaBuffered){var retryDelay=hls.config.levelLoadingRetryDelay;_logger.logger.warn('level controller,'+details+', but media buffered, retry in '+retryDelay+'ms');this.timer=setTimeout(this.ontick,retryDelay);data.levelRetry=true;}else{_logger.logger.error('cannot recover '+details+' error');this._level=undefined;if(this.timer){clearTimeout(this.timer);this.timer=null;}data.fatal=true;}}}}}},{key:'onFragLoaded',value:function onFragLoaded(data){var fragLoaded=data.frag;if(fragLoaded&&fragLoaded.type==='main'){var level=this._levels[fragLoaded.level];if(level){level.loadError=0;}}}},{key:'onLevelLoaded',value:function onLevelLoaded(data){var levelId=data.level;if(levelId===this._level){var curLevel=this._levels[levelId];curLevel.loadError=0;var newDetails=data.details;if(newDetails.live){var reloadInterval=1000*(newDetails.averagetargetduration?newDetails.averagetargetduration:newDetails.targetduration),curDetails=curLevel.details;if(curDetails&&newDetails.endSN===curDetails.endSN){reloadInterval/=2;_logger.logger.log('same live playlist, reload twice faster');}reloadInterval-=performance.now()-data.stats.trequest;reloadInterval=Math.max(1000,Math.round(reloadInterval));_logger.logger.log('live playlist, reload in '+reloadInterval+' ms');this.timer=setTimeout(this.ontick,reloadInterval);}else{this.timer=null;}}}},{key:'tick',value:function tick(){var levelId=this._level;if(levelId!==undefined&&this.canload){var level=this._levels[levelId];if(level&&level.url){var urlId=level.urlId;this.hls.trigger(_events2.default.LEVEL_LOADING,{url:level.url[urlId],level:levelId,id:urlId});}}}},{key:'levels',get:function get(){return this._levels;}},{key:'level',get:function get(){return this._level;},set:function set(newLevel){var levels=this._levels;if(levels&&levels.length>newLevel){if(this._level!==newLevel||levels[newLevel].details===undefined){this.setLevelInternal(newLevel);}}}},{key:'manualLevel',get:function get(){return this._manualLevel;},set:function set(newLevel){this._manualLevel=newLevel;if(this._startLevel===undefined){this._startLevel=newLevel;}if(newLevel!==-1){this.level=newLevel;}}},{key:'firstLevel',get:function get(){return this._firstLevel;},set:function set(newLevel){this._firstLevel=newLevel;}},{key:'startLevel',get:function get(){if(this._startLevel===undefined){var configStartLevel=this.hls.config.startLevel;if(configStartLevel!==undefined){return configStartLevel;}else{return this._firstLevel;}}else{return this._startLevel;}},set:function set(newLevel){this._startLevel=newLevel;}},{key:'nextLoadLevel',get:function get(){if(this._manualLevel!==-1){return this._manualLevel;}else{return this.hls.nextAutoLevel;}},set:function set(nextLevel){this.level=nextLevel;if(this._manualLevel===-1){this.hls.nextAutoLevel=nextLevel;}}}]);return LevelController;}(_eventHandler2.default);exports.default=LevelController;},{"33":33,"34":34,"35":35,"37":37,"54":54}],13:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _binarySearch=_dereq_(48);var _binarySearch2=_interopRequireDefault(_binarySearch);var _bufferHelper=_dereq_(37);var _bufferHelper2=_interopRequireDefault(_bufferHelper);var _demuxer=_dereq_(25);var _demuxer2=_interopRequireDefault(_demuxer);var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _levelHelper=_dereq_(38);var _levelHelper2=_interopRequireDefault(_levelHelper);var _timeRanges=_dereq_(55);var _timeRanges2=_interopRequireDefault(_timeRanges);var _errors=_dereq_(33);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var State={STOPPED:'STOPPED',IDLE:'IDLE',KEY_LOADING:'KEY_LOADING',FRAG_LOADING:'FRAG_LOADING',FRAG_LOADING_WAITING_RETRY:'FRAG_LOADING_WAITING_RETRY',WAITING_LEVEL:'WAITING_LEVEL',PARSING:'PARSING',PARSED:'PARSED',BUFFER_FLUSHING:'BUFFER_FLUSHING',ENDED:'ENDED',ERROR:'ERROR'};var StreamController=function(_EventHandler){_inherits$$1(StreamController,_EventHandler);function StreamController(hls){_classCallCheck$$1(this,StreamController);var _this=_possibleConstructorReturn$$1(this,(StreamController.__proto__||Object.getPrototypeOf(StreamController)).call(this,hls,_events2.default.MEDIA_ATTACHED,_events2.default.MEDIA_DETACHING,_events2.default.MANIFEST_LOADING,_events2.default.MANIFEST_PARSED,_events2.default.LEVEL_LOADED,_events2.default.KEY_LOADED,_events2.default.FRAG_LOADED,_events2.default.FRAG_LOAD_EMERGENCY_ABORTED,_events2.default.FRAG_PARSING_INIT_SEGMENT,_events2.default.FRAG_PARSING_DATA,_events2.default.FRAG_PARSED,_events2.default.ERROR,_events2.default.AUDIO_TRACK_SWITCHING,_events2.default.AUDIO_TRACK_SWITCHED,_events2.default.BUFFER_CREATED,_events2.default.BUFFER_APPENDED,_events2.default.BUFFER_FLUSHED));_this.config=hls.config;_this.audioCodecSwap=false;_this.ticks=0;_this._state=State.STOPPED;_this.ontick=_this.tick.bind(_this);return _this;}_createClass$$1(StreamController,[{key:'destroy',value:function destroy(){this.stopLoad();if(this.timer){clearInterval(this.timer);this.timer=null;}_eventHandler2.default.prototype.destroy.call(this);this.state=State.STOPPED;}},{key:'startLoad',value:function startLoad(startPosition){if(this.levels){var lastCurrentTime=this.lastCurrentTime,hls=this.hls;this.stopLoad();if(!this.timer){this.timer=setInterval(this.ontick,100);}this.level=-1;this.fragLoadError=0;if(!this.startFragRequested){var startLevel=hls.startLevel;if(startLevel===-1){startLevel=0;this.bitrateTest=true;}this.level=hls.nextLoadLevel=startLevel;this.loadedmetadata=false;}if(lastCurrentTime>0&&startPosition===-1){_logger.logger.log('override startPosition with lastCurrentTime @'+lastCurrentTime.toFixed(3));startPosition=lastCurrentTime;}this.state=State.IDLE;this.nextLoadPosition=this.startPosition=this.lastCurrentTime=startPosition;this.tick();}else{this.forceStartLoad=true;this.state=State.STOPPED;}}},{key:'stopLoad',value:function stopLoad(){var frag=this.fragCurrent;if(frag){if(frag.loader){frag.loader.abort();}this.fragCurrent=null;}this.fragPrevious=null;if(this.demuxer){this.demuxer.destroy();this.demuxer=null;}this.state=State.STOPPED;this.forceStartLoad=false;}},{key:'tick',value:function tick(){this.ticks++;if(this.ticks===1){this.doTick();if(this.ticks>1){setTimeout(this.tick,1);}this.ticks=0;}}},{key:'doTick',value:function doTick(){switch(this.state){case State.ERROR:break;case State.BUFFER_FLUSHING:this.fragLoadError=0;break;case State.IDLE:this._doTickIdle();break;case State.WAITING_LEVEL:var level=this.levels[this.level];if(level&&level.details){this.state=State.IDLE;}break;case State.FRAG_LOADING_WAITING_RETRY:var now=performance.now();var retryDate=this.retryDate;if(!retryDate||now>=retryDate||this.media&&this.media.seeking){_logger.logger.log('mediaController: retryDate reached, switch back to IDLE state');this.state=State.IDLE;}break;case State.ERROR:case State.STOPPED:case State.FRAG_LOADING:case State.PARSING:case State.PARSED:case State.ENDED:break;default:break;}this._checkBuffer();this._checkFragmentChanged();}},{key:'_doTickIdle',value:function _doTickIdle(){var hls=this.hls,config=hls.config,media=this.media;if(this.levelLastLoaded!==undefined&&!media&&(this.startFragRequested||!config.startFragPrefetch)){return;}var pos=void 0;if(this.loadedmetadata){pos=media.currentTime;}else{pos=this.nextLoadPosition;}var level=hls.nextLoadLevel,levelInfo=this.levels[level];if(!levelInfo){return;}var levelBitrate=levelInfo.bitrate,maxBufLen=void 0;if(levelBitrate){maxBufLen=Math.max(8*config.maxBufferSize/levelBitrate,config.maxBufferLength);}else{maxBufLen=config.maxBufferLength;}maxBufLen=Math.min(maxBufLen,config.maxMaxBufferLength);var bufferInfo=_bufferHelper2.default.bufferInfo(this.mediaBuffer?this.mediaBuffer:media,pos,config.maxBufferHole),bufferLen=bufferInfo.len;if(bufferLen>=maxBufLen){return;}_logger.logger.trace('buffer length of '+bufferLen.toFixed(3)+' is below max of '+maxBufLen.toFixed(3)+'. checking for more payload ...');this.level=hls.nextLoadLevel=level;var levelDetails=levelInfo.details;if(typeof levelDetails==='undefined'||levelDetails.live&&this.levelLastLoaded!==level){this.state=State.WAITING_LEVEL;return;}var fragPrevious=this.fragPrevious;if(!levelDetails.live&&fragPrevious&&fragPrevious.sn===levelDetails.endSN&&bufferLen&&!bufferInfo.nextStart){var duration=Math.min(media.duration,fragPrevious.start+fragPrevious.duration);if(duration-Math.max(bufferInfo.end,fragPrevious.start)<=Math.max(0.2,fragPrevious.duration)){var data={};if(this.altAudio){data.type='video';}this.hls.trigger(_events2.default.BUFFER_EOS,data);this.state=State.ENDED;return;}}this._fetchPayloadOrEos(pos,bufferInfo,levelDetails);}},{key:'_fetchPayloadOrEos',value:function _fetchPayloadOrEos(pos,bufferInfo,levelDetails){var fragPrevious=this.fragPrevious,level=this.level,fragments=levelDetails.fragments,fragLen=fragments.length;if(fragLen===0){return;}var start=fragments[0].start,end=fragments[fragLen-1].start+fragments[fragLen-1].duration,bufferEnd=bufferInfo.end,frag=void 0;if(levelDetails.initSegment&&!levelDetails.initSegment.data){frag=levelDetails.initSegment;}else{if(levelDetails.live){var initialLiveManifestSize=this.config.initialLiveManifestSize;if(fragLen<initialLiveManifestSize){_logger.logger.warn('Can not start playback of a level, reason: not enough fragments '+fragLen+' < '+initialLiveManifestSize);return;}frag=this._ensureFragmentAtLivePoint(levelDetails,bufferEnd,start,end,fragPrevious,fragments,fragLen);if(frag===null){return;}}else{if(bufferEnd<start){frag=fragments[0];}}}if(!frag){frag=this._findFragment(start,fragPrevious,fragLen,fragments,bufferEnd,end,levelDetails);}if(frag){this._loadFragmentOrKey(frag,level,levelDetails,pos,bufferEnd);}return;}},{key:'_ensureFragmentAtLivePoint',value:function _ensureFragmentAtLivePoint(levelDetails,bufferEnd,start,end,fragPrevious,fragments,fragLen){var config=this.hls.config,media=this.media;var frag=void 0;var maxLatency=config.liveMaxLatencyDuration!==undefined?config.liveMaxLatencyDuration:config.liveMaxLatencyDurationCount*levelDetails.targetduration;if(bufferEnd<Math.max(start-config.maxFragLookUpTolerance,end-maxLatency)){var liveSyncPosition=this.liveSyncPosition=this.computeLivePosition(start,levelDetails);_logger.logger.log('buffer end: '+bufferEnd.toFixed(3)+' is located too far from the end of live sliding playlist, reset currentTime to : '+liveSyncPosition.toFixed(3));bufferEnd=liveSyncPosition;if(media&&media.readyState&&media.duration>liveSyncPosition){media.currentTime=liveSyncPosition;}this.nextLoadPosition=liveSyncPosition;}if(levelDetails.PTSKnown&&bufferEnd>end&&media&&media.readyState){return null;}if(this.startFragRequested&&!levelDetails.PTSKnown){if(fragPrevious){var targetSN=fragPrevious.sn+1;if(targetSN>=levelDetails.startSN&&targetSN<=levelDetails.endSN){frag=fragments[targetSN-levelDetails.startSN];_logger.logger.log('live playlist, switching playlist, load frag with next SN: '+frag.sn);}}if(!frag){frag=fragments[Math.min(fragLen-1,Math.round(fragLen/2))];_logger.logger.log('live playlist, switching playlist, unknown, load middle frag : '+frag.sn);}}return frag;}},{key:'_findFragment',value:function _findFragment(start,fragPrevious,fragLen,fragments,bufferEnd,end,levelDetails){var config=this.hls.config;var frag=void 0;var foundFrag=void 0;var maxFragLookUpTolerance=config.maxFragLookUpTolerance;var fragNext=fragPrevious?fragments[fragPrevious.sn-fragments[0].sn+1]:undefined;var fragmentWithinToleranceTest=function fragmentWithinToleranceTest(candidate){var candidateLookupTolerance=Math.min(maxFragLookUpTolerance,candidate.duration);if(candidate.start+candidate.duration-candidateLookupTolerance<=bufferEnd){return 1;}else if(candidate.start-candidateLookupTolerance>bufferEnd&&candidate.start){return-1;}return 0;};if(bufferEnd<end){if(bufferEnd>end-maxFragLookUpTolerance){maxFragLookUpTolerance=0;}if(fragNext&&!fragmentWithinToleranceTest(fragNext)){foundFrag=fragNext;}else{foundFrag=_binarySearch2.default.search(fragments,fragmentWithinToleranceTest);}}else{foundFrag=fragments[fragLen-1];}if(foundFrag){frag=foundFrag;var curSNIdx=frag.sn-levelDetails.startSN;var sameLevel=fragPrevious&&frag.level===fragPrevious.level;var prevFrag=fragments[curSNIdx-1];var nextFrag=fragments[curSNIdx+1];if(fragPrevious&&frag.sn===fragPrevious.sn){if(sameLevel&&!frag.backtracked){if(frag.sn<levelDetails.endSN){var deltaPTS=fragPrevious.deltaPTS;if(deltaPTS&&deltaPTS>config.maxBufferHole&&fragPrevious.dropped&&curSNIdx){frag=prevFrag;_logger.logger.warn('SN just loaded, with large PTS gap between audio and video, maybe frag is not starting with a keyframe ? load previous one to try to overcome this');fragPrevious.loadCounter--;}else{frag=nextFrag;_logger.logger.log('SN just loaded, load next one: '+frag.sn);}}else{frag=null;}}else if(frag.backtracked){if(nextFrag&&nextFrag.backtracked){_logger.logger.warn('Already backtracked from fragment '+nextFrag.sn+', will not backtrack to fragment '+frag.sn+'. Loading fragment '+nextFrag.sn);frag=nextFrag;}else{_logger.logger.warn('Loaded fragment with dropped frames, backtracking 1 segment to find a keyframe');frag.dropped=0;if(prevFrag){if(prevFrag.loadCounter){prevFrag.loadCounter--;}frag=prevFrag;frag.backtracked=true;}else if(curSNIdx){frag=null;}}}}}return frag;}},{key:'_loadFragmentOrKey',value:function _loadFragmentOrKey(frag,level,levelDetails,pos,bufferEnd){var hls=this.hls,config=hls.config;if(frag.decryptdata&&frag.decryptdata.uri!=null&&frag.decryptdata.key==null){_logger.logger.log('Loading key for '+frag.sn+' of ['+levelDetails.startSN+' ,'+levelDetails.endSN+'],level '+level);this.state=State.KEY_LOADING;hls.trigger(_events2.default.KEY_LOADING,{frag:frag});}else{_logger.logger.log('Loading '+frag.sn+' of ['+levelDetails.startSN+' ,'+levelDetails.endSN+'],level '+level+', currentTime:'+pos.toFixed(3)+',bufferEnd:'+bufferEnd.toFixed(3));if(this.fragLoadIdx!==undefined){this.fragLoadIdx++;}else{this.fragLoadIdx=0;}if(frag.loadCounter){frag.loadCounter++;var maxThreshold=config.fragLoadingLoopThreshold;if(frag.loadCounter>maxThreshold&&Math.abs(this.fragLoadIdx-frag.loadIdx)<maxThreshold){hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR,fatal:false,frag:frag});return;}}else{frag.loadCounter=1;}frag.loadIdx=this.fragLoadIdx;this.fragCurrent=frag;this.startFragRequested=true;if(!isNaN(frag.sn)){this.nextLoadPosition=frag.start+frag.duration;}frag.autoLevel=hls.autoLevelEnabled;frag.bitrateTest=this.bitrateTest;hls.trigger(_events2.default.FRAG_LOADING,{frag:frag});if(!this.demuxer){this.demuxer=new _demuxer2.default(hls,'main');}this.state=State.FRAG_LOADING;return;}}},{key:'getBufferedFrag',value:function getBufferedFrag(position){return _binarySearch2.default.search(this._bufferedFrags,function(frag){if(position<frag.startPTS){return-1;}else if(position>frag.endPTS){return 1;}return 0;});}},{key:'followingBufferedFrag',value:function followingBufferedFrag(frag){if(frag){return this.getBufferedFrag(frag.endPTS+0.5);}return null;}},{key:'_checkFragmentChanged',value:function _checkFragmentChanged(){var fragPlayingCurrent,currentTime,video=this.media;if(video&&video.readyState&&video.seeking===false){currentTime=video.currentTime;if(currentTime>video.playbackRate*this.lastCurrentTime){this.lastCurrentTime=currentTime;}if(_bufferHelper2.default.isBuffered(video,currentTime)){fragPlayingCurrent=this.getBufferedFrag(currentTime);}else if(_bufferHelper2.default.isBuffered(video,currentTime+0.1)){fragPlayingCurrent=this.getBufferedFrag(currentTime+0.1);}if(fragPlayingCurrent){var fragPlaying=fragPlayingCurrent;if(fragPlaying!==this.fragPlaying){this.hls.trigger(_events2.default.FRAG_CHANGED,{frag:fragPlaying});var fragPlayingLevel=fragPlaying.level;if(!this.fragPlaying||this.fragPlaying.level!==fragPlayingLevel){this.hls.trigger(_events2.default.LEVEL_SWITCHED,{level:fragPlayingLevel});}this.fragPlaying=fragPlaying;}}}}},{key:'immediateLevelSwitch',value:function immediateLevelSwitch(){_logger.logger.log('immediateLevelSwitch');if(!this.immediateSwitch){this.immediateSwitch=true;var media=this.media,previouslyPaused=void 0;if(media){previouslyPaused=media.paused;media.pause();}else{previouslyPaused=true;}this.previouslyPaused=previouslyPaused;}var fragCurrent=this.fragCurrent;if(fragCurrent&&fragCurrent.loader){fragCurrent.loader.abort();}this.fragCurrent=null;this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold;this.flushMainBuffer(0,Number.POSITIVE_INFINITY);}},{key:'immediateLevelSwitchEnd',value:function immediateLevelSwitchEnd(){var media=this.media;if(media&&media.buffered.length){this.immediateSwitch=false;if(_bufferHelper2.default.isBuffered(media,media.currentTime)){media.currentTime-=0.0001;}if(!this.previouslyPaused){media.play();}}}},{key:'nextLevelSwitch',value:function nextLevelSwitch(){var media=this.media;if(media&&media.readyState){var fetchdelay=void 0,fragPlayingCurrent=void 0,nextBufferedFrag=void 0;this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold;fragPlayingCurrent=this.getBufferedFrag(media.currentTime);if(fragPlayingCurrent&&fragPlayingCurrent.startPTS>1){this.flushMainBuffer(0,fragPlayingCurrent.startPTS-1);}if(!media.paused){var nextLevelId=this.hls.nextLoadLevel,nextLevel=this.levels[nextLevelId],fragLastKbps=this.fragLastKbps;if(fragLastKbps&&this.fragCurrent){fetchdelay=this.fragCurrent.duration*nextLevel.bitrate/(1000*fragLastKbps)+1;}else{fetchdelay=0;}}else{fetchdelay=0;}nextBufferedFrag=this.getBufferedFrag(media.currentTime+fetchdelay);if(nextBufferedFrag){nextBufferedFrag=this.followingBufferedFrag(nextBufferedFrag);if(nextBufferedFrag){var fragCurrent=this.fragCurrent;if(fragCurrent&&fragCurrent.loader){fragCurrent.loader.abort();}this.fragCurrent=null;this.flushMainBuffer(nextBufferedFrag.maxStartPTS,Number.POSITIVE_INFINITY);}}}}},{key:'flushMainBuffer',value:function flushMainBuffer(startOffset,endOffset){this.state=State.BUFFER_FLUSHING;var flushScope={startOffset:startOffset,endOffset:endOffset};if(this.altAudio){flushScope.type='video';}this.hls.trigger(_events2.default.BUFFER_FLUSHING,flushScope);}},{key:'onMediaAttached',value:function onMediaAttached(data){var media=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this);this.onvseeked=this.onMediaSeeked.bind(this);this.onvended=this.onMediaEnded.bind(this);media.addEventListener('seeking',this.onvseeking);media.addEventListener('seeked',this.onvseeked);media.addEventListener('ended',this.onvended);var config=this.config;if(this.levels&&config.autoStartLoad){this.hls.startLoad(config.startPosition);}}},{key:'onMediaDetaching',value:function onMediaDetaching(){var media=this.media;if(media&&media.ended){_logger.logger.log('MSE detaching and video ended, reset startPosition');this.startPosition=this.lastCurrentTime=0;}var levels=this.levels;if(levels){levels.forEach(function(level){if(level.details){level.details.fragments.forEach(function(fragment){fragment.loadCounter=undefined;fragment.backtracked=undefined;});}});}if(media){media.removeEventListener('seeking',this.onvseeking);media.removeEventListener('seeked',this.onvseeked);media.removeEventListener('ended',this.onvended);this.onvseeking=this.onvseeked=this.onvended=null;}this.media=this.mediaBuffer=null;this.loadedmetadata=false;this.stopLoad();}},{key:'onMediaSeeking',value:function onMediaSeeking(){var media=this.media,currentTime=media?media.currentTime:undefined,config=this.config;if(!isNaN(currentTime)){_logger.logger.log('media seeking to '+currentTime.toFixed(3));}var mediaBuffer=this.mediaBuffer?this.mediaBuffer:media;var bufferInfo=_bufferHelper2.default.bufferInfo(mediaBuffer,currentTime,this.config.maxBufferHole);if(this.state===State.FRAG_LOADING){var fragCurrent=this.fragCurrent;if(bufferInfo.len===0&&fragCurrent){var tolerance=config.maxFragLookUpTolerance,fragStartOffset=fragCurrent.start-tolerance,fragEndOffset=fragCurrent.start+fragCurrent.duration+tolerance;if(currentTime<fragStartOffset||currentTime>fragEndOffset){if(fragCurrent.loader){_logger.logger.log('seeking outside of buffer while fragment load in progress, cancel fragment load');fragCurrent.loader.abort();}this.fragCurrent=null;this.fragPrevious=null;this.state=State.IDLE;}else{_logger.logger.log('seeking outside of buffer but within currently loaded fragment range');}}}else if(this.state===State.ENDED){if(bufferInfo.len===0){this.fragPrevious=0;}this.state=State.IDLE;}if(media){this.lastCurrentTime=currentTime;}if(this.state!==State.FRAG_LOADING&&this.fragLoadIdx!==undefined){this.fragLoadIdx+=2*config.fragLoadingLoopThreshold;}if(!this.loadedmetadata){this.nextLoadPosition=this.startPosition=currentTime;}this.tick();}},{key:'onMediaSeeked',value:function onMediaSeeked(){var media=this.media,currentTime=media?media.currentTime:undefined;if(!isNaN(currentTime)){_logger.logger.log('media seeked to '+currentTime.toFixed(3));}this.tick();}},{key:'onMediaEnded',value:function onMediaEnded(){_logger.logger.log('media ended');this.startPosition=this.lastCurrentTime=0;}},{key:'onManifestLoading',value:function onManifestLoading(){_logger.logger.log('trigger BUFFER_RESET');this.hls.trigger(_events2.default.BUFFER_RESET);this._bufferedFrags=[];this.stalled=false;this.startPosition=this.lastCurrentTime=0;}},{key:'onManifestParsed',value:function onManifestParsed(data){var aac=false,heaac=false,codec;data.levels.forEach(function(level){codec=level.audioCodec;if(codec){if(codec.indexOf('mp4a.40.2')!==-1){aac=true;}if(codec.indexOf('mp4a.40.5')!==-1){heaac=true;}}});this.audioCodecSwitch=aac&&heaac;if(this.audioCodecSwitch){_logger.logger.log('both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC');}this.levels=data.levels;this.startLevelLoaded=false;this.startFragRequested=false;var config=this.config;if(config.autoStartLoad||this.forceStartLoad){this.hls.startLoad(config.startPosition);}}},{key:'onLevelLoaded',value:function onLevelLoaded(data){var newDetails=data.details,newLevelId=data.level,curLevel=this.levels[newLevelId],duration=newDetails.totalduration,sliding=0;_logger.logger.log('level '+newLevelId+' loaded ['+newDetails.startSN+','+newDetails.endSN+'],duration:'+duration);this.levelLastLoaded=newLevelId;if(newDetails.live){var curDetails=curLevel.details;if(curDetails&&newDetails.fragments.length>0){_levelHelper2.default.mergeDetails(curDetails,newDetails);sliding=newDetails.fragments[0].start;this.liveSyncPosition=this.computeLivePosition(sliding,curDetails);if(newDetails.PTSKnown){_logger.logger.log('live playlist sliding:'+sliding.toFixed(3));}else{_logger.logger.log('live playlist - outdated PTS, unknown sliding');}}else{newDetails.PTSKnown=false;_logger.logger.log('live playlist - first load, unknown sliding');}}else{newDetails.PTSKnown=false;}curLevel.details=newDetails;this.hls.trigger(_events2.default.LEVEL_UPDATED,{details:newDetails,level:newLevelId});if(this.startFragRequested===false){if(this.startPosition===-1||this.lastCurrentTime===-1){var startTimeOffset=newDetails.startTimeOffset;if(!isNaN(startTimeOffset)){if(startTimeOffset<0){_logger.logger.log('negative start time offset '+startTimeOffset+', count from end of last fragment');startTimeOffset=sliding+duration+startTimeOffset;}_logger.logger.log('start time offset found in playlist, adjust startPosition to '+startTimeOffset);this.startPosition=startTimeOffset;}else{if(newDetails.live){this.startPosition=this.computeLivePosition(sliding,newDetails);_logger.logger.log('configure startPosition to '+this.startPosition);}else{this.startPosition=0;}}this.lastCurrentTime=this.startPosition;}this.nextLoadPosition=this.startPosition;}if(this.state===State.WAITING_LEVEL){this.state=State.IDLE;}this.tick();}},{key:'onKeyLoaded',value:function onKeyLoaded(){if(this.state===State.KEY_LOADING){this.state=State.IDLE;this.tick();}}},{key:'onFragLoaded',value:function onFragLoaded(data){var fragCurrent=this.fragCurrent,fragLoaded=data.frag;if(this.state===State.FRAG_LOADING&&fragCurrent&&fragLoaded.type==='main'&&fragLoaded.level===fragCurrent.level&&fragLoaded.sn===fragCurrent.sn){var stats=data.stats,currentLevel=this.levels[fragCurrent.level],details=currentLevel.details;_logger.logger.log('Loaded  '+fragCurrent.sn+' of ['+details.startSN+' ,'+details.endSN+'],level '+fragCurrent.level);this.bitrateTest=false;this.stats=stats;if(fragLoaded.bitrateTest===true&&this.hls.nextLoadLevel){this.state=State.IDLE;this.startFragRequested=false;stats.tparsed=stats.tbuffered=performance.now();this.hls.trigger(_events2.default.FRAG_BUFFERED,{stats:stats,frag:fragCurrent,id:'main'});this.tick();}else if(fragLoaded.sn==='initSegment'){this.state=State.IDLE;stats.tparsed=stats.tbuffered=performance.now();details.initSegment.data=data.payload;this.hls.trigger(_events2.default.FRAG_BUFFERED,{stats:stats,frag:fragCurrent,id:'main'});this.tick();}else{this.state=State.PARSING;var duration=details.totalduration,level=fragCurrent.level,sn=fragCurrent.sn,audioCodec=this.config.defaultAudioCodec||currentLevel.audioCodec;if(this.audioCodecSwap){_logger.logger.log('swapping playlist audio codec');if(audioCodec===undefined){audioCodec=this.lastAudioCodec;}if(audioCodec){if(audioCodec.indexOf('mp4a.40.5')!==-1){audioCodec='mp4a.40.2';}else{audioCodec='mp4a.40.5';}}}this.pendingBuffering=true;this.appended=false;_logger.logger.log('Parsing '+sn+' of ['+details.startSN+' ,'+details.endSN+'],level '+level+', cc '+fragCurrent.cc);var demuxer=this.demuxer;if(!demuxer){demuxer=this.demuxer=new _demuxer2.default(this.hls,'main');}var media=this.media;var mediaSeeking=media&&media.seeking;var accurateTimeOffset=!mediaSeeking&&(details.PTSKnown||!details.live);var initSegmentData=details.initSegment?details.initSegment.data:[];demuxer.push(data.payload,initSegmentData,audioCodec,currentLevel.videoCodec,fragCurrent,duration,accurateTimeOffset,undefined);}}this.fragLoadError=0;}},{key:'onFragParsingInitSegment',value:function onFragParsingInitSegment(data){var fragCurrent=this.fragCurrent;var fragNew=data.frag;if(fragCurrent&&data.id==='main'&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State.PARSING){var tracks=data.tracks,trackName,track;if(tracks.audio&&this.altAudio){delete tracks.audio;}track=tracks.audio;if(track){var audioCodec=this.levels[this.level].audioCodec,ua=navigator.userAgent.toLowerCase();if(audioCodec&&this.audioCodecSwap){_logger.logger.log('swapping playlist audio codec');if(audioCodec.indexOf('mp4a.40.5')!==-1){audioCodec='mp4a.40.2';}else{audioCodec='mp4a.40.5';}}if(this.audioCodecSwitch){if(track.metadata.channelCount!==1&&ua.indexOf('firefox')===-1){audioCodec='mp4a.40.5';}}if(ua.indexOf('android')!==-1&&track.container!=='audio/mpeg'){audioCodec='mp4a.40.2';_logger.logger.log('Android: force audio codec to '+audioCodec);}track.levelCodec=audioCodec;track.id=data.id;}track=tracks.video;if(track){track.levelCodec=this.levels[this.level].videoCodec;track.id=data.id;}this.hls.trigger(_events2.default.BUFFER_CODECS,tracks);for(trackName in tracks){track=tracks[trackName];_logger.logger.log('main track:'+trackName+',container:'+track.container+',codecs[level/parsed]=['+track.levelCodec+'/'+track.codec+']');var initSegment=track.initSegment;if(initSegment){this.appended=true;this.pendingBuffering=true;this.hls.trigger(_events2.default.BUFFER_APPENDING,{type:trackName,data:initSegment,parent:'main',content:'initSegment'});}}this.tick();}}},{key:'onFragParsingData',value:function onFragParsingData(data){var _this2=this;var fragCurrent=this.fragCurrent;var fragNew=data.frag;if(fragCurrent&&data.id==='main'&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&!(data.type==='audio'&&this.altAudio)&&this.state===State.PARSING){var level=this.levels[this.level],frag=fragCurrent;if(isNaN(data.endPTS)){data.endPTS=data.startPTS+fragCurrent.duration;data.endDTS=data.startDTS+fragCurrent.duration;}_logger.logger.log('Parsed '+data.type+',PTS:['+data.startPTS.toFixed(3)+','+data.endPTS.toFixed(3)+'],DTS:['+data.startDTS.toFixed(3)+'/'+data.endDTS.toFixed(3)+'],nb:'+data.nb+',dropped:'+(data.dropped||0));if(data.type==='video'){frag.dropped=data.dropped;if(frag.dropped){if(!frag.backtracked){_logger.logger.warn('missing video frame(s), backtracking fragment');frag.backtracked=true;this.nextLoadPosition=data.startPTS;this.state=State.IDLE;this.fragPrevious=frag;this.tick();return;}else{_logger.logger.warn('Already backtracked on this fragment, appending with the gap');}}else{frag.backtracked=false;}}var drift=_levelHelper2.default.updateFragPTSDTS(level.details,frag,data.startPTS,data.endPTS,data.startDTS,data.endDTS),hls=this.hls;hls.trigger(_events2.default.LEVEL_PTS_UPDATED,{details:level.details,level:this.level,drift:drift,type:data.type,start:data.startPTS,end:data.endPTS});[data.data1,data.data2].forEach(function(buffer){if(buffer&&buffer.length&&_this2.state===State.PARSING){_this2.appended=true;_this2.pendingBuffering=true;hls.trigger(_events2.default.BUFFER_APPENDING,{type:data.type,data:buffer,parent:'main',content:'data'});}});this.tick();}}},{key:'onFragParsed',value:function onFragParsed(data){var fragCurrent=this.fragCurrent;var fragNew=data.frag;if(fragCurrent&&data.id==='main'&&fragNew.sn===fragCurrent.sn&&fragNew.level===fragCurrent.level&&this.state===State.PARSING){this.stats.tparsed=performance.now();this.state=State.PARSED;this._checkAppendedParsed();}}},{key:'onAudioTrackSwitching',value:function onAudioTrackSwitching(data){var altAudio=!!data.url,trackId=data.id;if(!altAudio){if(this.mediaBuffer!==this.media){_logger.logger.log('switching on main audio, use media.buffered to schedule main fragment loading');this.mediaBuffer=this.media;var fragCurrent=this.fragCurrent;if(fragCurrent.loader){_logger.logger.log('switching to main audio track, cancel main fragment load');fragCurrent.loader.abort();}this.fragCurrent=null;this.fragPrevious=null;if(this.demuxer){this.demuxer.destroy();this.demuxer=null;}this.state=State.IDLE;}var hls=this.hls;hls.trigger(_events2.default.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:'audio'});hls.trigger(_events2.default.AUDIO_TRACK_SWITCHED,{id:trackId});this.altAudio=false;}}},{key:'onAudioTrackSwitched',value:function onAudioTrackSwitched(data){var trackId=data.id,altAudio=!!this.hls.audioTracks[trackId].url;if(altAudio){var videoBuffer=this.videoBuffer;if(videoBuffer&&this.mediaBuffer!==videoBuffer){_logger.logger.log('switching on alternate audio, use video.buffered to schedule main fragment loading');this.mediaBuffer=videoBuffer;}}this.altAudio=altAudio;this.tick();}},{key:'onBufferCreated',value:function onBufferCreated(data){var tracks=data.tracks,mediaTrack=void 0,name=void 0,alternate=false;for(var type in tracks){var track=tracks[type];if(track.id==='main'){name=type;mediaTrack=track;if(type==='video'){this.videoBuffer=tracks[type].buffer;}}else{alternate=true;}}if(alternate&&mediaTrack){_logger.logger.log('alternate track found, use '+name+'.buffered to schedule main fragment loading');this.mediaBuffer=mediaTrack.buffer;}else{this.mediaBuffer=this.media;}}},{key:'onBufferAppended',value:function onBufferAppended(data){if(data.parent==='main'){var state=this.state;if(state===State.PARSING||state===State.PARSED){this.pendingBuffering=data.pending>0;this._checkAppendedParsed();}}}},{key:'_checkAppendedParsed',value:function _checkAppendedParsed(){if(this.state===State.PARSED&&(!this.appended||!this.pendingBuffering)){var frag=this.fragCurrent;if(frag){var media=this.mediaBuffer?this.mediaBuffer:this.media;_logger.logger.log('main buffered : '+_timeRanges2.default.toString(media.buffered));var bufferedFrags=this._bufferedFrags.filter(function(frag){return _bufferHelper2.default.isBuffered(media,(frag.startPTS+frag.endPTS)/2);});bufferedFrags.push(frag);this._bufferedFrags=bufferedFrags.sort(function(a,b){return a.startPTS-b.startPTS;});this.fragPrevious=frag;var stats=this.stats;stats.tbuffered=performance.now();this.fragLastKbps=Math.round(8*stats.total/(stats.tbuffered-stats.tfirst));this.hls.trigger(_events2.default.FRAG_BUFFERED,{stats:stats,frag:frag,id:'main'});this.state=State.IDLE;}this.tick();}}},{key:'onError',value:function onError(data){var frag=data.frag||this.fragCurrent;if(frag&&frag.type!=='main'){return;}var media=this.media,mediaBuffered=media&&_bufferHelper2.default.isBuffered(media,media.currentTime)&&_bufferHelper2.default.isBuffered(media,media.currentTime+0.5);switch(data.details){case _errors.ErrorDetails.FRAG_LOAD_ERROR:case _errors.ErrorDetails.FRAG_LOAD_TIMEOUT:case _errors.ErrorDetails.KEY_LOAD_ERROR:case _errors.ErrorDetails.KEY_LOAD_TIMEOUT:if(!data.fatal){var loadError=this.fragLoadError;if(loadError){loadError++;}else{loadError=1;}var config=this.config;if(loadError<=config.fragLoadingMaxRetry||mediaBuffered||frag.autoLevel&&frag.level){this.fragLoadError=loadError;frag.loadCounter=0;var delay=Math.min(Math.pow(2,loadError-1)*config.fragLoadingRetryDelay,config.fragLoadingMaxRetryTimeout);_logger.logger.warn('mediaController: frag loading failed, retry in '+delay+' ms');this.retryDate=performance.now()+delay;if(!this.loadedmetadata){this.startFragRequested=false;this.nextLoadPosition=this.startPosition;}this.state=State.FRAG_LOADING_WAITING_RETRY;}else{_logger.logger.error('mediaController: '+data.details+' reaches max retry, redispatch as fatal ...');data.fatal=true;this.state=State.ERROR;}}break;case _errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR:if(!data.fatal){if(mediaBuffered){this._reduceMaxBufferLength(frag.duration);this.state=State.IDLE;}else{if(!frag.autoLevel||frag.level===0){data.fatal=true;this.state=State.ERROR;}}}break;case _errors.ErrorDetails.LEVEL_LOAD_ERROR:case _errors.ErrorDetails.LEVEL_LOAD_TIMEOUT:if(this.state!==State.ERROR){if(data.fatal){this.state=State.ERROR;_logger.logger.warn('streamController: '+data.details+',switch to '+this.state+' state ...');}else{if(!data.levelRetry&&this.state===State.WAITING_LEVEL){this.state=State.IDLE;}}}break;case _errors.ErrorDetails.BUFFER_FULL_ERROR:if(data.parent==='main'&&(this.state===State.PARSING||this.state===State.PARSED)){if(mediaBuffered){this._reduceMaxBufferLength(this.config.maxBufferLength);this.state=State.IDLE;}else{_logger.logger.warn('buffer full error also media.currentTime is not buffered, flush everything');this.fragCurrent=null;this.flushMainBuffer(0,Number.POSITIVE_INFINITY);}}break;default:break;}}},{key:'_reduceMaxBufferLength',value:function _reduceMaxBufferLength(minLength){var config=this.config;if(config.maxMaxBufferLength>=minLength){config.maxMaxBufferLength/=2;_logger.logger.warn('main:reduce max buffer length to '+config.maxMaxBufferLength+'s');this.fragLoadIdx+=2*config.fragLoadingLoopThreshold;}}},{key:'_checkBuffer',value:function _checkBuffer(){var media=this.media,config=this.config;if(media&&media.readyState){var currentTime=media.currentTime,mediaBuffer=this.mediaBuffer?this.mediaBuffer:media,buffered=mediaBuffer.buffered;if(!this.loadedmetadata&&buffered.length){this.loadedmetadata=true;var startPosition=media.seeking?currentTime:this.startPosition,startPositionBuffered=_bufferHelper2.default.isBuffered(mediaBuffer,startPosition),firstbufferedPosition=buffered.start(0);if(currentTime!==startPosition||!startPositionBuffered&&Math.abs(startPosition-firstbufferedPosition)<config.maxSeekHole){_logger.logger.log('target start position:'+startPosition);if(!startPositionBuffered){startPosition=firstbufferedPosition;_logger.logger.log('target start position not buffered, seek to buffered.start(0) '+startPosition);}_logger.logger.log('adjust currentTime from '+currentTime+' to '+startPosition);media.currentTime=startPosition;}}else if(this.immediateSwitch){this.immediateLevelSwitchEnd();}else{var bufferInfo=_bufferHelper2.default.bufferInfo(media,currentTime,0),expectedPlaying=!(media.paused||media.ended||media.buffered.length===0),jumpThreshold=0.5,playheadMoving=currentTime!==this.lastCurrentTime;if(playheadMoving){if(this.stallReported){_logger.logger.warn('playback not stuck anymore @'+currentTime+', after '+Math.round(performance.now()-this.stalled)+'ms');this.stallReported=false;}this.stalled=undefined;this.nudgeRetry=0;}else{if(expectedPlaying){var tnow=performance.now();var hls=this.hls;if(!this.stalled){this.stalled=tnow;this.stallReported=false;}else{var stalledDuration=tnow-this.stalled;var bufferLen=bufferInfo.len;var nudgeRetry=this.nudgeRetry||0;if(bufferLen<=jumpThreshold&&stalledDuration>config.lowBufferWatchdogPeriod*1000){if(!this.stallReported){this.stallReported=true;_logger.logger.warn('playback stalling in low buffer @'+currentTime);hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_STALLED_ERROR,fatal:false,buffer:bufferLen});}var nextBufferStart=bufferInfo.nextStart,delta=nextBufferStart-currentTime;if(nextBufferStart&&delta<config.maxSeekHole&&delta>0){this.nudgeRetry=++nudgeRetry;var nudgeOffset=nudgeRetry*config.nudgeOffset;_logger.logger.log('adjust currentTime from '+media.currentTime+' to next buffered @ '+nextBufferStart+' + nudge '+nudgeOffset);media.currentTime=nextBufferStart+nudgeOffset;this.stalled=undefined;hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:false,hole:nextBufferStart+nudgeOffset-currentTime});}}else if(bufferLen>jumpThreshold&&stalledDuration>config.highBufferWatchdogPeriod*1000){if(!this.stallReported){this.stallReported=true;_logger.logger.warn('playback stalling in high buffer @'+currentTime);hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_STALLED_ERROR,fatal:false,buffer:bufferLen});}this.stalled=undefined;this.nudgeRetry=++nudgeRetry;if(nudgeRetry<config.nudgeMaxRetry){var _currentTime=media.currentTime;var targetTime=_currentTime+nudgeRetry*config.nudgeOffset;_logger.logger.log('adjust currentTime from '+_currentTime+' to '+targetTime);media.currentTime=targetTime;hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:false});}else{_logger.logger.error('still stuck in high buffer @'+currentTime+' after '+config.nudgeMaxRetry+', raise fatal error');hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_STALLED_ERROR,fatal:true});}}}}}}}}},{key:'onFragLoadEmergencyAborted',value:function onFragLoadEmergencyAborted(){this.state=State.IDLE;if(!this.loadedmetadata){this.startFragRequested=false;this.nextLoadPosition=this.startPosition;}this.tick();}},{key:'onBufferFlushed',value:function onBufferFlushed(){var media=this.mediaBuffer?this.mediaBuffer:this.media;this._bufferedFrags=this._bufferedFrags.filter(function(frag){return _bufferHelper2.default.isBuffered(media,(frag.startPTS+frag.endPTS)/2);});this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold;this.state=State.IDLE;this.fragPrevious=null;}},{key:'swapAudioCodec',value:function swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap;}},{key:'computeLivePosition',value:function computeLivePosition(sliding,levelDetails){var targetLatency=this.config.liveSyncDuration!==undefined?this.config.liveSyncDuration:this.config.liveSyncDurationCount*levelDetails.targetduration;return sliding+Math.max(0,levelDetails.totalduration-targetLatency);}},{key:'state',set:function set(nextState){if(this.state!==nextState){var previousState=this.state;this._state=nextState;_logger.logger.log('main stream:'+previousState+'->'+nextState);this.hls.trigger(_events2.default.STREAM_STATE_TRANSITION,{previousState:previousState,nextState:nextState});}},get:function get(){return this._state;}},{key:'currentLevel',get:function get(){var media=this.media;if(media){var frag=this.getBufferedFrag(media.currentTime);if(frag){return frag.level;}}return-1;}},{key:'nextBufferedFrag',get:function get(){var media=this.media;if(media){return this.followingBufferedFrag(this.getBufferedFrag(media.currentTime));}else{return null;}}},{key:'nextLevel',get:function get(){var frag=this.nextBufferedFrag;if(frag){return frag.level;}else{return-1;}}},{key:'liveSyncPosition',get:function get(){return this._liveSyncPosition;},set:function set(value){this._liveSyncPosition=value;}}]);return StreamController;}(_eventHandler2.default);exports.default=StreamController;},{"25":25,"33":33,"34":34,"35":35,"37":37,"38":38,"48":48,"54":54,"55":55}],14:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var SubtitleStreamController=function(_EventHandler){_inherits$$1(SubtitleStreamController,_EventHandler);function SubtitleStreamController(hls){_classCallCheck$$1(this,SubtitleStreamController);var _this=_possibleConstructorReturn$$1(this,(SubtitleStreamController.__proto__||Object.getPrototypeOf(SubtitleStreamController)).call(this,hls,_events2.default.ERROR,_events2.default.SUBTITLE_TRACKS_UPDATED,_events2.default.SUBTITLE_TRACK_SWITCH,_events2.default.SUBTITLE_TRACK_LOADED,_events2.default.SUBTITLE_FRAG_PROCESSED));_this.config=hls.config;_this.vttFragSNsProcessed={};_this.vttFragQueues=undefined;_this.currentlyProcessing=null;_this.currentTrackId=-1;return _this;}_createClass$$1(SubtitleStreamController,[{key:'destroy',value:function destroy(){_eventHandler2.default.prototype.destroy.call(this);}},{key:'clearVttFragQueues',value:function clearVttFragQueues(){var _this2=this;this.vttFragQueues={};this.tracks.forEach(function(track){_this2.vttFragQueues[track.id]=[];});}},{key:'nextFrag',value:function nextFrag(){if(this.currentlyProcessing===null&&this.currentTrackId>-1&&this.vttFragQueues[this.currentTrackId].length){var frag=this.currentlyProcessing=this.vttFragQueues[this.currentTrackId].shift();this.hls.trigger(_events2.default.FRAG_LOADING,{frag:frag});}}},{key:'onSubtitleFragProcessed',value:function onSubtitleFragProcessed(data){if(data.success){this.vttFragSNsProcessed[data.frag.trackId].push(data.frag.sn);}this.currentlyProcessing=null;this.nextFrag();}},{key:'onError',value:function onError(data){var frag=data.frag;if(frag&&frag.type!=='subtitle'){return;}if(this.currentlyProcessing){this.currentlyProcessing=null;this.nextFrag();}}},{key:'onSubtitleTracksUpdated',value:function onSubtitleTracksUpdated(data){var _this3=this;_logger.logger.log('subtitle tracks updated');this.tracks=data.subtitleTracks;this.clearVttFragQueues();this.vttFragSNsProcessed={};this.tracks.forEach(function(track){_this3.vttFragSNsProcessed[track.id]=[];});}},{key:'onSubtitleTrackSwitch',value:function onSubtitleTrackSwitch(data){this.currentTrackId=data.id;this.clearVttFragQueues();}},{key:'onSubtitleTrackLoaded',value:function onSubtitleTrackLoaded(data){var processedFragSNs=this.vttFragSNsProcessed[data.id],fragQueue=this.vttFragQueues[data.id],currentFragSN=!!this.currentlyProcessing?this.currentlyProcessing.sn:-1;var alreadyProcessed=function alreadyProcessed(frag){return processedFragSNs.indexOf(frag.sn)>-1;};var alreadyInQueue=function alreadyInQueue(frag){return fragQueue.some(function(fragInQueue){return fragInQueue.sn===frag.sn;});};data.details.fragments.forEach(function(frag){if(!(alreadyProcessed(frag)||frag.sn===currentFragSN||alreadyInQueue(frag))){frag.trackId=data.id;fragQueue.push(frag);}});this.nextFrag();}}]);return SubtitleStreamController;}(_eventHandler2.default);exports.default=SubtitleStreamController;},{"34":34,"35":35,"54":54}],15:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function filterSubtitleTracks(textTrackList){var tracks=[];for(var i=0;i<textTrackList.length;i++){if(textTrackList[i].kind==='subtitles'){tracks.push(textTrackList[i]);}}return tracks;}var SubtitleTrackController=function(_EventHandler){_inherits$$1(SubtitleTrackController,_EventHandler);function SubtitleTrackController(hls){_classCallCheck$$1(this,SubtitleTrackController);var _this=_possibleConstructorReturn$$1(this,(SubtitleTrackController.__proto__||Object.getPrototypeOf(SubtitleTrackController)).call(this,hls,_events2.default.MEDIA_ATTACHED,_events2.default.MEDIA_DETACHING,_events2.default.MANIFEST_LOADING,_events2.default.MANIFEST_LOADED,_events2.default.SUBTITLE_TRACK_LOADED));_this.tracks=[];_this.trackId=-1;_this.media=undefined;return _this;}_createClass$$1(SubtitleTrackController,[{key:'_onTextTracksChanged',value:function _onTextTracksChanged(){if(!this.media){return;}var trackId=-1;var tracks=filterSubtitleTracks(this.media.textTracks);for(var id=0;id<tracks.length;id++){if(tracks[id].mode==='showing'){trackId=id;}}this.subtitleTrack=trackId;}},{key:'destroy',value:function destroy(){_eventHandler2.default.prototype.destroy.call(this);}},{key:'onMediaAttached',value:function onMediaAttached(data){this.media=data.media;if(!this.media){return;}this.trackChangeListener=this._onTextTracksChanged.bind(this);this.media.textTracks.addEventListener('change',this.trackChangeListener);}},{key:'onMediaDetaching',value:function onMediaDetaching(){if(!this.media){return;}this.media.textTracks.removeEventListener('change',this.trackChangeListener);this.media=undefined;}},{key:'onManifestLoading',value:function onManifestLoading(){this.tracks=[];this.trackId=-1;}},{key:'onManifestLoaded',value:function onManifestLoaded(data){var _this2=this;var tracks=data.subtitles||[];var defaultFound=false;this.tracks=tracks;this.trackId=-1;this.hls.trigger(_events2.default.SUBTITLE_TRACKS_UPDATED,{subtitleTracks:tracks});tracks.forEach(function(track){if(track.default){_this2.subtitleTrack=track.id;defaultFound=true;}});}},{key:'onTick',value:function onTick(){var trackId=this.trackId;var subtitleTrack=this.tracks[trackId];if(!subtitleTrack){return;}var details=subtitleTrack.details;if(details===undefined||details.live===true){_logger.logger.log('(re)loading playlist for subtitle track '+trackId);this.hls.trigger(_events2.default.SUBTITLE_TRACK_LOADING,{url:subtitleTrack.url,id:trackId});}}},{key:'onSubtitleTrackLoaded',value:function onSubtitleTrackLoaded(data){var _this3=this;if(data.id<this.tracks.length){_logger.logger.log('subtitle track '+data.id+' loaded');this.tracks[data.id].details=data.details;if(data.details.live&&!this.timer){this.timer=setInterval(function(){_this3.onTick();},1000*data.details.targetduration,this);}if(!data.details.live&&this.timer){clearInterval(this.timer);this.timer=null;}}}},{key:'setSubtitleTrackInternal',value:function setSubtitleTrackInternal(newId){if(newId>=0&&newId<this.tracks.length){if(this.timer){clearInterval(this.timer);this.timer=null;}this.trackId=newId;_logger.logger.log('switching to subtitle track '+newId);var subtitleTrack=this.tracks[newId];this.hls.trigger(_events2.default.SUBTITLE_TRACK_SWITCH,{id:newId});var details=subtitleTrack.details;if(details===undefined||details.live===true){_logger.logger.log('(re)loading playlist for subtitle track '+newId);this.hls.trigger(_events2.default.SUBTITLE_TRACK_LOADING,{url:subtitleTrack.url,id:newId});}}}},{key:'subtitleTracks',get:function get(){return this.tracks;}},{key:'subtitleTrack',get:function get(){return this.trackId;},set:function set(subtitleTrackId){if(this.trackId!==subtitleTrackId){this.setSubtitleTrackInternal(subtitleTrackId);}}}]);return SubtitleTrackController;}(_eventHandler2.default);exports.default=SubtitleTrackController;},{"34":34,"35":35,"54":54}],16:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _cea608Parser=_dereq_(49);var _cea608Parser2=_interopRequireDefault(_cea608Parser);var _webvttParser=_dereq_(58);var _webvttParser2=_interopRequireDefault(_webvttParser);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function clearCurrentCues(track){if(track&&track.cues){while(track.cues.length>0){track.removeCue(track.cues[0]);}}}function reuseVttTextTrack(inUseTrack,manifestTrack){return inUseTrack&&inUseTrack.label===manifestTrack.name&&!(inUseTrack.textTrack1||inUseTrack.textTrack2);}function intersection(x1,x2,y1,y2){return Math.min(x2,y2)-Math.max(x1,y1);}var TimelineController=function(_EventHandler){_inherits$$1(TimelineController,_EventHandler);function TimelineController(hls){_classCallCheck$$1(this,TimelineController);var _this=_possibleConstructorReturn$$1(this,(TimelineController.__proto__||Object.getPrototypeOf(TimelineController)).call(this,hls,_events2.default.MEDIA_ATTACHING,_events2.default.MEDIA_DETACHING,_events2.default.FRAG_PARSING_USERDATA,_events2.default.MANIFEST_LOADING,_events2.default.MANIFEST_LOADED,_events2.default.FRAG_LOADED,_events2.default.LEVEL_SWITCHING,_events2.default.INIT_PTS_FOUND));_this.hls=hls;_this.config=hls.config;_this.enabled=true;_this.Cues=hls.config.cueHandler;_this.textTracks=[];_this.tracks=[];_this.unparsedVttFrags=[];_this.initPTS=undefined;_this.cueRanges=[];if(_this.config.enableCEA708Captions){var self=_this;var sendAddTrackEvent=function sendAddTrackEvent(track,media){var e=null;try{e=new window.Event('addtrack');}catch(err){e=document.createEvent('Event');e.initEvent('addtrack',false,false);}e.track=track;media.dispatchEvent(e);};var channel1={'newCue':function newCue(startTime,endTime,screen){if(!self.textTrack1){var existingTrack1=self.getExistingTrack('1');if(!existingTrack1){var textTrack1=self.createTextTrack('captions',self.config.captionsTextTrack1Label,self.config.captionsTextTrack1LanguageCode);if(textTrack1){textTrack1.textTrack1=true;self.textTrack1=textTrack1;}}else{self.textTrack1=existingTrack1;clearCurrentCues(self.textTrack1);sendAddTrackEvent(self.textTrack1,self.media);}}self.addCues('textTrack1',startTime,endTime,screen);}};var channel2={'newCue':function newCue(startTime,endTime,screen){if(!self.textTrack2){var existingTrack2=self.getExistingTrack('2');if(!existingTrack2){var textTrack2=self.createTextTrack('captions',self.config.captionsTextTrack2Label,self.config.captionsTextTrack1LanguageCode);if(textTrack2){textTrack2.textTrack2=true;self.textTrack2=textTrack2;}}else{self.textTrack2=existingTrack2;clearCurrentCues(self.textTrack2);sendAddTrackEvent(self.textTrack2,self.media);}}self.addCues('textTrack2',startTime,endTime,screen);}};_this.cea608Parser=new _cea608Parser2.default(0,channel1,channel2);}return _this;}_createClass$$1(TimelineController,[{key:'addCues',value:function addCues(channel,startTime,endTime,screen){var ranges=this.cueRanges;var merged=false;for(var i=ranges.length;i--;){var cueRange=ranges[i];var overlap=intersection(cueRange[0],cueRange[1],startTime,endTime);if(overlap>=0){cueRange[0]=Math.min(cueRange[0],startTime);cueRange[1]=Math.max(cueRange[1],endTime);merged=true;if(overlap/(endTime-startTime)>0.5){return;}}}if(!merged){ranges.push([startTime,endTime]);}this.Cues.newCue(this[channel],startTime,endTime,screen);}},{key:'onInitPtsFound',value:function onInitPtsFound(data){var _this2=this;if(typeof this.initPTS==='undefined'){this.initPTS=data.initPTS;}if(this.unparsedVttFrags.length){this.unparsedVttFrags.forEach(function(frag){_this2.onFragLoaded(frag);});this.unparsedVttFrags=[];}}},{key:'getExistingTrack',value:function getExistingTrack(channelNumber){var media=this.media;if(media){for(var i=0;i<media.textTracks.length;i++){var textTrack=media.textTracks[i];var propName='textTrack'+channelNumber;if(textTrack[propName]===true){return textTrack;}}}return null;}},{key:'createTextTrack',value:function createTextTrack(kind,label,lang){var media=this.media;if(media){return media.addTextTrack(kind,label,lang);}}},{key:'destroy',value:function destroy(){_eventHandler2.default.prototype.destroy.call(this);}},{key:'onMediaAttaching',value:function onMediaAttaching(data){this.media=data.media;}},{key:'onMediaDetaching',value:function onMediaDetaching(){clearCurrentCues(this.textTrack1);clearCurrentCues(this.textTrack2);}},{key:'onManifestLoading',value:function onManifestLoading(){this.lastSn=-1;this.prevCC=-1;this.vttCCs={ccOffset:0,presentationOffset:0};var media=this.media;if(media){var textTracks=media.textTracks;if(textTracks){for(var i=0;i<textTracks.length;i++){clearCurrentCues(textTracks[i]);}}}}},{key:'onManifestLoaded',value:function onManifestLoaded(data){var _this3=this;this.textTracks=[];this.unparsedVttFrags=this.unparsedVttFrags||[];this.initPTS=undefined;this.cueRanges=[];if(this.config.enableWebVTT){this.tracks=data.subtitles||[];var inUseTracks=this.media?this.media.textTracks:[];this.tracks.forEach(function(track,index){var textTrack=void 0;if(index<inUseTracks.length){var inUseTrack=inUseTracks[index];if(reuseVttTextTrack(inUseTrack,track)){textTrack=inUseTrack;}}if(!textTrack){textTrack=_this3.createTextTrack('subtitles',track.name,track.lang);}textTrack.mode=track.default?'showing':'hidden';_this3.textTracks.push(textTrack);});}}},{key:'onLevelSwitching',value:function onLevelSwitching(){this.enabled=this.hls.currentLevel.closedCaptions!=='NONE';}},{key:'onFragLoaded',value:function onFragLoaded(data){var frag=data.frag,payload=data.payload;if(frag.type==='main'){var sn=frag.sn;if(sn!==this.lastSn+1){var cea608Parser=this.cea608Parser;if(cea608Parser){cea608Parser.reset();}}this.lastSn=sn;}else if(frag.type==='subtitle'){if(payload.byteLength){if(typeof this.initPTS==='undefined'){this.unparsedVttFrags.push(data);return;}var vttCCs=this.vttCCs;if(!vttCCs[frag.cc]){vttCCs[frag.cc]={start:frag.start,prevCC:this.prevCC,new:true};this.prevCC=frag.cc;}var textTracks=this.textTracks,hls=this.hls;_webvttParser2.default.parse(payload,this.initPTS,vttCCs,frag.cc,function(cues){var currentTrack=textTracks[frag.trackId];cues.forEach(function(cue){if(!currentTrack.cues.getCueById(cue.id)){currentTrack.addCue(cue);}});hls.trigger(_events2.default.SUBTITLE_FRAG_PROCESSED,{success:true,frag:frag});},function(e){_logger.logger.log('Failed to parse VTT cue: '+e);hls.trigger(_events2.default.SUBTITLE_FRAG_PROCESSED,{success:false,frag:frag});});}else{this.hls.trigger(_events2.default.SUBTITLE_FRAG_PROCESSED,{success:false,frag:frag});}}}},{key:'onFragParsingUserdata',value:function onFragParsingUserdata(data){if(this.enabled&&this.config.enableCEA708Captions){for(var i=0;i<data.samples.length;i++){var ccdatas=this.extractCea608Data(data.samples[i].bytes);this.cea608Parser.addData(data.samples[i].pts,ccdatas);}}}},{key:'extractCea608Data',value:function extractCea608Data(byteArray){var count=byteArray[0]&31;var position=2;var tmpByte,ccbyte1,ccbyte2,ccValid,ccType;var actualCCBytes=[];for(var j=0;j<count;j++){tmpByte=byteArray[position++];ccbyte1=0x7F&byteArray[position++];ccbyte2=0x7F&byteArray[position++];ccValid=(4&tmpByte)!==0;ccType=3&tmpByte;if(ccbyte1===0&&ccbyte2===0){continue;}if(ccValid){if(ccType===0){actualCCBytes.push(ccbyte1);actualCCBytes.push(ccbyte2);}}}return actualCCBytes;}}]);return TimelineController;}(_eventHandler2.default);exports.default=TimelineController;},{"34":34,"35":35,"49":49,"54":54,"58":58}],17:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var AESCrypto=function(){function AESCrypto(subtle,iv){_classCallCheck$$1(this,AESCrypto);this.subtle=subtle;this.aesIV=iv;}_createClass$$1(AESCrypto,[{key:'decrypt',value:function decrypt(data,key){return this.subtle.decrypt({name:'AES-CBC',iv:this.aesIV},key,data);}}]);return AESCrypto;}();exports.default=AESCrypto;},{}],18:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var AESDecryptor=function(){function AESDecryptor(){_classCallCheck$$1(this,AESDecryptor);this.rcon=[0x0,0x1,0x2,0x4,0x8,0x10,0x20,0x40,0x80,0x1b,0x36];this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)];this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)];this.sBox=new Uint32Array(256);this.invSBox=new Uint32Array(256);this.key=new Uint32Array(0);this.initTable();}_createClass$$1(AESDecryptor,[{key:'uint8ArrayToUint32Array_',value:function uint8ArrayToUint32Array_(arrayBuffer){var view=new DataView(arrayBuffer);var newArray=new Uint32Array(4);for(var i=0;i<4;i++){newArray[i]=view.getUint32(i*4);}return newArray;}},{key:'initTable',value:function initTable(){var sBox=this.sBox;var invSBox=this.invSBox;var subMix=this.subMix;var subMix0=subMix[0];var subMix1=subMix[1];var subMix2=subMix[2];var subMix3=subMix[3];var invSubMix=this.invSubMix;var invSubMix0=invSubMix[0];var invSubMix1=invSubMix[1];var invSubMix2=invSubMix[2];var invSubMix3=invSubMix[3];var d=new Uint32Array(256);var x=0;var xi=0;var i=0;for(i=0;i<256;i++){if(i<128){d[i]=i<<1;}else{d[i]=i<<1^0x11b;}}for(i=0;i<256;i++){var sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^sx&0xff^0x63;sBox[x]=sx;invSBox[sx]=x;var x2=d[x];var x4=d[x2];var x8=d[x4];var t=d[sx]*0x101^sx*0x1010100;subMix0[x]=t<<24|t>>>8;subMix1[x]=t<<16|t>>>16;subMix2[x]=t<<8|t>>>24;subMix3[x]=t;t=x8*0x1010101^x4*0x10001^x2*0x101^x*0x1010100;invSubMix0[sx]=t<<24|t>>>8;invSubMix1[sx]=t<<16|t>>>16;invSubMix2[sx]=t<<8|t>>>24;invSubMix3[sx]=t;if(!x){x=xi=1;}else{x=x2^d[d[d[x8^x2]]];xi^=d[d[xi]];}}}},{key:'expandKey',value:function expandKey(keyBuffer){var key=this.uint8ArrayToUint32Array_(keyBuffer);var sameKey=true;var offset=0;while(offset<key.length&&sameKey){sameKey=key[offset]===this.key[offset];offset++;}if(sameKey){return;}this.key=key;var keySize=this.keySize=key.length;if(keySize!==4&&keySize!==6&&keySize!==8){throw new Error('Invalid aes key size='+keySize);}var ksRows=this.ksRows=(keySize+6+1)*4;var ksRow=void 0;var invKsRow=void 0;var keySchedule=this.keySchedule=new Uint32Array(ksRows);var invKeySchedule=this.invKeySchedule=new Uint32Array(ksRows);var sbox=this.sBox;var rcon=this.rcon;var invSubMix=this.invSubMix;var invSubMix0=invSubMix[0];var invSubMix1=invSubMix[1];var invSubMix2=invSubMix[2];var invSubMix3=invSubMix[3];var prev=void 0;var t=void 0;for(ksRow=0;ksRow<ksRows;ksRow++){if(ksRow<keySize){prev=keySchedule[ksRow]=key[ksRow];continue;}t=prev;if(ksRow%keySize===0){t=t<<8|t>>>24;t=sbox[t>>>24]<<24|sbox[t>>>16&0xff]<<16|sbox[t>>>8&0xff]<<8|sbox[t&0xff];t^=rcon[ksRow/keySize|0]<<24;}else if(keySize>6&&ksRow%keySize===4){t=sbox[t>>>24]<<24|sbox[t>>>16&0xff]<<16|sbox[t>>>8&0xff]<<8|sbox[t&0xff];}keySchedule[ksRow]=prev=(keySchedule[ksRow-keySize]^t)>>>0;}for(invKsRow=0;invKsRow<ksRows;invKsRow++){ksRow=ksRows-invKsRow;if(invKsRow&3){t=keySchedule[ksRow];}else{t=keySchedule[ksRow-4];}if(invKsRow<4||ksRow<=4){invKeySchedule[invKsRow]=t;}else{invKeySchedule[invKsRow]=invSubMix0[sbox[t>>>24]]^invSubMix1[sbox[t>>>16&0xff]]^invSubMix2[sbox[t>>>8&0xff]]^invSubMix3[sbox[t&0xff]];}invKeySchedule[invKsRow]=invKeySchedule[invKsRow]>>>0;}}},{key:'networkToHostOrderSwap',value:function networkToHostOrderSwap(word){return word<<24|(word&0xff00)<<8|(word&0xff0000)>>8|word>>>24;}},{key:'decrypt',value:function decrypt(inputArrayBuffer,offset,aesIV){var nRounds=this.keySize+6;var invKeySchedule=this.invKeySchedule;var invSBOX=this.invSBox;var invSubMix=this.invSubMix;var invSubMix0=invSubMix[0];var invSubMix1=invSubMix[1];var invSubMix2=invSubMix[2];var invSubMix3=invSubMix[3];var initVector=this.uint8ArrayToUint32Array_(aesIV);var initVector0=initVector[0];var initVector1=initVector[1];var initVector2=initVector[2];var initVector3=initVector[3];var inputInt32=new Int32Array(inputArrayBuffer);var outputInt32=new Int32Array(inputInt32.length);var t0=void 0,t1=void 0,t2=void 0,t3=void 0;var s0=void 0,s1=void 0,s2=void 0,s3=void 0;var inputWords0=void 0,inputWords1=void 0,inputWords2=void 0,inputWords3=void 0;var ksRow,i;var swapWord=this.networkToHostOrderSwap;while(offset<inputInt32.length){inputWords0=swapWord(inputInt32[offset]);inputWords1=swapWord(inputInt32[offset+1]);inputWords2=swapWord(inputInt32[offset+2]);inputWords3=swapWord(inputInt32[offset+3]);s0=inputWords0^invKeySchedule[0];s1=inputWords3^invKeySchedule[1];s2=inputWords2^invKeySchedule[2];s3=inputWords1^invKeySchedule[3];ksRow=4;for(i=1;i<nRounds;i++){t0=invSubMix0[s0>>>24]^invSubMix1[s1>>16&0xff]^invSubMix2[s2>>8&0xff]^invSubMix3[s3&0xff]^invKeySchedule[ksRow];t1=invSubMix0[s1>>>24]^invSubMix1[s2>>16&0xff]^invSubMix2[s3>>8&0xff]^invSubMix3[s0&0xff]^invKeySchedule[ksRow+1];t2=invSubMix0[s2>>>24]^invSubMix1[s3>>16&0xff]^invSubMix2[s0>>8&0xff]^invSubMix3[s1&0xff]^invKeySchedule[ksRow+2];t3=invSubMix0[s3>>>24]^invSubMix1[s0>>16&0xff]^invSubMix2[s1>>8&0xff]^invSubMix3[s2&0xff]^invKeySchedule[ksRow+3];s0=t0;s1=t1;s2=t2;s3=t3;ksRow=ksRow+4;}t0=invSBOX[s0>>>24]<<24^invSBOX[s1>>16&0xff]<<16^invSBOX[s2>>8&0xff]<<8^invSBOX[s3&0xff]^invKeySchedule[ksRow];t1=invSBOX[s1>>>24]<<24^invSBOX[s2>>16&0xff]<<16^invSBOX[s3>>8&0xff]<<8^invSBOX[s0&0xff]^invKeySchedule[ksRow+1];t2=invSBOX[s2>>>24]<<24^invSBOX[s3>>16&0xff]<<16^invSBOX[s0>>8&0xff]<<8^invSBOX[s1&0xff]^invKeySchedule[ksRow+2];t3=invSBOX[s3>>>24]<<24^invSBOX[s0>>16&0xff]<<16^invSBOX[s1>>8&0xff]<<8^invSBOX[s2&0xff]^invKeySchedule[ksRow+3];ksRow=ksRow+3;outputInt32[offset]=swapWord(t0^initVector0);outputInt32[offset+1]=swapWord(t3^initVector1);outputInt32[offset+2]=swapWord(t2^initVector2);outputInt32[offset+3]=swapWord(t1^initVector3);initVector0=inputWords0;initVector1=inputWords1;initVector2=inputWords2;initVector3=inputWords3;offset=offset+4;}return outputInt32.buffer;}},{key:'destroy',value:function destroy(){this.key=undefined;this.keySize=undefined;this.ksRows=undefined;this.sBox=undefined;this.invSBox=undefined;this.subMix=undefined;this.invSubMix=undefined;this.keySchedule=undefined;this.invKeySchedule=undefined;this.rcon=undefined;}}]);return AESDecryptor;}();exports.default=AESDecryptor;},{}],19:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _aesCrypto=_dereq_(17);var _aesCrypto2=_interopRequireDefault(_aesCrypto);var _fastAesKey=_dereq_(20);var _fastAesKey2=_interopRequireDefault(_fastAesKey);var _aesDecryptor=_dereq_(18);var _aesDecryptor2=_interopRequireDefault(_aesDecryptor);var _errors=_dereq_(33);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var Decrypter=function(){function Decrypter(observer,config){_classCallCheck$$1(this,Decrypter);this.observer=observer;this.config=config;this.logEnabled=true;try{var browserCrypto=crypto?crypto:self.crypto;this.subtle=browserCrypto.subtle||browserCrypto.webkitSubtle;}catch(e){}this.disableWebCrypto=!this.subtle;}_createClass$$1(Decrypter,[{key:'isSync',value:function isSync(){return this.disableWebCrypto&&this.config.enableSoftwareAES;}},{key:'decrypt',value:function decrypt(data,key,iv,callback){var _this=this;if(this.disableWebCrypto&&this.config.enableSoftwareAES){if(this.logEnabled){_logger.logger.log('JS AES decrypt');this.logEnabled=false;}var decryptor=this.decryptor;if(!decryptor){this.decryptor=decryptor=new _aesDecryptor2.default();}decryptor.expandKey(key);callback(decryptor.decrypt(data,0,iv));}else{if(this.logEnabled){_logger.logger.log('WebCrypto AES decrypt');this.logEnabled=false;}var subtle=this.subtle;if(this.key!==key){this.key=key;this.fastAesKey=new _fastAesKey2.default(subtle,key);}this.fastAesKey.expandKey().then(function(aesKey){var crypto=new _aesCrypto2.default(subtle,iv);crypto.decrypt(data,aesKey).catch(function(err){_this.onWebCryptoError(err,data,key,iv,callback);}).then(function(result){callback(result);});}).catch(function(err){_this.onWebCryptoError(err,data,key,iv,callback);});}}},{key:'onWebCryptoError',value:function onWebCryptoError(err,data,key,iv,callback){if(this.config.enableSoftwareAES){_logger.logger.log('WebCrypto Error, disable WebCrypto API');this.disableWebCrypto=true;this.logEnabled=true;this.decrypt(data,key,iv,callback);}else{_logger.logger.error('decrypting error : '+err.message);this.observer.trigger(Event.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_DECRYPT_ERROR,fatal:true,reason:err.message});}}},{key:'destroy',value:function destroy(){var decryptor=this.decryptor;if(decryptor){decryptor.destroy();this.decryptor=undefined;}}}]);return Decrypter;}();exports.default=Decrypter;},{"17":17,"18":18,"20":20,"33":33,"54":54}],20:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var FastAESKey=function(){function FastAESKey(subtle,key){_classCallCheck$$1(this,FastAESKey);this.subtle=subtle;this.key=key;}_createClass$$1(FastAESKey,[{key:'expandKey',value:function expandKey(){return this.subtle.importKey('raw',this.key,{name:'AES-CBC'},false,['encrypt','decrypt']);}}]);return FastAESKey;}();exports.default=FastAESKey;},{}],21:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _adts=_dereq_(22);var _adts2=_interopRequireDefault(_adts);var _logger=_dereq_(54);var _id=_dereq_(27);var _id2=_interopRequireDefault(_id);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var AACDemuxer=function(){function AACDemuxer(observer,remuxer,config){_classCallCheck$$1(this,AACDemuxer);this.observer=observer;this.config=config;this.remuxer=remuxer;}_createClass$$1(AACDemuxer,[{key:'resetInitSegment',value:function resetInitSegment(initSegment,audioCodec,videoCodec,duration){this._audioTrack={container:'audio/adts',type:'audio',id:-1,sequenceNumber:0,isAAC:true,samples:[],len:0,manifestCodec:audioCodec,duration:duration,inputTimeScale:90000};}},{key:'resetTimeStamp',value:function resetTimeStamp(){}},{key:'append',value:function append(data,timeOffset,contiguous,accurateTimeOffset){var track=this._audioTrack,id3Data=_id2.default.getID3Data(data,0),pts=90*_id2.default.getTimeStamp(id3Data),frameIndex=0,stamp=pts,length=data.length,offset=id3Data.length;var id3Samples=[{pts:stamp,dts:stamp,data:id3Data}];while(offset<length-1){if(_adts2.default.isHeader(data,offset)&&offset+5<length){_adts2.default.initTrackConfig(track,this.observer,data,offset,track.manifestCodec);var frame=_adts2.default.appendFrame(track,data,offset,pts,frameIndex);if(frame){offset+=frame.length;stamp=frame.sample.pts;frameIndex++;}else{_logger.logger.log('Unable to parse AAC frame');break;}}else if(_id2.default.isHeader(data,offset)){id3Data=_id2.default.getID3Data(data,offset);id3Samples.push({pts:stamp,dts:stamp,data:id3Data});offset+=id3Data.length;}else{offset++;}}this.remuxer.remux(track,{samples:[]},{samples:id3Samples,inputTimeScale:90000},{samples:[]},timeOffset,contiguous,accurateTimeOffset);}},{key:'destroy',value:function destroy(){}}],[{key:'probe',value:function probe(data){var offset,length;var id3Data=_id2.default.getID3Data(data,0);if(id3Data&&_id2.default.getTimeStamp(id3Data)!==undefined){for(offset=id3Data.length,length=Math.min(data.length-1,offset+100);offset<length;offset++){if(_adts2.default.probe(data,offset)){_logger.logger.log('ADTS sync word found !');return true;}}}return false;}}]);return AACDemuxer;}();exports.default=AACDemuxer;},{"22":22,"27":27,"54":54}],22:[function(_dereq_,module,exports){'use strict';var _logger=_dereq_(54);var _errors=_dereq_(33);var ADTS={getAudioConfig:function getAudioConfig(observer,data,offset,audioCodec){var adtsObjectType,adtsSampleingIndex,adtsExtensionSampleingIndex,adtsChanelConfig,config,userAgent=navigator.userAgent.toLowerCase(),manifestCodec=audioCodec,adtsSampleingRates=[96000,88200,64000,48000,44100,32000,24000,22050,16000,12000,11025,8000,7350];adtsObjectType=((data[offset+2]&0xC0)>>>6)+1;adtsSampleingIndex=(data[offset+2]&0x3C)>>>2;if(adtsSampleingIndex>adtsSampleingRates.length-1){observer.trigger(Event.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:true,reason:'invalid ADTS sampling index:'+adtsSampleingIndex});return;}adtsChanelConfig=(data[offset+2]&0x01)<<2;adtsChanelConfig|=(data[offset+3]&0xC0)>>>6;_logger.logger.log('manifest codec:'+audioCodec+',ADTS data:type:'+adtsObjectType+',sampleingIndex:'+adtsSampleingIndex+'['+adtsSampleingRates[adtsSampleingIndex]+'Hz],channelConfig:'+adtsChanelConfig);if(/firefox/i.test(userAgent)){if(adtsSampleingIndex>=6){adtsObjectType=5;config=new Array(4);adtsExtensionSampleingIndex=adtsSampleingIndex-3;}else{adtsObjectType=2;config=new Array(2);adtsExtensionSampleingIndex=adtsSampleingIndex;}}else if(userAgent.indexOf('android')!==-1){adtsObjectType=2;config=new Array(2);adtsExtensionSampleingIndex=adtsSampleingIndex;}else{adtsObjectType=5;config=new Array(4);if(audioCodec&&(audioCodec.indexOf('mp4a.40.29')!==-1||audioCodec.indexOf('mp4a.40.5')!==-1)||!audioCodec&&adtsSampleingIndex>=6){adtsExtensionSampleingIndex=adtsSampleingIndex-3;}else{if(audioCodec&&audioCodec.indexOf('mp4a.40.2')!==-1&&adtsSampleingIndex>=6&&adtsChanelConfig===1||!audioCodec&&adtsChanelConfig===1){adtsObjectType=2;config=new Array(2);}adtsExtensionSampleingIndex=adtsSampleingIndex;}}config[0]=adtsObjectType<<3;config[0]|=(adtsSampleingIndex&0x0E)>>1;config[1]|=(adtsSampleingIndex&0x01)<<7;config[1]|=adtsChanelConfig<<3;if(adtsObjectType===5){config[1]|=(adtsExtensionSampleingIndex&0x0E)>>1;config[2]=(adtsExtensionSampleingIndex&0x01)<<7;config[2]|=2<<2;config[3]=0;}return{config:config,samplerate:adtsSampleingRates[adtsSampleingIndex],channelCount:adtsChanelConfig,codec:'mp4a.40.'+adtsObjectType,manifestCodec:manifestCodec};},isHeaderPattern:function isHeaderPattern(data,offset){return data[offset]===0xff&&(data[offset+1]&0xf6)===0xf0;},getHeaderLength:function getHeaderLength(data,offset){return!!(data[offset+1]&0x01)?7:9;},getFullFrameLength:function getFullFrameLength(data,offset){return(data[offset+3]&0x03)<<11|data[offset+4]<<3|(data[offset+5]&0xE0)>>>5;},isHeader:function isHeader(data,offset){if(offset+1<data.length&&this.isHeaderPattern(data,offset)){return true;}return false;},probe:function probe(data,offset){if(offset+1<data.length&&this.isHeaderPattern(data,offset)){var headerLength=this.getHeaderLength(data,offset);var frameLength=headerLength;if(offset+5<data.length){frameLength=this.getFullFrameLength(data,offset);}var newOffset=offset+frameLength;if(newOffset===data.length||newOffset+1<data.length&&this.isHeaderPattern(data,newOffset)){return true;}}return false;},initTrackConfig:function initTrackConfig(track,observer,data,offset,audioCodec){if(!track.samplerate){var config=this.getAudioConfig(observer,data,offset,audioCodec);track.config=config.config;track.samplerate=config.samplerate;track.channelCount=config.channelCount;track.codec=config.codec;track.manifestCodec=config.manifestCodec;_logger.logger.log('parsed codec:'+track.codec+',rate:'+config.samplerate+',nb channel:'+config.channelCount);}},getFrameDuration:function getFrameDuration(samplerate){return 1024*90000/samplerate;},appendFrame:function appendFrame(track,data,offset,pts,frameIndex){var frameDuration=this.getFrameDuration(track.samplerate);var header=this.parseFrameHeader(data,offset,pts,frameIndex,frameDuration);if(header){var stamp=header.stamp;var headerLength=header.headerLength;var frameLength=header.frameLength;var aacSample={unit:data.subarray(offset+headerLength,offset+headerLength+frameLength),pts:stamp,dts:stamp};track.samples.push(aacSample);track.len+=frameLength;return{sample:aacSample,length:frameLength+headerLength};}return undefined;},parseFrameHeader:function parseFrameHeader(data,offset,pts,frameIndex,frameDuration){var headerLength,frameLength,stamp;var length=data.length;headerLength=this.getHeaderLength(data,offset);frameLength=this.getFullFrameLength(data,offset);frameLength-=headerLength;if(frameLength>0&&offset+headerLength+frameLength<=length){stamp=pts+frameIndex*frameDuration;return{headerLength:headerLength,frameLength:frameLength,stamp:stamp};}return undefined;}};module.exports=ADTS;},{"33":33,"54":54}],23:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _errors=_dereq_(33);var _decrypter=_dereq_(19);var _decrypter2=_interopRequireDefault(_decrypter);var _aacdemuxer=_dereq_(21);var _aacdemuxer2=_interopRequireDefault(_aacdemuxer);var _mp4demuxer=_dereq_(29);var _mp4demuxer2=_interopRequireDefault(_mp4demuxer);var _tsdemuxer=_dereq_(32);var _tsdemuxer2=_interopRequireDefault(_tsdemuxer);var _mp3demuxer=_dereq_(28);var _mp3demuxer2=_interopRequireDefault(_mp3demuxer);var _mp4Remuxer=_dereq_(45);var _mp4Remuxer2=_interopRequireDefault(_mp4Remuxer);var _passthroughRemuxer=_dereq_(46);var _passthroughRemuxer2=_interopRequireDefault(_passthroughRemuxer);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var DemuxerInline=function(){function DemuxerInline(observer,typeSupported,config,vendor){_classCallCheck$$1(this,DemuxerInline);this.observer=observer;this.typeSupported=typeSupported;this.config=config;this.vendor=vendor;}_createClass$$1(DemuxerInline,[{key:'destroy',value:function destroy(){var demuxer=this.demuxer;if(demuxer){demuxer.destroy();}}},{key:'push',value:function push(data,decryptdata,initSegment,audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS){if(data.byteLength>0&&decryptdata!=null&&decryptdata.key!=null&&decryptdata.method==='AES-128'){var decrypter=this.decrypter;if(decrypter==null){decrypter=this.decrypter=new _decrypter2.default(this.observer,this.config);}var localthis=this;var startTime;try{startTime=performance.now();}catch(error){startTime=Date.now();}decrypter.decrypt(data,decryptdata.key.buffer,decryptdata.iv.buffer,function(decryptedData){var endTime;try{endTime=performance.now();}catch(error){endTime=Date.now();}localthis.observer.trigger(_events2.default.FRAG_DECRYPTED,{stats:{tstart:startTime,tdecrypt:endTime}});localthis.pushDecrypted(new Uint8Array(decryptedData),decryptdata,new Uint8Array(initSegment),audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS);});}else{this.pushDecrypted(new Uint8Array(data),decryptdata,new Uint8Array(initSegment),audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS);}}},{key:'pushDecrypted',value:function pushDecrypted(data,decryptdata,initSegment,audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS){var demuxer=this.demuxer;if(!demuxer||discontinuity&&!this.probe(data)){var observer=this.observer;var typeSupported=this.typeSupported;var config=this.config;var muxConfig=[{demux:_aacdemuxer2.default,remux:_mp4Remuxer2.default},{demux:_mp3demuxer2.default,remux:_mp4Remuxer2.default},{demux:_tsdemuxer2.default,remux:_mp4Remuxer2.default},{demux:_mp4demuxer2.default,remux:_passthroughRemuxer2.default}];for(var i=0,len=muxConfig.length;i<len;i++){var mux=muxConfig[i];var probe=mux.demux.probe;if(probe(data)){var _remuxer=this.remuxer=new mux.remux(observer,config,typeSupported,this.vendor);demuxer=new mux.demux(observer,_remuxer,config,typeSupported);this.probe=probe;break;}}if(!demuxer){observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:true,reason:'no demux matching with content found'});return;}this.demuxer=demuxer;}var remuxer=this.remuxer;if(discontinuity||trackSwitch){demuxer.resetInitSegment(initSegment,audioCodec,videoCodec,duration);remuxer.resetInitSegment();}if(discontinuity){demuxer.resetTimeStamp(defaultInitPTS);remuxer.resetTimeStamp(defaultInitPTS);}if(typeof demuxer.setDecryptData==='function'){demuxer.setDecryptData(decryptdata);}demuxer.append(data,timeOffset,contiguous,accurateTimeOffset);}}]);return DemuxerInline;}();exports.default=DemuxerInline;},{"19":19,"21":21,"28":28,"29":29,"32":32,"33":33,"35":35,"45":45,"46":46}],24:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _demuxerInline=_dereq_(23);var _demuxerInline2=_interopRequireDefault(_demuxerInline);var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _logger=_dereq_(54);var _events3=_dereq_(1);var _events4=_interopRequireDefault(_events3);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var DemuxerWorker=function DemuxerWorker(self){var observer=new _events4.default();observer.trigger=function trigger(event){for(var _len=arguments.length,data=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){data[_key-1]=arguments[_key];}observer.emit.apply(observer,[event,event].concat(data));};observer.off=function off(event){for(var _len2=arguments.length,data=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){data[_key2-1]=arguments[_key2];}observer.removeListener.apply(observer,[event].concat(data));};var forwardMessage=function forwardMessage(ev,data){self.postMessage({event:ev,data:data});};self.addEventListener('message',function(ev){var data=ev.data;switch(data.cmd){case'init':var config=JSON.parse(data.config);self.demuxer=new _demuxerInline2.default(observer,data.typeSupported,config,data.vendor);try{(0,_logger.enableLogs)(config.debug===true);}catch(err){console.warn('demuxerWorker: unable to enable logs');}forwardMessage('init',null);break;case'demux':self.demuxer.push(data.data,data.decryptdata,data.initSegment,data.audioCodec,data.videoCodec,data.timeOffset,data.discontinuity,data.trackSwitch,data.contiguous,data.duration,data.accurateTimeOffset,data.defaultInitPTS);break;default:break;}});observer.on(_events2.default.FRAG_DECRYPTED,forwardMessage);observer.on(_events2.default.FRAG_PARSING_INIT_SEGMENT,forwardMessage);observer.on(_events2.default.FRAG_PARSED,forwardMessage);observer.on(_events2.default.ERROR,forwardMessage);observer.on(_events2.default.FRAG_PARSING_METADATA,forwardMessage);observer.on(_events2.default.FRAG_PARSING_USERDATA,forwardMessage);observer.on(_events2.default.INIT_PTS_FOUND,forwardMessage);observer.on(_events2.default.FRAG_PARSING_DATA,function(ev,data){var transferable=[];var message={event:ev,data:data};if(data.data1){message.data1=data.data1.buffer;transferable.push(data.data1.buffer);delete data.data1;}if(data.data2){message.data2=data.data2.buffer;transferable.push(data.data2.buffer);delete data.data2;}self.postMessage(message,transferable);});};exports.default=DemuxerWorker;},{"1":1,"23":23,"35":35,"54":54}],25:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _demuxerInline=_dereq_(23);var _demuxerInline2=_interopRequireDefault(_demuxerInline);var _demuxerWorker=_dereq_(24);var _demuxerWorker2=_interopRequireDefault(_demuxerWorker);var _logger=_dereq_(54);var _errors=_dereq_(33);var _events3=_dereq_(1);var _events4=_interopRequireDefault(_events3);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var Demuxer=function(){function Demuxer(hls,id){_classCallCheck$$1(this,Demuxer);this.hls=hls;this.id=id;var observer=this.observer=new _events4.default();var config=hls.config;observer.trigger=function trigger(event){for(var _len=arguments.length,data=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){data[_key-1]=arguments[_key];}observer.emit.apply(observer,[event,event].concat(data));};observer.off=function off(event){for(var _len2=arguments.length,data=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){data[_key2-1]=arguments[_key2];}observer.removeListener.apply(observer,[event].concat(data));};var forwardMessage=function(ev,data){data=data||{};data.frag=this.frag;data.id=this.id;hls.trigger(ev,data);}.bind(this);observer.on(_events2.default.FRAG_DECRYPTED,forwardMessage);observer.on(_events2.default.FRAG_PARSING_INIT_SEGMENT,forwardMessage);observer.on(_events2.default.FRAG_PARSING_DATA,forwardMessage);observer.on(_events2.default.FRAG_PARSED,forwardMessage);observer.on(_events2.default.ERROR,forwardMessage);observer.on(_events2.default.FRAG_PARSING_METADATA,forwardMessage);observer.on(_events2.default.FRAG_PARSING_USERDATA,forwardMessage);observer.on(_events2.default.INIT_PTS_FOUND,forwardMessage);var typeSupported={mp4:MediaSource.isTypeSupported('video/mp4'),mpeg:MediaSource.isTypeSupported('audio/mpeg'),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"')};var vendor=navigator.vendor;if(config.enableWorker&&typeof Worker!=='undefined'){_logger.logger.log('demuxing in webworker');var w=void 0;try{var work$$1=_dereq_(3);w=this.w=work$$1(_demuxerWorker2.default);this.onwmsg=this.onWorkerMessage.bind(this);w.addEventListener('message',this.onwmsg);w.onerror=function(event){hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.OTHER_ERROR,details:_errors.ErrorDetails.INTERNAL_EXCEPTION,fatal:true,event:'demuxerWorker',err:{message:event.message+' ('+event.filename+':'+event.lineno+')'}});};w.postMessage({cmd:'init',typeSupported:typeSupported,vendor:vendor,id:id,config:JSON.stringify(config)});}catch(err){_logger.logger.error('error while initializing DemuxerWorker, fallback on DemuxerInline');if(w){URL.revokeObjectURL(w.objectURL);}this.demuxer=new _demuxerInline2.default(observer,typeSupported,config,vendor);this.w=undefined;}}else{this.demuxer=new _demuxerInline2.default(observer,typeSupported,config,vendor);}}_createClass$$1(Demuxer,[{key:'destroy',value:function destroy(){var w=this.w;if(w){w.removeEventListener('message',this.onwmsg);w.terminate();this.w=null;}else{var demuxer=this.demuxer;if(demuxer){demuxer.destroy();this.demuxer=null;}}var observer=this.observer;if(observer){observer.removeAllListeners();this.observer=null;}}},{key:'push',value:function push(data,initSegment,audioCodec,videoCodec,frag,duration,accurateTimeOffset,defaultInitPTS){var w=this.w;var timeOffset=!isNaN(frag.startDTS)?frag.startDTS:frag.start;var decryptdata=frag.decryptdata;var lastFrag=this.frag;var discontinuity=!(lastFrag&&frag.cc===lastFrag.cc);var trackSwitch=!(lastFrag&&frag.level===lastFrag.level);var nextSN=lastFrag&&frag.sn===lastFrag.sn+1;var contiguous=!trackSwitch&&nextSN;if(discontinuity){_logger.logger.log(this.id+':discontinuity detected');}if(trackSwitch){_logger.logger.log(this.id+':switch detected');}this.frag=frag;if(w){w.postMessage({cmd:'demux',data:data,decryptdata:decryptdata,initSegment:initSegment,audioCodec:audioCodec,videoCodec:videoCodec,timeOffset:timeOffset,discontinuity:discontinuity,trackSwitch:trackSwitch,contiguous:contiguous,duration:duration,accurateTimeOffset:accurateTimeOffset,defaultInitPTS:defaultInitPTS},[data]);}else{var demuxer=this.demuxer;if(demuxer){demuxer.push(data,decryptdata,initSegment,audioCodec,videoCodec,timeOffset,discontinuity,trackSwitch,contiguous,duration,accurateTimeOffset,defaultInitPTS);}}}},{key:'onWorkerMessage',value:function onWorkerMessage(ev){var data=ev.data,hls=this.hls;switch(data.event){case'init':URL.revokeObjectURL(this.w.objectURL);break;case _events2.default.FRAG_PARSING_DATA:data.data.data1=new Uint8Array(data.data1);if(data.data2){data.data.data2=new Uint8Array(data.data2);}default:data.data=data.data||{};data.data.frag=this.frag;data.data.id=this.id;hls.trigger(data.event,data.data);break;}}}]);return Demuxer;}();exports.default=Demuxer;},{"1":1,"23":23,"24":24,"3":3,"33":33,"35":35,"54":54}],26:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _logger=_dereq_(54);function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var ExpGolomb=function(){function ExpGolomb(data){_classCallCheck$$1(this,ExpGolomb);this.data=data;this.bytesAvailable=data.byteLength;this.word=0;this.bitsAvailable=0;}_createClass$$1(ExpGolomb,[{key:'loadWord',value:function loadWord(){var data=this.data,bytesAvailable=this.bytesAvailable,position=data.byteLength-bytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,bytesAvailable);if(availableBytes===0){throw new Error('no bytes available');}workingBytes.set(data.subarray(position,position+availableBytes));this.word=new DataView(workingBytes.buffer).getUint32(0);this.bitsAvailable=availableBytes*8;this.bytesAvailable-=availableBytes;}},{key:'skipBits',value:function skipBits(count){var skipBytes;if(this.bitsAvailable>count){this.word<<=count;this.bitsAvailable-=count;}else{count-=this.bitsAvailable;skipBytes=count>>3;count-=skipBytes>>3;this.bytesAvailable-=skipBytes;this.loadWord();this.word<<=count;this.bitsAvailable-=count;}}},{key:'readBits',value:function readBits(size){var bits=Math.min(this.bitsAvailable,size),valu=this.word>>>32-bits;if(size>32){_logger.logger.error('Cannot read more than 32 bits at a time');}this.bitsAvailable-=bits;if(this.bitsAvailable>0){this.word<<=bits;}else if(this.bytesAvailable>0){this.loadWord();}bits=size-bits;if(bits>0&&this.bitsAvailable){return valu<<bits|this.readBits(bits);}else{return valu;}}},{key:'skipLZ',value:function skipLZ(){var leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<this.bitsAvailable;++leadingZeroCount){if(0!==(this.word&0x80000000>>>leadingZeroCount)){this.word<<=leadingZeroCount;this.bitsAvailable-=leadingZeroCount;return leadingZeroCount;}}this.loadWord();return leadingZeroCount+this.skipLZ();}},{key:'skipUEG',value:function skipUEG(){this.skipBits(1+this.skipLZ());}},{key:'skipEG',value:function skipEG(){this.skipBits(1+this.skipLZ());}},{key:'readUEG',value:function readUEG(){var clz=this.skipLZ();return this.readBits(clz+1)-1;}},{key:'readEG',value:function readEG(){var valu=this.readUEG();if(0x01&valu){return 1+valu>>>1;}else{return-1*(valu>>>1);}}},{key:'readBoolean',value:function readBoolean(){return 1===this.readBits(1);}},{key:'readUByte',value:function readUByte(){return this.readBits(8);}},{key:'readUShort',value:function readUShort(){return this.readBits(16);}},{key:'readUInt',value:function readUInt(){return this.readBits(32);}},{key:'skipScalingList',value:function skipScalingList(count){var lastScale=8,nextScale=8,j,deltaScale;for(j=0;j<count;j++){if(nextScale!==0){deltaScale=this.readEG();nextScale=(lastScale+deltaScale+256)%256;}lastScale=nextScale===0?lastScale:nextScale;}}},{key:'readSPS',value:function readSPS(){var frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,profileIdc,profileCompat,levelIdc,numRefFramesInPicOrderCntCycle,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,scalingListCount,i,readUByte=this.readUByte.bind(this),readBits=this.readBits.bind(this),readUEG=this.readUEG.bind(this),readBoolean=this.readBoolean.bind(this),skipBits=this.skipBits.bind(this),skipEG=this.skipEG.bind(this),skipUEG=this.skipUEG.bind(this),skipScalingList=this.skipScalingList.bind(this);readUByte();profileIdc=readUByte();profileCompat=readBits(5);skipBits(3);levelIdc=readUByte();skipUEG();if(profileIdc===100||profileIdc===110||profileIdc===122||profileIdc===244||profileIdc===44||profileIdc===83||profileIdc===86||profileIdc===118||profileIdc===128){var chromaFormatIdc=readUEG();if(chromaFormatIdc===3){skipBits(1);}skipUEG();skipUEG();skipBits(1);if(readBoolean()){scalingListCount=chromaFormatIdc!==3?8:12;for(i=0;i<scalingListCount;i++){if(readBoolean()){if(i<6){skipScalingList(16);}else{skipScalingList(64);}}}}}skipUEG();var picOrderCntType=readUEG();if(picOrderCntType===0){readUEG();}else if(picOrderCntType===1){skipBits(1);skipEG();skipEG();numRefFramesInPicOrderCntCycle=readUEG();for(i=0;i<numRefFramesInPicOrderCntCycle;i++){skipEG();}}skipUEG();skipBits(1);picWidthInMbsMinus1=readUEG();picHeightInMapUnitsMinus1=readUEG();frameMbsOnlyFlag=readBits(1);if(frameMbsOnlyFlag===0){skipBits(1);}skipBits(1);if(readBoolean()){frameCropLeftOffset=readUEG();frameCropRightOffset=readUEG();frameCropTopOffset=readUEG();frameCropBottomOffset=readUEG();}var pixelRatio=[1,1];if(readBoolean()){if(readBoolean()){var aspectRatioIdc=readUByte();switch(aspectRatioIdc){case 1:pixelRatio=[1,1];break;case 2:pixelRatio=[12,11];break;case 3:pixelRatio=[10,11];break;case 4:pixelRatio=[16,11];break;case 5:pixelRatio=[40,33];break;case 6:pixelRatio=[24,11];break;case 7:pixelRatio=[20,11];break;case 8:pixelRatio=[32,11];break;case 9:pixelRatio=[80,33];break;case 10:pixelRatio=[18,11];break;case 11:pixelRatio=[15,11];break;case 12:pixelRatio=[64,33];break;case 13:pixelRatio=[160,99];break;case 14:pixelRatio=[4,3];break;case 15:pixelRatio=[3,2];break;case 16:pixelRatio=[2,1];break;case 255:{pixelRatio=[readUByte()<<8|readUByte(),readUByte()<<8|readUByte()];break;}}}}return{width:Math.ceil((picWidthInMbsMinus1+1)*16-frameCropLeftOffset*2-frameCropRightOffset*2),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-(frameMbsOnlyFlag?2:4)*(frameCropTopOffset+frameCropBottomOffset),pixelRatio:pixelRatio};}},{key:'readSliceType',value:function readSliceType(){this.readUByte();this.readUEG();return this.readUEG();}}]);return ExpGolomb;}();exports.default=ExpGolomb;},{"54":54}],27:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var ID3=function(){function ID3(){_classCallCheck$$1(this,ID3);}_createClass$$1(ID3,null,[{key:'isHeader',value:function isHeader(data,offset){if(offset+10<=data.length){if(data[offset]===0x49&&data[offset+1]===0x44&&data[offset+2]===0x33){if(data[offset+3]<0xFF&&data[offset+4]<0xFF){if(data[offset+6]<0x80&&data[offset+7]<0x80&&data[offset+8]<0x80&&data[offset+9]<0x80){return true;}}}}return false;}},{key:'isFooter',value:function isFooter(data,offset){if(offset+10<=data.length){if(data[offset]===0x33&&data[offset+1]===0x44&&data[offset+2]===0x49){if(data[offset+3]<0xFF&&data[offset+4]<0xFF){if(data[offset+6]<0x80&&data[offset+7]<0x80&&data[offset+8]<0x80&&data[offset+9]<0x80){return true;}}}}return false;}},{key:'getID3Data',value:function getID3Data(data,offset){var front=offset;var length=0;while(ID3.isHeader(data,offset)){length+=10;var size=ID3._readSize(data,offset+6);length+=size;if(ID3.isFooter(data,offset+10)){length+=10;}offset+=length;}if(length>0){return data.subarray(front,front+length);}return undefined;}},{key:'_readSize',value:function _readSize(data,offset){var size=0;size=(data[offset]&0x7f)<<21;size|=(data[offset+1]&0x7f)<<14;size|=(data[offset+2]&0x7f)<<7;size|=data[offset+3]&0x7f;return size;}},{key:'getTimeStamp',value:function getTimeStamp(data){var frames=ID3.getID3Frames(data);for(var i=0;i<frames.length;i++){var frame=frames[i];if(ID3.isTimeStampFrame(frame)){return ID3._readTimeStamp(frame);}}return undefined;}},{key:'isTimeStampFrame',value:function isTimeStampFrame(frame){return frame&&frame.key==='PRIV'&&frame.info==='com.apple.streaming.transportStreamTimestamp';}},{key:'_getFrameData',value:function _getFrameData(data){var type=String.fromCharCode(data[0],data[1],data[2],data[3]);var size=ID3._readSize(data,4);var offset=10;return{type:type,size:size,data:data.subarray(offset,offset+size)};}},{key:'getID3Frames',value:function getID3Frames(id3Data){var offset=0;var frames=[];while(ID3.isHeader(id3Data,offset)){var size=ID3._readSize(id3Data,offset+6);offset+=10;var end=offset+size;while(offset+8<end){var frameData=ID3._getFrameData(id3Data.subarray(offset));var frame=ID3._decodeFrame(frameData);if(frame){frames.push(frame);}offset+=frameData.size+10;}if(ID3.isFooter(id3Data,offset)){offset+=10;}}return frames;}},{key:'_decodeFrame',value:function _decodeFrame(frame){if(frame.type==='PRIV'){return ID3._decodePrivFrame(frame);}else if(frame.type[0]==='T'){return ID3._decodeTextFrame(frame);}else if(frame.type[0]==='W'){return ID3._decodeURLFrame(frame);}return undefined;}},{key:'_readTimeStamp',value:function _readTimeStamp(timeStampFrame){if(timeStampFrame.data.byteLength===8){var data=new Uint8Array(timeStampFrame.data);var pts33Bit=data[3]&0x1;var timestamp=(data[4]<<23)+(data[5]<<15)+(data[6]<<7)+data[7];timestamp/=45;if(pts33Bit){timestamp+=47721858.84;}return Math.round(timestamp);}return undefined;}},{key:'_decodePrivFrame',value:function _decodePrivFrame(frame){if(frame.size<2){return undefined;}var owner=ID3._utf8ArrayToStr(frame.data);var privateData=new Uint8Array(frame.data.subarray(owner.length+1));return{key:frame.type,info:owner,data:privateData.buffer};}},{key:'_decodeTextFrame',value:function _decodeTextFrame(frame){if(frame.size<2){return undefined;}if(frame.type==='TXXX'){var index=1;var description=ID3._utf8ArrayToStr(frame.data.subarray(index));index+=description.length+1;var value=ID3._utf8ArrayToStr(frame.data.subarray(index));return{key:frame.type,info:description,data:value};}else{var text=ID3._utf8ArrayToStr(frame.data.subarray(1));return{key:frame.type,data:text};}}},{key:'_decodeURLFrame',value:function _decodeURLFrame(frame){if(frame.type==='WXXX'){if(frame.size<2){return undefined;}var index=1;var description=ID3._utf8ArrayToStr(frame.data.subarray(index));index+=description.length+1;var value=ID3._utf8ArrayToStr(frame.data.subarray(index));return{key:frame.type,info:description,data:value};}else{var url=ID3._utf8ArrayToStr(frame.data);return{key:frame.type,data:url};}}},{key:'_utf8ArrayToStr',value:function _utf8ArrayToStr(array){var char2=void 0;var char3=void 0;var out='';var i=0;var length=array.length;while(i<length){var c=array[i++];switch(c>>4){case 0:return out;case 1:case 2:case 3:case 4:case 5:case 6:case 7:out+=String.fromCharCode(c);break;case 12:case 13:char2=array[i++];out+=String.fromCharCode((c&0x1F)<<6|char2&0x3F);break;case 14:char2=array[i++];char3=array[i++];out+=String.fromCharCode((c&0x0F)<<12|(char2&0x3F)<<6|(char3&0x3F)<<0);break;}}return out;}}]);return ID3;}();exports.default=ID3;},{}],28:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _id=_dereq_(27);var _id2=_interopRequireDefault(_id);var _logger=_dereq_(54);var _mpegaudio=_dereq_(30);var _mpegaudio2=_interopRequireDefault(_mpegaudio);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var MP3Demuxer=function(){function MP3Demuxer(observer,remuxer,config){_classCallCheck$$1(this,MP3Demuxer);this.observer=observer;this.config=config;this.remuxer=remuxer;}_createClass$$1(MP3Demuxer,[{key:'resetInitSegment',value:function resetInitSegment(initSegment,audioCodec,videoCodec,duration){this._audioTrack={container:'audio/mpeg',type:'audio',id:-1,sequenceNumber:0,isAAC:false,samples:[],len:0,manifestCodec:audioCodec,duration:duration,inputTimeScale:90000};}},{key:'resetTimeStamp',value:function resetTimeStamp(){}},{key:'append',value:function append(data,timeOffset,contiguous,accurateTimeOffset){var id3Data=_id2.default.getID3Data(data,0);var pts=90*_id2.default.getTimeStamp(id3Data);var offset=id3Data.length;var length=data.length;var frameIndex=0,stamp=0;var track=this._audioTrack;var id3Samples=[{pts:pts,dts:pts,data:id3Data}];while(offset<length){if(_mpegaudio2.default.isHeader(data,offset)){var frame=_mpegaudio2.default.appendFrame(track,data,offset,pts,frameIndex);if(frame){offset+=frame.length;stamp=frame.sample.pts;frameIndex++;}else{break;}}else if(_id2.default.isHeader(data,offset)){id3Data=_id2.default.getID3Data(data,offset);id3Samples.push({pts:stamp,dts:stamp,data:id3Data});offset+=id3Data.length;}else{offset++;}}this.remuxer.remux(track,{samples:[]},{samples:id3Samples,inputTimeScale:90000},{samples:[]},timeOffset,contiguous,accurateTimeOffset);}},{key:'destroy',value:function destroy(){}}],[{key:'probe',value:function probe(data){var offset,length;var id3Data=_id2.default.getID3Data(data,0);if(id3Data&&_id2.default.getTimeStamp(id3Data)!==undefined){for(offset=id3Data.length,length=Math.min(data.length-1,offset+100);offset<length;offset++){if(_mpegaudio2.default.probe(data,offset)){_logger.logger.log('MPEG Audio sync word found !');return true;}}}return false;}}]);return MP3Demuxer;}();exports.default=MP3Demuxer;},{"27":27,"30":30,"54":54}],29:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var UINT32_MAX=Math.pow(2,32)-1;var MP4Demuxer=function(){function MP4Demuxer(observer,remuxer){_classCallCheck$$1(this,MP4Demuxer);this.observer=observer;this.remuxer=remuxer;}_createClass$$1(MP4Demuxer,[{key:'resetTimeStamp',value:function resetTimeStamp(initPTS){this.initPTS=initPTS;}},{key:'resetInitSegment',value:function resetInitSegment(initSegment,audioCodec,videoCodec,duration){if(initSegment&&initSegment.byteLength){var initData=this.initData=MP4Demuxer.parseInitSegment(initSegment);var tracks={};if(initData.audio){tracks.audio={container:'audio/mp4',codec:audioCodec,initSegment:duration?initSegment:null};}if(initData.video){tracks.video={container:'video/mp4',codec:videoCodec,initSegment:duration?initSegment:null};}this.observer.trigger(_events2.default.FRAG_PARSING_INIT_SEGMENT,{tracks:tracks});}else{if(audioCodec){this.audioCodec=audioCodec;}if(videoCodec){this.videoCodec=videoCodec;}}}},{key:'append',value:function append(data,timeOffset,contiguous,accurateTimeOffset){var initData=this.initData;if(!initData){this.resetInitSegment(data,this.audioCodec,this.videoCodec);initData=this.initData;}var startDTS=void 0,initPTS=this.initPTS;if(initPTS===undefined){var _startDTS=MP4Demuxer.getStartDTS(initData,data);this.initPTS=initPTS=_startDTS-timeOffset;this.observer.trigger(_events2.default.INIT_PTS_FOUND,{initPTS:initPTS});}MP4Demuxer.offsetStartDTS(initData,data,initPTS);startDTS=MP4Demuxer.getStartDTS(initData,data);this.remuxer.remux(initData.audio,initData.video,null,null,startDTS,contiguous,accurateTimeOffset,data);}},{key:'destroy',value:function destroy(){}}],[{key:'probe',value:function probe(data){if(data.length>=8){var dataType=MP4Demuxer.bin2str(data.subarray(4,8));return['moof','ftyp','styp'].indexOf(dataType)>=0;}return false;}},{key:'bin2str',value:function bin2str(buffer){return String.fromCharCode.apply(null,buffer);}},{key:'readUint32',value:function readUint32(buffer,offset){if(buffer.data){offset+=buffer.start;buffer=buffer.data;}var val=buffer[offset]<<24|buffer[offset+1]<<16|buffer[offset+2]<<8|buffer[offset+3];return val<0?4294967296+val:val;}},{key:'writeUint32',value:function writeUint32(buffer,offset,value){if(buffer.data){offset+=buffer.start;buffer=buffer.data;}buffer[offset]=value>>24;buffer[offset+1]=value>>16&0xff;buffer[offset+2]=value>>8&0xff;buffer[offset+3]=value&0xff;}},{key:'findBox',value:function findBox(data,path){var results=[],i,size,type,end,subresults,start,endbox;if(data.data){start=data.start;end=data.end;data=data.data;}else{start=0;end=data.byteLength;}if(!path.length){return null;}for(i=start;i<end;){size=MP4Demuxer.readUint32(data,i);type=MP4Demuxer.bin2str(data.subarray(i+4,i+8));endbox=size>1?i+size:end;if(type===path[0]){if(path.length===1){results.push({data:data,start:i+8,end:endbox});}else{subresults=MP4Demuxer.findBox({data:data,start:i+8,end:endbox},path.slice(1));if(subresults.length){results=results.concat(subresults);}}}i=endbox;}return results;}},{key:'parseInitSegment',value:function parseInitSegment(initSegment){var result=[];var traks=MP4Demuxer.findBox(initSegment,['moov','trak']);traks.forEach(function(trak){var tkhd=MP4Demuxer.findBox(trak,['tkhd'])[0];if(tkhd){var version=tkhd.data[tkhd.start];var index=version===0?12:20;var trackId=MP4Demuxer.readUint32(tkhd,index);var mdhd=MP4Demuxer.findBox(trak,['mdia','mdhd'])[0];if(mdhd){version=mdhd.data[mdhd.start];index=version===0?12:20;var timescale=MP4Demuxer.readUint32(mdhd,index);var hdlr=MP4Demuxer.findBox(trak,['mdia','hdlr'])[0];if(hdlr){var hdlrType=MP4Demuxer.bin2str(hdlr.data.subarray(hdlr.start+8,hdlr.start+12));var type={'soun':'audio','vide':'video'}[hdlrType];if(type){result[trackId]={timescale:timescale,type:type};result[type]={timescale:timescale,id:trackId};}}}}});return result;}},{key:'getStartDTS',value:function getStartDTS(initData,fragment){var trafs,baseTimes,result;trafs=MP4Demuxer.findBox(fragment,['moof','traf']);baseTimes=[].concat.apply([],trafs.map(function(traf){return MP4Demuxer.findBox(traf,['tfhd']).map(function(tfhd){var id,scale,baseTime;id=MP4Demuxer.readUint32(tfhd,4);scale=initData[id].timescale||90e3;baseTime=MP4Demuxer.findBox(traf,['tfdt']).map(function(tfdt){var version,result;version=tfdt.data[tfdt.start];result=MP4Demuxer.readUint32(tfdt,4);if(version===1){result*=Math.pow(2,32);result+=MP4Demuxer.readUint32(tfdt,8);}return result;})[0];baseTime=baseTime||Infinity;return baseTime/scale;});}));result=Math.min.apply(null,baseTimes);return isFinite(result)?result:0;}},{key:'offsetStartDTS',value:function offsetStartDTS(initData,fragment,timeOffset){MP4Demuxer.findBox(fragment,['moof','traf']).map(function(traf){return MP4Demuxer.findBox(traf,['tfhd']).map(function(tfhd){var id=MP4Demuxer.readUint32(tfhd,4);var timescale=initData[id].timescale||90e3;MP4Demuxer.findBox(traf,['tfdt']).map(function(tfdt){var version=tfdt.data[tfdt.start];var baseMediaDecodeTime=MP4Demuxer.readUint32(tfdt,4);if(version===0){MP4Demuxer.writeUint32(tfdt,4,baseMediaDecodeTime-timeOffset*timescale);}else{baseMediaDecodeTime*=Math.pow(2,32);baseMediaDecodeTime+=MP4Demuxer.readUint32(tfdt,8);baseMediaDecodeTime-=timeOffset*timescale;var upper=Math.floor(baseMediaDecodeTime/(UINT32_MAX+1));var lower=Math.floor(baseMediaDecodeTime%(UINT32_MAX+1));MP4Demuxer.writeUint32(tfdt,4,upper);MP4Demuxer.writeUint32(tfdt,8,lower);}});});});}}]);return MP4Demuxer;}();exports.default=MP4Demuxer;},{"35":35}],30:[function(_dereq_,module,exports){"use strict";var MpegAudio={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48000,32000,22050,24000,16000,11025,12000,8000],appendFrame:function appendFrame(track,data,offset,pts,frameIndex){if(offset+24>data.length){return undefined;}var header=this.parseHeader(data,offset);if(header&&offset+header.frameLength<=data.length){var frameDuration=1152*90000/header.sampleRate;var stamp=pts+frameIndex*frameDuration;var sample={unit:data.subarray(offset,offset+header.frameLength),pts:stamp,dts:stamp};track.config=[];track.channelCount=header.channelCount;track.samplerate=header.sampleRate;track.samples.push(sample);track.len+=header.frameLength;return{sample:sample,length:header.frameLength};}return undefined;},parseHeader:function parseHeader(data,offset){var headerB=data[offset+1]>>3&3;var headerC=data[offset+1]>>1&3;var headerE=data[offset+2]>>4&15;var headerF=data[offset+2]>>2&3;var headerG=!!(data[offset+2]&2);if(headerB!==1&&headerE!==0&&headerE!==15&&headerF!==3){var columnInBitrates=headerB===3?3-headerC:headerC===3?3:4;var bitRate=MpegAudio.BitratesMap[columnInBitrates*14+headerE-1]*1000;var columnInSampleRates=headerB===3?0:headerB===2?1:2;var sampleRate=MpegAudio.SamplingRateMap[columnInSampleRates*3+headerF];var padding=headerG?1:0;var channelCount=data[offset+3]>>6===3?1:2;var frameLength=headerC===3?(headerB===3?12:6)*bitRate/sampleRate+padding<<2:(headerB===3?144:72)*bitRate/sampleRate+padding|0;return{sampleRate:sampleRate,channelCount:channelCount,frameLength:frameLength};}return undefined;},isHeaderPattern:function isHeaderPattern(data,offset){return data[offset]===0xff&&(data[offset+1]&0xe0)===0xe0&&(data[offset+1]&0x06)!==0x00;},isHeader:function isHeader(data,offset){if(offset+1<data.length&&this.isHeaderPattern(data,offset)){return true;}return false;},probe:function probe(data,offset){if(offset+1<data.length&&this.isHeaderPattern(data,offset)){var headerLength=4;var header=this.parseHeader(data,offset);var frameLength=headerLength;if(header&&header.frameLength){frameLength=header.frameLength;}var newOffset=offset+frameLength;if(newOffset===data.length||newOffset+1<data.length&&this.isHeaderPattern(data,newOffset)){return true;}}return false;}};module.exports=MpegAudio;},{}],31:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _decrypter=_dereq_(19);var _decrypter2=_interopRequireDefault(_decrypter);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var SampleAesDecrypter=function(){function SampleAesDecrypter(observer,config,decryptdata,discardEPB){_classCallCheck$$1(this,SampleAesDecrypter);this.decryptdata=decryptdata;this.discardEPB=discardEPB;this.decrypter=new _decrypter2.default(observer,config);}_createClass$$1(SampleAesDecrypter,[{key:'decryptBuffer',value:function decryptBuffer(encryptedData,callback){this.decrypter.decrypt(encryptedData,this.decryptdata.key.buffer,this.decryptdata.iv.buffer,callback);}},{key:'decryptAacSample',value:function decryptAacSample(samples,sampleIndex,callback,sync){var curUnit=samples[sampleIndex].unit;var encryptedData=curUnit.subarray(16,curUnit.length-curUnit.length%16);var encryptedBuffer=encryptedData.buffer.slice(encryptedData.byteOffset,encryptedData.byteOffset+encryptedData.length);var localthis=this;this.decryptBuffer(encryptedBuffer,function(decryptedData){decryptedData=new Uint8Array(decryptedData);curUnit.set(decryptedData,16);if(!sync){localthis.decryptAacSamples(samples,sampleIndex+1,callback);}});}},{key:'decryptAacSamples',value:function decryptAacSamples(samples,sampleIndex,callback){for(;;sampleIndex++){if(sampleIndex>=samples.length){callback();return;}if(samples[sampleIndex].unit.length<32){continue;}var sync=this.decrypter.isSync();this.decryptAacSample(samples,sampleIndex,callback,sync);if(!sync){return;}}}},{key:'getAvcEncryptedData',value:function getAvcEncryptedData(decodedData){var encryptedDataLen=Math.floor((decodedData.length-48)/160)*16+16;var encryptedData=new Int8Array(encryptedDataLen);var outputPos=0;for(var inputPos=32;inputPos<=decodedData.length-16;inputPos+=160,outputPos+=16){encryptedData.set(decodedData.subarray(inputPos,inputPos+16),outputPos);}return encryptedData;}},{key:'getAvcDecryptedUnit',value:function getAvcDecryptedUnit(decodedData,decryptedData){decryptedData=new Uint8Array(decryptedData);var inputPos=0;for(var outputPos=32;outputPos<=decodedData.length-16;outputPos+=160,inputPos+=16){decodedData.set(decryptedData.subarray(inputPos,inputPos+16),outputPos);}return decodedData;}},{key:'decryptAvcSample',value:function decryptAvcSample(samples,sampleIndex,unitIndex,callback,curUnit,sync){var decodedData=this.discardEPB(curUnit.data);var encryptedData=this.getAvcEncryptedData(decodedData);var localthis=this;this.decryptBuffer(encryptedData.buffer,function(decryptedData){curUnit.data=localthis.getAvcDecryptedUnit(decodedData,decryptedData);if(!sync){localthis.decryptAvcSamples(samples,sampleIndex,unitIndex+1,callback);}});}},{key:'decryptAvcSamples',value:function decryptAvcSamples(samples,sampleIndex,unitIndex,callback){for(;;sampleIndex++,unitIndex=0){if(sampleIndex>=samples.length){callback();return;}var curUnits=samples[sampleIndex].units;for(;;unitIndex++){if(unitIndex>=curUnits.length){break;}var curUnit=curUnits[unitIndex];if(curUnit.length<=48||curUnit.type!==1&&curUnit.type!==5){continue;}var sync=this.decrypter.isSync();this.decryptAvcSample(samples,sampleIndex,unitIndex,callback,curUnit,sync);if(!sync){return;}}}}}]);return SampleAesDecrypter;}();exports.default=SampleAesDecrypter;},{"19":19}],32:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _adts=_dereq_(22);var _adts2=_interopRequireDefault(_adts);var _mpegaudio=_dereq_(30);var _mpegaudio2=_interopRequireDefault(_mpegaudio);var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _expGolomb=_dereq_(26);var _expGolomb2=_interopRequireDefault(_expGolomb);var _sampleAes=_dereq_(31);var _sampleAes2=_interopRequireDefault(_sampleAes);var _logger=_dereq_(54);var _errors=_dereq_(33);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var TSDemuxer=function(){function TSDemuxer(observer,remuxer,config,typeSupported){_classCallCheck$$1(this,TSDemuxer);this.observer=observer;this.config=config;this.typeSupported=typeSupported;this.remuxer=remuxer;this.sampleAes=null;}_createClass$$1(TSDemuxer,[{key:'setDecryptData',value:function setDecryptData(decryptdata){if(decryptdata!=null&&decryptdata.key!=null&&decryptdata.method==='SAMPLE-AES'){this.sampleAes=new _sampleAes2.default(this.observer,this.config,decryptdata,this.discardEPB);}else{this.sampleAes=null;}}},{key:'resetInitSegment',value:function resetInitSegment(initSegment,audioCodec,videoCodec,duration){this.pmtParsed=false;this._pmtId=-1;this._avcTrack={container:'video/mp2t',type:'video',id:-1,inputTimeScale:90000,sequenceNumber:0,samples:[],len:0,dropped:0};this._audioTrack={container:'video/mp2t',type:'audio',id:-1,inputTimeScale:90000,duration:duration,sequenceNumber:0,samples:[],len:0,isAAC:true};this._id3Track={type:'id3',id:-1,inputTimeScale:90000,sequenceNumber:0,samples:[],len:0};this._txtTrack={type:'text',id:-1,inputTimeScale:90000,sequenceNumber:0,samples:[],len:0};this.aacOverFlow=null;this.aacLastPTS=null;this.avcSample=null;this.audioCodec=audioCodec;this.videoCodec=videoCodec;this._duration=duration;}},{key:'resetTimeStamp',value:function resetTimeStamp(){}},{key:'append',value:function append(data,timeOffset,contiguous,accurateTimeOffset){var start,len=data.length,stt,pid,atf,offset,pes,unknownPIDs=false;this.contiguous=contiguous;var pmtParsed=this.pmtParsed,avcTrack=this._avcTrack,audioTrack=this._audioTrack,id3Track=this._id3Track,avcId=avcTrack.id,audioId=audioTrack.id,id3Id=id3Track.id,pmtId=this._pmtId,avcData=avcTrack.pesData,audioData=audioTrack.pesData,id3Data=id3Track.pesData,parsePAT=this._parsePAT,parsePMT=this._parsePMT,parsePES=this._parsePES,parseAVCPES=this._parseAVCPES.bind(this),parseAACPES=this._parseAACPES.bind(this),parseMPEGPES=this._parseMPEGPES.bind(this),parseID3PES=this._parseID3PES.bind(this);len-=len%188;for(start=0;start<len;start+=188){if(data[start]===0x47){stt=!!(data[start+1]&0x40);pid=((data[start+1]&0x1f)<<8)+data[start+2];atf=(data[start+3]&0x30)>>4;if(atf>1){offset=start+5+data[start+4];if(offset===start+188){continue;}}else{offset=start+4;}switch(pid){case avcId:if(stt){if(avcData&&(pes=parsePES(avcData))){parseAVCPES(pes,false);}avcData={data:[],size:0};}if(avcData){avcData.data.push(data.subarray(offset,start+188));avcData.size+=start+188-offset;}break;case audioId:if(stt){if(audioData&&(pes=parsePES(audioData))){if(audioTrack.isAAC){parseAACPES(pes);}else{parseMPEGPES(pes);}}audioData={data:[],size:0};}if(audioData){audioData.data.push(data.subarray(offset,start+188));audioData.size+=start+188-offset;}break;case id3Id:if(stt){if(id3Data&&(pes=parsePES(id3Data))){parseID3PES(pes);}id3Data={data:[],size:0};}if(id3Data){id3Data.data.push(data.subarray(offset,start+188));id3Data.size+=start+188-offset;}break;case 0:if(stt){offset+=data[offset]+1;}pmtId=this._pmtId=parsePAT(data,offset);break;case pmtId:if(stt){offset+=data[offset]+1;}var parsedPIDs=parsePMT(data,offset,this.typeSupported.mpeg===true||this.typeSupported.mp3===true,this.sampleAes!=null);avcId=parsedPIDs.avc;if(avcId>0){avcTrack.id=avcId;}audioId=parsedPIDs.audio;if(audioId>0){audioTrack.id=audioId;audioTrack.isAAC=parsedPIDs.isAAC;}id3Id=parsedPIDs.id3;if(id3Id>0){id3Track.id=id3Id;}if(unknownPIDs&&!pmtParsed){_logger.logger.log('reparse from beginning');unknownPIDs=false;start=-188;}pmtParsed=this.pmtParsed=true;break;case 17:case 0x1fff:break;default:unknownPIDs=true;break;}}else{this.observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:false,reason:'TS packet did not start with 0x47'});}}if(avcData&&(pes=parsePES(avcData))){parseAVCPES(pes,true);avcTrack.pesData=null;}else{avcTrack.pesData=avcData;}if(audioData&&(pes=parsePES(audioData))){if(audioTrack.isAAC){parseAACPES(pes);}else{parseMPEGPES(pes);}audioTrack.pesData=null;}else{if(audioData&&audioData.size){_logger.logger.log('last AAC PES packet truncated,might overlap between fragments');}audioTrack.pesData=audioData;}if(id3Data&&(pes=parsePES(id3Data))){parseID3PES(pes);id3Track.pesData=null;}else{id3Track.pesData=id3Data;}if(this.sampleAes==null){this.remuxer.remux(audioTrack,avcTrack,id3Track,this._txtTrack,timeOffset,contiguous,accurateTimeOffset);}else{this.decryptAndRemux(audioTrack,avcTrack,id3Track,this._txtTrack,timeOffset,contiguous,accurateTimeOffset);}}},{key:'decryptAndRemux',value:function decryptAndRemux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset){if(audioTrack.samples&&audioTrack.isAAC){var localthis=this;this.sampleAes.decryptAacSamples(audioTrack.samples,0,function(){localthis.decryptAndRemuxAvc(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset);});}else{this.decryptAndRemuxAvc(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset);}}},{key:'decryptAndRemuxAvc',value:function decryptAndRemuxAvc(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset){if(videoTrack.samples){var localthis=this;this.sampleAes.decryptAvcSamples(videoTrack.samples,0,0,function(){localthis.remuxer.remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset);});}else{this.remuxer.remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset);}}},{key:'destroy',value:function destroy(){this._initPTS=this._initDTS=undefined;this._duration=0;}},{key:'_parsePAT',value:function _parsePAT(data,offset){return(data[offset+10]&0x1F)<<8|data[offset+11];}},{key:'_parsePMT',value:function _parsePMT(data,offset,mpegSupported,isSampleAes){var sectionLength,tableEnd,programInfoLength,pid,result={audio:-1,avc:-1,id3:-1,isAAC:true};sectionLength=(data[offset+1]&0x0f)<<8|data[offset+2];tableEnd=offset+3+sectionLength-4;programInfoLength=(data[offset+10]&0x0f)<<8|data[offset+11];offset+=12+programInfoLength;while(offset<tableEnd){pid=(data[offset+1]&0x1F)<<8|data[offset+2];switch(data[offset]){case 0xcf:if(!isSampleAes){_logger.logger.log('unkown stream type:'+data[offset]);break;}case 0x0f:if(result.audio===-1){result.audio=pid;}break;case 0x15:if(result.id3===-1){result.id3=pid;}break;case 0xdb:if(!isSampleAes){_logger.logger.log('unkown stream type:'+data[offset]);break;}case 0x1b:if(result.avc===-1){result.avc=pid;}break;case 0x03:case 0x04:if(!mpegSupported){_logger.logger.log('MPEG audio found, not supported in this browser for now');}else if(result.audio===-1){result.audio=pid;result.isAAC=false;}break;case 0x24:_logger.logger.warn('HEVC stream type found, not supported for now');break;default:_logger.logger.log('unkown stream type:'+data[offset]);break;}offset+=((data[offset+3]&0x0F)<<8|data[offset+4])+5;}return result;}},{key:'_parsePES',value:function _parsePES(stream){var i=0,frag,pesFlags,pesPrefix,pesLen,pesHdrLen,pesData,pesPts,pesDts,payloadStartOffset,data=stream.data;if(!stream||stream.size===0){return null;}while(data[0].length<19&&data.length>1){var newData=new Uint8Array(data[0].length+data[1].length);newData.set(data[0]);newData.set(data[1],data[0].length);data[0]=newData;data.splice(1,1);}frag=data[0];pesPrefix=(frag[0]<<16)+(frag[1]<<8)+frag[2];if(pesPrefix===1){pesLen=(frag[4]<<8)+frag[5];if(pesLen&&pesLen>stream.size-6){return null;}pesFlags=frag[7];if(pesFlags&0xC0){pesPts=(frag[9]&0x0E)*536870912+(frag[10]&0xFF)*4194304+(frag[11]&0xFE)*16384+(frag[12]&0xFF)*128+(frag[13]&0xFE)/2;if(pesPts>4294967295){pesPts-=8589934592;}if(pesFlags&0x40){pesDts=(frag[14]&0x0E)*536870912+(frag[15]&0xFF)*4194304+(frag[16]&0xFE)*16384+(frag[17]&0xFF)*128+(frag[18]&0xFE)/2;if(pesDts>4294967295){pesDts-=8589934592;}if(pesPts-pesDts>60*90000){_logger.logger.warn(Math.round((pesPts-pesDts)/90000)+'s delta between PTS and DTS, align them');pesPts=pesDts;}}else{pesDts=pesPts;}}pesHdrLen=frag[8];payloadStartOffset=pesHdrLen+9;stream.size-=payloadStartOffset;pesData=new Uint8Array(stream.size);for(var j=0,dataLen=data.length;j<dataLen;j++){frag=data[j];var len=frag.byteLength;if(payloadStartOffset){if(payloadStartOffset>len){payloadStartOffset-=len;continue;}else{frag=frag.subarray(payloadStartOffset);len-=payloadStartOffset;payloadStartOffset=0;}}pesData.set(frag,i);i+=len;}if(pesLen){pesLen-=pesHdrLen+3;}return{data:pesData,pts:pesPts,dts:pesDts,len:pesLen};}else{return null;}}},{key:'pushAccesUnit',value:function pushAccesUnit(avcSample,avcTrack){if(avcSample.units.length&&avcSample.frame){var samples=avcTrack.samples;var nbSamples=samples.length;if(!this.config.forceKeyFrameOnDiscontinuity||avcSample.key===true||avcTrack.sps&&(nbSamples||this.contiguous)){avcSample.id=nbSamples;samples.push(avcSample);}else{avcTrack.dropped++;}}if(avcSample.debug.length){_logger.logger.log(avcSample.pts+'/'+avcSample.dts+':'+avcSample.debug);}}},{key:'_parseAVCPES',value:function _parseAVCPES(pes,last){var _this=this;var track=this._avcTrack,units=this._parseAVCNALu(pes.data),debug=false,expGolombDecoder,avcSample=this.avcSample,push,spsfound=false,i;pes.data=null;units.forEach(function(unit){switch(unit.type){case 1:push=true;if(debug&&avcSample){avcSample.debug+='NDR ';}avcSample.frame=true;var data=unit.data;if(spsfound&&data.length>4){var sliceType=new _expGolomb2.default(data).readSliceType();if(sliceType===2||sliceType===4||sliceType===7||sliceType===9){avcSample.key=true;}}break;case 5:push=true;if(!avcSample){avcSample=_this.avcSample=_this._createAVCSample(true,pes.pts,pes.dts,'');}if(debug){avcSample.debug+='IDR ';}avcSample.key=true;avcSample.frame=true;break;case 6:push=true;if(debug&&avcSample){avcSample.debug+='SEI ';}expGolombDecoder=new _expGolomb2.default(_this.discardEPB(unit.data));expGolombDecoder.readUByte();var payloadType=0;var payloadSize=0;var endOfCaptions=false;var b=0;while(!endOfCaptions&&expGolombDecoder.bytesAvailable>1){payloadType=0;do{b=expGolombDecoder.readUByte();payloadType+=b;}while(b===0xFF);payloadSize=0;do{b=expGolombDecoder.readUByte();payloadSize+=b;}while(b===0xFF);if(payloadType===4&&expGolombDecoder.bytesAvailable!==0){endOfCaptions=true;var countryCode=expGolombDecoder.readUByte();if(countryCode===181){var providerCode=expGolombDecoder.readUShort();if(providerCode===49){var userStructure=expGolombDecoder.readUInt();if(userStructure===0x47413934){var userDataType=expGolombDecoder.readUByte();if(userDataType===3){var firstByte=expGolombDecoder.readUByte();var secondByte=expGolombDecoder.readUByte();var totalCCs=31&firstByte;var byteArray=[firstByte,secondByte];for(i=0;i<totalCCs;i++){byteArray.push(expGolombDecoder.readUByte());byteArray.push(expGolombDecoder.readUByte());byteArray.push(expGolombDecoder.readUByte());}_this._insertSampleInOrder(_this._txtTrack.samples,{type:3,pts:pes.pts,bytes:byteArray});}}}}}else if(payloadSize<expGolombDecoder.bytesAvailable){for(i=0;i<payloadSize;i++){expGolombDecoder.readUByte();}}}break;case 7:push=true;spsfound=true;if(debug&&avcSample){avcSample.debug+='SPS ';}if(!track.sps){expGolombDecoder=new _expGolomb2.default(unit.data);var config=expGolombDecoder.readSPS();track.width=config.width;track.height=config.height;track.pixelRatio=config.pixelRatio;track.sps=[unit.data];track.duration=_this._duration;var codecarray=unit.data.subarray(1,4);var codecstring='avc1.';for(i=0;i<3;i++){var h=codecarray[i].toString(16);if(h.length<2){h='0'+h;}codecstring+=h;}track.codec=codecstring;}break;case 8:push=true;if(debug&&avcSample){avcSample.debug+='PPS ';}if(!track.pps){track.pps=[unit.data];}break;case 9:push=false;if(avcSample){_this.pushAccesUnit(avcSample,track);}avcSample=_this.avcSample=_this._createAVCSample(false,pes.pts,pes.dts,debug?'AUD ':'');break;case 12:push=false;break;default:push=false;if(avcSample){avcSample.debug+='unknown NAL '+unit.type+' ';}break;}if(avcSample&&push){var _units=avcSample.units;_units.push(unit);}});if(last&&avcSample){this.pushAccesUnit(avcSample,track);this.avcSample=null;}}},{key:'_createAVCSample',value:function _createAVCSample(key,pts,dts,debug){return{key:key,pts:pts,dts:dts,units:[],debug:debug};}},{key:'_insertSampleInOrder',value:function _insertSampleInOrder(arr,data){var len=arr.length;if(len>0){if(data.pts>=arr[len-1].pts){arr.push(data);}else{for(var pos=len-1;pos>=0;pos--){if(data.pts<arr[pos].pts){arr.splice(pos,0,data);break;}}}}else{arr.push(data);}}},{key:'_getLastNalUnit',value:function _getLastNalUnit(){var avcSample=this.avcSample,lastUnit=void 0;if(!avcSample||avcSample.units.length===0){var track=this._avcTrack,samples=track.samples;avcSample=samples[samples.length-1];}if(avcSample){var units=avcSample.units;lastUnit=units[units.length-1];}return lastUnit;}},{key:'_parseAVCNALu',value:function _parseAVCNALu(array){var i=0,len=array.byteLength,value,overflow,track=this._avcTrack,state=track.naluState||0,lastState=state;var units=[],unit,unitType,lastUnitStart=-1,lastUnitType;if(state===-1){lastUnitStart=0;lastUnitType=array[0]&0x1f;state=0;i=1;}while(i<len){value=array[i++];if(!state){state=value?0:1;continue;}if(state===1){state=value?0:2;continue;}if(!value){state=3;}else if(value===1){if(lastUnitStart>=0){unit={data:array.subarray(lastUnitStart,i-state-1),type:lastUnitType};units.push(unit);}else{var lastUnit=this._getLastNalUnit();if(lastUnit){if(lastState&&i<=4-lastState){if(lastUnit.state){lastUnit.data=lastUnit.data.subarray(0,lastUnit.data.byteLength-lastState);}}overflow=i-state-1;if(overflow>0){var tmp=new Uint8Array(lastUnit.data.byteLength+overflow);tmp.set(lastUnit.data,0);tmp.set(array.subarray(0,overflow),lastUnit.data.byteLength);lastUnit.data=tmp;}}}if(i<len){unitType=array[i]&0x1f;lastUnitStart=i;lastUnitType=unitType;state=0;}else{state=-1;}}else{state=0;}}if(lastUnitStart>=0&&state>=0){unit={data:array.subarray(lastUnitStart,len),type:lastUnitType,state:state};units.push(unit);}if(units.length===0){var _lastUnit=this._getLastNalUnit();if(_lastUnit){var _tmp=new Uint8Array(_lastUnit.data.byteLength+array.byteLength);_tmp.set(_lastUnit.data,0);_tmp.set(array,_lastUnit.data.byteLength);_lastUnit.data=_tmp;}}track.naluState=state;return units;}},{key:'discardEPB',value:function discardEPB(data){var length=data.byteLength,EPBPositions=[],i=1,newLength,newData;while(i<length-2){if(data[i]===0&&data[i+1]===0&&data[i+2]===0x03){EPBPositions.push(i+2);i+=2;}else{i++;}}if(EPBPositions.length===0){return data;}newLength=length-EPBPositions.length;newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++){if(sourceIndex===EPBPositions[0]){sourceIndex++;EPBPositions.shift();}newData[i]=data[sourceIndex];}return newData;}},{key:'_parseAACPES',value:function _parseAACPES(pes){var track=this._audioTrack,data=pes.data,pts=pes.pts,startOffset=0,aacOverFlow=this.aacOverFlow,aacLastPTS=this.aacLastPTS,frameDuration,frameIndex,offset,stamp,len;if(aacOverFlow){var tmp=new Uint8Array(aacOverFlow.byteLength+data.byteLength);tmp.set(aacOverFlow,0);tmp.set(data,aacOverFlow.byteLength);data=tmp;}for(offset=startOffset,len=data.length;offset<len-1;offset++){if(_adts2.default.isHeader(data,offset)){break;}}if(offset){var reason,fatal;if(offset<len-1){reason='AAC PES did not start with ADTS header,offset:'+offset;fatal=false;}else{reason='no ADTS header found in AAC PES';fatal=true;}_logger.logger.warn('parsing error:'+reason);this.observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:fatal,reason:reason});if(fatal){return;}}_adts2.default.initTrackConfig(track,this.observer,data,offset,this.audioCodec);frameIndex=0;frameDuration=_adts2.default.getFrameDuration(track.samplerate);if(aacOverFlow&&aacLastPTS){var newPTS=aacLastPTS+frameDuration;if(Math.abs(newPTS-pts)>1){_logger.logger.log('AAC: align PTS for overlapping frames by '+Math.round((newPTS-pts)/90));pts=newPTS;}}while(offset<len){if(_adts2.default.isHeader(data,offset)&&offset+5<len){var frame=_adts2.default.appendFrame(track,data,offset,pts,frameIndex);if(frame){offset+=frame.length;stamp=frame.sample.pts;frameIndex++;}else{break;}}else{offset++;}}if(offset<len){aacOverFlow=data.subarray(offset,len);}else{aacOverFlow=null;}this.aacOverFlow=aacOverFlow;this.aacLastPTS=stamp;}},{key:'_parseMPEGPES',value:function _parseMPEGPES(pes){var data=pes.data;var length=data.length;var frameIndex=0;var offset=0;var pts=pes.pts;while(offset<length){if(_mpegaudio2.default.isHeader(data,offset)){var frame=_mpegaudio2.default.appendFrame(this._audioTrack,data,offset,pts,frameIndex);if(frame){offset+=frame.length;frameIndex++;}else{break;}}else{offset++;}}}},{key:'_parseID3PES',value:function _parseID3PES(pes){this._id3Track.samples.push(pes);}}],[{key:'probe',value:function probe(data){if(data.length>=3*188&&data[0]===0x47&&data[188]===0x47&&data[2*188]===0x47){return true;}else{return false;}}}]);return TSDemuxer;}();exports.default=TSDemuxer;},{"22":22,"26":26,"30":30,"31":31,"33":33,"35":35,"54":54}],33:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var ErrorTypes=exports.ErrorTypes={NETWORK_ERROR:'networkError',MEDIA_ERROR:'mediaError',MUX_ERROR:'muxError',OTHER_ERROR:'otherError'};var ErrorDetails=exports.ErrorDetails={MANIFEST_LOAD_ERROR:'manifestLoadError',MANIFEST_LOAD_TIMEOUT:'manifestLoadTimeOut',MANIFEST_PARSING_ERROR:'manifestParsingError',MANIFEST_INCOMPATIBLE_CODECS_ERROR:'manifestIncompatibleCodecsError',LEVEL_LOAD_ERROR:'levelLoadError',LEVEL_LOAD_TIMEOUT:'levelLoadTimeOut',LEVEL_SWITCH_ERROR:'levelSwitchError',AUDIO_TRACK_LOAD_ERROR:'audioTrackLoadError',AUDIO_TRACK_LOAD_TIMEOUT:'audioTrackLoadTimeOut',FRAG_LOAD_ERROR:'fragLoadError',FRAG_LOOP_LOADING_ERROR:'fragLoopLoadingError',FRAG_LOAD_TIMEOUT:'fragLoadTimeOut',FRAG_DECRYPT_ERROR:'fragDecryptError',FRAG_PARSING_ERROR:'fragParsingError',REMUX_ALLOC_ERROR:'remuxAllocError',KEY_LOAD_ERROR:'keyLoadError',KEY_LOAD_TIMEOUT:'keyLoadTimeOut',BUFFER_ADD_CODEC_ERROR:'bufferAddCodecError',BUFFER_APPEND_ERROR:'bufferAppendError',BUFFER_APPENDING_ERROR:'bufferAppendingError',BUFFER_STALLED_ERROR:'bufferStalledError',BUFFER_FULL_ERROR:'bufferFullError',BUFFER_SEEK_OVER_HOLE:'bufferSeekOverHole',BUFFER_NUDGE_ON_STALL:'bufferNudgeOnStall',INTERNAL_EXCEPTION:'internalException',WEBVTT_EXCEPTION:'webVTTException'};},{}],34:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _typeof$$1=typeof Symbol==="function"&&_typeof2(Symbol.iterator)==="symbol"?function(obj){return typeof obj==='undefined'?'undefined':_typeof2(obj);}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj==='undefined'?'undefined':_typeof2(obj);};var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _logger=_dereq_(54);var _errors=_dereq_(33);var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var EventHandler=function(){function EventHandler(hls){_classCallCheck$$1(this,EventHandler);this.hls=hls;this.onEvent=this.onEvent.bind(this);for(var _len=arguments.length,events=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){events[_key-1]=arguments[_key];}this.handledEvents=events;this.useGenericHandler=true;this.registerListeners();}_createClass$$1(EventHandler,[{key:'destroy',value:function destroy(){this.unregisterListeners();}},{key:'isEventHandler',value:function isEventHandler(){return _typeof$$1(this.handledEvents)==='object'&&this.handledEvents.length&&typeof this.onEvent==='function';}},{key:'registerListeners',value:function registerListeners(){if(this.isEventHandler()){this.handledEvents.forEach(function(event){if(event==='hlsEventGeneric'){throw new Error('Forbidden event name: '+event);}this.hls.on(event,this.onEvent);},this);}}},{key:'unregisterListeners',value:function unregisterListeners(){if(this.isEventHandler()){this.handledEvents.forEach(function(event){this.hls.off(event,this.onEvent);},this);}}},{key:'onEvent',value:function onEvent(event,data){this.onEventGeneric(event,data);}},{key:'onEventGeneric',value:function onEventGeneric(event,data){var eventToFunction=function eventToFunction(event,data){var funcName='on'+event.replace('hls','');if(typeof this[funcName]!=='function'){throw new Error('Event '+event+' has no generic handler in this '+this.constructor.name+' class (tried '+funcName+')');}return this[funcName].bind(this,data);};try{eventToFunction.call(this,event,data).call();}catch(err){_logger.logger.error('internal error happened while processing '+event+':'+err.message);this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.OTHER_ERROR,details:_errors.ErrorDetails.INTERNAL_EXCEPTION,fatal:false,event:event,err:err});}}}]);return EventHandler;}();exports.default=EventHandler;},{"33":33,"35":35,"54":54}],35:[function(_dereq_,module,exports){'use strict';module.exports={MEDIA_ATTACHING:'hlsMediaAttaching',MEDIA_ATTACHED:'hlsMediaAttached',MEDIA_DETACHING:'hlsMediaDetaching',MEDIA_DETACHED:'hlsMediaDetached',BUFFER_RESET:'hlsBufferReset',BUFFER_CODECS:'hlsBufferCodecs',BUFFER_CREATED:'hlsBufferCreated',BUFFER_APPENDING:'hlsBufferAppending',BUFFER_APPENDED:'hlsBufferAppended',BUFFER_EOS:'hlsBufferEos',BUFFER_FLUSHING:'hlsBufferFlushing',BUFFER_FLUSHED:'hlsBufferFlushed',MANIFEST_LOADING:'hlsManifestLoading',MANIFEST_LOADED:'hlsManifestLoaded',MANIFEST_PARSED:'hlsManifestParsed',LEVEL_SWITCH:'hlsLevelSwitch',LEVEL_SWITCHING:'hlsLevelSwitching',LEVEL_SWITCHED:'hlsLevelSwitched',LEVEL_LOADING:'hlsLevelLoading',LEVEL_LOADED:'hlsLevelLoaded',LEVEL_UPDATED:'hlsLevelUpdated',LEVEL_PTS_UPDATED:'hlsLevelPtsUpdated',AUDIO_TRACKS_UPDATED:'hlsAudioTracksUpdated',AUDIO_TRACK_SWITCH:'hlsAudioTrackSwitch',AUDIO_TRACK_SWITCHING:'hlsAudioTrackSwitching',AUDIO_TRACK_SWITCHED:'hlsAudioTrackSwitched',AUDIO_TRACK_LOADING:'hlsAudioTrackLoading',AUDIO_TRACK_LOADED:'hlsAudioTrackLoaded',SUBTITLE_TRACKS_UPDATED:'hlsSubtitleTracksUpdated',SUBTITLE_TRACK_SWITCH:'hlsSubtitleTrackSwitch',SUBTITLE_TRACK_LOADING:'hlsSubtitleTrackLoading',SUBTITLE_TRACK_LOADED:'hlsSubtitleTrackLoaded',SUBTITLE_FRAG_PROCESSED:'hlsSubtitleFragProcessed',INIT_PTS_FOUND:'hlsInitPtsFound',FRAG_LOADING:'hlsFragLoading',FRAG_LOAD_PROGRESS:'hlsFragLoadProgress',FRAG_LOAD_EMERGENCY_ABORTED:'hlsFragLoadEmergencyAborted',FRAG_LOADED:'hlsFragLoaded',FRAG_DECRYPTED:'hlsFragDecrypted',FRAG_PARSING_INIT_SEGMENT:'hlsFragParsingInitSegment',FRAG_PARSING_USERDATA:'hlsFragParsingUserdata',FRAG_PARSING_METADATA:'hlsFragParsingMetadata',FRAG_PARSING_DATA:'hlsFragParsingData',FRAG_PARSED:'hlsFragParsed',FRAG_BUFFERED:'hlsFragBuffered',FRAG_CHANGED:'hlsFragChanged',FPS_DROP:'hlsFpsDrop',FPS_DROP_LEVEL_CAPPING:'hlsFpsDropLevelCapping',ERROR:'hlsError',DESTROYING:'hlsDestroying',KEY_LOADING:'hlsKeyLoading',KEY_LOADED:'hlsKeyLoaded',STREAM_STATE_TRANSITION:'hlsStreamStateTransition'};},{}],36:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var AAC=function(){function AAC(){_classCallCheck$$1(this,AAC);}_createClass$$1(AAC,null,[{key:'getSilentFrame',value:function getSilentFrame(codec,channelCount){switch(codec){case'mp4a.40.2':if(channelCount===1){return new Uint8Array([0x00,0xc8,0x00,0x80,0x23,0x80]);}else if(channelCount===2){return new Uint8Array([0x21,0x00,0x49,0x90,0x02,0x19,0x00,0x23,0x80]);}else if(channelCount===3){return new Uint8Array([0x00,0xc8,0x00,0x80,0x20,0x84,0x01,0x26,0x40,0x08,0x64,0x00,0x8e]);}else if(channelCount===4){return new Uint8Array([0x00,0xc8,0x00,0x80,0x20,0x84,0x01,0x26,0x40,0x08,0x64,0x00,0x80,0x2c,0x80,0x08,0x02,0x38]);}else if(channelCount===5){return new Uint8Array([0x00,0xc8,0x00,0x80,0x20,0x84,0x01,0x26,0x40,0x08,0x64,0x00,0x82,0x30,0x04,0x99,0x00,0x21,0x90,0x02,0x38]);}else if(channelCount===6){return new Uint8Array([0x00,0xc8,0x00,0x80,0x20,0x84,0x01,0x26,0x40,0x08,0x64,0x00,0x82,0x30,0x04,0x99,0x00,0x21,0x90,0x02,0x00,0xb2,0x00,0x20,0x08,0xe0]);}break;default:if(channelCount===1){return new Uint8Array([0x1,0x40,0x22,0x80,0xa3,0x4e,0xe6,0x80,0xba,0x8,0x0,0x0,0x0,0x1c,0x6,0xf1,0xc1,0xa,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5e]);}else if(channelCount===2){return new Uint8Array([0x1,0x40,0x22,0x80,0xa3,0x5e,0xe6,0x80,0xba,0x8,0x0,0x0,0x0,0x0,0x95,0x0,0x6,0xf1,0xa1,0xa,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5e]);}else if(channelCount===3){return new Uint8Array([0x1,0x40,0x22,0x80,0xa3,0x5e,0xe6,0x80,0xba,0x8,0x0,0x0,0x0,0x0,0x95,0x0,0x6,0xf1,0xa1,0xa,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5a,0x5e]);}break;}return null;}}]);return AAC;}();exports.default=AAC;},{}],37:[function(_dereq_,module,exports){"use strict";var BufferHelper={isBuffered:function isBuffered(media,position){if(media){var buffered=media.buffered;for(var i=0;i<buffered.length;i++){if(position>=buffered.start(i)&&position<=buffered.end(i)){return true;}}}return false;},bufferInfo:function bufferInfo(media,pos,maxHoleDuration){if(media){var vbuffered=media.buffered,buffered=[],i;for(i=0;i<vbuffered.length;i++){buffered.push({start:vbuffered.start(i),end:vbuffered.end(i)});}return this.bufferedInfo(buffered,pos,maxHoleDuration);}else{return{len:0,start:pos,end:pos,nextStart:undefined};}},bufferedInfo:function bufferedInfo(buffered,pos,maxHoleDuration){var buffered2=[],bufferLen,bufferStart,bufferEnd,bufferStartNext,i;buffered.sort(function(a,b){var diff=a.start-b.start;if(diff){return diff;}else{return b.end-a.end;}});for(i=0;i<buffered.length;i++){var buf2len=buffered2.length;if(buf2len){var buf2end=buffered2[buf2len-1].end;if(buffered[i].start-buf2end<maxHoleDuration){if(buffered[i].end>buf2end){buffered2[buf2len-1].end=buffered[i].end;}}else{buffered2.push(buffered[i]);}}else{buffered2.push(buffered[i]);}}for(i=0,bufferLen=0,bufferStart=bufferEnd=pos;i<buffered2.length;i++){var start=buffered2[i].start,end=buffered2[i].end;if(pos+maxHoleDuration>=start&&pos<end){bufferStart=start;bufferEnd=end;bufferLen=bufferEnd-pos;}else if(pos+maxHoleDuration<start){bufferStartNext=start;break;}}return{len:bufferLen,start:bufferStart,end:bufferEnd,nextStart:bufferStartNext};}};module.exports=BufferHelper;},{}],38:[function(_dereq_,module,exports){'use strict';var _logger=_dereq_(54);var LevelHelper={mergeDetails:function mergeDetails(oldDetails,newDetails){var start=Math.max(oldDetails.startSN,newDetails.startSN)-newDetails.startSN,end=Math.min(oldDetails.endSN,newDetails.endSN)-newDetails.startSN,delta=newDetails.startSN-oldDetails.startSN,oldfragments=oldDetails.fragments,newfragments=newDetails.fragments,ccOffset=0,PTSFrag;if(end<start){newDetails.PTSKnown=false;return;}for(var i=start;i<=end;i++){var oldFrag=oldfragments[delta+i],newFrag=newfragments[i];if(newFrag&&oldFrag){ccOffset=oldFrag.cc-newFrag.cc;if(!isNaN(oldFrag.startPTS)){newFrag.start=newFrag.startPTS=oldFrag.startPTS;newFrag.endPTS=oldFrag.endPTS;newFrag.duration=oldFrag.duration;newFrag.backtracked=oldFrag.backtracked;newFrag.dropped=oldFrag.dropped;PTSFrag=newFrag;}}}if(ccOffset){_logger.logger.log('discontinuity sliding from playlist, take drift into account');for(i=0;i<newfragments.length;i++){newfragments[i].cc+=ccOffset;}}if(PTSFrag){LevelHelper.updateFragPTSDTS(newDetails,PTSFrag,PTSFrag.startPTS,PTSFrag.endPTS,PTSFrag.startDTS,PTSFrag.endDTS);}else{if(delta>=0&&delta<oldfragments.length){var sliding=oldfragments[delta].start;for(i=0;i<newfragments.length;i++){newfragments[i].start+=sliding;}}}newDetails.PTSKnown=oldDetails.PTSKnown;return;},updateFragPTSDTS:function updateFragPTSDTS(details,frag,startPTS,endPTS,startDTS,endDTS){var maxStartPTS=startPTS;if(!isNaN(frag.startPTS)){var deltaPTS=Math.abs(frag.startPTS-startPTS);if(isNaN(frag.deltaPTS)){frag.deltaPTS=deltaPTS;}else{frag.deltaPTS=Math.max(deltaPTS,frag.deltaPTS);}maxStartPTS=Math.max(startPTS,frag.startPTS);startPTS=Math.min(startPTS,frag.startPTS);endPTS=Math.max(endPTS,frag.endPTS);startDTS=Math.min(startDTS,frag.startDTS);endDTS=Math.max(endDTS,frag.endDTS);}var drift=startPTS-frag.start;frag.start=frag.startPTS=startPTS;frag.maxStartPTS=maxStartPTS;frag.endPTS=endPTS;frag.startDTS=startDTS;frag.endDTS=endDTS;frag.duration=endPTS-startPTS;var sn=frag.sn;if(!details||sn<details.startSN||sn>details.endSN){return 0;}var fragIdx,fragments,i;fragIdx=sn-details.startSN;fragments=details.fragments;frag=fragments[fragIdx];for(i=fragIdx;i>0;i--){LevelHelper.updatePTS(fragments,i,i-1);}for(i=fragIdx;i<fragments.length-1;i++){LevelHelper.updatePTS(fragments,i,i+1);}details.PTSKnown=true;return drift;},updatePTS:function updatePTS(fragments,fromIdx,toIdx){var fragFrom=fragments[fromIdx],fragTo=fragments[toIdx],fragToPTS=fragTo.startPTS;if(!isNaN(fragToPTS)){if(toIdx>fromIdx){fragFrom.duration=fragToPTS-fragFrom.start;if(fragFrom.duration<0){_logger.logger.warn('negative duration computed for frag '+fragFrom.sn+',level '+fragFrom.level+', there should be some duration drift between playlist and fragment!');}}else{fragTo.duration=fragFrom.start-fragToPTS;if(fragTo.duration<0){_logger.logger.warn('negative duration computed for frag '+fragTo.sn+',level '+fragTo.level+', there should be some duration drift between playlist and fragment!');}}}else{if(toIdx>fromIdx){fragTo.start=fragFrom.start+fragFrom.duration;}else{fragTo.start=Math.max(fragFrom.start-fragTo.duration,0);}}}};module.exports=LevelHelper;},{"54":54}],39:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _urlToolkit=_dereq_(2);var _urlToolkit2=_interopRequireDefault(_urlToolkit);var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _errors=_dereq_(33);var _playlistLoader=_dereq_(43);var _playlistLoader2=_interopRequireDefault(_playlistLoader);var _fragmentLoader=_dereq_(41);var _fragmentLoader2=_interopRequireDefault(_fragmentLoader);var _keyLoader=_dereq_(42);var _keyLoader2=_interopRequireDefault(_keyLoader);var _streamController=_dereq_(13);var _streamController2=_interopRequireDefault(_streamController);var _levelController=_dereq_(12);var _levelController2=_interopRequireDefault(_levelController);var _id3TrackController=_dereq_(11);var _id3TrackController2=_interopRequireDefault(_id3TrackController);var _logger=_dereq_(54);var _events3=_dereq_(1);var _events4=_interopRequireDefault(_events3);var _config=_dereq_(4);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var Hls=function(){_createClass$$1(Hls,null,[{key:'isSupported',value:function isSupported(){var mediaSource=window.MediaSource=window.MediaSource||window.WebKitMediaSource;var sourceBuffer=window.SourceBuffer=window.SourceBuffer||window.WebKitSourceBuffer;var isTypeSupported=mediaSource&&typeof mediaSource.isTypeSupported==='function'&&mediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"');var sourceBufferValidAPI=!sourceBuffer||sourceBuffer.prototype&&typeof sourceBuffer.prototype.appendBuffer==='function'&&typeof sourceBuffer.prototype.remove==='function';return isTypeSupported&&sourceBufferValidAPI;}},{key:'version',get:function get(){return'0.7.10';}},{key:'Events',get:function get(){return _events2.default;}},{key:'ErrorTypes',get:function get(){return _errors.ErrorTypes;}},{key:'ErrorDetails',get:function get(){return _errors.ErrorDetails;}},{key:'DefaultConfig',get:function get(){if(!Hls.defaultConfig){return _config.hlsDefaultConfig;}return Hls.defaultConfig;},set:function set(defaultConfig){Hls.defaultConfig=defaultConfig;}}]);function Hls(){var _this=this;var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};_classCallCheck$$1(this,Hls);var defaultConfig=Hls.DefaultConfig;if((config.liveSyncDurationCount||config.liveMaxLatencyDurationCount)&&(config.liveSyncDuration||config.liveMaxLatencyDuration)){throw new Error('Illegal hls.js config: don\'t mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration');}for(var prop in defaultConfig){if(prop in config){continue;}config[prop]=defaultConfig[prop];}if(config.liveMaxLatencyDurationCount!==undefined&&config.liveMaxLatencyDurationCount<=config.liveSyncDurationCount){throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be gt "liveSyncDurationCount"');}if(config.liveMaxLatencyDuration!==undefined&&(config.liveMaxLatencyDuration<=config.liveSyncDuration||config.liveSyncDuration===undefined)){throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be gt "liveSyncDuration"');}(0,_logger.enableLogs)(config.debug);this.config=config;this._autoLevelCapping=-1;var observer=this.observer=new _events4.default();observer.trigger=function trigger(event){for(var _len=arguments.length,data=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){data[_key-1]=arguments[_key];}observer.emit.apply(observer,[event,event].concat(data));};observer.off=function off(event){for(var _len2=arguments.length,data=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){data[_key2-1]=arguments[_key2];}observer.removeListener.apply(observer,[event].concat(data));};this.on=observer.on.bind(observer);this.off=observer.off.bind(observer);this.trigger=observer.trigger.bind(observer);var abrController=this.abrController=new config.abrController(this);var bufferController=new config.bufferController(this);var capLevelController=new config.capLevelController(this);var fpsController=new config.fpsController(this);var playListLoader=new _playlistLoader2.default(this);var fragmentLoader=new _fragmentLoader2.default(this);var keyLoader=new _keyLoader2.default(this);var id3TrackController=new _id3TrackController2.default(this);var levelController=this.levelController=new _levelController2.default(this);var streamController=this.streamController=new _streamController2.default(this);var networkControllers=[levelController,streamController];var Controller=config.audioStreamController;if(Controller){networkControllers.push(new Controller(this));}this.networkControllers=networkControllers;var coreComponents=[playListLoader,fragmentLoader,keyLoader,abrController,bufferController,capLevelController,fpsController,id3TrackController];Controller=config.audioTrackController;if(Controller){var audioTrackController=new Controller(this);this.audioTrackController=audioTrackController;coreComponents.push(audioTrackController);}Controller=config.subtitleTrackController;if(Controller){var subtitleTrackController=new Controller(this);this.subtitleTrackController=subtitleTrackController;coreComponents.push(subtitleTrackController);}[config.subtitleStreamController,config.timelineController].forEach(function(Controller){if(Controller){coreComponents.push(new Controller(_this));}});this.coreComponents=coreComponents;}_createClass$$1(Hls,[{key:'destroy',value:function destroy(){_logger.logger.log('destroy');this.trigger(_events2.default.DESTROYING);this.detachMedia();this.coreComponents.concat(this.networkControllers).forEach(function(component){component.destroy();});this.url=null;this.observer.removeAllListeners();this._autoLevelCapping=-1;}},{key:'attachMedia',value:function attachMedia(media){_logger.logger.log('attachMedia');this.media=media;this.trigger(_events2.default.MEDIA_ATTACHING,{media:media});}},{key:'detachMedia',value:function detachMedia(){_logger.logger.log('detachMedia');this.trigger(_events2.default.MEDIA_DETACHING);this.media=null;}},{key:'loadSource',value:function loadSource(url){url=_urlToolkit2.default.buildAbsoluteURL(window.location.href,url,{alwaysNormalize:true});_logger.logger.log('loadSource:'+url);this.url=url;this.trigger(_events2.default.MANIFEST_LOADING,{url:url});}},{key:'startLoad',value:function startLoad(){var startPosition=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;_logger.logger.log('startLoad('+startPosition+')');this.networkControllers.forEach(function(controller){controller.startLoad(startPosition);});}},{key:'stopLoad',value:function stopLoad(){_logger.logger.log('stopLoad');this.networkControllers.forEach(function(controller){controller.stopLoad();});}},{key:'swapAudioCodec',value:function swapAudioCodec(){_logger.logger.log('swapAudioCodec');this.streamController.swapAudioCodec();}},{key:'recoverMediaError',value:function recoverMediaError(){_logger.logger.log('recoverMediaError');var media=this.media;this.detachMedia();this.attachMedia(media);}},{key:'levels',get:function get(){return this.levelController.levels;}},{key:'currentLevel',get:function get(){return this.streamController.currentLevel;},set:function set(newLevel){_logger.logger.log('set currentLevel:'+newLevel);this.loadLevel=newLevel;this.streamController.immediateLevelSwitch();}},{key:'nextLevel',get:function get(){return this.streamController.nextLevel;},set:function set(newLevel){_logger.logger.log('set nextLevel:'+newLevel);this.levelController.manualLevel=newLevel;this.streamController.nextLevelSwitch();}},{key:'loadLevel',get:function get(){return this.levelController.level;},set:function set(newLevel){_logger.logger.log('set loadLevel:'+newLevel);this.levelController.manualLevel=newLevel;}},{key:'nextLoadLevel',get:function get(){return this.levelController.nextLoadLevel;},set:function set(level){this.levelController.nextLoadLevel=level;}},{key:'firstLevel',get:function get(){return Math.max(this.levelController.firstLevel,this.minAutoLevel);},set:function set(newLevel){_logger.logger.log('set firstLevel:'+newLevel);this.levelController.firstLevel=newLevel;}},{key:'startLevel',get:function get(){return this.levelController.startLevel;},set:function set(newLevel){_logger.logger.log('set startLevel:'+newLevel);var hls=this;if(newLevel!==-1){newLevel=Math.max(newLevel,hls.minAutoLevel);}hls.levelController.startLevel=newLevel;}},{key:'autoLevelCapping',get:function get(){return this._autoLevelCapping;},set:function set(newLevel){_logger.logger.log('set autoLevelCapping:'+newLevel);this._autoLevelCapping=newLevel;}},{key:'autoLevelEnabled',get:function get(){return this.levelController.manualLevel===-1;}},{key:'manualLevel',get:function get(){return this.levelController.manualLevel;}},{key:'minAutoLevel',get:function get(){var hls=this,levels=hls.levels,minAutoBitrate=hls.config.minAutoBitrate,len=levels?levels.length:0;for(var i=0;i<len;i++){var levelNextBitrate=levels[i].realBitrate?Math.max(levels[i].realBitrate,levels[i].bitrate):levels[i].bitrate;if(levelNextBitrate>minAutoBitrate){return i;}}return 0;}},{key:'maxAutoLevel',get:function get(){var hls=this;var levels=hls.levels;var autoLevelCapping=hls.autoLevelCapping;var maxAutoLevel=void 0;if(autoLevelCapping===-1&&levels&&levels.length){maxAutoLevel=levels.length-1;}else{maxAutoLevel=autoLevelCapping;}return maxAutoLevel;}},{key:'nextAutoLevel',get:function get(){var hls=this;return Math.min(Math.max(hls.abrController.nextAutoLevel,hls.minAutoLevel),hls.maxAutoLevel);},set:function set(nextLevel){var hls=this;hls.abrController.nextAutoLevel=Math.max(hls.minAutoLevel,nextLevel);}},{key:'audioTracks',get:function get(){var audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.audioTracks:[];}},{key:'audioTrack',get:function get(){var audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.audioTrack:-1;},set:function set(audioTrackId){var audioTrackController=this.audioTrackController;if(audioTrackController){audioTrackController.audioTrack=audioTrackId;}}},{key:'liveSyncPosition',get:function get(){return this.streamController.liveSyncPosition;}},{key:'subtitleTracks',get:function get(){var subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.subtitleTracks:[];}},{key:'subtitleTrack',get:function get(){var subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.subtitleTrack:-1;},set:function set(subtitleTrackId){var subtitleTrackController=this.subtitleTrackController;if(subtitleTrackController){subtitleTrackController.subtitleTrack=subtitleTrackId;}}}]);return Hls;}();exports.default=Hls;},{"1":1,"11":11,"12":12,"13":13,"2":2,"33":33,"35":35,"4":4,"41":41,"42":42,"43":43,"54":54}],40:[function(_dereq_,module,exports){'use strict';module.exports=_dereq_(39).default;},{"39":39}],41:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _errors=_dereq_(33);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var FragmentLoader=function(_EventHandler){_inherits$$1(FragmentLoader,_EventHandler);function FragmentLoader(hls){_classCallCheck$$1(this,FragmentLoader);var _this=_possibleConstructorReturn$$1(this,(FragmentLoader.__proto__||Object.getPrototypeOf(FragmentLoader)).call(this,hls,_events2.default.FRAG_LOADING));_this.loaders={};return _this;}_createClass$$1(FragmentLoader,[{key:'destroy',value:function destroy(){var loaders=this.loaders;for(var loaderName in loaders){var loader=loaders[loaderName];if(loader){loader.destroy();}}this.loaders={};_eventHandler2.default.prototype.destroy.call(this);}},{key:'onFragLoading',value:function onFragLoading(data){var frag=data.frag,type=frag.type,loader=this.loaders[type],config=this.hls.config;frag.loaded=0;if(loader){_logger.logger.warn('abort previous fragment loader for type:'+type);loader.abort();}loader=this.loaders[type]=frag.loader=typeof config.fLoader!=='undefined'?new config.fLoader(config):new config.loader(config);var loaderContext=void 0,loaderConfig=void 0,loaderCallbacks=void 0;loaderContext={url:frag.url,frag:frag,responseType:'arraybuffer',progressData:false};var start=frag.byteRangeStartOffset,end=frag.byteRangeEndOffset;if(!isNaN(start)&&!isNaN(end)){loaderContext.rangeStart=start;loaderContext.rangeEnd=end;}loaderConfig={timeout:config.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:config.fragLoadingMaxRetryTimeout};loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this),onProgress:this.loadprogress.bind(this)};loader.load(loaderContext,loaderConfig,loaderCallbacks);}},{key:'loadsuccess',value:function loadsuccess(response,stats,context){var networkDetails=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var payload=response.data,frag=context.frag;frag.loader=undefined;this.loaders[frag.type]=undefined;this.hls.trigger(_events2.default.FRAG_LOADED,{payload:payload,frag:frag,stats:stats,networkDetails:networkDetails});}},{key:'loaderror',value:function loaderror(response,context){var networkDetails=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var loader=context.loader;if(loader){loader.abort();}this.loaders[context.type]=undefined;this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.FRAG_LOAD_ERROR,fatal:false,frag:context.frag,response:response,networkDetails:networkDetails});}},{key:'loadtimeout',value:function loadtimeout(stats,context){var networkDetails=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var loader=context.loader;if(loader){loader.abort();}this.loaders[context.type]=undefined;this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:false,frag:context.frag,networkDetails:networkDetails});}},{key:'loadprogress',value:function loadprogress(stats,context,data){var networkDetails=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var frag=context.frag;frag.loaded=stats.loaded;this.hls.trigger(_events2.default.FRAG_LOAD_PROGRESS,{frag:frag,stats:stats,networkDetails:networkDetails});}}]);return FragmentLoader;}(_eventHandler2.default);exports.default=FragmentLoader;},{"33":33,"34":34,"35":35,"54":54}],42:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _errors=_dereq_(33);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var KeyLoader=function(_EventHandler){_inherits$$1(KeyLoader,_EventHandler);function KeyLoader(hls){_classCallCheck$$1(this,KeyLoader);var _this=_possibleConstructorReturn$$1(this,(KeyLoader.__proto__||Object.getPrototypeOf(KeyLoader)).call(this,hls,_events2.default.KEY_LOADING));_this.loaders={};_this.decryptkey=null;_this.decrypturl=null;return _this;}_createClass$$1(KeyLoader,[{key:'destroy',value:function destroy(){for(var loaderName in this.loaders){var loader=this.loaders[loaderName];if(loader){loader.destroy();}}this.loaders={};_eventHandler2.default.prototype.destroy.call(this);}},{key:'onKeyLoading',value:function onKeyLoading(data){var frag=data.frag,type=frag.type,loader=this.loaders[type],decryptdata=frag.decryptdata,uri=decryptdata.uri;if(uri!==this.decrypturl||this.decryptkey===null){var config=this.hls.config;if(loader){_logger.logger.warn('abort previous key loader for type:'+type);loader.abort();}frag.loader=this.loaders[type]=new config.loader(config);this.decrypturl=uri;this.decryptkey=null;var loaderContext=void 0,loaderConfig=void 0,loaderCallbacks=void 0;loaderContext={url:uri,frag:frag,responseType:'arraybuffer'};loaderConfig={timeout:config.fragLoadingTimeOut,maxRetry:config.fragLoadingMaxRetry,retryDelay:config.fragLoadingRetryDelay,maxRetryDelay:config.fragLoadingMaxRetryTimeout};loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};frag.loader.load(loaderContext,loaderConfig,loaderCallbacks);}else if(this.decryptkey){decryptdata.key=this.decryptkey;this.hls.trigger(_events2.default.KEY_LOADED,{frag:frag});}}},{key:'loadsuccess',value:function loadsuccess(response,stats,context){var frag=context.frag;this.decryptkey=frag.decryptdata.key=new Uint8Array(response.data);frag.loader=undefined;this.loaders[frag.type]=undefined;this.hls.trigger(_events2.default.KEY_LOADED,{frag:frag});}},{key:'loaderror',value:function loaderror(response,context){var frag=context.frag,loader=frag.loader;if(loader){loader.abort();}this.loaders[context.type]=undefined;this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.KEY_LOAD_ERROR,fatal:false,frag:frag,response:response});}},{key:'loadtimeout',value:function loadtimeout(stats,context){var frag=context.frag,loader=frag.loader;if(loader){loader.abort();}this.loaders[context.type]=undefined;this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.KEY_LOAD_TIMEOUT,fatal:false,frag:frag});}}]);return KeyLoader;}(_eventHandler2.default);exports.default=KeyLoader;},{"33":33,"34":34,"35":35,"54":54}],43:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _urlToolkit=_dereq_(2);var _urlToolkit2=_interopRequireDefault(_urlToolkit);var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _eventHandler=_dereq_(34);var _eventHandler2=_interopRequireDefault(_eventHandler);var _errors=_dereq_(33);var _attrList=_dereq_(47);var _attrList2=_interopRequireDefault(_attrList);var _logger=_dereq_(54);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _possibleConstructorReturn$$1(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==='undefined'?'undefined':_typeof2(call))==="object"||typeof call==="function")?call:self;}function _inherits$$1(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==='undefined'?'undefined':_typeof2(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var MASTER_PLAYLIST_REGEX=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g;var MASTER_PLAYLIST_MEDIA_REGEX=/#EXT-X-MEDIA:(.*)/g;var LEVEL_PLAYLIST_REGEX_FAST=new RegExp([/#EXTINF:(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/|(?!#)(\S+)/.source,/|#EXT-X-BYTERANGE:*(.+)/.source,/|#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/|#.*/.source].join(''),'g');var LEVEL_PLAYLIST_REGEX_SLOW=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:(#)(.*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/;var LevelKey=function(){function LevelKey(){_classCallCheck$$1(this,LevelKey);this.method=null;this.key=null;this.iv=null;this._uri=null;}_createClass$$1(LevelKey,[{key:'uri',get:function get(){if(!this._uri&&this.reluri){this._uri=_urlToolkit2.default.buildAbsoluteURL(this.baseuri,this.reluri,{alwaysNormalize:true});}return this._uri;}}]);return LevelKey;}();var Fragment=function(){function Fragment(){_classCallCheck$$1(this,Fragment);this._url=null;this._byteRange=null;this._decryptdata=null;this.tagList=[];}_createClass$$1(Fragment,[{key:'createInitializationVector',value:function createInitializationVector(segmentNumber){var uint8View=new Uint8Array(16);for(var i=12;i<16;i++){uint8View[i]=segmentNumber>>8*(15-i)&0xff;}return uint8View;}},{key:'fragmentDecryptdataFromLevelkey',value:function fragmentDecryptdataFromLevelkey(levelkey,segmentNumber){var decryptdata=levelkey;if(levelkey&&levelkey.method&&levelkey.uri&&!levelkey.iv){decryptdata=new LevelKey();decryptdata.method=levelkey.method;decryptdata.baseuri=levelkey.baseuri;decryptdata.reluri=levelkey.reluri;decryptdata.iv=this.createInitializationVector(segmentNumber);}return decryptdata;}},{key:'cloneObj',value:function cloneObj(obj){return JSON.parse(JSON.stringify(obj));}},{key:'url',get:function get(){if(!this._url&&this.relurl){this._url=_urlToolkit2.default.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:true});}return this._url;},set:function set(value){this._url=value;}},{key:'programDateTime',get:function get(){if(!this._programDateTime&&this.rawProgramDateTime){this._programDateTime=new Date(Date.parse(this.rawProgramDateTime));}return this._programDateTime;}},{key:'byteRange',get:function get(){if(!this._byteRange){var byteRange=this._byteRange=[];if(this.rawByteRange){var params=this.rawByteRange.split('@',2);if(params.length===1){var lastByteRangeEndOffset=this.lastByteRangeEndOffset;byteRange[0]=lastByteRangeEndOffset?lastByteRangeEndOffset:0;}else{byteRange[0]=parseInt(params[1]);}byteRange[1]=parseInt(params[0])+byteRange[0];}}return this._byteRange;}},{key:'byteRangeStartOffset',get:function get(){return this.byteRange[0];}},{key:'byteRangeEndOffset',get:function get(){return this.byteRange[1];}},{key:'decryptdata',get:function get(){if(!this._decryptdata){this._decryptdata=this.fragmentDecryptdataFromLevelkey(this.levelkey,this.sn);}return this._decryptdata;}}]);return Fragment;}();var PlaylistLoader=function(_EventHandler){_inherits$$1(PlaylistLoader,_EventHandler);function PlaylistLoader(hls){_classCallCheck$$1(this,PlaylistLoader);var _this=_possibleConstructorReturn$$1(this,(PlaylistLoader.__proto__||Object.getPrototypeOf(PlaylistLoader)).call(this,hls,_events2.default.MANIFEST_LOADING,_events2.default.LEVEL_LOADING,_events2.default.AUDIO_TRACK_LOADING,_events2.default.SUBTITLE_TRACK_LOADING));_this.loaders={};return _this;}_createClass$$1(PlaylistLoader,[{key:'destroy',value:function destroy(){for(var loaderName in this.loaders){var loader=this.loaders[loaderName];if(loader){loader.destroy();}}this.loaders={};_eventHandler2.default.prototype.destroy.call(this);}},{key:'onManifestLoading',value:function onManifestLoading(data){this.load(data.url,{type:'manifest'});}},{key:'onLevelLoading',value:function onLevelLoading(data){this.load(data.url,{type:'level',level:data.level,id:data.id});}},{key:'onAudioTrackLoading',value:function onAudioTrackLoading(data){this.load(data.url,{type:'audioTrack',id:data.id});}},{key:'onSubtitleTrackLoading',value:function onSubtitleTrackLoading(data){this.load(data.url,{type:'subtitleTrack',id:data.id});}},{key:'load',value:function load(url,context){var loader=this.loaders[context.type];if(loader){var loaderContext=loader.context;if(loaderContext&&loaderContext.url===url){_logger.logger.trace('playlist request ongoing');return;}else{_logger.logger.warn('abort previous loader for type:'+context.type);loader.abort();}}var config=this.hls.config,retry=void 0,timeout=void 0,retryDelay=void 0,maxRetryDelay=void 0;if(context.type==='manifest'){retry=config.manifestLoadingMaxRetry;timeout=config.manifestLoadingTimeOut;retryDelay=config.manifestLoadingRetryDelay;maxRetryDelay=config.manifestLoadingMaxRetryTimeout;}else{retry=config.levelLoadingMaxRetry;timeout=config.levelLoadingTimeOut;retryDelay=config.levelLoadingRetryDelay;maxRetryDelay=config.levelLoadingMaxRetryTimeout;_logger.logger.log('loading playlist for '+context.type+' '+(context.level||context.id));}loader=this.loaders[context.type]=context.loader=typeof config.pLoader!=='undefined'?new config.pLoader(config):new config.loader(config);context.url=url;context.responseType='';var loaderConfig=void 0,loaderCallbacks=void 0;loaderConfig={timeout:timeout,maxRetry:retry,retryDelay:retryDelay,maxRetryDelay:maxRetryDelay};loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};loader.load(context,loaderConfig,loaderCallbacks);}},{key:'resolve',value:function resolve(url,baseUrl){return _urlToolkit2.default.buildAbsoluteURL(baseUrl,url,{alwaysNormalize:true});}},{key:'parseMasterPlaylist',value:function parseMasterPlaylist(string,baseurl){var levels=[],result=void 0;MASTER_PLAYLIST_REGEX.lastIndex=0;while((result=MASTER_PLAYLIST_REGEX.exec(string))!=null){var level={};var attrs=level.attrs=new _attrList2.default(result[1]);level.url=this.resolve(result[2],baseurl);var resolution=attrs.decimalResolution('RESOLUTION');if(resolution){level.width=resolution.width;level.height=resolution.height;}level.bitrate=attrs.decimalInteger('AVERAGE-BANDWIDTH')||attrs.decimalInteger('BANDWIDTH');level.name=attrs.NAME;var codecs=attrs.CODECS;if(codecs){codecs=codecs.split(/[ ,]+/);for(var i=0;i<codecs.length;i++){var codec=codecs[i];if(codec.indexOf('avc1')!==-1){level.videoCodec=this.avc1toavcoti(codec);}else if(codec.indexOf('hvc1')!==-1){level.videoCodec=codec;}else{level.audioCodec=codec;}}}levels.push(level);}return levels;}},{key:'parseMasterPlaylistMedia',value:function parseMasterPlaylistMedia(string,baseurl,type){var audioCodec=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var result=void 0,medias=[],id=0;MASTER_PLAYLIST_MEDIA_REGEX.lastIndex=0;while((result=MASTER_PLAYLIST_MEDIA_REGEX.exec(string))!=null){var media={};var attrs=new _attrList2.default(result[1]);if(attrs.TYPE===type){media.groupId=attrs['GROUP-ID'];media.name=attrs.NAME;media.type=type;media.default=attrs.DEFAULT==='YES';media.autoselect=attrs.AUTOSELECT==='YES';media.forced=attrs.FORCED==='YES';if(attrs.URI){media.url=this.resolve(attrs.URI,baseurl);}media.lang=attrs.LANGUAGE;if(!media.name){media.name=media.lang;}if(audioCodec){media.audioCodec=audioCodec;}media.id=id++;medias.push(media);}}return medias;}},{key:'avc1toavcoti',value:function avc1toavcoti(codec){var result,avcdata=codec.split('.');if(avcdata.length>2){result=avcdata.shift()+'.';result+=parseInt(avcdata.shift()).toString(16);result+=('000'+parseInt(avcdata.shift()).toString(16)).substr(-4);}else{result=codec;}return result;}},{key:'parseLevelPlaylist',value:function parseLevelPlaylist(string,baseurl,id,type){var currentSN=0,totalduration=0,level={type:null,version:null,url:baseurl,fragments:[],live:true,startSN:0},levelkey=new LevelKey(),cc=0,prevFrag=null,frag=new Fragment(),result,i;LEVEL_PLAYLIST_REGEX_FAST.lastIndex=0;while((result=LEVEL_PLAYLIST_REGEX_FAST.exec(string))!==null){var duration=result[1];if(duration){frag.duration=parseFloat(duration);var title=(' '+result[2]).slice(1);frag.title=title?title:null;frag.tagList.push(title?['INF',duration,title]:['INF',duration]);}else if(result[3]){if(!isNaN(frag.duration)){var sn=currentSN++;frag.type=type;frag.start=totalduration;frag.levelkey=levelkey;frag.sn=sn;frag.level=id;frag.cc=cc;frag.baseurl=baseurl;frag.relurl=(' '+result[3]).slice(1);level.fragments.push(frag);prevFrag=frag;totalduration+=frag.duration;frag=new Fragment();}}else if(result[4]){frag.rawByteRange=(' '+result[4]).slice(1);if(prevFrag){var lastByteRangeEndOffset=prevFrag.byteRangeEndOffset;if(lastByteRangeEndOffset){frag.lastByteRangeEndOffset=lastByteRangeEndOffset;}}}else if(result[5]){frag.rawProgramDateTime=(' '+result[5]).slice(1);frag.tagList.push(['PROGRAM-DATE-TIME',frag.rawProgramDateTime]);}else{result=result[0].match(LEVEL_PLAYLIST_REGEX_SLOW);for(i=1;i<result.length;i++){if(result[i]!==undefined){break;}}var value1=(' '+result[i+1]).slice(1);var value2=(' '+result[i+2]).slice(1);switch(result[i]){case'#':frag.tagList.push(value2?[value1,value2]:[value1]);break;case'PLAYLIST-TYPE':level.type=value1.toUpperCase();break;case'MEDIA-SEQUENCE':currentSN=level.startSN=parseInt(value1);break;case'TARGETDURATION':level.targetduration=parseFloat(value1);break;case'VERSION':level.version=parseInt(value1);break;case'EXTM3U':break;case'ENDLIST':level.live=false;break;case'DIS':cc++;frag.tagList.push(['DIS']);break;case'DISCONTINUITY-SEQ':cc=parseInt(value1);break;case'KEY':var decryptparams=value1;var keyAttrs=new _attrList2.default(decryptparams);var decryptmethod=keyAttrs.enumeratedString('METHOD'),decrypturi=keyAttrs.URI,decryptiv=keyAttrs.hexadecimalInteger('IV');if(decryptmethod){levelkey=new LevelKey();if(decrypturi&&['AES-128','SAMPLE-AES'].indexOf(decryptmethod)>=0){levelkey.method=decryptmethod;levelkey.baseuri=baseurl;levelkey.reluri=decrypturi;levelkey.key=null;levelkey.iv=decryptiv;}}break;case'START':var startParams=value1;var startAttrs=new _attrList2.default(startParams);var startTimeOffset=startAttrs.decimalFloatingPoint('TIME-OFFSET');if(!isNaN(startTimeOffset)){level.startTimeOffset=startTimeOffset;}break;case'MAP':var mapAttrs=new _attrList2.default(value1);frag.relurl=mapAttrs.URI;frag.rawByteRange=mapAttrs.BYTERANGE;frag.baseurl=baseurl;frag.level=id;frag.type=type;frag.sn='initSegment';level.initSegment=frag;frag=new Fragment();break;default:_logger.logger.warn('line parsed but not handled: '+result);break;}}}frag=prevFrag;if(frag&&!frag.relurl){level.fragments.pop();totalduration-=frag.duration;}level.totalduration=totalduration;level.averagetargetduration=totalduration/level.fragments.length;level.endSN=currentSN-1;return level;}},{key:'loadsuccess',value:function loadsuccess(response,stats,context){var networkDetails=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var string=response.data,url=response.url,type=context.type,id=context.id,level=context.level,hls=this.hls;this.loaders[type]=undefined;if(url===undefined||url.indexOf('data:')===0){url=context.url;}stats.tload=performance.now();if(string.indexOf('#EXTM3U')===0){if(string.indexOf('#EXTINF:')>0){var isLevel=type!=='audioTrack'&&type!=='subtitleTrack',levelId=!isNaN(level)?level:!isNaN(id)?id:0,levelDetails=this.parseLevelPlaylist(string,url,levelId,type==='audioTrack'?'audio':type==='subtitleTrack'?'subtitle':'main');levelDetails.tload=stats.tload;if(type==='manifest'){hls.trigger(_events2.default.MANIFEST_LOADED,{levels:[{url:url,details:levelDetails}],audioTracks:[],url:url,stats:stats,networkDetails:networkDetails});}stats.tparsed=performance.now();if(levelDetails.targetduration){if(isLevel){hls.trigger(_events2.default.LEVEL_LOADED,{details:levelDetails,level:level||0,id:id||0,stats:stats,networkDetails:networkDetails});}else{if(type==='audioTrack'){hls.trigger(_events2.default.AUDIO_TRACK_LOADED,{details:levelDetails,id:id,stats:stats,networkDetails:networkDetails});}else if(type==='subtitleTrack'){hls.trigger(_events2.default.SUBTITLE_TRACK_LOADED,{details:levelDetails,id:id,stats:stats,networkDetails:networkDetails});}}}else{hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:true,url:url,reason:'invalid targetduration',networkDetails:networkDetails});}}else{var levels=this.parseMasterPlaylist(string,url);if(levels.length){var audioTracks=this.parseMasterPlaylistMedia(string,url,'AUDIO',levels[0].audioCodec);var subtitles=this.parseMasterPlaylistMedia(string,url,'SUBTITLES');if(audioTracks.length){var embeddedAudioFound=false;audioTracks.forEach(function(audioTrack){if(!audioTrack.url){embeddedAudioFound=true;}});if(embeddedAudioFound===false&&levels[0].audioCodec&&!levels[0].attrs.AUDIO){_logger.logger.log('audio codec signaled in quality level, but no embedded audio track signaled, create one');audioTracks.unshift({type:'main',name:'main'});}}hls.trigger(_events2.default.MANIFEST_LOADED,{levels:levels,audioTracks:audioTracks,subtitles:subtitles,url:url,stats:stats,networkDetails:networkDetails});}else{hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:true,url:url,reason:'no level found in manifest',networkDetails:networkDetails});}}}else{hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:true,url:url,reason:'no EXTM3U delimiter',networkDetails:networkDetails});}}},{key:'loaderror',value:function loaderror(response,context){var networkDetails=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var details,fatal,loader=context.loader;switch(context.type){case'manifest':details=_errors.ErrorDetails.MANIFEST_LOAD_ERROR;fatal=true;break;case'level':details=_errors.ErrorDetails.LEVEL_LOAD_ERROR;fatal=false;break;case'audioTrack':details=_errors.ErrorDetails.AUDIO_TRACK_LOAD_ERROR;fatal=false;break;}if(loader){loader.abort();this.loaders[context.type]=undefined;}this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:details,fatal:fatal,url:loader.url,loader:loader,response:response,context:context,networkDetails:networkDetails});}},{key:'loadtimeout',value:function loadtimeout(stats,context){var networkDetails=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var details,fatal,loader=context.loader;switch(context.type){case'manifest':details=_errors.ErrorDetails.MANIFEST_LOAD_TIMEOUT;fatal=true;break;case'level':details=_errors.ErrorDetails.LEVEL_LOAD_TIMEOUT;fatal=false;break;case'audioTrack':details=_errors.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT;fatal=false;break;}if(loader){loader.abort();this.loaders[context.type]=undefined;}this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:details,fatal:fatal,url:loader.url,loader:loader,context:context,networkDetails:networkDetails});}}]);return PlaylistLoader;}(_eventHandler2.default);exports.default=PlaylistLoader;},{"2":2,"33":33,"34":34,"35":35,"47":47,"54":54}],44:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var UINT32_MAX=Math.pow(2,32)-1;var MP4=function(){function MP4(){_classCallCheck$$1(this,MP4);}_createClass$$1(MP4,null,[{key:'init',value:function init(){MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],'.mp3':[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var i;for(i in MP4.types){if(MP4.types.hasOwnProperty(i)){MP4.types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)];}}var videoHdlr=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x76,0x69,0x64,0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x56,0x69,0x64,0x65,0x6f,0x48,0x61,0x6e,0x64,0x6c,0x65,0x72,0x00]);var audioHdlr=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x73,0x6f,0x75,0x6e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x53,0x6f,0x75,0x6e,0x64,0x48,0x61,0x6e,0x64,0x6c,0x65,0x72,0x00]);MP4.HDLR_TYPES={'video':videoHdlr,'audio':audioHdlr};var dref=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0c,0x75,0x72,0x6c,0x20,0x00,0x00,0x00,0x01]);var stco=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);MP4.STTS=MP4.STSC=MP4.STCO=stco;MP4.STSZ=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);MP4.VMHD=new Uint8Array([0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);MP4.SMHD=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);MP4.STSD=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01]);var majorBrand=new Uint8Array([105,115,111,109]);var avc1Brand=new Uint8Array([97,118,99,49]);var minorVersion=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,majorBrand,minorVersion,majorBrand,avc1Brand);MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,dref));}},{key:'box',value:function box(type){var payload=Array.prototype.slice.call(arguments,1),size=8,i=payload.length,len=i,result;while(i--){size+=payload[i].byteLength;}result=new Uint8Array(size);result[0]=size>>24&0xff;result[1]=size>>16&0xff;result[2]=size>>8&0xff;result[3]=size&0xff;result.set(type,4);for(i=0,size=8;i<len;i++){result.set(payload[i],size);size+=payload[i].byteLength;}return result;}},{key:'hdlr',value:function hdlr(type){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[type]);}},{key:'mdat',value:function mdat(data){return MP4.box(MP4.types.mdat,data);}},{key:'mdhd',value:function mdhd(timescale,duration){duration*=timescale;var upperWordDuration=Math.floor(duration/(UINT32_MAX+1));var lowerWordDuration=Math.floor(duration%(UINT32_MAX+1));return MP4.box(MP4.types.mdhd,new Uint8Array([0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,timescale>>24&0xFF,timescale>>16&0xFF,timescale>>8&0xFF,timescale&0xFF,upperWordDuration>>24,upperWordDuration>>16&0xFF,upperWordDuration>>8&0xFF,upperWordDuration&0xFF,lowerWordDuration>>24,lowerWordDuration>>16&0xFF,lowerWordDuration>>8&0xFF,lowerWordDuration&0xFF,0x55,0xc4,0x00,0x00]));}},{key:'mdia',value:function mdia(track){return MP4.box(MP4.types.mdia,MP4.mdhd(track.timescale,track.duration),MP4.hdlr(track.type),MP4.minf(track));}},{key:'mfhd',value:function mfhd(sequenceNumber){return MP4.box(MP4.types.mfhd,new Uint8Array([0x00,0x00,0x00,0x00,sequenceNumber>>24,sequenceNumber>>16&0xFF,sequenceNumber>>8&0xFF,sequenceNumber&0xFF]));}},{key:'minf',value:function minf(track){if(track.type==='audio'){return MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(track));}else{return MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(track));}}},{key:'moof',value:function moof(sn,baseMediaDecodeTime,track){return MP4.box(MP4.types.moof,MP4.mfhd(sn),MP4.traf(track,baseMediaDecodeTime));}},{key:'moov',value:function moov(tracks){var i=tracks.length,boxes=[];while(i--){boxes[i]=MP4.trak(tracks[i]);}return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(tracks[0].timescale,tracks[0].duration)].concat(boxes).concat(MP4.mvex(tracks)));}},{key:'mvex',value:function mvex(tracks){var i=tracks.length,boxes=[];while(i--){boxes[i]=MP4.trex(tracks[i]);}return MP4.box.apply(null,[MP4.types.mvex].concat(boxes));}},{key:'mvhd',value:function mvhd(timescale,duration){duration*=timescale;var upperWordDuration=Math.floor(duration/(UINT32_MAX+1));var lowerWordDuration=Math.floor(duration%(UINT32_MAX+1));var bytes=new Uint8Array([0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,timescale>>24&0xFF,timescale>>16&0xFF,timescale>>8&0xFF,timescale&0xFF,upperWordDuration>>24,upperWordDuration>>16&0xFF,upperWordDuration>>8&0xFF,upperWordDuration&0xFF,lowerWordDuration>>24,lowerWordDuration>>16&0xFF,lowerWordDuration>>8&0xFF,lowerWordDuration&0xFF,0x00,0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff]);return MP4.box(MP4.types.mvhd,bytes);}},{key:'sdtp',value:function sdtp(track){var samples=track.samples||[],bytes=new Uint8Array(4+samples.length),flags,i;for(i=0;i<samples.length;i++){flags=samples[i].flags;bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;}return MP4.box(MP4.types.sdtp,bytes);}},{key:'stbl',value:function stbl(track){return MP4.box(MP4.types.stbl,MP4.stsd(track),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO));}},{key:'avc1',value:function avc1(track){var sps=[],pps=[],i,data,len;for(i=0;i<track.sps.length;i++){data=track.sps[i];len=data.byteLength;sps.push(len>>>8&0xFF);sps.push(len&0xFF);sps=sps.concat(Array.prototype.slice.call(data));}for(i=0;i<track.pps.length;i++){data=track.pps[i];len=data.byteLength;pps.push(len>>>8&0xFF);pps.push(len&0xFF);pps=pps.concat(Array.prototype.slice.call(data));}var avcc=MP4.box(MP4.types.avcC,new Uint8Array([0x01,sps[3],sps[4],sps[5],0xfc|3,0xE0|track.sps.length].concat(sps).concat([track.pps.length]).concat(pps))),width=track.width,height=track.height,hSpacing=track.pixelRatio[0],vSpacing=track.pixelRatio[1];return MP4.box(MP4.types.avc1,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,width>>8&0xFF,width&0xff,height>>8&0xFF,height&0xff,0x00,0x48,0x00,0x00,0x00,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x12,0x64,0x61,0x69,0x6C,0x79,0x6D,0x6F,0x74,0x69,0x6F,0x6E,0x2F,0x68,0x6C,0x73,0x2E,0x6A,0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x11,0x11]),avcc,MP4.box(MP4.types.btrt,new Uint8Array([0x00,0x1c,0x9c,0x80,0x00,0x2d,0xc6,0xc0,0x00,0x2d,0xc6,0xc0])),MP4.box(MP4.types.pasp,new Uint8Array([hSpacing>>24,hSpacing>>16&0xFF,hSpacing>>8&0xFF,hSpacing&0xFF,vSpacing>>24,vSpacing>>16&0xFF,vSpacing>>8&0xFF,vSpacing&0xFF])));}},{key:'esds',value:function esds(track){var configlen=track.config.length;return new Uint8Array([0x00,0x00,0x00,0x00,0x03,0x17+configlen,0x00,0x01,0x00,0x04,0x0f+configlen,0x40,0x15,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05].concat([configlen]).concat(track.config).concat([0x06,0x01,0x02]));}},{key:'mp4a',value:function mp4a(track){var samplerate=track.samplerate;return MP4.box(MP4.types.mp4a,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,track.channelCount,0x00,0x10,0x00,0x00,0x00,0x00,samplerate>>8&0xFF,samplerate&0xff,0x00,0x00]),MP4.box(MP4.types.esds,MP4.esds(track)));}},{key:'mp3',value:function mp3(track){var samplerate=track.samplerate;return MP4.box(MP4.types['.mp3'],new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,track.channelCount,0x00,0x10,0x00,0x00,0x00,0x00,samplerate>>8&0xFF,samplerate&0xff,0x00,0x00]));}},{key:'stsd',value:function stsd(track){if(track.type==='audio'){if(!track.isAAC&&track.codec==='mp3'){return MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp3(track));}return MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(track));}else{return MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(track));}}},{key:'tkhd',value:function tkhd(track){var id=track.id,duration=track.duration*track.timescale,width=track.width,height=track.height,upperWordDuration=Math.floor(duration/(UINT32_MAX+1)),lowerWordDuration=Math.floor(duration%(UINT32_MAX+1));return MP4.box(MP4.types.tkhd,new Uint8Array([0x01,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,id>>24&0xFF,id>>16&0xFF,id>>8&0xFF,id&0xFF,0x00,0x00,0x00,0x00,upperWordDuration>>24,upperWordDuration>>16&0xFF,upperWordDuration>>8&0xFF,upperWordDuration&0xFF,lowerWordDuration>>24,lowerWordDuration>>16&0xFF,lowerWordDuration>>8&0xFF,lowerWordDuration&0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,width>>8&0xFF,width&0xFF,0x00,0x00,height>>8&0xFF,height&0xFF,0x00,0x00]));}},{key:'traf',value:function traf(track,baseMediaDecodeTime){var sampleDependencyTable=MP4.sdtp(track),id=track.id,upperWordBaseMediaDecodeTime=Math.floor(baseMediaDecodeTime/(UINT32_MAX+1)),lowerWordBaseMediaDecodeTime=Math.floor(baseMediaDecodeTime%(UINT32_MAX+1));return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0x00,0x00,0x00,0x00,id>>24,id>>16&0XFF,id>>8&0XFF,id&0xFF])),MP4.box(MP4.types.tfdt,new Uint8Array([0x01,0x00,0x00,0x00,upperWordBaseMediaDecodeTime>>24,upperWordBaseMediaDecodeTime>>16&0XFF,upperWordBaseMediaDecodeTime>>8&0XFF,upperWordBaseMediaDecodeTime&0xFF,lowerWordBaseMediaDecodeTime>>24,lowerWordBaseMediaDecodeTime>>16&0XFF,lowerWordBaseMediaDecodeTime>>8&0XFF,lowerWordBaseMediaDecodeTime&0xFF])),MP4.trun(track,sampleDependencyTable.length+16+20+8+16+8+8),sampleDependencyTable);}},{key:'trak',value:function trak(track){track.duration=track.duration||0xffffffff;return MP4.box(MP4.types.trak,MP4.tkhd(track),MP4.mdia(track));}},{key:'trex',value:function trex(track){var id=track.id;return MP4.box(MP4.types.trex,new Uint8Array([0x00,0x00,0x00,0x00,id>>24,id>>16&0XFF,id>>8&0XFF,id&0xFF,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01]));}},{key:'trun',value:function trun(track,offset){var samples=track.samples||[],len=samples.length,arraylen=12+16*len,array=new Uint8Array(arraylen),i,sample,duration,size,flags,cts;offset+=8+arraylen;array.set([0x00,0x00,0x0f,0x01,len>>>24&0xFF,len>>>16&0xFF,len>>>8&0xFF,len&0xFF,offset>>>24&0xFF,offset>>>16&0xFF,offset>>>8&0xFF,offset&0xFF],0);for(i=0;i<len;i++){sample=samples[i];duration=sample.duration;size=sample.size;flags=sample.flags;cts=sample.cts;array.set([duration>>>24&0xFF,duration>>>16&0xFF,duration>>>8&0xFF,duration&0xFF,size>>>24&0xFF,size>>>16&0xFF,size>>>8&0xFF,size&0xFF,flags.isLeading<<2|flags.dependsOn,flags.isDependedOn<<6|flags.hasRedundancy<<4|flags.paddingValue<<1|flags.isNonSync,flags.degradPrio&0xF0<<8,flags.degradPrio&0x0F,cts>>>24&0xFF,cts>>>16&0xFF,cts>>>8&0xFF,cts&0xFF],12+16*i);}return MP4.box(MP4.types.trun,array);}},{key:'initSegment',value:function initSegment(tracks){if(!MP4.types){MP4.init();}var movie=MP4.moov(tracks),result;result=new Uint8Array(MP4.FTYP.byteLength+movie.byteLength);result.set(MP4.FTYP);result.set(movie,MP4.FTYP.byteLength);return result;}}]);return MP4;}();exports.default=MP4;},{}],45:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _aac=_dereq_(36);var _aac2=_interopRequireDefault(_aac);var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);var _logger=_dereq_(54);var _mp4Generator=_dereq_(44);var _mp4Generator2=_interopRequireDefault(_mp4Generator);var _errors=_dereq_(33);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var MAX_SILENT_FRAME_DURATION=10*1000;var MP4Remuxer=function(){function MP4Remuxer(observer,config,typeSupported,vendor){_classCallCheck$$1(this,MP4Remuxer);this.observer=observer;this.config=config;this.typeSupported=typeSupported;var userAgent=navigator.userAgent;this.isSafari=vendor&&vendor.indexOf('Apple')>-1&&userAgent&&!userAgent.match('CriOS');this.ISGenerated=false;}_createClass$$1(MP4Remuxer,[{key:'destroy',value:function destroy(){}},{key:'resetTimeStamp',value:function resetTimeStamp(defaultTimeStamp){this._initPTS=this._initDTS=defaultTimeStamp;}},{key:'resetInitSegment',value:function resetInitSegment(){this.ISGenerated=false;}},{key:'remux',value:function remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset){if(!this.ISGenerated){this.generateIS(audioTrack,videoTrack,timeOffset);}else{if(accurateTimeOffset){var refPTS=this._initPTS;var ptsNormalize=this._PTSNormalize;var timeScale=audioTrack.inputTimeScale||videoTrack.inputTimeScale;var initPTS=Infinity,initDTS=Infinity;var samples=audioTrack.samples;if(samples.length){initPTS=initDTS=ptsNormalize(samples[0].pts-timeScale*timeOffset,refPTS);}samples=videoTrack.samples;if(samples.length){var sample=samples[0];initPTS=Math.min(initPTS,ptsNormalize(sample.pts-timeScale*timeOffset,refPTS));initDTS=Math.min(initDTS,ptsNormalize(sample.dts-timeScale*timeOffset,refPTS));}if(initPTS!==Infinity){var initPTSDelta=refPTS-initPTS;if(Math.abs(initPTSDelta)>10*timeScale){_logger.logger.warn('timestamp inconsistency, '+(initPTSDelta/timeScale).toFixed(3)+'s delta against expected value: missing discontinuity ? reset initPTS/initDTS');this._initPTS=initPTS;this._initDTS=initDTS;this.observer.trigger(_events2.default.INIT_PTS_FOUND,{initPTS:initPTS});}}}}if(this.ISGenerated){if(audioTrack.samples.length){if(!audioTrack.timescale){_logger.logger.warn('regenerate InitSegment as audio detected');this.generateIS(audioTrack,videoTrack,timeOffset);}var audioData=this.remuxAudio(audioTrack,timeOffset,contiguous,accurateTimeOffset);if(videoTrack.samples.length){var audioTrackLength=void 0;if(audioData){audioTrackLength=audioData.endPTS-audioData.startPTS;}if(!videoTrack.timescale){_logger.logger.warn('regenerate InitSegment as video detected');this.generateIS(audioTrack,videoTrack,timeOffset);}this.remuxVideo(videoTrack,timeOffset,contiguous,audioTrackLength,accurateTimeOffset);}}else{var videoData=void 0;if(videoTrack.samples.length){videoData=this.remuxVideo(videoTrack,timeOffset,contiguous,accurateTimeOffset);}if(videoData&&audioTrack.codec){this.remuxEmptyAudio(audioTrack,timeOffset,contiguous,videoData);}}}if(id3Track.samples.length){this.remuxID3(id3Track,timeOffset);}if(textTrack.samples.length){this.remuxText(textTrack,timeOffset);}this.observer.trigger(_events2.default.FRAG_PARSED);}},{key:'generateIS',value:function generateIS(audioTrack,videoTrack,timeOffset){var observer=this.observer,audioSamples=audioTrack.samples,videoSamples=videoTrack.samples,typeSupported=this.typeSupported,container='audio/mp4',tracks={},data={tracks:tracks},computePTSDTS=this._initPTS===undefined,initPTS,initDTS;if(computePTSDTS){initPTS=initDTS=Infinity;}if(audioTrack.config&&audioSamples.length){audioTrack.timescale=audioTrack.samplerate;_logger.logger.log('audio sampling rate : '+audioTrack.samplerate);if(!audioTrack.isAAC){if(typeSupported.mpeg){container='audio/mpeg';audioTrack.codec='';}else if(typeSupported.mp3){audioTrack.codec='mp3';}}tracks.audio={container:container,codec:audioTrack.codec,initSegment:!audioTrack.isAAC&&typeSupported.mpeg?new Uint8Array():_mp4Generator2.default.initSegment([audioTrack]),metadata:{channelCount:audioTrack.channelCount}};if(computePTSDTS){initPTS=initDTS=audioSamples[0].pts-audioTrack.inputTimeScale*timeOffset;}}if(videoTrack.sps&&videoTrack.pps&&videoSamples.length){var inputTimeScale=videoTrack.inputTimeScale;videoTrack.timescale=inputTimeScale;tracks.video={container:'video/mp4',codec:videoTrack.codec,initSegment:_mp4Generator2.default.initSegment([videoTrack]),metadata:{width:videoTrack.width,height:videoTrack.height}};if(computePTSDTS){initPTS=Math.min(initPTS,videoSamples[0].pts-inputTimeScale*timeOffset);initDTS=Math.min(initDTS,videoSamples[0].dts-inputTimeScale*timeOffset);this.observer.trigger(_events2.default.INIT_PTS_FOUND,{initPTS:initPTS});}}if(Object.keys(tracks).length){observer.trigger(_events2.default.FRAG_PARSING_INIT_SEGMENT,data);this.ISGenerated=true;if(computePTSDTS){this._initPTS=initPTS;this._initDTS=initDTS;}}else{observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:false,reason:'no audio/video samples found'});}}},{key:'remuxVideo',value:function remuxVideo(track,timeOffset,contiguous,audioTrackLength,accurateTimeOffset){var offset=8,timeScale=track.timescale,mp4SampleDuration,mdat,moof,firstPTS,firstDTS,nextDTS,lastPTS,lastDTS,inputSamples=track.samples,outputSamples=[],nbSamples=inputSamples.length,ptsNormalize=this._PTSNormalize,initDTS=this._initDTS;var nextAvcDts=this.nextAvcDts;var isSafari=this.isSafari;if(isSafari){contiguous|=inputSamples.length&&nextAvcDts&&(accurateTimeOffset&&Math.abs(timeOffset-nextAvcDts/timeScale)<0.1||Math.abs(inputSamples[0].pts-nextAvcDts-initDTS)<timeScale/5);}if(!contiguous){nextAvcDts=timeOffset*timeScale;}inputSamples.forEach(function(sample){sample.pts=ptsNormalize(sample.pts-initDTS,nextAvcDts);sample.dts=ptsNormalize(sample.dts-initDTS,nextAvcDts);});inputSamples.sort(function(a,b){var deltadts=a.dts-b.dts;var deltapts=a.pts-b.pts;return deltadts?deltadts:deltapts?deltapts:a.id-b.id;});var PTSDTSshift=inputSamples.reduce(function(prev,curr){return Math.max(Math.min(prev,curr.pts-curr.dts),-18000);},0);if(PTSDTSshift<0){_logger.logger.warn('PTS < DTS detected in video samples, shifting DTS by '+Math.round(PTSDTSshift/90)+' ms to overcome this issue');for(var i=0;i<inputSamples.length;i++){inputSamples[i].dts+=PTSDTSshift;}}var sample=inputSamples[0];firstDTS=Math.max(sample.dts,0);firstPTS=Math.max(sample.pts,0);var delta=Math.round((firstDTS-nextAvcDts)/90);if(contiguous){if(delta){if(delta>1){_logger.logger.log('AVC:'+delta+' ms hole between fragments detected,filling it');}else if(delta<-1){_logger.logger.log('AVC:'+-delta+' ms overlapping between fragments detected');}firstDTS=nextAvcDts;inputSamples[0].dts=firstDTS;firstPTS=Math.max(firstPTS-delta,nextAvcDts);inputSamples[0].pts=firstPTS;_logger.logger.log('Video/PTS/DTS adjusted: '+Math.round(firstPTS/90)+'/'+Math.round(firstDTS/90)+',delta:'+delta+' ms');}}nextDTS=firstDTS;sample=inputSamples[inputSamples.length-1];lastDTS=Math.max(sample.dts,0);lastPTS=Math.max(sample.pts,0,lastDTS);if(isSafari){mp4SampleDuration=Math.round((lastDTS-firstDTS)/(inputSamples.length-1));}var nbNalu=0,naluLen=0;for(var _i=0;_i<nbSamples;_i++){var _sample=inputSamples[_i],units=_sample.units,nbUnits=units.length,sampleLen=0;for(var j=0;j<nbUnits;j++){sampleLen+=units[j].data.length;}naluLen+=sampleLen;nbNalu+=nbUnits;_sample.length=sampleLen;if(isSafari){_sample.dts=firstDTS+_i*mp4SampleDuration;}else{_sample.dts=Math.max(_sample.dts,firstDTS);}_sample.pts=Math.max(_sample.pts,_sample.dts);}var mdatSize=naluLen+4*nbNalu+8;try{mdat=new Uint8Array(mdatSize);}catch(err){this.observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MUX_ERROR,details:_errors.ErrorDetails.REMUX_ALLOC_ERROR,fatal:false,bytes:mdatSize,reason:'fail allocating video mdat '+mdatSize});return;}var view=new DataView(mdat.buffer);view.setUint32(0,mdatSize);mdat.set(_mp4Generator2.default.types.mdat,4);for(var _i2=0;_i2<nbSamples;_i2++){var avcSample=inputSamples[_i2],avcSampleUnits=avcSample.units,mp4SampleLength=0,compositionTimeOffset=void 0;for(var _j=0,_nbUnits=avcSampleUnits.length;_j<_nbUnits;_j++){var unit=avcSampleUnits[_j],unitData=unit.data,unitDataLen=unit.data.byteLength;view.setUint32(offset,unitDataLen);offset+=4;mdat.set(unitData,offset);offset+=unitDataLen;mp4SampleLength+=4+unitDataLen;}if(!isSafari){if(_i2<nbSamples-1){mp4SampleDuration=inputSamples[_i2+1].dts-avcSample.dts;}else{var config=this.config,lastFrameDuration=avcSample.dts-inputSamples[_i2>0?_i2-1:_i2].dts;if(config.stretchShortVideoTrack){var maxBufferHole=config.maxBufferHole,maxSeekHole=config.maxSeekHole,gapTolerance=Math.floor(Math.min(maxBufferHole,maxSeekHole)*timeScale),deltaToFrameEnd=(audioTrackLength?firstPTS+audioTrackLength*timeScale:this.nextAudioPts)-avcSample.pts;if(deltaToFrameEnd>gapTolerance){mp4SampleDuration=deltaToFrameEnd-lastFrameDuration;if(mp4SampleDuration<0){mp4SampleDuration=lastFrameDuration;}_logger.logger.log('It is approximately '+deltaToFrameEnd/90+' ms to the next segment; using duration '+mp4SampleDuration/90+' ms for the last video frame.');}else{mp4SampleDuration=lastFrameDuration;}}else{mp4SampleDuration=lastFrameDuration;}}compositionTimeOffset=Math.round(avcSample.pts-avcSample.dts);}else{compositionTimeOffset=Math.max(0,mp4SampleDuration*Math.round((avcSample.pts-avcSample.dts)/mp4SampleDuration));}outputSamples.push({size:mp4SampleLength,duration:mp4SampleDuration,cts:compositionTimeOffset,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:avcSample.key?2:1,isNonSync:avcSample.key?0:1}});}this.nextAvcDts=lastDTS+mp4SampleDuration;var dropped=track.dropped;track.len=0;track.nbNalu=0;track.dropped=0;if(outputSamples.length&&navigator.userAgent.toLowerCase().indexOf('chrome')>-1){var flags=outputSamples[0].flags;flags.dependsOn=2;flags.isNonSync=0;}track.samples=outputSamples;moof=_mp4Generator2.default.moof(track.sequenceNumber++,firstDTS,track);track.samples=[];var data={data1:moof,data2:mdat,startPTS:firstPTS/timeScale,endPTS:(lastPTS+mp4SampleDuration)/timeScale,startDTS:firstDTS/timeScale,endDTS:this.nextAvcDts/timeScale,type:'video',nb:outputSamples.length,dropped:dropped};this.observer.trigger(_events2.default.FRAG_PARSING_DATA,data);return data;}},{key:'remuxAudio',value:function remuxAudio(track,timeOffset,contiguous,accurateTimeOffset){var inputTimeScale=track.inputTimeScale,mp4timeScale=track.timescale,scaleFactor=inputTimeScale/mp4timeScale,mp4SampleDuration=track.isAAC?1024:1152,inputSampleDuration=mp4SampleDuration*scaleFactor,ptsNormalize=this._PTSNormalize,initDTS=this._initDTS,rawMPEG=!track.isAAC&&this.typeSupported.mpeg;var offset,mp4Sample,fillFrame,mdat,moof,firstPTS,lastPTS,inputSamples=track.samples,outputSamples=[],nextAudioPts=this.nextAudioPts;contiguous|=inputSamples.length&&nextAudioPts&&(accurateTimeOffset&&Math.abs(timeOffset-nextAudioPts/inputTimeScale)<0.1||Math.abs(inputSamples[0].pts-nextAudioPts-initDTS)<20*inputSampleDuration);if(!contiguous){nextAudioPts=timeOffset*inputTimeScale;}inputSamples.forEach(function(sample){sample.pts=sample.dts=ptsNormalize(sample.pts-initDTS,nextAudioPts);});inputSamples.sort(function(a,b){return a.pts-b.pts;});if(accurateTimeOffset&&track.isAAC){for(var i=0,nextPts=nextAudioPts;i<inputSamples.length;){var sample=inputSamples[i],delta;var pts=sample.pts;delta=pts-nextPts;var duration=Math.abs(1000*delta/inputTimeScale);if(delta<=-inputSampleDuration){_logger.logger.warn('Dropping 1 audio frame @ '+(nextPts/inputTimeScale).toFixed(3)+'s due to '+duration+' ms overlap.');inputSamples.splice(i,1);track.len-=sample.unit.length;}else if(delta>=inputSampleDuration&&duration<MAX_SILENT_FRAME_DURATION&&nextPts){var missing=Math.round(delta/inputSampleDuration);_logger.logger.warn('Injecting '+missing+' audio frame @ '+(nextPts/inputTimeScale).toFixed(3)+'s due to '+Math.round(1000*delta/inputTimeScale)+' ms gap.');for(var j=0;j<missing;j++){var newStamp=Math.max(nextPts,0);fillFrame=_aac2.default.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);if(!fillFrame){_logger.logger.log('Unable to get silent frame for given audio codec; duplicating last frame instead.');fillFrame=sample.unit.subarray();}inputSamples.splice(i,0,{unit:fillFrame,pts:newStamp,dts:newStamp});track.len+=fillFrame.length;nextPts+=inputSampleDuration;i++;}sample.pts=sample.dts=nextPts;nextPts+=inputSampleDuration;i++;}else{if(Math.abs(delta)>0.1*inputSampleDuration){}sample.pts=sample.dts=nextPts;nextPts+=inputSampleDuration;i++;}}}for(var _j2=0,_nbSamples=inputSamples.length;_j2<_nbSamples;_j2++){var audioSample=inputSamples[_j2];var unit=audioSample.unit;var _pts=audioSample.pts;if(lastPTS!==undefined){mp4Sample.duration=Math.round((_pts-lastPTS)/scaleFactor);}else{var _delta=Math.round(1000*(_pts-nextAudioPts)/inputTimeScale),numMissingFrames=0;if(contiguous&&track.isAAC){if(_delta){if(_delta>0&&_delta<MAX_SILENT_FRAME_DURATION){numMissingFrames=Math.round((_pts-nextAudioPts)/inputSampleDuration);_logger.logger.log(_delta+' ms hole between AAC samples detected,filling it');if(numMissingFrames>0){fillFrame=_aac2.default.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);if(!fillFrame){fillFrame=unit.subarray();}track.len+=numMissingFrames*fillFrame.length;}}else if(_delta<-12){_logger.logger.log('drop overlapping AAC sample, expected/parsed/delta:'+(nextAudioPts/inputTimeScale).toFixed(3)+'s/'+(_pts/inputTimeScale).toFixed(3)+'s/'+-_delta+'ms');track.len-=unit.byteLength;continue;}_pts=nextAudioPts;}}firstPTS=Math.max(0,_pts);if(track.len>0){var mdatSize=rawMPEG?track.len:track.len+8;offset=rawMPEG?0:8;try{mdat=new Uint8Array(mdatSize);}catch(err){this.observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MUX_ERROR,details:_errors.ErrorDetails.REMUX_ALLOC_ERROR,fatal:false,bytes:mdatSize,reason:'fail allocating audio mdat '+mdatSize});return;}if(!rawMPEG){var view=new DataView(mdat.buffer);view.setUint32(0,mdatSize);mdat.set(_mp4Generator2.default.types.mdat,4);}}else{return;}for(var _i3=0;_i3<numMissingFrames;_i3++){fillFrame=_aac2.default.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);if(!fillFrame){_logger.logger.log('Unable to get silent frame for given audio codec; duplicating this frame instead.');fillFrame=unit.subarray();}mdat.set(fillFrame,offset);offset+=fillFrame.byteLength;mp4Sample={size:fillFrame.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}};outputSamples.push(mp4Sample);}}mdat.set(unit,offset);var unitLen=unit.byteLength;offset+=unitLen;mp4Sample={size:unitLen,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}};outputSamples.push(mp4Sample);lastPTS=_pts;}var lastSampleDuration=0;var nbSamples=outputSamples.length;if(nbSamples>=2){lastSampleDuration=outputSamples[nbSamples-2].duration;mp4Sample.duration=lastSampleDuration;}if(nbSamples){this.nextAudioPts=nextAudioPts=lastPTS+scaleFactor*lastSampleDuration;track.len=0;track.samples=outputSamples;if(rawMPEG){moof=new Uint8Array();}else{moof=_mp4Generator2.default.moof(track.sequenceNumber++,firstPTS/scaleFactor,track);}track.samples=[];var start=firstPTS/inputTimeScale;var end=nextAudioPts/inputTimeScale;var audioData={data1:moof,data2:mdat,startPTS:start,endPTS:end,startDTS:start,endDTS:end,type:'audio',nb:nbSamples};this.observer.trigger(_events2.default.FRAG_PARSING_DATA,audioData);return audioData;}return null;}},{key:'remuxEmptyAudio',value:function remuxEmptyAudio(track,timeOffset,contiguous,videoData){var inputTimeScale=track.inputTimeScale,mp4timeScale=track.samplerate?track.samplerate:inputTimeScale,scaleFactor=inputTimeScale/mp4timeScale,nextAudioPts=this.nextAudioPts,startDTS=(nextAudioPts!==undefined?nextAudioPts:videoData.startDTS*inputTimeScale)+this._initDTS,endDTS=videoData.endDTS*inputTimeScale+this._initDTS,sampleDuration=1024,frameDuration=scaleFactor*sampleDuration,nbSamples=Math.ceil((endDTS-startDTS)/frameDuration),silentFrame=_aac2.default.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);_logger.logger.warn('remux empty Audio');if(!silentFrame){_logger.logger.trace('Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!');return;}var samples=[];for(var i=0;i<nbSamples;i++){var stamp=startDTS+i*frameDuration;samples.push({unit:silentFrame,pts:stamp,dts:stamp});track.len+=silentFrame.length;}track.samples=samples;this.remuxAudio(track,timeOffset,contiguous);}},{key:'remuxID3',value:function remuxID3(track,timeOffset){var length=track.samples.length,sample;var inputTimeScale=track.inputTimeScale;var initPTS=this._initPTS;var initDTS=this._initDTS;if(length){for(var index=0;index<length;index++){sample=track.samples[index];sample.pts=(sample.pts-initPTS)/inputTimeScale;sample.dts=(sample.dts-initDTS)/inputTimeScale;}this.observer.trigger(_events2.default.FRAG_PARSING_METADATA,{samples:track.samples});}track.samples=[];timeOffset=timeOffset;}},{key:'remuxText',value:function remuxText(track,timeOffset){track.samples.sort(function(a,b){return a.pts-b.pts;});var length=track.samples.length,sample;var inputTimeScale=track.inputTimeScale;var initPTS=this._initPTS;if(length){for(var index=0;index<length;index++){sample=track.samples[index];sample.pts=(sample.pts-initPTS)/inputTimeScale;}this.observer.trigger(_events2.default.FRAG_PARSING_USERDATA,{samples:track.samples});}track.samples=[];timeOffset=timeOffset;}},{key:'_PTSNormalize',value:function _PTSNormalize(value,reference){var offset;if(reference===undefined){return value;}if(reference<value){offset=-8589934592;}else{offset=8589934592;}while(Math.abs(value-reference)>4294967296){value+=offset;}return value;}}]);return MP4Remuxer;}();exports.default=MP4Remuxer;},{"33":33,"35":35,"36":36,"44":44,"54":54}],46:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _events=_dereq_(35);var _events2=_interopRequireDefault(_events);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var PassThroughRemuxer=function(){function PassThroughRemuxer(observer){_classCallCheck$$1(this,PassThroughRemuxer);this.observer=observer;}_createClass$$1(PassThroughRemuxer,[{key:'destroy',value:function destroy(){}},{key:'resetTimeStamp',value:function resetTimeStamp(){}},{key:'resetInitSegment',value:function resetInitSegment(){}},{key:'remux',value:function remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset,rawData){var observer=this.observer;var streamType='';if(audioTrack){streamType+='audio';}if(videoTrack){streamType+='video';}observer.trigger(_events2.default.FRAG_PARSING_DATA,{data1:rawData,startPTS:timeOffset,startDTS:timeOffset,type:streamType,nb:1,dropped:0});observer.trigger(_events2.default.FRAG_PARSED);}}]);return PassThroughRemuxer;}();exports.default=PassThroughRemuxer;},{"35":35}],47:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var DECIMAL_RESOLUTION_REGEX=/^(\d+)x(\d+)$/;var ATTR_LIST_REGEX=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;var AttrList=function(){function AttrList(attrs){_classCallCheck$$1(this,AttrList);if(typeof attrs==='string'){attrs=AttrList.parseAttrList(attrs);}for(var attr in attrs){if(attrs.hasOwnProperty(attr)){this[attr]=attrs[attr];}}}_createClass$$1(AttrList,[{key:'decimalInteger',value:function decimalInteger(attrName){var intValue=parseInt(this[attrName],10);if(intValue>Number.MAX_SAFE_INTEGER){return Infinity;}return intValue;}},{key:'hexadecimalInteger',value:function hexadecimalInteger(attrName){if(this[attrName]){var stringValue=(this[attrName]||'0x').slice(2);stringValue=(stringValue.length&1?'0':'')+stringValue;var value=new Uint8Array(stringValue.length/2);for(var i=0;i<stringValue.length/2;i++){value[i]=parseInt(stringValue.slice(i*2,i*2+2),16);}return value;}else{return null;}}},{key:'hexadecimalIntegerAsNumber',value:function hexadecimalIntegerAsNumber(attrName){var intValue=parseInt(this[attrName],16);if(intValue>Number.MAX_SAFE_INTEGER){return Infinity;}return intValue;}},{key:'decimalFloatingPoint',value:function decimalFloatingPoint(attrName){return parseFloat(this[attrName]);}},{key:'enumeratedString',value:function enumeratedString(attrName){return this[attrName];}},{key:'decimalResolution',value:function decimalResolution(attrName){var res=DECIMAL_RESOLUTION_REGEX.exec(this[attrName]);if(res===null){return undefined;}return{width:parseInt(res[1],10),height:parseInt(res[2],10)};}}],[{key:'parseAttrList',value:function parseAttrList(input){var match,attrs={};ATTR_LIST_REGEX.lastIndex=0;while((match=ATTR_LIST_REGEX.exec(input))!==null){var value=match[2],quote='"';if(value.indexOf(quote)===0&&value.lastIndexOf(quote)===value.length-1){value=value.slice(1,-1);}attrs[match[1]]=value;}return attrs;}}]);return AttrList;}();exports.default=AttrList;},{}],48:[function(_dereq_,module,exports){"use strict";var BinarySearch={search:function search(list,comparisonFunction){var minIndex=0;var maxIndex=list.length-1;var currentIndex=null;var currentElement=null;while(minIndex<=maxIndex){currentIndex=(minIndex+maxIndex)/2|0;currentElement=list[currentIndex];var comparisonResult=comparisonFunction(currentElement);if(comparisonResult>0){minIndex=currentIndex+1;}else if(comparisonResult<0){maxIndex=currentIndex-1;}else{return currentElement;}}return null;}};module.exports=BinarySearch;},{}],49:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var specialCea608CharsCodes={0x2a:0xe1,0x5c:0xe9,0x5e:0xed,0x5f:0xf3,0x60:0xfa,0x7b:0xe7,0x7c:0xf7,0x7d:0xd1,0x7e:0xf1,0x7f:0x2588,0x80:0xae,0x81:0xb0,0x82:0xbd,0x83:0xbf,0x84:0x2122,0x85:0xa2,0x86:0xa3,0x87:0x266a,0x88:0xe0,0x89:0x20,0x8a:0xe8,0x8b:0xe2,0x8c:0xea,0x8d:0xee,0x8e:0xf4,0x8f:0xfb,0x90:0xc1,0x91:0xc9,0x92:0xd3,0x93:0xda,0x94:0xdc,0x95:0xfc,0x96:0x2018,0x97:0xa1,0x98:0x2a,0x99:0x2019,0x9a:0x2501,0x9b:0xa9,0x9c:0x2120,0x9d:0x2022,0x9e:0x201c,0x9f:0x201d,0xa0:0xc0,0xa1:0xc2,0xa2:0xc7,0xa3:0xc8,0xa4:0xca,0xa5:0xcb,0xa6:0xeb,0xa7:0xce,0xa8:0xcf,0xa9:0xef,0xaa:0xd4,0xab:0xd9,0xac:0xf9,0xad:0xdb,0xae:0xab,0xaf:0xbb,0xb0:0xc3,0xb1:0xe3,0xb2:0xcd,0xb3:0xcc,0xb4:0xec,0xb5:0xd2,0xb6:0xf2,0xb7:0xd5,0xb8:0xf5,0xb9:0x7b,0xba:0x7d,0xbb:0x5c,0xbc:0x5e,0xbd:0x5f,0xbe:0x7c,0xbf:0x223c,0xc0:0xc4,0xc1:0xe4,0xc2:0xd6,0xc3:0xf6,0xc4:0xdf,0xc5:0xa5,0xc6:0xa4,0xc7:0x2503,0xc8:0xc5,0xc9:0xe5,0xca:0xd8,0xcb:0xf8,0xcc:0x250f,0xcd:0x2513,0xce:0x2517,0xcf:0x251b};var getCharForByte=function getCharForByte(byte){var charCode=byte;if(specialCea608CharsCodes.hasOwnProperty(byte)){charCode=specialCea608CharsCodes[byte];}return String.fromCharCode(charCode);};var NR_ROWS=15,NR_COLS=100;var rowsLowCh1={0x11:1,0x12:3,0x15:5,0x16:7,0x17:9,0x10:11,0x13:12,0x14:14};var rowsHighCh1={0x11:2,0x12:4,0x15:6,0x16:8,0x17:10,0x13:13,0x14:15};var rowsLowCh2={0x19:1,0x1A:3,0x1D:5,0x1E:7,0x1F:9,0x18:11,0x1B:12,0x1C:14};var rowsHighCh2={0x19:2,0x1A:4,0x1D:6,0x1E:8,0x1F:10,0x1B:13,0x1C:15};var backgroundColors=['white','green','blue','cyan','red','yellow','magenta','black','transparent'];var logger={verboseFilter:{'DATA':3,'DEBUG':3,'INFO':2,'WARNING':2,'TEXT':1,'ERROR':0},time:null,verboseLevel:0,setTime:function setTime(newTime){this.time=newTime;},log:function log(severity,msg){var minLevel=this.verboseFilter[severity];if(this.verboseLevel>=minLevel){console.log(this.time+' ['+severity+'] '+msg);}}};var numArrayToHexArray=function numArrayToHexArray(numArray){var hexArray=[];for(var j=0;j<numArray.length;j++){hexArray.push(numArray[j].toString(16));}return hexArray;};var PenState=function(){function PenState(foreground,underline,italics,background,flash){_classCallCheck$$1(this,PenState);this.foreground=foreground||'white';this.underline=underline||false;this.italics=italics||false;this.background=background||'black';this.flash=flash||false;}_createClass$$1(PenState,[{key:'reset',value:function reset(){this.foreground='white';this.underline=false;this.italics=false;this.background='black';this.flash=false;}},{key:'setStyles',value:function setStyles(styles){var attribs=['foreground','underline','italics','background','flash'];for(var i=0;i<attribs.length;i++){var style=attribs[i];if(styles.hasOwnProperty(style)){this[style]=styles[style];}}}},{key:'isDefault',value:function isDefault(){return this.foreground==='white'&&!this.underline&&!this.italics&&this.background==='black'&&!this.flash;}},{key:'equals',value:function equals(other){return this.foreground===other.foreground&&this.underline===other.underline&&this.italics===other.italics&&this.background===other.background&&this.flash===other.flash;}},{key:'copy',value:function copy(newPenState){this.foreground=newPenState.foreground;this.underline=newPenState.underline;this.italics=newPenState.italics;this.background=newPenState.background;this.flash=newPenState.flash;}},{key:'toString',value:function toString(){return'color='+this.foreground+', underline='+this.underline+', italics='+this.italics+', background='+this.background+', flash='+this.flash;}}]);return PenState;}();var StyledUnicodeChar=function(){function StyledUnicodeChar(uchar,foreground,underline,italics,background,flash){_classCallCheck$$1(this,StyledUnicodeChar);this.uchar=uchar||' ';this.penState=new PenState(foreground,underline,italics,background,flash);}_createClass$$1(StyledUnicodeChar,[{key:'reset',value:function reset(){this.uchar=' ';this.penState.reset();}},{key:'setChar',value:function setChar(uchar,newPenState){this.uchar=uchar;this.penState.copy(newPenState);}},{key:'setPenState',value:function setPenState(newPenState){this.penState.copy(newPenState);}},{key:'equals',value:function equals(other){return this.uchar===other.uchar&&this.penState.equals(other.penState);}},{key:'copy',value:function copy(newChar){this.uchar=newChar.uchar;this.penState.copy(newChar.penState);}},{key:'isEmpty',value:function isEmpty$$1(){return this.uchar===' '&&this.penState.isDefault();}}]);return StyledUnicodeChar;}();var Row=function(){function Row(){_classCallCheck$$1(this,Row);this.chars=[];for(var i=0;i<NR_COLS;i++){this.chars.push(new StyledUnicodeChar());}this.pos=0;this.currPenState=new PenState();}_createClass$$1(Row,[{key:'equals',value:function equals(other){var equal=true;for(var i=0;i<NR_COLS;i++){if(!this.chars[i].equals(other.chars[i])){equal=false;break;}}return equal;}},{key:'copy',value:function copy(other){for(var i=0;i<NR_COLS;i++){this.chars[i].copy(other.chars[i]);}}},{key:'isEmpty',value:function isEmpty$$1(){var empty=true;for(var i=0;i<NR_COLS;i++){if(!this.chars[i].isEmpty()){empty=false;break;}}return empty;}},{key:'setCursor',value:function setCursor(absPos){if(this.pos!==absPos){this.pos=absPos;}if(this.pos<0){logger.log('ERROR','Negative cursor position '+this.pos);this.pos=0;}else if(this.pos>NR_COLS){logger.log('ERROR','Too large cursor position '+this.pos);this.pos=NR_COLS;}}},{key:'moveCursor',value:function moveCursor(relPos){var newPos=this.pos+relPos;if(relPos>1){for(var i=this.pos+1;i<newPos+1;i++){this.chars[i].setPenState(this.currPenState);}}this.setCursor(newPos);}},{key:'backSpace',value:function backSpace(){this.moveCursor(-1);this.chars[this.pos].setChar(' ',this.currPenState);}},{key:'insertChar',value:function insertChar(byte){if(byte>=0x90){this.backSpace();}var char=getCharForByte(byte);if(this.pos>=NR_COLS){logger.log('ERROR','Cannot insert '+byte.toString(16)+' ('+char+') at position '+this.pos+'. Skipping it!');return;}this.chars[this.pos].setChar(char,this.currPenState);this.moveCursor(1);}},{key:'clearFromPos',value:function clearFromPos(startPos){var i;for(i=startPos;i<NR_COLS;i++){this.chars[i].reset();}}},{key:'clear',value:function clear(){this.clearFromPos(0);this.pos=0;this.currPenState.reset();}},{key:'clearToEndOfRow',value:function clearToEndOfRow(){this.clearFromPos(this.pos);}},{key:'getTextString',value:function getTextString(){var chars=[];var empty=true;for(var i=0;i<NR_COLS;i++){var char=this.chars[i].uchar;if(char!==' '){empty=false;}chars.push(char);}if(empty){return'';}else{return chars.join('');}}},{key:'setPenStyles',value:function setPenStyles(styles){this.currPenState.setStyles(styles);var currChar=this.chars[this.pos];currChar.setPenState(this.currPenState);}}]);return Row;}();var CaptionScreen=function(){function CaptionScreen(){_classCallCheck$$1(this,CaptionScreen);this.rows=[];for(var i=0;i<NR_ROWS;i++){this.rows.push(new Row());}this.currRow=NR_ROWS-1;this.nrRollUpRows=null;this.reset();}_createClass$$1(CaptionScreen,[{key:'reset',value:function reset(){for(var i=0;i<NR_ROWS;i++){this.rows[i].clear();}this.currRow=NR_ROWS-1;}},{key:'equals',value:function equals(other){var equal=true;for(var i=0;i<NR_ROWS;i++){if(!this.rows[i].equals(other.rows[i])){equal=false;break;}}return equal;}},{key:'copy',value:function copy(other){for(var i=0;i<NR_ROWS;i++){this.rows[i].copy(other.rows[i]);}}},{key:'isEmpty',value:function isEmpty$$1(){var empty=true;for(var i=0;i<NR_ROWS;i++){if(!this.rows[i].isEmpty()){empty=false;break;}}return empty;}},{key:'backSpace',value:function backSpace(){var row=this.rows[this.currRow];row.backSpace();}},{key:'clearToEndOfRow',value:function clearToEndOfRow(){var row=this.rows[this.currRow];row.clearToEndOfRow();}},{key:'insertChar',value:function insertChar(char){var row=this.rows[this.currRow];row.insertChar(char);}},{key:'setPen',value:function setPen(styles){var row=this.rows[this.currRow];row.setPenStyles(styles);}},{key:'moveCursor',value:function moveCursor(relPos){var row=this.rows[this.currRow];row.moveCursor(relPos);}},{key:'setCursor',value:function setCursor(absPos){logger.log('INFO','setCursor: '+absPos);var row=this.rows[this.currRow];row.setCursor(absPos);}},{key:'setPAC',value:function setPAC(pacData){logger.log('INFO','pacData = '+JSON.stringify(pacData));var newRow=pacData.row-1;if(this.nrRollUpRows&&newRow<this.nrRollUpRows-1){newRow=this.nrRollUpRows-1;}if(this.nrRollUpRows&&this.currRow!==newRow){for(var i=0;i<NR_ROWS;i++){this.rows[i].clear();}var topRowIndex=this.currRow+1-this.nrRollUpRows;var lastOutputScreen=this.lastOutputScreen;if(lastOutputScreen){var prevLineTime=lastOutputScreen.rows[topRowIndex].cueStartTime;if(prevLineTime&&prevLineTime<logger.time){for(var _i=0;_i<this.nrRollUpRows;_i++){this.rows[newRow-this.nrRollUpRows+_i+1].copy(lastOutputScreen.rows[topRowIndex+_i]);}}}}this.currRow=newRow;var row=this.rows[this.currRow];if(pacData.indent!==null){var indent=pacData.indent;var prevPos=Math.max(indent-1,0);row.setCursor(pacData.indent);pacData.color=row.chars[prevPos].penState.foreground;}var styles={foreground:pacData.color,underline:pacData.underline,italics:pacData.italics,background:'black',flash:false};this.setPen(styles);}},{key:'setBkgData',value:function setBkgData(bkgData){logger.log('INFO','bkgData = '+JSON.stringify(bkgData));this.backSpace();this.setPen(bkgData);this.insertChar(0x20);}},{key:'setRollUpRows',value:function setRollUpRows(nrRows){this.nrRollUpRows=nrRows;}},{key:'rollUp',value:function rollUp(){if(this.nrRollUpRows===null){logger.log('DEBUG','roll_up but nrRollUpRows not set yet');return;}logger.log('TEXT',this.getDisplayText());var topRowIndex=this.currRow+1-this.nrRollUpRows;var topRow=this.rows.splice(topRowIndex,1)[0];topRow.clear();this.rows.splice(this.currRow,0,topRow);logger.log('INFO','Rolling up');}},{key:'getDisplayText',value:function getDisplayText(asOneRow){asOneRow=asOneRow||false;var displayText=[];var text='';var rowNr=-1;for(var i=0;i<NR_ROWS;i++){var rowText=this.rows[i].getTextString();if(rowText){rowNr=i+1;if(asOneRow){displayText.push('Row '+rowNr+': \''+rowText+'\'');}else{displayText.push(rowText.trim());}}}if(displayText.length>0){if(asOneRow){text='['+displayText.join(' | ')+']';}else{text=displayText.join('\n');}}return text;}},{key:'getTextAndFormat',value:function getTextAndFormat(){return this.rows;}}]);return CaptionScreen;}();var Cea608Channel=function(){function Cea608Channel(channelNumber,outputFilter){_classCallCheck$$1(this,Cea608Channel);this.chNr=channelNumber;this.outputFilter=outputFilter;this.mode=null;this.verbose=0;this.displayedMemory=new CaptionScreen();this.nonDisplayedMemory=new CaptionScreen();this.lastOutputScreen=new CaptionScreen();this.currRollUpRow=this.displayedMemory.rows[NR_ROWS-1];this.writeScreen=this.displayedMemory;this.mode=null;this.cueStartTime=null;}_createClass$$1(Cea608Channel,[{key:'reset',value:function reset(){this.mode=null;this.displayedMemory.reset();this.nonDisplayedMemory.reset();this.lastOutputScreen.reset();this.currRollUpRow=this.displayedMemory.rows[NR_ROWS-1];this.writeScreen=this.displayedMemory;this.mode=null;this.cueStartTime=null;this.lastCueEndTime=null;}},{key:'getHandler',value:function getHandler(){return this.outputFilter;}},{key:'setHandler',value:function setHandler(newHandler){this.outputFilter=newHandler;}},{key:'setPAC',value:function setPAC(pacData){this.writeScreen.setPAC(pacData);}},{key:'setBkgData',value:function setBkgData(bkgData){this.writeScreen.setBkgData(bkgData);}},{key:'setMode',value:function setMode(newMode){if(newMode===this.mode){return;}this.mode=newMode;logger.log('INFO','MODE='+newMode);if(this.mode==='MODE_POP-ON'){this.writeScreen=this.nonDisplayedMemory;}else{this.writeScreen=this.displayedMemory;this.writeScreen.reset();}if(this.mode!=='MODE_ROLL-UP'){this.displayedMemory.nrRollUpRows=null;this.nonDisplayedMemory.nrRollUpRows=null;}this.mode=newMode;}},{key:'insertChars',value:function insertChars(chars){for(var i=0;i<chars.length;i++){this.writeScreen.insertChar(chars[i]);}var screen=this.writeScreen===this.displayedMemory?'DISP':'NON_DISP';logger.log('INFO',screen+': '+this.writeScreen.getDisplayText(true));if(this.mode==='MODE_PAINT-ON'||this.mode==='MODE_ROLL-UP'){logger.log('TEXT','DISPLAYED: '+this.displayedMemory.getDisplayText(true));this.outputDataUpdate();}}},{key:'ccRCL',value:function ccRCL(){logger.log('INFO','RCL - Resume Caption Loading');this.setMode('MODE_POP-ON');}},{key:'ccBS',value:function ccBS(){logger.log('INFO','BS - BackSpace');if(this.mode==='MODE_TEXT'){return;}this.writeScreen.backSpace();if(this.writeScreen===this.displayedMemory){this.outputDataUpdate();}}},{key:'ccAOF',value:function ccAOF(){return;}},{key:'ccAON',value:function ccAON(){return;}},{key:'ccDER',value:function ccDER(){logger.log('INFO','DER- Delete to End of Row');this.writeScreen.clearToEndOfRow();this.outputDataUpdate();}},{key:'ccRU',value:function ccRU(nrRows){logger.log('INFO','RU('+nrRows+') - Roll Up');this.writeScreen=this.displayedMemory;this.setMode('MODE_ROLL-UP');this.writeScreen.setRollUpRows(nrRows);}},{key:'ccFON',value:function ccFON(){logger.log('INFO','FON - Flash On');this.writeScreen.setPen({flash:true});}},{key:'ccRDC',value:function ccRDC(){logger.log('INFO','RDC - Resume Direct Captioning');this.setMode('MODE_PAINT-ON');}},{key:'ccTR',value:function ccTR(){logger.log('INFO','TR');this.setMode('MODE_TEXT');}},{key:'ccRTD',value:function ccRTD(){logger.log('INFO','RTD');this.setMode('MODE_TEXT');}},{key:'ccEDM',value:function ccEDM(){logger.log('INFO','EDM - Erase Displayed Memory');this.displayedMemory.reset();this.outputDataUpdate();}},{key:'ccCR',value:function ccCR(){logger.log('CR - Carriage Return');this.writeScreen.rollUp();this.outputDataUpdate();}},{key:'ccENM',value:function ccENM(){logger.log('INFO','ENM - Erase Non-displayed Memory');this.nonDisplayedMemory.reset();}},{key:'ccEOC',value:function ccEOC(){logger.log('INFO','EOC - End Of Caption');if(this.mode==='MODE_POP-ON'){var tmp=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory;this.nonDisplayedMemory=tmp;this.writeScreen=this.nonDisplayedMemory;logger.log('TEXT','DISP: '+this.displayedMemory.getDisplayText());}this.outputDataUpdate();}},{key:'ccTO',value:function ccTO(nrCols){logger.log('INFO','TO('+nrCols+') - Tab Offset');this.writeScreen.moveCursor(nrCols);}},{key:'ccMIDROW',value:function ccMIDROW(secondByte){var styles={flash:false};styles.underline=secondByte%2===1;styles.italics=secondByte>=0x2e;if(!styles.italics){var colorIndex=Math.floor(secondByte/2)-0x10;var colors=['white','green','blue','cyan','red','yellow','magenta'];styles.foreground=colors[colorIndex];}else{styles.foreground='white';}logger.log('INFO','MIDROW: '+JSON.stringify(styles));this.writeScreen.setPen(styles);}},{key:'outputDataUpdate',value:function outputDataUpdate(){var t=logger.time;if(t===null){return;}if(this.outputFilter){if(this.outputFilter.updateData){this.outputFilter.updateData(t,this.displayedMemory);}if(this.cueStartTime===null&&!this.displayedMemory.isEmpty()){this.cueStartTime=t;}else{if(!this.displayedMemory.equals(this.lastOutputScreen)){if(this.outputFilter.newCue){this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen);}this.cueStartTime=this.displayedMemory.isEmpty()?null:t;}}this.lastOutputScreen.copy(this.displayedMemory);}}},{key:'cueSplitAtTime',value:function cueSplitAtTime(t){if(this.outputFilter){if(!this.displayedMemory.isEmpty()){if(this.outputFilter.newCue){this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory);}this.cueStartTime=t;}}}}]);return Cea608Channel;}();var Cea608Parser=function(){function Cea608Parser(field,out1,out2){_classCallCheck$$1(this,Cea608Parser);this.field=field||1;this.outputs=[out1,out2];this.channels=[new Cea608Channel(1,out1),new Cea608Channel(2,out2)];this.currChNr=-1;this.lastCmdA=null;this.lastCmdB=null;this.bufferedData=[];this.startTime=null;this.lastTime=null;this.dataCounters={'padding':0,'char':0,'cmd':0,'other':0};}_createClass$$1(Cea608Parser,[{key:'getHandler',value:function getHandler(index){return this.channels[index].getHandler();}},{key:'setHandler',value:function setHandler(index,newHandler){this.channels[index].setHandler(newHandler);}},{key:'addData',value:function addData(t,byteList){var cmdFound,a,b,charsFound=false;this.lastTime=t;logger.setTime(t);for(var i=0;i<byteList.length;i+=2){a=byteList[i]&0x7f;b=byteList[i+1]&0x7f;if(a===0&&b===0){this.dataCounters.padding+=2;continue;}else{logger.log('DATA','['+numArrayToHexArray([byteList[i],byteList[i+1]])+'] -> ('+numArrayToHexArray([a,b])+')');}cmdFound=this.parseCmd(a,b);if(!cmdFound){cmdFound=this.parseMidrow(a,b);}if(!cmdFound){cmdFound=this.parsePAC(a,b);}if(!cmdFound){cmdFound=this.parseBackgroundAttributes(a,b);}if(!cmdFound){charsFound=this.parseChars(a,b);if(charsFound){if(this.currChNr&&this.currChNr>=0){var channel=this.channels[this.currChNr-1];channel.insertChars(charsFound);}else{logger.log('WARNING','No channel found yet. TEXT-MODE?');}}}if(cmdFound){this.dataCounters.cmd+=2;}else if(charsFound){this.dataCounters.char+=2;}else{this.dataCounters.other+=2;logger.log('WARNING','Couldn\'t parse cleaned data '+numArrayToHexArray([a,b])+' orig: '+numArrayToHexArray([byteList[i],byteList[i+1]]));}}}},{key:'parseCmd',value:function parseCmd(a,b){var chNr=null;var cond1=(a===0x14||a===0x1C)&&0x20<=b&&b<=0x2F;var cond2=(a===0x17||a===0x1F)&&0x21<=b&&b<=0x23;if(!(cond1||cond2)){return false;}if(a===this.lastCmdA&&b===this.lastCmdB){this.lastCmdA=null;this.lastCmdB=null;logger.log('DEBUG','Repeated command ('+numArrayToHexArray([a,b])+') is dropped');return true;}if(a===0x14||a===0x17){chNr=1;}else{chNr=2;}var channel=this.channels[chNr-1];if(a===0x14||a===0x1C){if(b===0x20){channel.ccRCL();}else if(b===0x21){channel.ccBS();}else if(b===0x22){channel.ccAOF();}else if(b===0x23){channel.ccAON();}else if(b===0x24){channel.ccDER();}else if(b===0x25){channel.ccRU(2);}else if(b===0x26){channel.ccRU(3);}else if(b===0x27){channel.ccRU(4);}else if(b===0x28){channel.ccFON();}else if(b===0x29){channel.ccRDC();}else if(b===0x2A){channel.ccTR();}else if(b===0x2B){channel.ccRTD();}else if(b===0x2C){channel.ccEDM();}else if(b===0x2D){channel.ccCR();}else if(b===0x2E){channel.ccENM();}else if(b===0x2F){channel.ccEOC();}}else{channel.ccTO(b-0x20);}this.lastCmdA=a;this.lastCmdB=b;this.currChNr=chNr;return true;}},{key:'parseMidrow',value:function parseMidrow(a,b){var chNr=null;if((a===0x11||a===0x19)&&0x20<=b&&b<=0x2f){if(a===0x11){chNr=1;}else{chNr=2;}if(chNr!==this.currChNr){logger.log('ERROR','Mismatch channel in midrow parsing');return false;}var channel=this.channels[chNr-1];channel.ccMIDROW(b);logger.log('DEBUG','MIDROW ('+numArrayToHexArray([a,b])+')');return true;}return false;}},{key:'parsePAC',value:function parsePAC(a,b){var chNr=null;var row=null;var case1=(0x11<=a&&a<=0x17||0x19<=a&&a<=0x1F)&&0x40<=b&&b<=0x7F;var case2=(a===0x10||a===0x18)&&0x40<=b&&b<=0x5F;if(!(case1||case2)){return false;}if(a===this.lastCmdA&&b===this.lastCmdB){this.lastCmdA=null;this.lastCmdB=null;return true;}chNr=a<=0x17?1:2;if(0x40<=b&&b<=0x5F){row=chNr===1?rowsLowCh1[a]:rowsLowCh2[a];}else{row=chNr===1?rowsHighCh1[a]:rowsHighCh2[a];}var pacData=this.interpretPAC(row,b);var channel=this.channels[chNr-1];channel.setPAC(pacData);this.lastCmdA=a;this.lastCmdB=b;this.currChNr=chNr;return true;}},{key:'interpretPAC',value:function interpretPAC(row,byte){var pacIndex=byte;var pacData={color:null,italics:false,indent:null,underline:false,row:row};if(byte>0x5F){pacIndex=byte-0x60;}else{pacIndex=byte-0x40;}pacData.underline=(pacIndex&1)===1;if(pacIndex<=0xd){pacData.color=['white','green','blue','cyan','red','yellow','magenta','white'][Math.floor(pacIndex/2)];}else if(pacIndex<=0xf){pacData.italics=true;pacData.color='white';}else{pacData.indent=Math.floor((pacIndex-0x10)/2)*4;}return pacData;}},{key:'parseChars',value:function parseChars(a,b){var channelNr=null,charCodes=null,charCode1=null;if(a>=0x19){channelNr=2;charCode1=a-8;}else{channelNr=1;charCode1=a;}if(0x11<=charCode1&&charCode1<=0x13){var oneCode=b;if(charCode1===0x11){oneCode=b+0x50;}else if(charCode1===0x12){oneCode=b+0x70;}else{oneCode=b+0x90;}logger.log('INFO','Special char \''+getCharForByte(oneCode)+'\' in channel '+channelNr);charCodes=[oneCode];}else if(0x20<=a&&a<=0x7f){charCodes=b===0?[a]:[a,b];}if(charCodes){var hexCodes=numArrayToHexArray(charCodes);logger.log('DEBUG','Char codes =  '+hexCodes.join(','));this.lastCmdA=null;this.lastCmdB=null;}return charCodes;}},{key:'parseBackgroundAttributes',value:function parseBackgroundAttributes(a,b){var bkgData,index,chNr,channel;var case1=(a===0x10||a===0x18)&&0x20<=b&&b<=0x2f;var case2=(a===0x17||a===0x1f)&&0x2d<=b&&b<=0x2f;if(!(case1||case2)){return false;}bkgData={};if(a===0x10||a===0x18){index=Math.floor((b-0x20)/2);bkgData.background=backgroundColors[index];if(b%2===1){bkgData.background=bkgData.background+'_semi';}}else if(b===0x2d){bkgData.background='transparent';}else{bkgData.foreground='black';if(b===0x2f){bkgData.underline=true;}}chNr=a<0x18?1:2;channel=this.channels[chNr-1];channel.setBkgData(bkgData);this.lastCmdA=null;this.lastCmdB=null;return true;}},{key:'reset',value:function reset(){for(var i=0;i<this.channels.length;i++){if(this.channels[i]){this.channels[i].reset();}}this.lastCmdA=null;this.lastCmdB=null;}},{key:'cueSplitAtTime',value:function cueSplitAtTime(t){for(var i=0;i<this.channels.length;i++){if(this.channels[i]){this.channels[i].cueSplitAtTime(t);}}}}]);return Cea608Parser;}();exports.default=Cea608Parser;},{}],50:[function(_dereq_,module,exports){'use strict';var _vttparser=_dereq_(57);var Cues={newCue:function newCue(track,startTime,endTime,captionScreen){var row;var cue;var indenting;var indent;var text;var VTTCue=window.VTTCue||window.TextTrackCue;for(var r=0;r<captionScreen.rows.length;r++){row=captionScreen.rows[r];indenting=true;indent=0;text='';if(!row.isEmpty()){for(var c=0;c<row.chars.length;c++){if(row.chars[c].uchar.match(/\s/)&&indenting){indent++;}else{text+=row.chars[c].uchar;indenting=false;}}row.cueStartTime=startTime;if(startTime===endTime){endTime+=0.0001;}cue=new VTTCue(startTime,endTime,(0,_vttparser.fixLineBreaks)(text.trim()));if(indent>=16){indent--;}else{indent++;}if(navigator.userAgent.match(/Firefox\//)){cue.line=r+1;}else{cue.line=r>7?r-2:r+1;}cue.align='left';cue.position=Math.max(0,Math.min(100,100*(indent/32)+(navigator.userAgent.match(/Firefox\//)?50:0)));track.addCue(cue);}}}};module.exports=Cues;},{"57":57}],51:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.findFragWithCC=findFragWithCC;var _binarySearch=_dereq_(48);var _binarySearch2=_interopRequireDefault(_binarySearch);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function findFragWithCC(fragments,CC){return _binarySearch2.default.search(fragments,function(candidate){if(candidate.cc<CC){return 1;}else if(candidate.cc>CC){return-1;}else{return 0;}});}},{"48":48}],52:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _ewma=_dereq_(53);var _ewma2=_interopRequireDefault(_ewma);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var EwmaBandWidthEstimator=function(){function EwmaBandWidthEstimator(hls,slow,fast,defaultEstimate){_classCallCheck$$1(this,EwmaBandWidthEstimator);this.hls=hls;this.defaultEstimate_=defaultEstimate;this.minWeight_=0.001;this.minDelayMs_=50;this.slow_=new _ewma2.default(slow);this.fast_=new _ewma2.default(fast);}_createClass$$1(EwmaBandWidthEstimator,[{key:'sample',value:function sample(durationMs,numBytes){durationMs=Math.max(durationMs,this.minDelayMs_);var bandwidth=8000*numBytes/durationMs,weight=durationMs/1000;this.fast_.sample(weight,bandwidth);this.slow_.sample(weight,bandwidth);}},{key:'canEstimate',value:function canEstimate(){var fast=this.fast_;return fast&&fast.getTotalWeight()>=this.minWeight_;}},{key:'getEstimate',value:function getEstimate(){if(this.canEstimate()){return Math.min(this.fast_.getEstimate(),this.slow_.getEstimate());}else{return this.defaultEstimate_;}}},{key:'destroy',value:function destroy(){}}]);return EwmaBandWidthEstimator;}();exports.default=EwmaBandWidthEstimator;},{"53":53}],53:[function(_dereq_,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var EWMA=function(){function EWMA(halfLife){_classCallCheck$$1(this,EWMA);this.alpha_=halfLife?Math.exp(Math.log(0.5)/halfLife):0;this.estimate_=0;this.totalWeight_=0;}_createClass$$1(EWMA,[{key:"sample",value:function sample(weight,value){var adjAlpha=Math.pow(this.alpha_,weight);this.estimate_=value*(1-adjAlpha)+adjAlpha*this.estimate_;this.totalWeight_+=weight;}},{key:"getTotalWeight",value:function getTotalWeight(){return this.totalWeight_;}},{key:"getEstimate",value:function getEstimate(){if(this.alpha_){var zeroFactor=1-Math.pow(this.alpha_,this.totalWeight_);return this.estimate_/zeroFactor;}else{return this.estimate_;}}}]);return EWMA;}();exports.default=EWMA;},{}],54:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _typeof$$1=typeof Symbol==="function"&&_typeof2(Symbol.iterator)==="symbol"?function(obj){return typeof obj==='undefined'?'undefined':_typeof2(obj);}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj==='undefined'?'undefined':_typeof2(obj);};function noop(){}var fakeLogger={trace:noop,debug:noop,log:noop,warn:noop,info:noop,error:noop};var exportedLogger=fakeLogger;function formatMsg(type,msg){msg='['+type+'] > '+msg;return msg;}function consolePrintFn(type){var func=self.console[type];if(func){return function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}if(args[0]){args[0]=formatMsg(type,args[0]);}func.apply(self.console,args);};}return noop;}function exportLoggerFunctions(debugConfig){for(var _len2=arguments.length,functions=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){functions[_key2-1]=arguments[_key2];}functions.forEach(function(type){exportedLogger[type]=debugConfig[type]?debugConfig[type].bind(debugConfig):consolePrintFn(type);});}var enableLogs=exports.enableLogs=function enableLogs(debugConfig){if(debugConfig===true||(typeof debugConfig==='undefined'?'undefined':_typeof$$1(debugConfig))==='object'){exportLoggerFunctions(debugConfig,'debug','log','info','warn','error');try{exportedLogger.log();}catch(e){exportedLogger=fakeLogger;}}else{exportedLogger=fakeLogger;}};var logger=exports.logger=exportedLogger;},{}],55:[function(_dereq_,module,exports){'use strict';var TimeRanges={toString:function toString(r){var log='',len=r.length;for(var i=0;i<len;i++){log+='['+r.start(i).toFixed(3)+','+r.end(i).toFixed(3)+']';}return log;}};module.exports=TimeRanges;},{}],56:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.default=function(){if(typeof window!=='undefined'&&window.VTTCue){return window.VTTCue;}var autoKeyword='auto';var directionSetting={'':true,lr:true,rl:true};var alignSetting={start:true,middle:true,end:true,left:true,right:true};function findDirectionSetting(value){if(typeof value!=='string'){return false;}var dir=directionSetting[value.toLowerCase()];return dir?value.toLowerCase():false;}function findAlignSetting(value){if(typeof value!=='string'){return false;}var align=alignSetting[value.toLowerCase()];return align?value.toLowerCase():false;}function extend(obj){var i=1;for(;i<arguments.length;i++){var cobj=arguments[i];for(var p in cobj){obj[p]=cobj[p];}}return obj;}function VTTCue(startTime,endTime,text){var cue=this;var isIE8=function(){if(typeof navigator==='undefined'){return;}return /MSIE\s8\.0/.test(navigator.userAgent);}();var baseObj={};if(isIE8){cue=document.createElement('custom');}else{baseObj.enumerable=true;}cue.hasBeenReset=false;var _id='';var _pauseOnExit=false;var _startTime=startTime;var _endTime=endTime;var _text=text;var _region=null;var _vertical='';var _snapToLines=true;var _line='auto';var _lineAlign='start';var _position=50;var _positionAlign='middle';var _size=50;var _align='middle';Object.defineProperty(cue,'id',extend({},baseObj,{get:function get(){return _id;},set:function set(value){_id=''+value;}}));Object.defineProperty(cue,'pauseOnExit',extend({},baseObj,{get:function get(){return _pauseOnExit;},set:function set(value){_pauseOnExit=!!value;}}));Object.defineProperty(cue,'startTime',extend({},baseObj,{get:function get(){return _startTime;},set:function set(value){if(typeof value!=='number'){throw new TypeError('Start time must be set to a number.');}_startTime=value;this.hasBeenReset=true;}}));Object.defineProperty(cue,'endTime',extend({},baseObj,{get:function get(){return _endTime;},set:function set(value){if(typeof value!=='number'){throw new TypeError('End time must be set to a number.');}_endTime=value;this.hasBeenReset=true;}}));Object.defineProperty(cue,'text',extend({},baseObj,{get:function get(){return _text;},set:function set(value){_text=''+value;this.hasBeenReset=true;}}));Object.defineProperty(cue,'region',extend({},baseObj,{get:function get(){return _region;},set:function set(value){_region=value;this.hasBeenReset=true;}}));Object.defineProperty(cue,'vertical',extend({},baseObj,{get:function get(){return _vertical;},set:function set(value){var setting=findDirectionSetting(value);if(setting===false){throw new SyntaxError('An invalid or illegal string was specified.');}_vertical=setting;this.hasBeenReset=true;}}));Object.defineProperty(cue,'snapToLines',extend({},baseObj,{get:function get(){return _snapToLines;},set:function set(value){_snapToLines=!!value;this.hasBeenReset=true;}}));Object.defineProperty(cue,'line',extend({},baseObj,{get:function get(){return _line;},set:function set(value){if(typeof value!=='number'&&value!==autoKeyword){throw new SyntaxError('An invalid number or illegal string was specified.');}_line=value;this.hasBeenReset=true;}}));Object.defineProperty(cue,'lineAlign',extend({},baseObj,{get:function get(){return _lineAlign;},set:function set(value){var setting=findAlignSetting(value);if(!setting){throw new SyntaxError('An invalid or illegal string was specified.');}_lineAlign=setting;this.hasBeenReset=true;}}));Object.defineProperty(cue,'position',extend({},baseObj,{get:function get(){return _position;},set:function set(value){if(value<0||value>100){throw new Error('Position must be between 0 and 100.');}_position=value;this.hasBeenReset=true;}}));Object.defineProperty(cue,'positionAlign',extend({},baseObj,{get:function get(){return _positionAlign;},set:function set(value){var setting=findAlignSetting(value);if(!setting){throw new SyntaxError('An invalid or illegal string was specified.');}_positionAlign=setting;this.hasBeenReset=true;}}));Object.defineProperty(cue,'size',extend({},baseObj,{get:function get(){return _size;},set:function set(value){if(value<0||value>100){throw new Error('Size must be between 0 and 100.');}_size=value;this.hasBeenReset=true;}}));Object.defineProperty(cue,'align',extend({},baseObj,{get:function get(){return _align;},set:function set(value){var setting=findAlignSetting(value);if(!setting){throw new SyntaxError('An invalid or illegal string was specified.');}_align=setting;this.hasBeenReset=true;}}));cue.displayState=undefined;if(isIE8){return cue;}}VTTCue.prototype.getCueAsHTML=function(){var WebVTT=window.WebVTT;return WebVTT.convertCueToDOMTree(window,this.text);};return VTTCue;}();},{}],57:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.fixLineBreaks=undefined;var _vttcue=_dereq_(56);var _vttcue2=_interopRequireDefault(_vttcue);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var StringDecoder=function StringDecoder(){return{decode:function decode(data){if(!data){return'';}if(typeof data!=='string'){throw new Error('Error - expected string data.');}return decodeURIComponent(encodeURIComponent(data));}};};function VTTParser(){this.window=window;this.state='INITIAL';this.buffer='';this.decoder=new StringDecoder();this.regionList=[];}function parseTimeStamp(input){function computeSeconds(h,m,s,f){return(h|0)*3600+(m|0)*60+(s|0)+(f|0)/1000;}var m=input.match(/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/);if(!m){return null;}if(m[3]){return computeSeconds(m[1],m[2],m[3].replace(':',''),m[4]);}else if(m[1]>59){return computeSeconds(m[1],m[2],0,m[4]);}else{return computeSeconds(0,m[1],m[2],m[4]);}}function Settings(){this.values=Object.create(null);}Settings.prototype={set:function set(k,v){if(!this.get(k)&&v!==''){this.values[k]=v;}},get:function get(k,dflt,defaultKey){if(defaultKey){return this.has(k)?this.values[k]:dflt[defaultKey];}return this.has(k)?this.values[k]:dflt;},has:function has(k){return k in this.values;},alt:function alt(k,v,a){for(var n=0;n<a.length;++n){if(v===a[n]){this.set(k,v);break;}}},integer:function integer(k,v){if(/^-?\d+$/.test(v)){this.set(k,parseInt(v,10));}},percent:function percent(k,v){var m;if(m=v.match(/^([\d]{1,3})(\.[\d]*)?%$/)){v=parseFloat(v);if(v>=0&&v<=100){this.set(k,v);return true;}}return false;}};function parseOptions(input,callback,keyValueDelim,groupDelim){var groups=groupDelim?input.split(groupDelim):[input];for(var i in groups){if(typeof groups[i]!=='string'){continue;}var kv=groups[i].split(keyValueDelim);if(kv.length!==2){continue;}var k=kv[0];var v=kv[1];callback(k,v);}}var defaults=new _vttcue2.default(0,0,0);var center=defaults.align==='middle'?'middle':'center';function parseCue(input,cue,regionList){var oInput=input;function consumeTimeStamp(){var ts=parseTimeStamp(input);if(ts===null){throw new Error('Malformed timestamp: '+oInput);}input=input.replace(/^[^\sa-zA-Z-]+/,'');return ts;}function consumeCueSettings(input,cue){var settings=new Settings();parseOptions(input,function(k,v){switch(k){case'region':for(var i=regionList.length-1;i>=0;i--){if(regionList[i].id===v){settings.set(k,regionList[i].region);break;}}break;case'vertical':settings.alt(k,v,['rl','lr']);break;case'line':var vals=v.split(','),vals0=vals[0];settings.integer(k,vals0);if(settings.percent(k,vals0)){settings.set('snapToLines',false);}settings.alt(k,vals0,['auto']);if(vals.length===2){settings.alt('lineAlign',vals[1],['start',center,'end']);}break;case'position':vals=v.split(',');settings.percent(k,vals[0]);if(vals.length===2){settings.alt('positionAlign',vals[1],['start',center,'end','line-left','line-right','auto']);}break;case'size':settings.percent(k,v);break;case'align':settings.alt(k,v,['start',center,'end','left','right']);break;}},/:/,/\s/);cue.region=settings.get('region',null);cue.vertical=settings.get('vertical','');var line=settings.get('line','auto');if(line==='auto'&&defaults.line===-1){line=-1;}cue.line=line;cue.lineAlign=settings.get('lineAlign','start');cue.snapToLines=settings.get('snapToLines',true);cue.size=settings.get('size',100);cue.align=settings.get('align',center);var position=settings.get('position','auto');if(position==='auto'&&defaults.position===50){position=cue.align==='start'||cue.align==='left'?0:cue.align==='end'||cue.align==='right'?100:50;}cue.position=position;}function skipWhitespace(){input=input.replace(/^\s+/,'');}skipWhitespace();cue.startTime=consumeTimeStamp();skipWhitespace();if(input.substr(0,3)!=='-->'){throw new Error('Malformed time stamp (time stamps must be separated by \'-->\'): '+oInput);}input=input.substr(3);skipWhitespace();cue.endTime=consumeTimeStamp();skipWhitespace();consumeCueSettings(input,cue);}function fixLineBreaks(input){return input.replace(/<br(?: \/)?>/gi,'\n');}VTTParser.prototype={parse:function parse(data){var self=this;if(data){self.buffer+=self.decoder.decode(data,{stream:true});}function collectNextLine(){var buffer=self.buffer;var pos=0;buffer=fixLineBreaks(buffer);while(pos<buffer.length&&buffer[pos]!=='\r'&&buffer[pos]!=='\n'){++pos;}var line=buffer.substr(0,pos);if(buffer[pos]==='\r'){++pos;}if(buffer[pos]==='\n'){++pos;}self.buffer=buffer.substr(pos);return line;}function parseHeader(input){parseOptions(input,function(k,v){switch(k){case'Region':console.log('parse region',v);break;}},/:/);}try{var line;if(self.state==='INITIAL'){if(!/\r\n|\n/.test(self.buffer)){return this;}line=collectNextLine();var m=line.match(/^WEBVTT([ \t].*)?$/);if(!m||!m[0]){throw new Error('Malformed WebVTT signature.');}self.state='HEADER';}var alreadyCollectedLine=false;while(self.buffer){if(!/\r\n|\n/.test(self.buffer)){return this;}if(!alreadyCollectedLine){line=collectNextLine();}else{alreadyCollectedLine=false;}switch(self.state){case'HEADER':if(/:/.test(line)){parseHeader(line);}else if(!line){self.state='ID';}continue;case'NOTE':if(!line){self.state='ID';}continue;case'ID':if(/^NOTE($|[ \t])/.test(line)){self.state='NOTE';break;}if(!line){continue;}self.cue=new _vttcue2.default(0,0,'');self.state='CUE';if(line.indexOf('-->')===-1){self.cue.id=line;continue;}case'CUE':try{parseCue(line,self.cue,self.regionList);}catch(e){self.cue=null;self.state='BADCUE';continue;}self.state='CUETEXT';continue;case'CUETEXT':var hasSubstring=line.indexOf('-->')!==-1;if(!line||hasSubstring&&(alreadyCollectedLine=true)){if(self.oncue){self.oncue(self.cue);}self.cue=null;self.state='ID';continue;}if(self.cue.text){self.cue.text+='\n';}self.cue.text+=line;continue;case'BADCUE':if(!line){self.state='ID';}continue;}}}catch(e){if(self.state==='CUETEXT'&&self.cue&&self.oncue){self.oncue(self.cue);}self.cue=null;self.state=self.state==='INITIAL'?'BADWEBVTT':'BADCUE';}return this;},flush:function flush(){var self=this;try{self.buffer+=self.decoder.decode();if(self.cue||self.state==='HEADER'){self.buffer+='\n\n';self.parse();}if(self.state==='INITIAL'){throw new Error('Malformed WebVTT signature.');}}catch(e){throw e;}if(self.onflush){self.onflush();}return this;}};exports.fixLineBreaks=fixLineBreaks;exports.default=VTTParser;},{"56":56}],58:[function(_dereq_,module,exports){'use strict';var _vttparser=_dereq_(57);var _vttparser2=_interopRequireDefault(_vttparser);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var startsWith=function startsWith(inputString,searchString,position){return inputString.substr(position||0,searchString.length)===searchString;};var cueString2millis=function cueString2millis(timeString){var ts=parseInt(timeString.substr(-3));var secs=parseInt(timeString.substr(-6,2));var mins=parseInt(timeString.substr(-9,2));var hours=timeString.length>9?parseInt(timeString.substr(0,timeString.indexOf(':'))):0;if(isNaN(ts)||isNaN(secs)||isNaN(mins)||isNaN(hours)){return-1;}ts+=1000*secs;ts+=60*1000*mins;ts+=60*60*1000*hours;return ts;};var hash=function hash(text){var hash=5381;var i=text.length;while(i){hash=hash*33^text.charCodeAt(--i);}return(hash>>>0).toString();};var calculateOffset=function calculateOffset(vttCCs,cc,presentationTime){var currCC=vttCCs[cc];var prevCC=vttCCs[currCC.prevCC];if(!prevCC||!prevCC.new&&currCC.new){vttCCs.ccOffset=vttCCs.presentationOffset=currCC.start;currCC.new=false;return;}while(prevCC&&prevCC.new){vttCCs.ccOffset+=currCC.start-prevCC.start;currCC.new=false;currCC=prevCC;prevCC=vttCCs[currCC.prevCC];}vttCCs.presentationOffset=presentationTime;};var WebVTTParser={parse:function parse(vttByteArray,syncPTS,vttCCs,cc,callBack,errorCallBack){var re=/\r\n|\n\r|\n|\r/g;var vttLines=String.fromCharCode.apply(null,new Uint8Array(vttByteArray)).trim().replace(re,'\n').split('\n');var cueTime='00:00.000';var mpegTs=0;var localTime=0;var presentationTime=0;var cues=[];var parsingError=void 0;var inHeader=true;var parser=new _vttparser2.default();parser.oncue=function(cue){var currCC=vttCCs[cc];var cueOffset=vttCCs.ccOffset;if(currCC&&currCC.new){if(localTime!==undefined){cueOffset=vttCCs.ccOffset=currCC.start;}else{calculateOffset(vttCCs,cc,presentationTime);}}if(presentationTime){cueOffset=presentationTime+vttCCs.ccOffset-vttCCs.presentationOffset;}cue.startTime+=cueOffset-localTime;cue.endTime+=cueOffset-localTime;cue.id=hash(cue.startTime)+hash(cue.endTime)+hash(cue.text);cue.text=decodeURIComponent(escape(cue.text));if(cue.endTime>0){cues.push(cue);}};parser.onparsingerror=function(e){parsingError=e;};parser.onflush=function(){if(parsingError&&errorCallBack){errorCallBack(parsingError);return;}callBack(cues);};vttLines.forEach(function(line){if(inHeader){if(startsWith(line,'X-TIMESTAMP-MAP=')){inHeader=false;line.substr(16).split(',').forEach(function(timestamp){if(startsWith(timestamp,'LOCAL:')){cueTime=timestamp.substr(6);}else if(startsWith(timestamp,'MPEGTS:')){mpegTs=parseInt(timestamp.substr(7));}});try{syncPTS=syncPTS<0?syncPTS+8589934592:syncPTS;mpegTs-=syncPTS;localTime=cueString2millis(cueTime)/1000;presentationTime=mpegTs/90000;if(localTime===-1){parsingError=new Error('Malformed X-TIMESTAMP-MAP: '+line);}}catch(e){parsingError=new Error('Malformed X-TIMESTAMP-MAP: '+line);}return;}else if(line===''){inHeader=false;}}parser.parse(line+'\n');});parser.flush();}};module.exports=WebVTTParser;},{"57":57}],59:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass$$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _logger=_dereq_(54);function _classCallCheck$$1(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var XhrLoader=function(){function XhrLoader(config){_classCallCheck$$1(this,XhrLoader);if(config&&config.xhrSetup){this.xhrSetup=config.xhrSetup;}}_createClass$$1(XhrLoader,[{key:'destroy',value:function destroy(){this.abort();this.loader=null;}},{key:'abort',value:function abort(){var loader=this.loader;if(loader&&loader.readyState!==4){this.stats.aborted=true;loader.abort();}window.clearTimeout(this.requestTimeout);this.requestTimeout=null;window.clearTimeout(this.retryTimeout);this.retryTimeout=null;}},{key:'load',value:function load(context,config,callbacks){this.context=context;this.config=config;this.callbacks=callbacks;this.stats={trequest:performance.now(),retry:0};this.retryDelay=config.retryDelay;this.loadInternal();}},{key:'loadInternal',value:function loadInternal(){var xhr,context=this.context;if(typeof XDomainRequest!=='undefined'){xhr=this.loader=new XDomainRequest();}else{xhr=this.loader=new XMLHttpRequest();}var stats=this.stats;stats.tfirst=0;stats.loaded=0;var xhrSetup=this.xhrSetup;try{if(xhrSetup){try{xhrSetup(xhr,context.url);}catch(e){xhr.open('GET',context.url,true);xhrSetup(xhr,context.url);}}if(!xhr.readyState){xhr.open('GET',context.url,true);}}catch(e){this.callbacks.onError({code:xhr.status,text:e.message},context,xhr);return;}if(context.rangeEnd){xhr.setRequestHeader('Range','bytes='+context.rangeStart+'-'+(context.rangeEnd-1));}xhr.onreadystatechange=this.readystatechange.bind(this);xhr.onprogress=this.loadprogress.bind(this);xhr.responseType=context.responseType;this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),this.config.timeout);xhr.send();}},{key:'readystatechange',value:function readystatechange(event){var xhr=event.currentTarget,readyState=xhr.readyState,stats=this.stats,context=this.context,config=this.config;if(stats.aborted){return;}if(readyState>=2){window.clearTimeout(this.requestTimeout);if(stats.tfirst===0){stats.tfirst=Math.max(performance.now(),stats.trequest);}if(readyState===4){var status=xhr.status;if(status>=200&&status<300){stats.tload=Math.max(stats.tfirst,performance.now());var data=void 0,len=void 0;if(context.responseType==='arraybuffer'){data=xhr.response;len=data.byteLength;}else{data=xhr.responseText;len=data.length;}stats.loaded=stats.total=len;var response={url:xhr.responseURL,data:data};this.callbacks.onSuccess(response,stats,context,xhr);}else{if(stats.retry>=config.maxRetry||status>=400&&status<499){_logger.logger.error(status+' while loading '+context.url);this.callbacks.onError({code:status,text:xhr.statusText},context,xhr);}else{_logger.logger.warn(status+' while loading '+context.url+', retrying in '+this.retryDelay+'...');this.destroy();this.retryTimeout=window.setTimeout(this.loadInternal.bind(this),this.retryDelay);this.retryDelay=Math.min(2*this.retryDelay,config.maxRetryDelay);stats.retry++;}}}else{this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),config.timeout);}}}},{key:'loadtimeout',value:function loadtimeout(){_logger.logger.warn('timeout while loading '+this.context.url);this.callbacks.onTimeout(this.stats,this.context,null);}},{key:'loadprogress',value:function loadprogress(event){var xhr=event.currentTarget,stats=this.stats;stats.loaded=event.loaded;if(event.lengthComputable){stats.total=event.total;}var onProgress=this.callbacks.onProgress;if(onProgress){onProgress(stats,this.context,null,xhr);}}}]);return XhrLoader;}();exports.default=XhrLoader;},{"54":54}]},{},[40])(40);});});var HlsCore=unwrapExports$1(hls);var defaultConfig$2={type:'vod',autoPlay:false,box:'hls',lockInternalProperty:false,debug:true,enableWorker:true};var Hls=function(_CustEvent){_inherits(Hls,_CustEvent);function Hls(videodom,config){_classCallCheck(this,Hls);var _this2=_possibleConstructorReturn(this,(Hls.__proto__||_Object$getPrototypeOf(Hls)).call(this));_this2.tag='HLS-player';_this2.video=videodom;_this2.box='hls';_this2.config=defaultConfig$2;deepAssign(_this2.config,config);_this2.hls=new HlsCore();_this2.bindEvents(_this2.hls);_this2.attachMedia();return _this2;}_createClass(Hls,[{key:'internalPropertyHandle',value:function internalPropertyHandle(){if(!_Object$getOwnPropertyDescriptor){return;}var _this=this;var time=_Object$getOwnPropertyDescriptor(HTMLMediaElement.prototype,'currentTime');Object.defineProperty(this.video,'currentTime',{get:function get(){return time.get.call(_this.video);},set:function set(t){if(!_this.currentTimeLock){throw new Error('can not set currentTime by youself');}else{return time.set.call(_this.video,t);}}});}},{key:'bindEvents',value:function bindEvents(hlsKernel){var _this3=this;if(hlsKernel){hlsKernel.on(HlsCore.Events.ERROR,function(event,data){});hlsKernel.on(HlsCore.Events.LEVEL,function(event,data){});}if(this.video&&this.config.lockInternalProperty){this.video.addEventListener('canplay',function(){_this3.internalPropertyHandle();});}}},{key:'load',value:function load(){this.hls.loadSource(this.config.src);}},{key:'attachMedia',value:function attachMedia(){this.hls.attachMedia(this.video);}},{key:'play',value:function play(){return this.video.play();}},{key:'destroy',value:function destroy(){return this.hls.destroy();}},{key:'seek',value:function seek(seconds){this.currentTimeLock=true;this._seek(seconds);this.currentTimeLock=false;}},{key:'_seek',value:function _seek(seconds){this.video.currentTime=seconds;}},{key:'pause',value:function pause(){return this.video.pause();}}]);return Hls;}(CustEvent);var Kernel=function(_CustEvent){_inherits(Kernel,_CustEvent);function Kernel(videoElement,config){_classCallCheck(this,Kernel);var _this=_possibleConstructorReturn(this,(Kernel.__proto__||_Object$getPrototypeOf(Kernel)).call(this));_this.tag='kernel';_this.config=config;_this.video=videoElement;_this.videokernel=_this.selectKernel();_this.bindEvents(_this.videokernel);return _this;}_createClass(Kernel,[{key:'bindEvents',value:function bindEvents(videokernel){var _this2=this;if(videokernel){videokernel.on('mediaInfo',function(mediaInfo){_this2.emit('mediaInfo',mediaInfo);});}}},{key:'selectKernel',value:function selectKernel(){var config=this.config;var box=config.box?config.box:config.src.indexOf('.flv')!==-1?'flv':config.src.indexOf('.m3u8')!==-1?'hls':'mp4';if(box==='mp4'){return new Mp4(this.video,config);}else if(box==='flv'){return new Flv(this.video,config);}else if(box==='hls'){console.log(config);return new Hls(this.video,config);}else{Log.error(this.tag,'not mactch any player, please check your config');return null;}}},{key:'attachMedia',value:function attachMedia(){if(this.videokernel){this.videokernel.attachMedia();}else{Log.error(this.tag,'video player is not already, must init player');}}},{key:'load',value:function load(src){this.config.src=src||this.config.src;if(this.videokernel&&this.config.src){this.videokernel.load(src);}else{Log.error(this.tag,'video player is not already, must init player');}}},{key:'destroy',value:function destroy(){if(this.videokernel){this.videokernel.destroy();}else{Log.error(this.tag,'player is not exit');}}},{key:'play',value:function play(){if(this.videokernel){this.videokernel.play();}else{Log.error(this.tag,'video player is not already, must init player');}}},{key:'pause',value:function pause(){if(this.videokernel&&this.config.src){this.videokernel.pause();}else{Log.error(this.tag,'video player is not already, must init player');}}},{key:'seek',value:function seek(seconds){if(!isNumber(seconds)){Log.error(this.tag,'seek params must be a number');return;}return this.videokernel.seek(seconds);}},{key:'currentTime',get:function get(){if(this.videokernel){return this.video.currentTime;}return 0;}},{key:'duration',get:function get(){return this.video.duration;}},{key:'volume',get:function get(){return this.video.volume;},set:function set(value){this.video.volume=value;}},{key:'muted',get:function get(){return this.video.muted;},set:function set(muted){this.video.muted=muted;}},{key:'buffered',get:function get(){return this.video.buffered;}}]);return Kernel;}(CustEvent);var dP$2=_objectDp.f;var fastKey=_meta.fastKey;var SIZE=_descriptors?'_s':'size';var getEntry=function getEntry(that,key){var index=fastKey(key),entry;if(index!=='F')return that._i[index];for(entry=that._f;entry;entry=entry.n){if(entry.k==key)return entry;}};var _collectionStrong={getConstructor:function getConstructor(wrapper,NAME,IS_MAP,ADDER){var C=wrapper(function(that,iterable){_anInstance(that,C,NAME,'_i');that._i=_objectCreate(null);that._f=undefined;that._l=undefined;that[SIZE]=0;if(iterable!=undefined)_forOf(iterable,IS_MAP,that[ADDER],that);});_redefineAll(C.prototype,{clear:function clear(){for(var that=this,data=that._i,entry=that._f;entry;entry=entry.n){entry.r=true;if(entry.p)entry.p=entry.p.n=undefined;delete data[entry.i];}that._f=that._l=undefined;that[SIZE]=0;},'delete':function _delete(key){var that=this,entry=getEntry(that,key);if(entry){var next=entry.n,prev=entry.p;delete that._i[entry.i];entry.r=true;if(prev)prev.n=next;if(next)next.p=prev;if(that._f==entry)that._f=next;if(that._l==entry)that._l=prev;that[SIZE]--;}return!!entry;},forEach:function forEach(callbackfn){_anInstance(this,C,'forEach');var f=_ctx(callbackfn,arguments.length>1?arguments[1]:undefined,3),entry;while(entry=entry?entry.n:this._f){f(entry.v,entry.k,this);while(entry&&entry.r){entry=entry.p;}}},has:function has(key){return!!getEntry(this,key);}});if(_descriptors)dP$2(C.prototype,'size',{get:function get(){return _defined(this[SIZE]);}});return C;},def:function def(that,key,value){var entry=getEntry(that,key),prev,index;if(entry){entry.v=value;}else{that._l=entry={i:index=fastKey(key,true),k:key,v:value,p:prev=that._l,n:undefined,r:false};if(!that._f)that._f=entry;if(prev)prev.n=entry;that[SIZE]++;if(index!=='F')that._i[index]=entry;}return that;},getEntry:getEntry,setStrong:function setStrong(C,NAME,IS_MAP){_iterDefine(C,NAME,function(iterated,kind){this._t=iterated;this._k=kind;this._l=undefined;},function(){var that=this,kind=that._k,entry=that._l;while(entry&&entry.r){entry=entry.p;}if(!that._t||!(that._l=entry=entry?entry.n:that._t._f)){that._t=undefined;return _iterStep(1);}if(kind=='keys')return _iterStep(0,entry.k);if(kind=='values')return _iterStep(0,entry.v);return _iterStep(0,[entry.k,entry.v]);},IS_MAP?'entries':'values',!IS_MAP,true);_setSpecies(NAME);}};var SPECIES$2=_wks('species');var _arraySpeciesConstructor=function _arraySpeciesConstructor(original){var C;if(_isArray(original)){C=original.constructor;if(typeof C=='function'&&(C===Array||_isArray(C.prototype)))C=undefined;if(_isObject(C)){C=C[SPECIES$2];if(C===null)C=undefined;}}return C===undefined?Array:C;};var _arraySpeciesCreate=function _arraySpeciesCreate(original,length){return new(_arraySpeciesConstructor(original))(length);};var _arrayMethods=function _arrayMethods(TYPE,$create){var IS_MAP=TYPE==1,IS_FILTER=TYPE==2,IS_SOME=TYPE==3,IS_EVERY=TYPE==4,IS_FIND_INDEX=TYPE==6,NO_HOLES=TYPE==5||IS_FIND_INDEX,create=$create||_arraySpeciesCreate;return function($this,callbackfn,that){var O=_toObject($this),self=_iobject(O),f=_ctx(callbackfn,that,3),length=_toLength(self.length),index=0,result=IS_MAP?create($this,length):IS_FILTER?create($this,0):undefined,val,res;for(;length>index;index++){if(NO_HOLES||index in self){val=self[index];res=f(val,index,O);if(TYPE){if(IS_MAP)result[index]=res;else if(res)switch(TYPE){case 3:return true;case 5:return val;case 6:return index;case 2:result.push(val);}else if(IS_EVERY)return false;}}}return IS_FIND_INDEX?-1:IS_SOME||IS_EVERY?IS_EVERY:result;};};var dP$3=_objectDp.f;var each=_arrayMethods(0);var _collection=function _collection(NAME,wrapper,methods,common,IS_MAP,IS_WEAK){var Base=_global[NAME],C=Base,ADDER=IS_MAP?'set':'add',proto=C&&C.prototype,O={};if(!_descriptors||typeof C!='function'||!(IS_WEAK||proto.forEach&&!_fails(function(){new C().entries().next();}))){C=common.getConstructor(wrapper,NAME,IS_MAP,ADDER);_redefineAll(C.prototype,methods);_meta.NEED=true;}else{C=wrapper(function(target,iterable){_anInstance(target,C,NAME,'_c');target._c=new Base();if(iterable!=undefined)_forOf(iterable,IS_MAP,target[ADDER],target);});each('add,clear,delete,forEach,get,has,set,keys,values,entries,toJSON'.split(','),function(KEY){var IS_ADDER=KEY=='add'||KEY=='set';if(KEY in proto&&!(IS_WEAK&&KEY=='clear'))_hide(C.prototype,KEY,function(a,b){_anInstance(this,C,KEY);if(!IS_ADDER&&IS_WEAK&&!_isObject(a))return KEY=='get'?undefined:false;var result=this._c[KEY](a===0?0:a,b);return IS_ADDER?this:result;});});if('size'in proto)dP$3(C.prototype,'size',{get:function get(){return this._c.size;}});}_setToStringTag(C,NAME);O[NAME]=C;_export(_export.G+_export.W+_export.F,O);if(!IS_WEAK)common.setStrong(C,NAME,IS_MAP);return C;};var es6_map=_collection('Map',function(get){return function Map(){return get(this,arguments.length>0?arguments[0]:undefined);};},{get:function get(key){var entry=_collectionStrong.getEntry(this,key);return entry&&entry.v;},set:function set(key,value){return _collectionStrong.def(this,key===0?0:key,value);}},_collectionStrong,true);var _arrayFromIterable=function _arrayFromIterable(iter,ITERATOR){var result=[];_forOf(iter,false,result.push,result,ITERATOR);return result;};var _collectionToJson=function _collectionToJson(NAME){return function toJSON(){if(_classof(this)!=NAME)throw TypeError(NAME+"#toJSON isn't generic");return _arrayFromIterable(this);};};_export(_export.P+_export.R,'Map',{toJSON:_collectionToJson('Map')});var map$1=_core.Map;var map=createCommonjsModule(function(module){module.exports={"default":map$1,__esModule:true};});var _Map=unwrapExports(map);var videoEvents=['abort','canplay','canplaythrough','durationchange','emptied','encrypted','ended','error','interruptbegin','interruptend','loadeddata','loadedmetadata','loadstart','mozaudioavailable','pause','play','playing','progress','ratechange','seeked','seeking','stalled','suspend','timeupdate','volumechange','waiting'];var videoReadOnlyProperties=['buffered','currentSrc','duration','ended','networkState','paused','readyState','seekable','sinkId','controlsList'];var domEvents=['beforeinput','blur','click','compositionend','compositionstart','compositionupdate','dblclick','focus','focusin','focusout','input','keydown','keypress','keyup','mousedown','mouseenter','mouseleave','mousemove','mouseout','mouseover','mouseup','resize','scroll','select','wheel','fullscreenchange','webkitfullscreenchange','mozfullscreenchange','msfullscreenchange','contextmenu'];var kernelMethods=['play','pause','load','seek'];var domMethods=['focus','fullScreen','requestFullScreen','exitFullScreen'];var videoMethods=['canPlayType','captureStream','setSinkId'];var secondaryReg=/^(before|after|_)/;var Bus=function(){function Bus(dispatcher){_classCallCheck(this,Bus);this.events={};this.onceMap={};this.__dispatcher=dispatcher;}_createClass(Bus,[{key:'on',value:function on(id,key,fn){var _getEventStage2=this._getEventStage(key),stage=_getEventStage2.stage,eventName=_getEventStage2.key;this._addEvent([eventName,stage,id],fn);}},{key:'off',value:function off(id,key,fn){var _getEventStage3=this._getEventStage(key),stage=_getEventStage3.stage,eventName=_getEventStage3.key;var keys=[eventName,stage,id];var deleted=this._removeEvent(keys,fn);if(deleted)return;var handler=this._getHandlerFromOnceMap(keys,fn);if(isFunction(handler)){this._removeEvent(keys,handler)&&this._removeFromOnceMap(keys,fn,handler);}}},{key:'once',value:function once(id,key,fn){var _getEventStage4=this._getEventStage(key),stage=_getEventStage4.stage,eventName=_getEventStage4.key;var bus=this;var keys=[eventName,stage,id];var handler=function handler(){bind(fn,this).apply(undefined,arguments);bus._removeEvent(keys,handler);bus._removeFromOnceMap(keys,fn,handler);};this._addEvent(keys,handler);this._addToOnceMap(keys,fn,handler);}},{key:'emit',value:function emit(key){var _this=this;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}if(key.match(secondaryReg)){Log.warn('bus','Secondary Event could not be emit');return;}var event=this.events[key];if(isEmpty(event)){return this._eventProcessor.apply(this,[key,{sync:false}].concat(_toConsumableArray(args)));}var beforeQueue=this._getEventQueue(event.before,this.__dispatcher.order);return runRejectableQueue.apply(undefined,[beforeQueue].concat(_toConsumableArray(args))).then(function(){return _this._eventProcessor.apply(_this,[key,{sync:false}].concat(_toConsumableArray(args)));}).catch(function(error){if(isError(error))_this.__dispatcher.throwError(error);return _Promise.reject(error);});}},{key:'emitSync',value:function emitSync(key){if(key.match(secondaryReg)){Log.warn('bus','Secondary Event could not be emit');return false;}var event=this.events[key];for(var _len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2];}if(isEmpty(event)){return this._eventProcessor.apply(this,[key,{sync:true}].concat(_toConsumableArray(args)));}var beforeQueue=this._getEventQueue(event.before,this.__dispatcher.order);return runStoppableQueue.apply(undefined,[beforeQueue].concat(_toConsumableArray(args)))&&this._eventProcessor.apply(this,[key,{sync:true}].concat(_toConsumableArray(args)));}},{key:'trigger',value:function trigger(key){var _this2=this;for(var _len3=arguments.length,args=Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++){args[_key3-1]=arguments[_key3];}if(key.match(secondaryReg)){Log.warn('bus','Secondary Event could not be emit');return;}var event=this.events[key];if(isEmpty(event)){return _Promise.resolve(true);}var mainQueue=this._getEventQueue(event.main,this.__dispatcher.order);return runRejectableQueue.apply(undefined,[mainQueue].concat(_toConsumableArray(args))).then(function(){var afterQueue=_this2._getEventQueue(event.after,_this2.__dispatcher.order);return runRejectableQueue.apply(undefined,[afterQueue].concat(_toConsumableArray(args)));}).then(function(){return _this2._runSideEffectEvent.apply(_this2,[key,_this2.__dispatcher.order].concat(_toConsumableArray(args)));}).catch(function(error){if(isError(error))_this2.__dispatcher.throwError(error);return _this2._runSideEffectEvent.apply(_this2,[key,_this2.__dispatcher.order].concat(_toConsumableArray(args)));});}},{key:'triggerSync',value:function triggerSync(key){if(key.match(secondaryReg)){Log.warn('bus','Secondary Event could not be emit');return false;}var event=this.events[key];if(isEmpty(event)){return true;}var mainQueue=this._getEventQueue(event.main,this.__dispatcher.order);var afterQueue=this._getEventQueue(event.after,this.__dispatcher.order);for(var _len4=arguments.length,args=Array(_len4>1?_len4-1:0),_key4=1;_key4<_len4;_key4++){args[_key4-1]=arguments[_key4];}var result=runStoppableQueue.apply(undefined,[mainQueue].concat(_toConsumableArray(args)))&&runStoppableQueue.apply(undefined,[afterQueue].concat(_toConsumableArray(args)));this._runSideEffectEvent.apply(this,[key,this.__dispatcher.order].concat(_toConsumableArray(args)));return result;}},{key:'destroy',value:function destroy(){delete this.events;delete this.__dispatcher;}},{key:'_addEvent',value:function _addEvent(keys,fn){keys=deepClone(keys);var id=keys.pop();var target=keys.reduce(function(target,key){target[key]=target[key]||{};return target[key];},this.events);target[id]=target[id]||[];target[id].push(fn);}},{key:'_removeEvent',value:function _removeEvent(keys,fn){keys=deepClone(keys);var id=keys.pop();var target=this.events;for(var i=0,len=keys.length;i<len;i++){var son=target[keys[i]];if(isEmpty(son))return;target=son;}var queue=target[id]||[];var index=queue.indexOf(fn);var hasFn=index>-1;if(hasFn){queue.splice(index,1);}if(queue.length<1){delete target[id];}return hasFn;}},{key:'_addToOnceMap',value:function _addToOnceMap(keys,fn,handler){var key=keys.join('-');var map$$1=this.onceMap[key]=this.onceMap[key]||new _Map();if(!map$$1.has(fn))map$$1.set(fn,[]);var handlers=map$$1.get(fn);handlers.push(handler);}},{key:'_removeFromOnceMap',value:function _removeFromOnceMap(keys,fn,handler){var key=keys.join('-');var map$$1=this.onceMap[key];var handlers=map$$1.get(fn);var index=handlers.indexOf(handler);handlers.splice(index,1);if(isEmpty(handlers))map$$1.delete(fn);}},{key:'_getHandlerFromOnceMap',value:function _getHandlerFromOnceMap(keys,fn){var key=keys.join('-');var map$$1=this.onceMap[key];if(isVoid(map$$1)||!map$$1.has(fn))return;var handlers=map$$1.get(fn);return handlers[0];}},{key:'_getEventStage',value:function _getEventStage(key){var secondaryCheck=key.match(secondaryReg);var stage=secondaryCheck&&secondaryCheck[0]||'main';if(secondaryCheck){key=camelize(key.replace(secondaryReg,''));}return{stage:stage,key:key};}},{key:'_getEventQueue',value:function _getEventQueue(handlerSet,order){var _this3=this;order=isArray$1(order)?order.concat(['_vm']):['_vm'];return isEmpty(handlerSet)?[]:order.reduce(function(queue,id){if(isEmpty(handlerSet[id])||!isArray$1(handlerSet[id])||!_this3.__dispatcher.plugins[id]&&id!=='_vm'){return queue;}return queue.concat(handlerSet[id].map(function(fn){return bind(fn,_this3.__dispatcher.plugins[id]||_this3.__dispatcher.vm);}));},[]);}},{key:'_eventProcessor',value:function _eventProcessor(key,_ref){var sync=_ref.sync;var isKernelMethod=kernelMethods.indexOf(key)>-1;var isDomMethod=domMethods.indexOf(key)>-1;for(var _len5=arguments.length,args=Array(_len5>2?_len5-2:0),_key5=2;_key5<_len5;_key5++){args[_key5-2]=arguments[_key5];}if(isKernelMethod||isDomMethod){var _dispatcher;(_dispatcher=this.__dispatcher[isKernelMethod?'kernel':'dom'])[key].apply(_dispatcher,_toConsumableArray(args));if(videoEvents.indexOf(key)>-1||domEvents.indexOf(key)>-1)return true;}return this[sync?'triggerSync':'trigger'].apply(this,[key].concat(_toConsumableArray(args)));}},{key:'_runSideEffectEvent',value:function _runSideEffectEvent(key,order){for(var _len6=arguments.length,args=Array(_len6>2?_len6-2:0),_key6=2;_key6<_len6;_key6++){args[_key6-2]=arguments[_key6];}var event=this.events[key];if(isEmpty(event)){return;}var queue=this._getEventQueue(event['_'],order);queue.forEach(function(run){return run.apply(undefined,_toConsumableArray(args));});return true;}}]);return Bus;}();var Reflect=_global.Reflect;var _ownKeys=Reflect&&Reflect.ownKeys||function ownKeys(it){var keys=_objectGopn.f(_anObject(it)),getSymbols=_objectGops.f;return getSymbols?keys.concat(getSymbols(it)):keys;};_export(_export.S,'Object',{getOwnPropertyDescriptors:function getOwnPropertyDescriptors(object){var O=_toIobject(object),getDesc=_objectGopd.f,keys=_ownKeys(O),result={},i=0,key;while(keys.length>i){_createProperty(result,key=keys[i++],getDesc(O,key));}return result;}});var getOwnPropertyDescriptors$2=_core.Object.getOwnPropertyDescriptors;var getOwnPropertyDescriptors$1=createCommonjsModule(function(module){module.exports={"default":getOwnPropertyDescriptors$2,__esModule:true};});var _Object$getOwnPropertyDescriptors=unwrapExports(getOwnPropertyDescriptors$1);var getOwnPropertySymbols$1=_core.Object.getOwnPropertySymbols;var getOwnPropertySymbols=createCommonjsModule(function(module){module.exports={"default":getOwnPropertySymbols$1,__esModule:true};});var _Object$getOwnPropertySymbols=unwrapExports(getOwnPropertySymbols);_objectSap('getOwnPropertyNames',function(){return _objectGopnExt.f;});var $Object$3=_core.Object;var getOwnPropertyNames$1=function getOwnPropertyNames(it){return $Object$3.getOwnPropertyNames(it);};var getOwnPropertyNames=createCommonjsModule(function(module){module.exports={"default":getOwnPropertyNames$1,__esModule:true};});var _Object$getOwnPropertyNames=unwrapExports(getOwnPropertyNames);var ITERATOR$4=_wks('iterator');var core_isIterable=_core.isIterable=function(it){var O=Object(it);return O[ITERATOR$4]!==undefined||'@@iterator'in O||_iterators.hasOwnProperty(_classof(O));};var isIterable$2=core_isIterable;var isIterable=createCommonjsModule(function(module){module.exports={"default":isIterable$2,__esModule:true};});var core_getIterator=_core.getIterator=function(it){var iterFn=core_getIteratorMethod(it);if(typeof iterFn!='function')throw TypeError(it+' is not iterable!');return _anObject(iterFn.call(it));};var getIterator$2=core_getIterator;var getIterator=createCommonjsModule(function(module){module.exports={"default":getIterator$2,__esModule:true};});var slicedToArray=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;var _isIterable3=_interopRequireDefault(isIterable);var _getIterator3=_interopRequireDefault(getIterator);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=(0,_getIterator3.default)(arr),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if((0,_isIterable3.default)(Object(arr))){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();});var _slicedToArray=unwrapExports(slicedToArray);var getWeak=_meta.getWeak;var arrayFind=_arrayMethods(5);var arrayFindIndex=_arrayMethods(6);var id$1=0;var uncaughtFrozenStore=function uncaughtFrozenStore(that){return that._l||(that._l=new UncaughtFrozenStore());};var UncaughtFrozenStore=function UncaughtFrozenStore(){this.a=[];};var findUncaughtFrozen=function findUncaughtFrozen(store,key){return arrayFind(store.a,function(it){return it[0]===key;});};UncaughtFrozenStore.prototype={get:function get(key){var entry=findUncaughtFrozen(this,key);if(entry)return entry[1];},has:function has(key){return!!findUncaughtFrozen(this,key);},set:function set(key,value){var entry=findUncaughtFrozen(this,key);if(entry)entry[1]=value;else this.a.push([key,value]);},'delete':function _delete(key){var index=arrayFindIndex(this.a,function(it){return it[0]===key;});if(~index)this.a.splice(index,1);return!!~index;}};var _collectionWeak={getConstructor:function getConstructor(wrapper,NAME,IS_MAP,ADDER){var C=wrapper(function(that,iterable){_anInstance(that,C,NAME,'_i');that._i=id$1++;that._l=undefined;if(iterable!=undefined)_forOf(iterable,IS_MAP,that[ADDER],that);});_redefineAll(C.prototype,{'delete':function _delete(key){if(!_isObject(key))return false;var data=getWeak(key);if(data===true)return uncaughtFrozenStore(this)['delete'](key);return data&&_has(data,this._i)&&delete data[this._i];},has:function has(key){if(!_isObject(key))return false;var data=getWeak(key);if(data===true)return uncaughtFrozenStore(this).has(key);return data&&_has(data,this._i);}});return C;},def:function def(that,key,value){var data=getWeak(_anObject(key),true);if(data===true)uncaughtFrozenStore(that).set(key,value);else data[that._i]=value;return that;},ufstore:uncaughtFrozenStore};var es6_weakMap=createCommonjsModule(function(module){'use strict';var each=_arrayMethods(0),getWeak=_meta.getWeak,isExtensible=Object.isExtensible,uncaughtFrozenStore=_collectionWeak.ufstore,tmp={},InternalMap;var wrapper=function wrapper(get){return function WeakMap(){return get(this,arguments.length>0?arguments[0]:undefined);};};var methods={get:function get(key){if(_isObject(key)){var data=getWeak(key);if(data===true)return uncaughtFrozenStore(this).get(key);return data?data[this._i]:undefined;}},set:function set(key,value){return _collectionWeak.def(this,key,value);}};var $WeakMap=module.exports=_collection('WeakMap',wrapper,methods,_collectionWeak,true,true);if(new $WeakMap().set((Object.freeze||Object)(tmp),7).get(tmp)!=7){InternalMap=_collectionWeak.getConstructor(wrapper);_objectAssign(InternalMap.prototype,methods);_meta.NEED=true;each(['delete','has','get','set'],function(key){var proto=$WeakMap.prototype,method=proto[key];_redefine(proto,key,function(a,b){if(_isObject(a)&&!isExtensible(a)){if(!this._f)this._f=new InternalMap();var result=this._f[key](a,b);return key=='set'?this:result;}return method.call(this,a,b);});});}});var weakMap$1=_core.WeakMap;var weakMap=createCommonjsModule(function(module){module.exports={"default":weakMap$1,__esModule:true};});var _WeakMap=unwrapExports(weakMap);var defineProperty$5$1=createCommonjsModule(function(module,exports){"use strict";exports.__esModule=true;var _defineProperty2=_interopRequireDefault(defineProperty);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(obj,key,value){if(key in obj){(0,_defineProperty2.default)(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;};});var _defineProperty$1=unwrapExports(defineProperty$5$1);var meta=_meta.onFreeze;_objectSap('preventExtensions',function($preventExtensions){return function preventExtensions(it){return $preventExtensions&&_isObject(it)?$preventExtensions(meta(it)):it;};});var preventExtensions$2=_core.Object.preventExtensions;var preventExtensions$1=createCommonjsModule(function(module){module.exports={"default":preventExtensions$2,__esModule:true};});var _Object$preventExtensions=unwrapExports(preventExtensions$1);var getOwnPropertyDescriptor$3=_Object$getOwnPropertyDescriptor;function isDescriptor(desc){if(!desc||!desc.hasOwnProperty){return false;}var keys$$1=['value','initializer','get','set'];for(var i=0,l=keys$$1.length;i<l;i++){if(desc.hasOwnProperty(keys$$1[i])){return true;}}return false;}function isAccessorDescriptor(desc){return!!desc&&(isFunction(desc.get)||isFunction(desc.set))&&isBoolean(desc.configurable)&&isBoolean(desc.enumerable)&&desc.writable===undefined;}function isDataDescriptor(desc){return!!desc&&desc.hasOwnProperty('value')&&isBoolean(desc.configurable)&&isBoolean(desc.enumerable)&&isBoolean(desc.writable);}function isInitializerDescriptor(desc){return!!desc&&isFunction(desc.initializer)&&isBoolean(desc.configurable)&&isBoolean(desc.enumerable)&&isBoolean(desc.writable);}function createDefaultSetter(key){return function set(newValue){_Object$defineProperty(this,key,{configurable:true,writable:true,enumerable:true,value:newValue});return newValue;};}function compressOneArgFnArray(fns){var errmsg=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'You must pass me an array of function';if(!isArray$1(fns)||fns.length<1){throw new TypeError(errmsg);}if(fns.length===1){if(!isFunction(fns[0])){throw new TypeError(errmsg);}return fns[0];}return fns.reduce(function(prev,curr){if(!isFunction(curr)||!isFunction(prev))throw new TypeError(errmsg);return function(value){return bind(curr,this)(bind(prev,this)(value));};});}function warn(){var _console2,_console3;var _console=console,warn=_console.warn;if(isFunction(warn))return(_console2=console).warn.apply(_console2,arguments);(_console3=console).log.apply(_console3,arguments);}function getOwnKeysFn(){var getOwnPropertyNames$$1=_Object$getOwnPropertyNames,getOwnPropertySymbols$$1=_Object$getOwnPropertySymbols;return isFunction(getOwnPropertySymbols$$1)?function(obj){return _Array$from(getOwnPropertyNames$$1(obj).concat(getOwnPropertySymbols$$1(obj)));}:getOwnPropertyNames$$1;}var getOwnKeys=getOwnKeysFn();function getOwnPropertyDescriptorsFn(){return isFunction(_Object$getOwnPropertyDescriptors)?_Object$getOwnPropertyDescriptors:function(obj){return getOwnKeys(obj).reduce(function(descs,key){descs[key]=getOwnPropertyDescriptor$3(obj,key);return descs;},{});};}var getOwnPropertyDescriptors=getOwnPropertyDescriptorsFn();function compressMultipleDecorators(){for(var _len=arguments.length,fns=Array(_len),_key=0;_key<_len;_key++){fns[_key]=arguments[_key];}var fnOnlyErrorMsg='compressMultipleDecorators only accept function';fns.forEach(function(fn){if(!isFunction(fns[0]))throw new TypeError(fnOnlyErrorMsg);});if(fns.length===1)return fns[0];return function(obj,prop,descirptor){return fns.reduce(function(descirptor,fn){return fn(obj,prop,descirptor);},descirptor);};}function accessor(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},get=_ref.get,set=_ref.set;var _ref2=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},_ref2$preGet=_ref2.preGet,preGet=_ref2$preGet===undefined?false:_ref2$preGet,_ref2$preSet=_ref2.preSet,preSet=_ref2$preSet===undefined?true:_ref2$preSet;if(!isFunction(get)&&!isFunction(set)&&!(isArray$1(get)&&get.length>0)&&!(isArray$1(set)&&set.length>0))throw new TypeError("@accessor need a getter or setter. If you don't need to add setter/getter. You should remove @accessor");var errmsg='@accessor only accept function or array of function as getter/setter';get=isArray$1(get)?compressOneArgFnArray(get,errmsg):get;set=isArray$1(set)?compressOneArgFnArray(set,errmsg):set;return function(obj,prop,descriptor){var _ref3=descriptor||{},_ref3$configurable=_ref3.configurable,configurable=_ref3$configurable===undefined?true:_ref3$configurable,_ref3$enumerable=_ref3.enumerable,enumerable=_ref3$enumerable===undefined?true:_ref3$enumerable;var hasGet=isFunction(get);var hasSet=isFunction(set);var handleGet=function handleGet(value){return hasGet?bind(get,this)(value):value;};var handleSet=function handleSet(value){return hasSet?bind(set,this)(value):value;};if(isAccessorDescriptor(descriptor)){var originGet=descriptor.get,originSet=descriptor.set;var hasOriginGet=isFunction(originGet);var hasOriginSet=isFunction(originSet);if(!hasOriginGet&&hasGet){warn('You are trying to set getter via @accessor on '+prop+' without getter. That\'s not a good idea.');}if(!hasOriginSet&&hasSet){warn('You are trying to set setter via @accessor on  '+prop+' without setter. That\'s not a good idea.');}var getter=hasOriginGet||hasGet?function(){var _this=this;var boundGetter=bind(handleGet,this);var originBoundGetter=function originBoundGetter(){return hasOriginGet?bind(originGet,_this)():undefined;};var order=preGet?[boundGetter,originBoundGetter]:[originBoundGetter,boundGetter];return order.reduce(function(value,fn){return fn(value);},undefined);}:undefined;var setter=hasOriginSet||hasSet?function(val){var _this2=this;var boundSetter=bind(handleSet,this);var originBoundSetter=function originBoundSetter(value){return hasOriginSet?bind(originSet,_this2)(value):value;};var order=preSet?[boundSetter,originBoundSetter]:[originBoundSetter,boundSetter];return order.reduce(function(value,fn){return fn(value);},val);}:undefined;return{get:getter,set:setter,configurable:configurable,enumerable:enumerable};}else if(isInitializerDescriptor(descriptor)){var initializer=descriptor.initializer;var value=void 0;var inited=false;return{get:function get(){var boundFn=bind(handleGet,this);if(inited)return boundFn(value);value=bind(initializer,this)();inited=true;return boundFn(value);},set:function set(val){var boundFn=bind(handleSet,this);value=preSet?boundFn(val):val;inited=true;if(!preSet){boundFn(value);}return value;},configurable:configurable,enumerable:enumerable};}else{var _ref4=descriptor||{},_value=_ref4.value;return{get:function get(){return bind(handleGet,this)(_value);},set:function set(val){var boundFn=bind(handleSet,this);_value=preSet?boundFn(val):val;if(!preSet){boundFn(_value);}return _value;},configurable:configurable,enumerable:enumerable};}};}function before(){for(var _len=arguments.length,fns=Array(_len),_key=0;_key<_len;_key++){fns[_key]=arguments[_key];}if(fns.length===0)throw new Error("@before accept at least one parameter. If you don't need to preprocess before your function, do not add @before decorators");if(fns.length>2&&isDescriptor(fns[2])){throw new Error('You may use @before straightly, @before return decorators, you need to call it');}for(var i=fns.length-1;i>-1;i--){if(!isFunction(fns[i]))throw new TypeError('@before only accept function parameter');}return function(obj,prop,descriptor){if(descriptor===undefined){throw new Error('@before must used on descriptor, are you using it on undefined property?');}var fn=descriptor.value,configurable=descriptor.configurable,enumerable=descriptor.enumerable,writable=descriptor.writable;if(!isFunction(fn))throw new TypeError('@before can only be used on function');var handler=function handler(){var _this=this;for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}var paras=fns.reduce(function(paras,fn){var result=bind(fn,_this).apply(undefined,_toConsumableArray(paras));return result===undefined?paras:isArray$1(result)?result:[result];},args);return bind(fn,this).apply(undefined,_toConsumableArray(paras));};return{value:handler,configurable:configurable,enumerable:enumerable,writable:writable};};}function initialize(){for(var _len=arguments.length,fns=Array(_len),_key=0;_key<_len;_key++){fns[_key]=arguments[_key];}if(fns.length===0)throw new Error("@initialize accept at least one parameter. If you don't need to initialize your value, do not add @initialize.");if(fns.length>2&&isDescriptor(fns[2])){throw new Error('You may use @initialize straightly, @initialize return decorators, you need to call it');}var fn=compressOneArgFnArray(fns,'@initialize only accept function parameter');return function(obj,prop,descriptor){if(descriptor===undefined){return{value:bind(fn,obj)(),configurable:true,writable:true,enumerable:true};}if(isAccessorDescriptor(descriptor)){var hasBeenReset=false;var originSet=descriptor.set;return accessor({get:function get(value){if(hasBeenReset)return value;return bind(fn,this)(value);},set:originSet?function(value){hasBeenReset=true;return value;}:undefined})(obj,prop,descriptor);}if(isInitializerDescriptor(descriptor)){var initializer=descriptor.initializer;var handler=function handler(){return bind(fn,this)(bind(initializer,this)());};return{initializer:handler,configurable:descriptor.configurable,writable:descriptor.writable,enumerable:descriptor.enumerable};}var value=bind(fn,this)(descriptor.value);return{value:value,writable:descriptor.writable,configurable:descriptor.configurable,enumerable:descriptor.enumerable};};}var getOwnPropertyDescriptor$1$1=_Object$getOwnPropertyDescriptor;var defineProperty$4=_Object$defineProperty;function setAlias(root,prop,_ref,obj,key,_ref2){var configurable=_ref.configurable,enumerable=_ref.enumerable;var force=_ref2.force,omit=_ref2.omit;var originDesc=getOwnPropertyDescriptor$1$1(obj,key);if(originDesc!==undefined){if(omit)return;if(!force)throw new Error("@alias can't set alias on an existing attribute");if(!originDesc.configurable){throw new Error("You are tring to set alias on an existing attribute which its configurable is false. That's impossible. Please check if you have set @frozen on it.");}}defineProperty$4(obj,key,{get:function get(){return root[prop];},set:function set(value){root[prop]=value;return prop;},configurable:configurable,enumerable:enumerable});}function alias(other,key,option){if(arguments.length===2){if(isString(other)){option=key;key=other;other=undefined;}}else if(arguments.length===1){key=other;other=undefined;}if(!isString(key))throw new TypeError('@alias need a string as a key to find the porperty to set alias on');var illegalObjErrorMsg='If you want to use @alias to set alias on other instance, you must pass in a legal instance';if(other!==undefined&&isPrimitive(other))throw new TypeError(illegalObjErrorMsg);var _ref3=isObject$1(option)?option:{force:false,omit:false},force=_ref3.force,omit=_ref3.omit;return function(obj,prop,descriptor){descriptor=descriptor||{value:undefined,configurable:true,writable:true,enumerable:true};function getTargetAndName(other,obj,key){var target=isPrimitive(other)?obj:other;var keys$$1=key.split('.');var _keys$slice=keys$$1.slice(-1),_keys$slice2=_slicedToArray(_keys$slice,1),name=_keys$slice2[0];target=getDeepProperty(target,keys$$1.slice(0,-1),{throwError:true});if(isPrimitive(target)){throw new TypeError(illegalObjErrorMsg);}return{target:target,name:name};}if(isInitializerDescriptor(descriptor)){return initialize(function(value){var _getTargetAndName=getTargetAndName(other,this,key),target=_getTargetAndName.target,name=_getTargetAndName.name;setAlias(this,prop,descriptor,target,name,{force:force,omit:omit});return value;})(obj,prop,descriptor);}if(isAccessorDescriptor(descriptor)){var inited=void 0;var handler=function handler(value){if(inited)return value;var _getTargetAndName2=getTargetAndName(other,this,key),target=_getTargetAndName2.target,name=_getTargetAndName2.name;setAlias(this,prop,descriptor,target,name,{force:force,omit:omit});inited=true;return value;};return accessor({get:handler,set:handler})(obj,prop,descriptor);}var _getTargetAndName3=getTargetAndName(other,obj,key),target=_getTargetAndName3.target,name=_getTargetAndName3.name;setAlias(obj,prop,descriptor,target,name,{force:force,omit:omit});return descriptor;};}var defineProperty$1$1=_Object$defineProperty;function classify(decorator){var _ref=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},requirement=_ref.requirement,_ref$customArgs=_ref.customArgs,customArgs=_ref$customArgs===undefined?false:_ref$customArgs;return function(){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}var _ref2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref2$exclude=_ref2.exclude,exclude=_ref2$exclude===undefined?[]:_ref2$exclude,_ref2$include=_ref2.include,include=_ref2$include===undefined?[]:_ref2$include,_ref2$construct=_ref2.construct,construct=_ref2$construct===undefined?false:_ref2$construct,_ref2$self=_ref2.self,self=_ref2$self===undefined?false:_ref2$self;if(!isArray$1(exclude))throw new TypeError('options.exclude must be an array');if(!isArray$1(include))throw new TypeError('options.include must be an array');return function(Klass){var isClass=isFunction(Klass);if(!self&&!isClass)throw new TypeError('@'+decorator.name+'Class can only be used on class');if(self&&isPrimitive(Klass))throw new TypeError('@'+decorator.name+'Class must be used on non-primitive type value in \'self\' mode');var prototype=self?Klass:Klass.prototype;if(isVoid(prototype))throw new Error('The prototype of the '+Klass.name+' is empty, please check it');var descs=getOwnPropertyDescriptors(prototype);getOwnKeys(prototype).concat(include).forEach(function(key){var desc=descs[key];if(key==='constructor'&&!construct||self&&isClass&&['name','length','prototype'].indexOf(key)>-1||exclude.indexOf(key)>-1||isFunction(requirement)&&requirement(prototype,key,desc,{self:self})===false)return;defineProperty$1$1(prototype,key,(customArgs?decorator.apply(undefined,_toConsumableArray(args)):decorator)(prototype,key,desc));});};};}var autobindClass=classify(autobind,{requirement:function requirement(obj,prop,desc){return isDataDescriptor(desc)&&isFunction(desc.value);}});var mapStore=void 0;function getBoundSuper(obj,fn){if(typeof _WeakMap==='undefined'){throw new Error('Using @autobind on '+fn.name+'() requires WeakMap support due to its use of super.'+fn.name+'()');}if(!mapStore){mapStore=new _WeakMap();}if(mapStore.has(obj)===false){mapStore.set(obj,new _WeakMap());}var superStore=mapStore.get(obj);if(superStore.has(fn)===false){superStore.set(fn,bind(fn,obj));}return superStore.get(fn);}function autobind(obj,prop,descriptor){if(arguments.length===1)return autobindClass()(obj);if(!isDescriptor(descriptor)){throw new Error('@autobind must used on descriptor, are you using it on undefined property?');}var fn=descriptor.value,configurable=descriptor.configurable;if(!isFunction(fn)){throw new TypeError('@autobind can only be used on functions, not: '+fn+')');}var constructor=obj.constructor;return{configurable:configurable,enumerable:false,get:function get(){var _this=this;var boundFn=function boundFn(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}return fn.call.apply(fn,[_this].concat(_toConsumableArray(args)));};if(this===obj){return fn;}if(this.constructor!==constructor&&_Object$getPrototypeOf(this).constructor===constructor){return fn;}if(this.constructor!==constructor&&prop in this.constructor.prototype){return getBoundSuper(this,fn);}_Object$defineProperty(this,prop,{configurable:true,writable:true,enumerable:false,value:boundFn});return boundFn;},set:createDefaultSetter(prop)};}var defineProperty$2$1=_Object$defineProperty;function frozen(obj,prop,descriptor){if(descriptor===undefined){warn('You are using @frozen on an undefined property. This property will become a frozen undefined forever, which is meaningless');return{value:undefined,writable:false,enumerable:false,configurable:false};}descriptor.enumerable=false;descriptor.configurable=false;if(isAccessorDescriptor(descriptor)){var _get=descriptor.get;descriptor.set=undefined;if(!isFunction(_get)){warn('You are using @frozen on one accessor descriptor without getter. This property will become a frozen undefined finally.Which maybe meaningless.');return;}return{get:function get(){var value=bind(_get,this)();defineProperty$2$1(this,prop,{value:value,writable:false,configurable:false,enumerable:false});return value;},set:undefined,configurable:false,enumerable:false};}descriptor.writable=false;return descriptor;}var getOwnPropertyDescriptor$2$1=_Object$getOwnPropertyDescriptor;var defineProperty$3$1=_Object$defineProperty;function waituntil(key){var _ref=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},other=_ref.other;if(!isFunction(key)&&!isPromise(key)&&!isString(key))throw new TypeError('@waitUntil only accept Function, Promise or String');return function(obj,prop,descriptor){if(descriptor===undefined){throw new Error('@waituntil must used on descriptor, are you using it on undefined property?');}var _value=descriptor.value,configurable=descriptor.configurable;if(!isFunction(_value))throw new TypeError('@waituntil can only be used on function, but not '+_value);var binded=false;var waitingQueue=[];var canIRun=isPromise(key)?function(){return key;}:isFunction(key)?key:function(){var keys$$1=key.split('.');var prop=keys$$1.slice(-1);var originTarget=isPrimitive(other)?this:other;if(!binded){var target=getDeepProperty(originTarget,keys$$1.slice(0,-1));if(isVoid(target))return target;var _descriptor=getOwnPropertyDescriptor$2$1(target,prop);var set=function set(value){if(value===true){while(waitingQueue.length>0){waitingQueue[0]();waitingQueue.shift();}}return value;};var desc=isDescriptor(_descriptor)?accessor({set:set})(target,prop,_descriptor):accessor({set:set})(target,prop,{value:undefined,configurable:true,enumerable:true,writable:true});defineProperty$3$1(target,prop,desc);binded=true;}return getDeepProperty(originTarget,keys$$1);};return{value:function value(){var _this=this;for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var boundFn=bind(_value,this);var runnable=bind(canIRun,this).apply(undefined,args);if(isPromise(runnable)){return _Promise.resolve(runnable).then(function(){return bind(_value,_this).apply(undefined,args);});}else if(runnable===true){return bind(_value,this).apply(undefined,args);}else{return new _Promise(function(resolve){var cb=function cb(){boundFn.apply(undefined,args);resolve();};waitingQueue.push(cb);});}},enumerable:false,configurable:configurable,writable:false};};}var defineProperty$5=_Object$defineProperty;function lock(obj,prop,descriptor){if(descriptor===undefined){warn('You are using @lock on an undefined property. This property will become a lock undefined forever, which is meaningless');return{value:undefined,writable:false,enumerable:true,configurable:false};}descriptor.configurable=false;if(isAccessorDescriptor(descriptor)){var _get=descriptor.get;descriptor.set=undefined;if(!isFunction(_get)){warn('You are using @lock on one accessor descriptor without getter. This property will become a lock undefined finally.Which maybe meaningless.');return;}return{get:function get(){var value=bind(_get,this)();defineProperty$5(this,prop,{value:value,writable:false,configurable:false,enumerable:descriptor.enumerable});return value;},set:undefined,configurable:false,enumerable:descriptor.enumerable};}descriptor.writable=false;return descriptor;}function nonenumerable(obj,prop,descriptor){if(descriptor===undefined){return{value:undefined,enumerable:false,configurable:true,writable:true};}descriptor.enumerable=false;return descriptor;}var defineProperty$6=_Object$defineProperty;var getOwnPropertyDescriptor$3$1=_Object$getOwnPropertyDescriptor;function applyDecorators(Class,props){var _ref=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},_ref$self=_ref.self,self=_ref$self===undefined?false:_ref$self,_ref$omit=_ref.omit,omit=_ref$omit===undefined?false:_ref$omit;var isPropsFunction=isFunction(props);if(isPropsFunction||isArray$1(props)){if(!isFunction(Class))throw new TypeError('If you want to decorator class, you must pass it a legal class');if(isPropsFunction)props(Class);else{for(var i=0,len=props.length;i<len;i++){var fn=props[i];if(!isFunction(fn))throw new TypeError('If you want to decorate an class, you must pass it function or array of function');fn(Class);}}return Class;}if(!self&&!isFunction(Class))throw new TypeError('applyDecorators only accept class as first arguments. If you want to modify instance, you should set options.self true.');if(self&&isPrimitive(Class))throw new TypeError("We can't apply docorators on a primitive value, even in self mode");if(!isObject$1(props))throw new TypeError('applyDecorators only accept object as second arguments');var prototype=self?Class:Class.prototype;if(isVoid(prototype))throw new Error('The class muse have a prototype, please take a check');for(var key in props){var value=props[key];var decorators=isArray$1(value)?value:[value];var handler=void 0;try{handler=compressMultipleDecorators.apply(undefined,_toConsumableArray(decorators));}catch(err){warn(err&&err.message);throw new Error('The decorators set on props must be Function or Array of Function');}var descriptor=getOwnPropertyDescriptor$3$1(prototype,key);if(descriptor&&!descriptor.configurable){if(!omit)throw new Error(key+' of '+prototype+' is unconfigurable');continue;}defineProperty$6(prototype,key,handler(prototype,key,descriptor));}return Class;}var arrayChangeMethod=['push','pop','unshift','shift','splice','sort','reverse'];function deepProxy(value,hook,_ref){var _operateProps;var diff=_ref.diff,operationPrefix=_ref.operationPrefix;var mapStore={};var arrayChanging=false;var proxyValue=new Proxy(value,{get:function get(target,property,receiver){var value=target[property];if(isArray$1(target)&&arrayChangeMethod.indexOf(property)>-1){return function(){arrayChanging=true;bind(value,receiver).apply(undefined,arguments);arrayChanging=false;hook();};}if(mapStore[property]===true)return value;if(isObject$1(value)||isArray$1(value)){var _proxyValue=mapStore[property]||deepProxy(value,hook,{diff:diff,operationPrefix:operationPrefix});mapStore[property]=_proxyValue;return _proxyValue;}mapStore[property]=true;return value;},set:function set(target,property,value){var oldVal=target[property];var newVal=isObject$1(value)||isArray$1(value)?deepProxy(value,hook,{diff:diff,operationPrefix:operationPrefix}):value;target[property]=newVal;mapStore[property]=true;if(arrayChanging||diff&&oldVal===newVal)return true;hook();return true;},deleteProperty:function deleteProperty(target,property){delete target[property];delete mapStore[property];if(arrayChanging)return true;hook();return true;}});var operateProps=(_operateProps={},_defineProperty$1(_operateProps,operationPrefix+'set',[initialize(function(method){return function(property,val){proxyValue[property]=val;};}),nonenumerable]),_defineProperty$1(_operateProps,operationPrefix+'del',[initialize(function(method){return function(property){delete proxyValue[property];};}),nonenumerable]),_operateProps);applyDecorators(proxyValue,operateProps,{self:true});return proxyValue;}function deepObserve(value,hook,_ref2){var _this=this,_operateProps2;var operationPrefix=_ref2.operationPrefix,diff=_ref2.diff;var mapStore={};var arrayChanging=false;function getPropertyDecorators(keys$$1){var oldVal=void 0;return keys$$1.reduce(function(props,key){props[key]=[accessor({set:function set(value){oldVal=this[key];return value;}}),accessor({get:function get(val){if(mapStore[key])return val;if(isObject$1(val)||isArray$1(val)){deepObserve(val,hook,{operationPrefix:operationPrefix,diff:diff});}mapStore[key]=true;return val;},set:function set(val){if(isObject$1(val)||isArray$1(val))deepObserve(val,hook,{operationPrefix:operationPrefix,diff:diff});mapStore[key]=true;if(!arrayChanging&&(!diff||oldVal!==val))hook();return val;}},{preSet:false})];return props;},{});}var props=getPropertyDecorators(getOwnKeys(value));applyDecorators(value,props,{self:true,omit:true});if(isArray$1(value)){var methodProps=arrayChangeMethod.reduce(function(props,key){props[key]=[initialize(function(method){method=isFunction(method)?method:Array.prototype[key];return function(){var originLength=value.length;arrayChanging=true;bind(method,value).apply(undefined,arguments);arrayChanging=false;if(originLength<value.length){var keys$$1=new Array(value.length-originLength).fill(1).map(function(value,index){return(index+originLength).toString();});var _props=getPropertyDecorators(keys$$1);applyDecorators(value,_props,{self:true,omit:true});}hook();};}),nonenumerable];return props;},{});applyDecorators(value,methodProps,{self:true});}var operateProps=(_operateProps2={},_defineProperty$1(_operateProps2,operationPrefix+'set',[initialize(function(method){return function(property,val){var _ref3=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},disable=_ref3.disable,isNewVal=_ref3.isNewVal;isNewVal=isNewVal||getOwnKeys(value).indexOf(property)===-1;if(isFunction(method)){bind(method,_this)(property,val,{disable:true,isNewVal:isNewVal});}if(isNewVal){var _props2=getPropertyDecorators([property]);applyDecorators(value,_props2,{self:true,omit:true});}if(!disable){value[property]=val;}};}),nonenumerable]),_defineProperty$1(_operateProps2,operationPrefix+'del',[initialize(function(method){return function(property){if(getOwnKeys(value).indexOf(property)===-1){var _props3=getPropertyDecorators([property]);applyDecorators(value,_props3,{self:true,omit:true});}if(isFunction(method)){bind(method,_this)(property);}else{delete value[property];}hook();};}),nonenumerable]),_operateProps2);applyDecorators(value,operateProps,{self:true});return value;}function watch(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var option=isObject$1(args[args.length-1])?args[args.length-1]:{};var deep=option.deep,omit=option.omit,other=option.other,_option$operationPref=option.operationPrefix,operationPrefix=_option$operationPref===undefined?'__':_option$operationPref,_option$diff=option.diff,diff=_option$diff===undefined?true:_option$diff;var proxy=option.proxy;if(!Proxy){proxy=false;warn('You browser do not support Proxy, we will change back into observe mode.');}if(!args.length)throw new TypeError('You must pass a function or a string to find the hanlder function.');if(other!==undefined&&isPrimitive(other))throw new TypeError('If you want us to trigger function on the other instance, you must pass in a legal instance');if(!isString(operationPrefix))throw new TypeError('operationPrefix must be an string');return function(obj,prop,descriptor){var fns=args.reduce(function(fns,keyOrFn,index){if(!isString(keyOrFn)&&!isFunction(keyOrFn)){if(!index||index!==args.length-1)throw new TypeError('You can only pass function or string as handler');return fns;}fns.push(isString(keyOrFn)?function(newVal,oldVal){var target=other||obj;var fn=getDeepProperty(target,keyOrFn);if(!isFunction(fn)){if(!omit)throw new Error('You pass in a function for us to trigger, please ensure the property to be a function or set omit flag true');return;}return bind(fn,this)(newVal,oldVal);}:keyOrFn);return fns;},[]);var handler=function handler(newVal,oldVal){var _this2=this;fns.forEach(function(fn){return bind(fn,_this2)(newVal,oldVal);});};var inited=false;var oldVal=void 0;var newVal=void 0;var proxyValue=void 0;return compressMultipleDecorators(accessor({set:function set(value){var _this3=this;oldVal=this[prop];proxyValue=undefined;var hook=function hook(){return bind(handler,_this3)(newVal,oldVal);};return deep&&(isObject$1(value)||isArray$1(value))?proxy?deepProxy(value,hook,{diff:diff,operationPrefix:operationPrefix}):deepObserve(value,hook,{operationPrefix:operationPrefix,diff:diff}):value;},get:function get(value){var _this4=this;if(proxyValue)return proxyValue;if(!inited){inited=true;var hook=function hook(){return bind(handler,_this4)(newVal,oldVal);};if(deep&&(isObject$1(value)||isArray$1(value))){if(proxy){proxyValue=deepProxy(value,hook,{diff:diff,operationPrefix:operationPrefix});oldVal=proxyValue;newVal=proxyValue;return proxyValue;}deepObserve(value,hook,{operationPrefix:operationPrefix,diff:diff});}oldVal=value;newVal=value;}return value;}},{preSet:true}),accessor({set:function set(value){newVal=value;if(!diff||oldVal!==value)bind(handler,this)(newVal,oldVal);oldVal=value;return value;}},{preSet:false}))(obj,prop,descriptor);};}var preventExtensions=_Object$preventExtensions;function nonextendable(obj,prop,descriptor){if(descriptor===undefined)throw new Error('@nonextendable could not handle undefined');return initialize(function(value){preventExtensions(value);return value;})(obj,prop,descriptor);}function nonconfigurable(obj,prop,descriptor){if(descriptor===undefined){return{value:undefined,enumerable:true,configurable:true,writable:true};}descriptor.configurable=true;return descriptor;}function string(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var defaultValue=isString(args[0])?args.shift():'';args.unshift(function(value){return isString(value)?value:defaultValue;});return initialize.apply(undefined,args);}function array(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var defaultValue=isArray$1(args[0])?args.shift():[];args.unshift(function(value){return isArray$1(value)?value:defaultValue;});return initialize.apply(undefined,args);}function string$1(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var defaultValue=isString(args[0])?args.shift():'';args.unshift(function(value){return isString(value)?value:defaultValue;});return accessor({set:args,get:args});}function boolean$1(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var defaultValue=isBoolean(args[0])?args.shift():false;args.unshift(function(value){return isBoolean(value)?value:defaultValue;});return accessor({set:args,get:args});}function number$1(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var defaultValue=isNumber(args[0])?args.shift():0;args.unshift(function(value){return isNumber(value)?value:defaultValue;});return accessor({set:args,get:args});}function eventBinderCheck(key,fn){if(!isString(key))throw new TypeError('key parameter must be String');if(!isFunction(fn))throw new TypeError('fn parameter must be Function');}function attrAndStyleCheck(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}if(args.length>2){return['set'].concat(args);}if(args.length===2){if(['video','container','wrapper','videoElement'].indexOf(args[0])>-1){return['get'].concat(args);}return['set','container'].concat(args);}return['get','container'].concat(args);}var $JSON$1=_core.JSON||(_core.JSON={stringify:JSON.stringify});var stringify$2=function stringify(it){return $JSON$1.stringify.apply($JSON$1,arguments);};var stringify$1=createCommonjsModule(function(module){module.exports={"default":stringify$2,__esModule:true};});var _JSON$stringify=unwrapExports(stringify$1);var VideoWrapper=function(){function VideoWrapper(){_classCallCheck(this,VideoWrapper);this.__unwatchHandlers=[];}_createClass(VideoWrapper,[{key:'__wrapAsVideo',value:function __wrapAsVideo(videoConfig){var _this=this;videoReadOnlyProperties.forEach(function(key){_Object$defineProperty(_this,key,{get:function get(){return this.__dispatcher.dom.videoElement[key];},set:undefined,configurable:false,enumerable:false});});videoMethods.forEach(function(key){_Object$defineProperty(_this,key,{get:function get(){var video=this.__dispatcher.dom.videoElement;return bind(video[key],video);},set:undefined,configurable:false,enumerable:false});});var props=videoConfig._realDomAttr.concat(videoConfig._kernelProperty).reduce(function(props,key){props[key]=[accessor({get:function get(){return videoConfig[key];},set:function set(value){videoConfig[key]=value;return value;}}),nonenumerable];return props;},{});applyDecorators(this,props,{self:true});kernelMethods.forEach(function(key){_Object$defineProperty(_this,key,{value:function value(){var _this2=this;for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}return new _Promise(function(resolve,reject){var _dispatcher$bus;_this2.__dispatcher.bus.once(_this2.__id,'_'+key,resolve);(_dispatcher$bus=_this2.__dispatcher.bus)[/^(seek)$/.test(key)?'emitSync':'emit'].apply(_dispatcher$bus,[key].concat(_toConsumableArray(args)));});},configurable:true,enumerable:false,writable:true});});domMethods.forEach(function(key){_Object$defineProperty(_this,key,{value:function value(){var _dispatcher$dom;return(_dispatcher$dom=this.__dispatcher.dom)[key].apply(_dispatcher$dom,arguments);},configurable:true,enumerable:false,writable:true});});}},{key:'$watch',value:function $watch(key,handler){var _this3=this;var _ref=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},deep=_ref.deep,_ref$diff=_ref.diff,diff=_ref$diff===undefined?true:_ref$diff,other=_ref.other,_ref$proxy=_ref.proxy,proxy=_ref$proxy===undefined?false:_ref$proxy;if(!isString(key)&&!isArray$1(key))throw new TypeError('$watch only accept string and Array<string> as key to find the target to spy on, but not '+key+', whose type is '+(typeof key==='undefined'?'undefined':_typeof(key)));var watching=true;var watcher=function watcher(){if(watching)bind(handler,this).apply(undefined,arguments);};var unwatcher=function unwatcher(){watching=false;var index=_this3.__unwatchHandlers.indexOf(unwatcher);if(index>-1)_this3.__unwatchHandlers.splice(index,1);};var keys=isString(key)?key.split('.'):key;var property=keys.pop();var videoConfig=this.__dispatcher.videoConfig;var target=keys.length===0&&!other&&videoConfig._realDomAttr.indexOf(property)>-1?videoConfig:getDeepProperty(other||this,keys,{throwError:true});applyDecorators(target,_defineProperty$1({},property,watch(watcher,{deep:deep,diff:diff,proxy:proxy})),{self:true});this.__unwatchHandlers.push(unwatcher);return unwatcher;}},{key:'$set',value:function $set(obj,property,value){if(!isObject$1(obj)&&!isArray$1(obj))throw new TypeError('$set only support Array or Object, but not '+obj+', whose type is '+(typeof obj==='undefined'?'undefined':_typeof(obj)));if(!isFunction(obj.__set)){Log.warn('chimee',_JSON$stringify(obj)+' has not been deep watch. There is no need to use $set.');obj[property]=value;return;}obj.__set(property,value);}},{key:'$del',value:function $del(obj,property){if(!isObject$1(obj)&&!isArray$1(obj))throw new TypeError('$del only support Array or Object, but not '+obj+', whose type is '+(typeof obj==='undefined'?'undefined':_typeof(obj)));if(!isFunction(obj.__del)){Log.warn('chimee',_JSON$stringify(obj)+' has not been deep watch. There is no need to use $del.');delete obj[property];return;}obj.__del(property);}},{key:'__destroy',value:function __destroy(){this.__unwatchHandlers.forEach(function(unwatcher){return unwatcher();});}},{key:'currentTime',get:function get(){return this.__dispatcher.kernel.currentTime;},set:function set(second){this.__dispatcher.bus.emitSync('seek',second);}}]);return VideoWrapper;}();var _dec$2;var _dec2$2;var _dec3$2;var _dec4$2;var _dec5$2;var _dec6$1;var _class$2;var _class2$1;function _applyDecoratedDescriptor$2(target,property,decorators,descriptor,context){var desc={};Object['ke'+'ys'](descriptor).forEach(function(key){desc[key]=descriptor[key];});desc.enumerable=!!desc.enumerable;desc.configurable=!!desc.configurable;if('value'in desc||desc.initializer){desc.writable=true;}desc=decorators.slice().reverse().reduce(function(desc,decorator){return decorator(target,property,desc)||desc;},desc);if(context&&desc.initializer!==void 0){desc.value=desc.initializer?desc.initializer.call(context):void 0;desc.initializer=undefined;}if(desc.initializer===void 0){Object['define'+'Property'](target,property,desc);desc=null;}return desc;}var Plugin=(_dec$2=autobindClass(),_dec2$2=before(attrAndStyleCheck),_dec3$2=before(attrAndStyleCheck),_dec4$2=before(eventBinderCheck),_dec5$2=before(eventBinderCheck),_dec6$1=before(eventBinderCheck),_dec$2(_class$2=(_class2$1=function(_VideoWrapper){_inherits(Plugin,_VideoWrapper);function Plugin(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},id=_ref.id,name=_ref.name,_ref$level=_ref.level,level=_ref$level===undefined?0:_ref$level,_ref$operable=_ref.operable,operable=_ref$operable===undefined?true:_ref$operable,beforeCreate=_ref.beforeCreate,create=_ref.create,init=_ref.init,inited=_ref.inited,destroy=_ref.destroy,_ref$events=_ref.events,events=_ref$events===undefined?{}:_ref$events,_ref$data=_ref.data,data=_ref$data===undefined?{}:_ref$data,_ref$computed=_ref.computed,computed=_ref$computed===undefined?{}:_ref$computed,_ref$methods=_ref.methods,methods=_ref$methods===undefined?{}:_ref$methods,el=_ref.el,_ref$penetrate=_ref.penetrate,penetrate=_ref$penetrate===undefined?false:_ref$penetrate,_ref$inner=_ref.inner,inner=_ref$inner===undefined?true:_ref$inner,autoFocus=_ref.autoFocus,className=_ref.className;var dispatcher=arguments[1];var option=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{name:name};_classCallCheck(this,Plugin);var _this=_possibleConstructorReturn(this,(Plugin.__proto__||_Object$getPrototypeOf(Plugin)).call(this));_this.destroyed=false;_this.VERSION='0.1.3';_this.__operable=true;_this.__events={};_this.__level=0;if(isEmpty(dispatcher)){Log.error('Dispatcher.plugin','lack of dispatcher. Do you forget to pass arguments to super in plugin?');throw new TypeError('lack of dispatcher');}if(!isString(id)){throw new TypeError('id of PluginConfig must be string');}_this.__id=id;_this.__dispatcher=dispatcher;_this.$videoConfig=_this.__dispatcher.videoConfig;_this.__wrapAsVideo(_this.$videoConfig);_this.beforeCreate=_this.beforeCreate||beforeCreate;try{isFunction(_this.beforeCreate)&&_this.beforeCreate({events:events,data:data,computed:computed,methods:methods},option);}catch(error){_this.$throwError(error);}if(!isEmpty(methods)&&isObject$1(methods)){_Object$keys(methods).forEach(function(key){var fn=methods[key];if(!isFunction(fn))throw new TypeError('plugins methods must be Function');_Object$defineProperty(_this,key,{value:bind(fn,_this),writable:true,enumerable:false,configurable:true});});}if(!isEmpty(events)&&isObject$1(events)){_Object$keys(events).forEach(function(key){if(!isFunction(events[key]))throw new TypeError('plugins events hook must bind with Function');_this.$on(key,events[key]);});}if(!isEmpty(data)&&isObject$1(data)){deepAssign(_this,data);}if(!isEmpty(computed)&&isObject$1(computed)){var props=_Object$keys(computed).reduce(function(props,key){var val=computed[key];if(isFunction(val)){props[key]=accessor({get:val});return props;}if(isObject$1(val)&&(isFunction(val.get)||isFunction(val.set))){props[key]=accessor(val);return props;}Log.warn('Dispatcher.plugin','Wrong computed member \''+key+'\' defination in Plugin '+name);return props;},{});applyDecorators(_this,props,{self:true});}_this.create=_this.create||create;_this.init=_this.init||init;_this.inited=_this.inited||inited;_this.destroy=_this.destroy||destroy;_this.$dom=_this.__dispatcher.dom.insertPlugin(_this.__id,el,{penetrate:penetrate,inner:inner,autoFocus:autoFocus,className:className});_this.$inner=inner;_this.$autoFocus=autoFocus;_this.$penetrate=penetrate;applyDecorators(_this,{$inner:frozen,$autoFocus:frozen,$penetrate:frozen},{self:true});_this.$operable=isBoolean(option.operable)?option.operable:operable;_this.__level=isInteger(option.level)?option.level:level;_this.$config=option;try{isFunction(_this.create)&&_this.create();}catch(error){_this.$throwError(error);}return _this;}_createClass(Plugin,[{key:'__init',value:function __init(videoConfig){try{isFunction(this.init)&&this.init(videoConfig);}catch(error){this.$throwError(error);}}},{key:'__inited',value:function __inited(){var _this2=this;var result=void 0;try{result=isFunction(this.inited)&&this.inited();}catch(error){this.$throwError(error);}this.readySync=!isPromise(result);this.ready=this.readySync?_Promise.resolve():result.then(function(ret){_this2.readySync=true;return ret;}).catch(function(error){if(isError(error))return _this2.$throwError(error);return _Promise.reject(error);});return this.readySync||this.ready;}},{key:'$css',value:function $css(method){var _dispatcher$dom;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}return(_dispatcher$dom=this.__dispatcher.dom)[method+'Style'].apply(_dispatcher$dom,args);}},{key:'$attr',value:function $attr(method){var _dispatcher$dom2;for(var _len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2];}if(method==='set'&&/video/.test(args[0])){if(!this.__dispatcher.videoConfigReady){Log.warn('plugin','Plugin '+this.__id+' is tring to set attribute on video before video inited. Please wait until the inited event has benn trigger');return args[2];}if(this.$videoConfig._realDomAttr.indexOf(args[1])>-1){var key=args[1],val=args[2];this.$videoConfig[key]=val;return val;}}return(_dispatcher$dom2=this.__dispatcher.dom)[method+'Attr'].apply(_dispatcher$dom2,args);}},{key:'$fullScreen',value:function $fullScreen(){var flag=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var element=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'container';return this.__dispatcher.dom.fullScreen(flag,element);}},{key:'$bumpToTop',value:function $bumpToTop(){var topLevel=this.__dispatcher._getTopLevel(this.$inner);this.$level=topLevel+1;}},{key:'$on',value:function $on(key,fn){this.__dispatcher.bus.on(this.__id,key,fn);this.__addEvents(key,fn);}},{key:'$off',value:function $off(key,fn){this.__dispatcher.bus.off(this.__id,key,fn);this.__removeEvents(key,fn);}},{key:'$once',value:function $once(key,fn){var self=this;var boundFn=function boundFn(){bind(fn,this).apply(undefined,arguments);self.__removeEvents(key,boundFn);};self.__addEvents(key,boundFn);this.__dispatcher.bus.once(this.__id,key,boundFn);}},{key:'$emit',value:function $emit(key){var _dispatcher$bus;if(!isString(key))throw new TypeError('$emit key parameter must be String');if(domEvents.indexOf(key.replace(/^\w_/,''))>-1){Log.warn('plugin','You are using $emit to emit '+key+' event. As $emit is wrapped in Promise. It make you can\'t use event.preventDefault and event.stopPropagation. So we advice you to use $emitSync');}for(var _len3=arguments.length,args=Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++){args[_key3-1]=arguments[_key3];}(_dispatcher$bus=this.__dispatcher.bus).emit.apply(_dispatcher$bus,[key].concat(_toConsumableArray(args)));}},{key:'$emitSync',value:function $emitSync(key){var _dispatcher$bus2;if(!isString(key))throw new TypeError('$emitSync key parameter must be String');for(var _len4=arguments.length,args=Array(_len4>1?_len4-1:0),_key4=1;_key4<_len4;_key4++){args[_key4-1]=arguments[_key4];}return(_dispatcher$bus2=this.__dispatcher.bus).emitSync.apply(_dispatcher$bus2,[key].concat(_toConsumableArray(args)));}},{key:'$throwError',value:function $throwError(error){this.__dispatcher.throwError(error);}},{key:'$destroy',value:function $destroy(){var _this3=this;isFunction(this.destroy)&&this.destroy();_get(Plugin.prototype.__proto__||_Object$getPrototypeOf(Plugin.prototype),'__destroy',this).call(this);_Object$keys(this.__events).forEach(function(key){if(!isArray$1(_this3.__events[key]))return;_this3.__events[key].forEach(function(fn){return _this3.$off(key,fn);});});delete this.__events;this.__dispatcher.dom.removePlugin(this.__id);delete this.__dispatcher;delete this.$dom;this.destroyed=true;}},{key:'__addEvents',value:function __addEvents(key,fn){this.__events[key]=this.__events[key]||[];this.__events[key].push(fn);}},{key:'__removeEvents',value:function __removeEvents(key,fn){if(isEmpty(this.__events[key]))return;var index=this.__events[key].indexOf(fn);if(index<0)return;this.__events[key].splice(index,1);if(isEmpty(this.__events[key]))delete this.__events[key];}},{key:'$plugins',get:function get(){return this.__dispatcher.plugins;}},{key:'$pluginOrder',get:function get(){return this.__dispatcher.order;}},{key:'$operable',set:function set(val){if(!isBoolean(val))return;this.$dom.style.pointerEvents=val?'auto':'none';this.__operable=val;},get:function get(){return this.__operable;}},{key:'$level',set:function set(val){if(!isInteger(val))return;this.__level=val;this.__dispatcher._sortZIndex();},get:function get(){return this.__level;}}]);return Plugin;}(VideoWrapper),(_applyDecoratedDescriptor$2(_class2$1.prototype,'$css',[_dec2$2],_Object$getOwnPropertyDescriptor(_class2$1.prototype,'$css'),_class2$1.prototype),_applyDecoratedDescriptor$2(_class2$1.prototype,'$attr',[_dec3$2],_Object$getOwnPropertyDescriptor(_class2$1.prototype,'$attr'),_class2$1.prototype),_applyDecoratedDescriptor$2(_class2$1.prototype,'$on',[_dec4$2],_Object$getOwnPropertyDescriptor(_class2$1.prototype,'$on'),_class2$1.prototype),_applyDecoratedDescriptor$2(_class2$1.prototype,'$off',[_dec5$2],_Object$getOwnPropertyDescriptor(_class2$1.prototype,'$off'),_class2$1.prototype),_applyDecoratedDescriptor$2(_class2$1.prototype,'$once',[_dec6$1],_Object$getOwnPropertyDescriptor(_class2$1.prototype,'$once'),_class2$1.prototype),_applyDecoratedDescriptor$2(_class2$1.prototype,'$plugins',[nonenumerable,nonextendable],_Object$getOwnPropertyDescriptor(_class2$1.prototype,'$plugins'),_class2$1.prototype),_applyDecoratedDescriptor$2(_class2$1.prototype,'$pluginOrder',[nonenumerable,nonextendable],_Object$getOwnPropertyDescriptor(_class2$1.prototype,'$pluginOrder'),_class2$1.prototype)),_class2$1))||_class$2);var _dec$3;var _dec2$3;var _dec3$3;var _dec4$3;var _dec5$3;var _dec6$2;var _class$3;function _applyDecoratedDescriptor$3(target,property,decorators,descriptor,context){var desc={};Object['ke'+'ys'](descriptor).forEach(function(key){desc[key]=descriptor[key];});desc.enumerable=!!desc.enumerable;desc.configurable=!!desc.configurable;if('value'in desc||desc.initializer){desc.writable=true;}desc=decorators.slice().reverse().reduce(function(desc,decorator){return decorator(target,property,desc)||desc;},desc);if(context&&desc.initializer!==void 0){desc.value=desc.initializer?desc.initializer.call(context):void 0;desc.initializer=undefined;}if(desc.initializer===void 0){Object['define'+'Property'](target,property,desc);desc=null;}return desc;}function targetCheck(target){if(target==='video')target='videoElement';if(!isElement(this[target]))throw new TypeError('Your target '+target+' is not a legal HTMLElement');for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}return[target].concat(args);}function attrOperationCheck(target,attr,val){if(!isString(attr))throw new TypeError("to handle dom's attribute or style, your attr parameter must be string");if(!isString(target))throw new TypeError("to handle dom's attribute or style, your target parameter must be string");return[target,attr,val];}var Dom=(_dec$3=waituntil('__dispatcher.videoConfigReady'),_dec2$3=before(attrOperationCheck,targetCheck),_dec3$3=before(attrOperationCheck,targetCheck),_dec4$3=before(attrOperationCheck,targetCheck),_dec5$3=before(attrOperationCheck,targetCheck),_dec6$2=before(targetCheck),(_class$3=function(){function Dom(wrapper,dispatcher){var _this=this;_classCallCheck(this,Dom);this.plugins={};this.originHTML='';this.videoEventHandlerList=[];this.videoDomEventHandlerList=[];this.containerDomEventHandlerList=[];this.wrapperDomEventHandlerList=[];this.__domEventHandlerList={};this.__mouseInVideo=false;this.__videoExtendedNodes=[];this.__dispatcher=dispatcher;if(!isElement(wrapper)&&!isString(wrapper))throw new TypeError('Illegal wrapper');var $wrapper=$(wrapper);if($wrapper.length===0){throw new TypeError('Can not get dom node accroding wrapper. Please check your wrapper');}this.wrapper=$wrapper[0];this.originHTML=this.wrapper.innerHTML;var videoElement=$wrapper.find('video')[0];if(!videoElement){videoElement=document.createElement('video');}this.videoElement=videoElement;this.__videoExtendedNodes.push(videoElement);this.setAttr('videoElement','tabindex',-1);this._autoFocusToVideo(this.videoElement);if(this.videoElement.parentElement&&isElement(this.videoElement.parentElement)&&this.videoElement.parentElement!==this.wrapper){this.container=this.videoElement.parentElement;}else{this.container=document.createElement('container');$(this.container).append(this.videoElement);}if(this.container.parentElement!==this.wrapper){$wrapper.append(this.container);}videoEvents.forEach(function(key){var fn=function fn(){var _dispatcher$bus;for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}return(_dispatcher$bus=_this.__dispatcher.bus).trigger.apply(_dispatcher$bus,[key].concat(args));};_this.videoEventHandlerList.push(fn);addEvent(_this.videoElement,key,fn);});domEvents.forEach(function(key){var fn=_this._getEventHandler(key,{penetrate:true});_this.videoDomEventHandlerList.push(fn);addEvent(_this.videoElement,key,fn);var cfn=function cfn(){var _dispatcher$bus2;for(var _len3=arguments.length,args=Array(_len3),_key3=0;_key3<_len3;_key3++){args[_key3]=arguments[_key3];}return(_dispatcher$bus2=_this.__dispatcher.bus).triggerSync.apply(_dispatcher$bus2,['c_'+key].concat(args));};_this.containerDomEventHandlerList.push(cfn);addEvent(_this.container,key,cfn);var wfn=function wfn(){var _dispatcher$bus3;for(var _len4=arguments.length,args=Array(_len4),_key4=0;_key4<_len4;_key4++){args[_key4]=arguments[_key4];}return(_dispatcher$bus3=_this.__dispatcher.bus).triggerSync.apply(_dispatcher$bus3,['w_'+key].concat(args));};_this.wrapperDomEventHandlerList.push(wfn);addEvent(_this.wrapper,key,wfn);});}_createClass(Dom,[{key:'insertPlugin',value:function insertPlugin(id,el){var _this2=this;var option=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};if(!isString(id))throw new TypeError('insertPlugin id parameter must be string');if(isElement(this.plugins[id])){Log.warn('Dispatcher.dom','Plugin '+id+' have already had a dom node. Now it will be replaced');this.removePlugin(id);}if(isString(el)){if(isHTMLString(el)){var outer=document.createElement('div');outer.innerHTML=el;el=outer.children[0];}else{el=document.createElement(hypenate(el));}}else if(isObject$1(el)){option=el;}var _option=option,inner=_option.inner,penetrate=_option.penetrate,autoFocus=_option.autoFocus;var _option2=option,className=_option2.className;var node=el&&isElement(el)?el:document.createElement('div');if(isArray$1(className)){className=className.join(' ');}if(isString(className)){addClassName(node,className);}this.plugins[id]=node;var outerElement=inner?this.container:this.wrapper;var originElement=inner?this.videoElement:this.container;if(isBoolean(autoFocus)?autoFocus:inner)this._autoFocusToVideo(node);if(penetrate){this.__domEventHandlerList[id]=this.__domEventHandlerList[id]||[];domEvents.forEach(function(key){var fn=_this2._getEventHandler(key,{penetrate:penetrate});addEvent(node,key,fn);_this2.__domEventHandlerList[id].push(fn);});this.__videoExtendedNodes.push(node);}if(outerElement.lastChild===originElement){outerElement.appendChild(node);return node;}outerElement.insertBefore(node,originElement.nextSibling);return node;}},{key:'removePlugin',value:function removePlugin(id){var _this3=this;if(!isString(id))return;var dom=this.plugins[id];if(isElement(dom)){dom.parentNode&&dom.parentNode.removeChild(dom);this._autoFocusToVideo(dom,true);}if(!isEmpty(this.__domEventHandlerList[id])){domEvents.forEach(function(key,index){removeEvent(_this3.plugins[id],key,_this3.__domEventHandlerList[id][index]);});delete this.__domEventHandlerList[id];}delete this.plugins[id];}},{key:'setPluginsZIndex',value:function setPluginsZIndex(plugins){var _this4=this;plugins.forEach(function(key,index){return setStyle(key.match(/^(videoElement|container)$/)?_this4[key]:_this4.plugins[key],'z-index',++index);});}},{key:'setAttr',value:function setAttr$$1(target,attr,val){setAttr(this[target],attr,val);}},{key:'getAttr',value:function getAttr$$1(target,attr){return getAttr(this[target],attr);}},{key:'setStyle',value:function setStyle$$1(target,attr,val){setStyle(this[target],attr,val);}},{key:'getStyle',value:function getStyle$$1(target,attr){return getStyle(this[target],attr);}},{key:'requestFullScreen',value:function requestFullScreen(target){var methods=['requestFullscreen','mozRequestFullScreen','webkitRequestFullscreen','msRequestFullscreen'];for(var i=0,len=methods.length;i<len;i++){if(isFunction(this[target][methods[i]])){this[target][methods[i]]();return true;}}return false;}},{key:'exitFullScreen',value:function exitFullScreen(){var methods=['exitFullscreen','msExitFullscreen','mozCancelFullScreen','webkitExitFullscreen'];for(var i=0,len=methods.length;i<len;i++){if(isFunction(document[methods[i]])){document[methods[i]]();return true;}}return false;}},{key:'fullScreen',value:function fullScreen(){var request=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var target=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'container';for(var _len5=arguments.length,args=Array(_len5>2?_len5-2:0),_key5=2;_key5<_len5;_key5++){args[_key5-2]=arguments[_key5];}return request?this.requestFullScreen.apply(this,[target].concat(_toConsumableArray(args))):this.exitFullScreen.apply(this,_toConsumableArray(args));}},{key:'focus',value:function focus(){this.videoElement.focus();}},{key:'destroy',value:function destroy(){var _this5=this;this._autoFocusToVideo(this.videoElement,false);videoEvents.forEach(function(key,index){removeEvent(_this5.videoElement,key,_this5.videoEventHandlerList[index]);});domEvents.forEach(function(key,index){removeEvent(_this5.videoElement,key,_this5.videoDomEventHandlerList[index]);removeEvent(_this5.container,key,_this5.containerDomEventHandlerList[index]);removeEvent(_this5.wrapper,key,_this5.wrapperDomEventHandlerList[index]);});this.wrapper.innerHTML=this.originHTML;delete this.wrapper;delete this.videoElement;delete this.plugins;}},{key:'_autoFocusToVideo',value:function _autoFocusToVideo(element){var remove=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;(remove?removeEvent:addEvent)(element,'mouseup',this._focusToVideo,false,true);(remove?removeEvent:addEvent)(element,'touchend',this._focusToVideo,false,true);}},{key:'_focusToVideo',value:function _focusToVideo(evt){var x=window.scrollX;var y=window.scrollY;isFunction(this.videoElement.focus)&&this.videoElement.focus();window.scrollTo(x,y);}},{key:'_getEventHandler',value:function _getEventHandler(key,_ref){var _this6=this;var penetrate=_ref.penetrate;if(!penetrate||['mouseenter','mouseleave'].indexOf(key)<0){return function(){var _dispatcher$bus4;for(var _len6=arguments.length,args=Array(_len6),_key6=0;_key6<_len6;_key6++){args[_key6]=arguments[_key6];}(_dispatcher$bus4=_this6.__dispatcher.bus).triggerSync.apply(_dispatcher$bus4,[key].concat(args));};}var insideVideo=function insideVideo(node){return _this6.__videoExtendedNodes.indexOf(node)>-1||_this6.__videoExtendedNodes.reduce(function(flag,video){if(flag)return flag;return isPosterityNode(video,node);},false);};return function(){for(var _len7=arguments.length,args=Array(_len7),_key7=0;_key7<_len7;_key7++){args[_key7]=arguments[_key7];}var _args$=args[0],toElement=_args$.toElement,currentTarget=_args$.currentTarget,relatedTarget=_args$.relatedTarget,type=_args$.type;var to=toElement||relatedTarget;if(_this6.__mouseInVideo&&type==='mouseleave'&&!insideVideo(to)){var _dispatcher$bus5;_this6.__mouseInVideo=false;return(_dispatcher$bus5=_this6.__dispatcher.bus).triggerSync.apply(_dispatcher$bus5,['mouseleave'].concat(args));}if(!_this6.__mouseInVideo&&type==='mouseenter'&&insideVideo(currentTarget)){var _dispatcher$bus6;_this6.__mouseInVideo=true;return(_dispatcher$bus6=_this6.__dispatcher.bus).triggerSync.apply(_dispatcher$bus6,['mouseenter'].concat(args));}};}}]);return Dom;}(),(_applyDecoratedDescriptor$3(_class$3.prototype,'setAttr',[_dec$3,_dec2$3],_Object$getOwnPropertyDescriptor(_class$3.prototype,'setAttr'),_class$3.prototype),_applyDecoratedDescriptor$3(_class$3.prototype,'getAttr',[_dec3$3],_Object$getOwnPropertyDescriptor(_class$3.prototype,'getAttr'),_class$3.prototype),_applyDecoratedDescriptor$3(_class$3.prototype,'setStyle',[_dec4$3],_Object$getOwnPropertyDescriptor(_class$3.prototype,'setStyle'),_class$3.prototype),_applyDecoratedDescriptor$3(_class$3.prototype,'getStyle',[_dec5$3],_Object$getOwnPropertyDescriptor(_class$3.prototype,'getStyle'),_class$3.prototype),_applyDecoratedDescriptor$3(_class$3.prototype,'requestFullScreen',[_dec6$2],_Object$getOwnPropertyDescriptor(_class$3.prototype,'requestFullScreen'),_class$3.prototype),_applyDecoratedDescriptor$3(_class$3.prototype,'_focusToVideo',[autobind],_Object$getOwnPropertyDescriptor(_class$3.prototype,'_focusToVideo'),_class$3.prototype)),_class$3));var _dec$4;var _dec2$4;var _dec3$4;var _class$4;var _descriptor$1;var _descriptor2$1;var _descriptor3$1;var _descriptor4;var _descriptor5;var _descriptor6;var _descriptor7;function _initDefineProp$1(target,property,descriptor,context){if(!descriptor)return;_Object$defineProperty(target,property,{enumerable:descriptor.enumerable,configurable:descriptor.configurable,writable:descriptor.writable,value:descriptor.initializer?descriptor.initializer.call(context):void 0});}function _applyDecoratedDescriptor$4(target,property,decorators,descriptor,context){var desc={};Object['ke'+'ys'](descriptor).forEach(function(key){desc[key]=descriptor[key];});desc.enumerable=!!desc.enumerable;desc.configurable=!!desc.configurable;if('value'in desc||desc.initializer){desc.writable=true;}desc=decorators.slice().reverse().reduce(function(desc,decorator){return decorator(target,property,desc)||desc;},desc);if(context&&desc.initializer!==void 0){desc.value=desc.initializer?desc.initializer.call(context):void 0;desc.initializer=undefined;}if(desc.initializer===void 0){Object['define'+'Property'](target,property,desc);desc=null;}return desc;}function numberOrVoid(value){return isNumber(value)?value:undefined;}function stringOrVoid(value){return isString(value)?value:undefined;}function accessorVideoProperty(property){return accessor({get:function get(value){return this.dispatcher.videoConfigReady&&this.inited?this.videoElement[property]:value;},set:function set(value){if(!this.dispatcher.videoConfigReady)return value;this.videoElement[property]=value;return value;}});}function accessorVideoAttribute(attribute){var _ref=isObject$1(attribute)?attribute:{set:attribute,get:attribute,isBoolean:false},_set=_ref.set,_get=_ref.get,isBoolean$$1=_ref.isBoolean;return accessor({get:function get(value){return this.dispatcher.videoConfigReady&&this.inited?this.videoElement[_get]:value;},set:function set(value){if(!this.dispatcher.videoConfigReady)return value;var val=isBoolean$$1?value?'':undefined:value;this.dispatcher.dom.setAttr('video',_set,val);return value;}});}function accessorCustomAttribute(attribute,isBoolean$$1){return accessor({get:function get(value){var attrValue=this.dispatcher.dom.getAttr('video',attribute);return this.dispatcher.videoConfigReady&&this.inited?isBoolean$$1?!!attrValue:attrValue:value;},set:function set(value){if(!this.dispatcher.videoConfigReady)return value;var val=isBoolean$$1?value||undefined:value;this.dispatcher.dom.setAttr('video',attribute,val);return value;}});}var accessorMap={src:[string$1(),accessor({set:function set(val){if(this.needToLoadSrc){this.needToLoadSrc=false;this.dispatcher.bus.emit('load',val);}return val;}},{preSet:false}),accessor({set:function set(val){if(this.dispatcher.readySync&&this.autoload&&val!==this.src)this.needToLoadSrc=true;return val;}})],autoload:boolean$1(),autoplay:[boolean$1(),accessorVideoProperty('autoplay')],controls:[boolean$1(),accessorVideoProperty('controls')],width:[accessor({set:numberOrVoid}),accessorVideoAttribute('width')],height:[accessor({set:numberOrVoid}),accessorVideoAttribute('height')],crossOrigin:[accessor({set:stringOrVoid}),accessorVideoAttribute({set:'crossorigin',get:'crossOrigin'})],loop:[boolean$1(),accessorVideoProperty('loop')],defaultMuted:[boolean$1(),accessorVideoAttribute({get:'defaultMuted',set:'muted',isBoolean:true})],muted:[boolean$1(),accessorVideoProperty('muted')],preload:[accessor({set:stringOrVoid}),accessorVideoAttribute('preload')],poster:[accessor({set:stringOrVoid}),accessorVideoAttribute('poster')],playsInline:[accessor({get:function get(value){var playsInline=this.videoElement.playsInline;return this.dispatcher.videoConfigReady&&this.inited?playsInline===undefined?value:playsInline:value;},set:function set(value){if(!this.dispatcher.videoConfigReady)return value;this.videoElement.playsInline=value;var val=value?'':undefined;this.dispatcher.dom.setAttr('video','playsinline',val);this.dispatcher.dom.setAttr('video','webkit-playsinline',val);this.dispatcher.dom.setAttr('video','x5-video-player-type',value?'h5':undefined);return value;}}),boolean$1()],x5VideoPlayerFullScreen:[accessor({set:function set(value){return!!value;},get:function get(value){return!!value;}}),accessorCustomAttribute('x5-video-player-fullscreen',true)],x5VideoOrientation:[accessor({set:stringOrVoid}),accessorCustomAttribute('x5-video-orientation')],xWebkitAirplay:[accessor({set:function set(value){return!!value;},get:function get(value){return!!value;}}),accessorCustomAttribute('x-webkit-airplay',true)],playbackRate:[number$1(1),accessorVideoProperty('playbackRate')],defaultPlaybackRate:[accessorVideoProperty('defaultPlaybackRate'),number$1(1)],disableRemotePlayback:[boolean$1(),accessorVideoProperty('disableRemotePlayback')],volume:[number$1(1),accessorVideoProperty('volume')]};var VideoConfig=(_dec$4=string(),_dec2$4=string(function(str){return str.toLocaleLowerCase();}),_dec3$4=array(),(_class$4=function(){_createClass(VideoConfig,[{key:'lockKernelProperty',value:function lockKernelProperty(){applyDecorators(this,{type:lock,box:lock,runtimeOrder:lock},{self:true});}}]);function VideoConfig(dispatcher,config){_classCallCheck(this,VideoConfig);_initDefineProp$1(this,'needToLoadSrc',_descriptor$1,this);_initDefineProp$1(this,'inited',_descriptor2$1,this);this.src='';_initDefineProp$1(this,'type',_descriptor3$1,this);_initDefineProp$1(this,'box',_descriptor4,this);_initDefineProp$1(this,'runtimeOrder',_descriptor5,this);this.autoload=true;this.autoplay=false;this.controls=false;this.width=undefined;this.height=undefined;this.crossOrigin=undefined;this.loop=false;this.defaultMuted=false;this.muted=false;this.preload='auto';this.poster=undefined;this.playsInline=false;this.x5VideoPlayerFullScreen=false;this.x5VideoOrientation=undefined;this.xWebkitAirplay=false;this.playbackRate=1;this.defaultPlaybackRate=1;this.disableRemotePlayback=false;this.volume=1;_initDefineProp$1(this,'_kernelProperty',_descriptor6,this);_initDefineProp$1(this,'_realDomAttr',_descriptor7,this);applyDecorators(this,accessorMap,{self:true});Object.defineProperty(this,'dispatcher',{value:dispatcher,enumerable:false,writable:false,configurable:false});Object.defineProperty(this,'videoElement',{value:dispatcher.dom.videoElement,enumerable:false,writable:false,configurable:false});deepAssign(this,config);}_createClass(VideoConfig,[{key:'init',value:function init(){var _this=this;this._realDomAttr.forEach(function(key){_this[key]=_this[key];});this.inited=true;}}]);return VideoConfig;}(),(_descriptor$1=_applyDecoratedDescriptor$4(_class$4.prototype,'needToLoadSrc',[nonenumerable],{enumerable:true,initializer:function initializer(){return false;}}),_descriptor2$1=_applyDecoratedDescriptor$4(_class$4.prototype,'inited',[nonenumerable],{enumerable:true,initializer:function initializer(){return false;}}),_descriptor3$1=_applyDecoratedDescriptor$4(_class$4.prototype,'type',[_dec$4,nonconfigurable],{enumerable:true,initializer:function initializer(){return'vod';}}),_descriptor4=_applyDecoratedDescriptor$4(_class$4.prototype,'box',[_dec2$4,nonconfigurable],{enumerable:true,initializer:function initializer(){return'';}}),_descriptor5=_applyDecoratedDescriptor$4(_class$4.prototype,'runtimeOrder',[_dec3$4,nonconfigurable],{enumerable:true,initializer:function initializer(){return['html5','flash'];}}),_descriptor6=_applyDecoratedDescriptor$4(_class$4.prototype,'_kernelProperty',[frozen],{enumerable:true,initializer:function initializer(){return['type','box','runtimeOrder'];}}),_descriptor7=_applyDecoratedDescriptor$4(_class$4.prototype,'_realDomAttr',[frozen],{enumerable:true,initializer:function initializer(){return['src','controls','width','height','crossOrigin','loop','muted','preload','poster','autoplay','playsInline','x5VideoPlayerFullScreen','x5VideoOrientation','xWebkitAirplay','playbackRate','defaultPlaybackRate','autoload','disableRemotePlayback','defaultMuted','volume'];}})),_class$4));var _dec$1;var _dec2$1;var _dec3$1;var _dec4$1;var _dec5$1;var _class$1;function _applyDecoratedDescriptor$1(target,property,decorators,descriptor,context){var desc={};Object['ke'+'ys'](descriptor).forEach(function(key){desc[key]=descriptor[key];});desc.enumerable=!!desc.enumerable;desc.configurable=!!desc.configurable;if('value'in desc||desc.initializer){desc.writable=true;}desc=decorators.slice().reverse().reduce(function(desc,decorator){return decorator(target,property,desc)||desc;},desc);if(context&&desc.initializer!==void 0){desc.value=desc.initializer?desc.initializer.call(context):void 0;desc.initializer=undefined;}if(desc.initializer===void 0){Object['define'+'Property'](target,property,desc);desc=null;}return desc;}var pluginConfigSet={};function convertNameIntoId(name){if(!isString(name))throw new Error("Plugin's name must be a string");return camelize(name);}function checkPluginConfig(config){if(isFunction(config)){if(!(config.prototype instanceof Plugin)){throw new TypeError('If you pass a function as plugin config, this class must extends from Chimee.plugin');}return;}if(!isObject$1(config)||isEmpty(config))throw new TypeError("plugin's config must be an Object");var name=config.name;if(!isString(name)||name.length<1)throw new TypeError('plugin must have a legal name');}var Dispatcher=(_dec$1=before(convertNameIntoId),_dec2$1=before(checkPluginConfig),_dec3$1=before(convertNameIntoId),_dec4$1=before(convertNameIntoId),_dec5$1=before(convertNameIntoId),(_class$1=function(){function Dispatcher(config,vm){var _this=this;_classCallCheck(this,Dispatcher);this.plugins={};this.order=[];this.readySync=false;this.zIndexMap={inner:[],outer:[]};if(!isObject$1(config))throw new TypeError('UserConfig must be an Object');this.dom=new Dom(config.wrapper,this);this.bus=new Bus(this);this.vm=vm;this.videoConfigReady=false;this.videoConfig=new VideoConfig(this,config);this._initUserPlugin(config.plugin);this.order.forEach(function(key){return _this.plugins[key].__init(_this.videoConfig);});this.videoConfig.lockKernelProperty();this.videoConfigReady=true;this.videoConfig.init();this.kernel=new Kernel(this.dom.videoElement,this.videoConfig);var asyncInitedTasks=[];this.order.forEach(function(key){var ready=_this.plugins[key].__inited();if(isPromise(ready)){asyncInitedTasks.push(ready);}});this.readySync=asyncInitedTasks.length===0;this.ready=this.readySync?_Promise.resolve():_Promise.all(asyncInitedTasks).then(function(){_this.readySync=true;_this.bus.trigger('ready');_this._autoloadVideoSrcAtFirst();});if(this.readySync)this._autoloadVideoSrcAtFirst();}_createClass(Dispatcher,[{key:'use',value:function use(option){if(isString(option))option={name:option,alias:undefined};if(!isObject$1(option)||isObject$1(option)&&!isString(option.name)){throw new TypeError('pluginConfig do not match requirement');}if(!isString(option.alias))option.alias=undefined;var _option=option,name=_option.name,alias$$1=_option.alias;option.name=alias$$1||name;delete option.alias;var key=camelize(name);var id=camelize(alias$$1||name);var pluginOption=option;var pluginConfig=Dispatcher.getPluginConfig(key);if(isEmpty(pluginConfig))throw new TypeError('You have not installed plugin '+key);if(isObject$1(pluginConfig)){pluginConfig.id=id;}var plugin=isFunction(pluginConfig)?new pluginConfig({id:id},this,pluginOption):new Plugin(pluginConfig,this,pluginOption);this.plugins[id]=plugin;_Object$defineProperty(this.vm,id,{value:plugin,configurable:true,enumerable:false,writable:false});this.order.push(id);this._sortZIndex();if(this.videoConfigReady)plugin.__inited();return plugin.ready;}},{key:'unuse',value:function unuse(id){var plugin=this.plugins[id];if(!isObject$1(plugin)||!isFunction(plugin.$destroy)){delete this.plugins[id];return;}plugin.$destroy();var orderIndex=this.order.indexOf(id);if(orderIndex>-1){this.order.splice(orderIndex,1);}delete this.plugins[id];delete this.vm[id];}},{key:'throwError',value:function throwError(error){this.vm.__throwError(error);}},{key:'destroy',value:function destroy(){for(var key in this.plugins){this.unuse(key);}this.bus.destroy();delete this.bus;this.dom.destroy();delete this.dom;this.kernel.destroy();delete this.kernel;delete this.vm;delete this.plugins;delete this.order;}},{key:'_initUserPlugin',value:function _initUserPlugin(){var _this2=this;var configs=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];if(!isArray$1(configs)){Log.warn('Dispatcher','UserConfig.plugin can only by an Array');configs=[];}return configs.map(function(config){return _this2.use(config);});}},{key:'_sortZIndex',value:function _sortZIndex(){var _this3=this;var _order$reduce=this.order.reduce(function(levelSet,key){var plugin=_this3.plugins[key];if(isEmpty(plugin))return levelSet;var set=levelSet[plugin.$inner?'inner':'outer'];var level=plugin.$level;set[level]=set[level]||[];set[level].push(key);return levelSet;},{inner:{},outer:{}}),inner=_order$reduce.inner,outer=_order$reduce.outer;inner[0]=inner[0]||[];inner[0].unshift('videoElement');outer[0]=outer[0]||[];outer[0].unshift('container');var innerOrderArr=transObjectAttrIntoArray(inner);var outerOrderArr=transObjectAttrIntoArray(outer);this.dom.setPluginsZIndex(innerOrderArr);this.dom.setPluginsZIndex(outerOrderArr);this.zIndexMap.inner=innerOrderArr;this.zIndexMap.outer=outerOrderArr;}},{key:'_getTopLevel',value:function _getTopLevel(inner){var arr=this.zIndexMap[inner?'inner':'outer'];var plugin=this.plugins[arr[arr.length-1]];return isEmpty(plugin)?0:plugin.$level;}},{key:'_autoloadVideoSrcAtFirst',value:function _autoloadVideoSrcAtFirst(){if(this.videoConfig.autoload)this.bus.emit('load',this.videoConfig.src);}}],[{key:'install',value:function install(config){var name=config.name;var id=camelize(name);if(!isEmpty(pluginConfigSet[id])){Log.warn('Dispatcher','You have installed '+name+' again. And the older one will be replaced');}var pluginConfig=isFunction(config)?config:deepAssign({id:id},config);pluginConfigSet[id]=pluginConfig;return id;}},{key:'hasInstalled',value:function hasInstalled(id){return!isEmpty(pluginConfigSet[id]);}},{key:'uninstall',value:function uninstall(id){delete pluginConfigSet[id];}},{key:'getPluginConfig',value:function getPluginConfig(id){return pluginConfigSet[id];}}]);return Dispatcher;}(),(_applyDecoratedDescriptor$1(_class$1.prototype,'unuse',[_dec$1],_Object$getOwnPropertyDescriptor(_class$1.prototype,'unuse'),_class$1.prototype),_applyDecoratedDescriptor$1(_class$1,'install',[_dec2$1],_Object$getOwnPropertyDescriptor(_class$1,'install'),_class$1),_applyDecoratedDescriptor$1(_class$1,'hasInstalled',[_dec3$1],_Object$getOwnPropertyDescriptor(_class$1,'hasInstalled'),_class$1),_applyDecoratedDescriptor$1(_class$1,'uninstall',[_dec4$1],_Object$getOwnPropertyDescriptor(_class$1,'uninstall'),_class$1),_applyDecoratedDescriptor$1(_class$1,'getPluginConfig',[_dec5$1],_Object$getOwnPropertyDescriptor(_class$1,'getPluginConfig'),_class$1)),_class$1));var _class$5;var _descriptor$2;function _initDefineProp$2(target,property,descriptor,context){if(!descriptor)return;_Object$defineProperty(target,property,{enumerable:descriptor.enumerable,configurable:descriptor.configurable,writable:descriptor.writable,value:descriptor.initializer?descriptor.initializer.call(context):void 0});}function _applyDecoratedDescriptor$5(target,property,decorators,descriptor,context){var desc={};Object['ke'+'ys'](descriptor).forEach(function(key){desc[key]=descriptor[key];});desc.enumerable=!!desc.enumerable;desc.configurable=!!desc.configurable;if('value'in desc||desc.initializer){desc.writable=true;}desc=decorators.slice().reverse().reduce(function(desc,decorator){return decorator(target,property,desc)||desc;},desc);if(context&&desc.initializer!==void 0){desc.value=desc.initializer?desc.initializer.call(context):void 0;desc.initializer=undefined;}if(desc.initializer===void 0){Object['define'+'Property'](target,property,desc);desc=null;}return desc;}var GlobalConfig=(_class$5=function(){_createClass(GlobalConfig,[{key:'silent',get:function get(){return this._silent;},set:function set(val){var _this=this;val=!!val;this._silent=val;_Object$keys(this.log).forEach(function(key){_this.log[key]=!val;});}}]);function GlobalConfig(){_classCallCheck(this,GlobalConfig);this.log={error:true,info:true,warn:true,debug:true,verbose:true};_initDefineProp$2(this,'_silent',_descriptor$2,this);this.errorHandler=undefined;var props=_Object$keys(this.log).reduce(function(props,key){props[key]=accessor({get:function get(){return Log['ENABLE_'+key.toUpperCase()];},set:function set(val){Log['ENABLE_'+key.toUpperCase()]=val;if(val===true)this.silent=false;return val;}});return props;},{});applyDecorators(this.log,props,{self:true});}return GlobalConfig;}(),_descriptor$2=_applyDecoratedDescriptor$5(_class$5.prototype,'_silent',[nonenumerable],{enumerable:true,initializer:function initializer(){return false;}}),_class$5);var _dec;var _dec2;var _dec3;var _dec4;var _dec5;var _dec6;var _dec7;var _dec8;var _class;var _class2;var _descriptor;var _descriptor2;var _descriptor3;var _init;var _init2;var _init3;var _init4;var _init5;var _init6;var _class3;var _temp;function _initDefineProp(target,property,descriptor,context){if(!descriptor)return;_Object$defineProperty(target,property,{enumerable:descriptor.enumerable,configurable:descriptor.configurable,writable:descriptor.writable,value:descriptor.initializer?descriptor.initializer.call(context):void 0});}function _applyDecoratedDescriptor(target,property,decorators,descriptor,context){var desc={};Object['ke'+'ys'](descriptor).forEach(function(key){desc[key]=descriptor[key];});desc.enumerable=!!desc.enumerable;desc.configurable=!!desc.configurable;if('value'in desc||desc.initializer){desc.writable=true;}desc=decorators.slice().reverse().reduce(function(desc,decorator){return decorator(target,property,desc)||desc;},desc);if(context&&desc.initializer!==void 0){desc.value=desc.initializer?desc.initializer.call(context):void 0;desc.initializer=undefined;}if(desc.initializer===void 0){Object['define'+'Property'](target,property,desc);desc=null;}return desc;}var Chimee=(_dec=autobindClass(),_dec2=alias('addEventListener'),_dec3=before(eventBinderCheck),_dec4=before(eventBinderCheck),_dec5=alias('removeEventListener'),_dec6=before(eventBinderCheck),_dec7=before(attrAndStyleCheck),_dec8=before(attrAndStyleCheck),_dec(_class=(_class2=(_temp=_class3=function(_VideoWrapper){_inherits(Chimee,_VideoWrapper);function Chimee(config){_classCallCheck(this,Chimee);var _this=_possibleConstructorReturn(this,(Chimee.__proto__||_Object$getPrototypeOf(Chimee)).call(this));_this.destroyed=false;_initDefineProp(_this,'__id',_descriptor,_this);_initDefineProp(_this,'version',_descriptor2,_this);_initDefineProp(_this,'config',_descriptor3,_this);if(isString(config)||isElement(config)){config={wrapper:config,controls:true};}else if(isObject$1(config)){if(!config.wrapper)throw new Error('You must pass in an legal object');}else{throw new Error('You must pass in an Object containing wrapper or string or element to new a Chimee');}_this.__dispatcher=new Dispatcher(config,_this);_this.__dispatcher.kernel.on('error',_this.__throwError);_this.ready=_this.__dispatcher.ready;_this.readySync=_this.__dispatcher.readySync;_this.__wrapAsVideo(_this.__dispatcher.videoConfig);return _this;}_createClass(Chimee,[{key:'destroy',value:function destroy(){_get(Chimee.prototype.__proto__||_Object$getPrototypeOf(Chimee.prototype),'__destroy',this).call(this);this.__dispatcher.destroy();this.destroyed=true;}},{key:'use',value:function use(option){this.__dispatcher.use(option);}},{key:'unuse',value:function unuse(name){this.__dispatcher.unuse(name);}},{key:'on',value:function on(key,fn){this.__dispatcher.bus.on('_vm',key,fn);return this;}},{key:'off',value:function off(key,fn){return this.__dispatcher.bus.off('_vm',key,fn);}},{key:'once',value:function once(key,fn){return this.__dispatcher.bus.once('_vm',key,fn);}},{key:'emit',value:function emit(key){var _dispatcher$bus;if(!isString(key))throw new TypeError('emit key parameter must be String');if(domEvents.indexOf(key.replace(/^\w_/,''))>-1){Log.warn('plugin','You are using emit to emit '+key+' event. As emit is wrapped in Promise. It make you can\'t use event.preventDefault and event.stopPropagation. So we advice you to use emitSync');}for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}return(_dispatcher$bus=this.__dispatcher.bus).emit.apply(_dispatcher$bus,[key].concat(_toConsumableArray(args)));}},{key:'emitSync',value:function emitSync(key){var _dispatcher$bus2;if(!isString(key))throw new TypeError('emitSync key parameter must be String');for(var _len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2];}return(_dispatcher$bus2=this.__dispatcher.bus).emitSync.apply(_dispatcher$bus2,[key].concat(_toConsumableArray(args)));}},{key:'css',value:function css(method){var _dispatcher$dom;for(var _len3=arguments.length,args=Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++){args[_key3-1]=arguments[_key3];}return(_dispatcher$dom=this.__dispatcher.dom)[method+'Style'].apply(_dispatcher$dom,args);}},{key:'attr',value:function attr(method){var _dispatcher$dom2;for(var _len4=arguments.length,args=Array(_len4>1?_len4-1:0),_key4=1;_key4<_len4;_key4++){args[_key4-1]=arguments[_key4];}if(method==='set'&&/video/.test(args[0])){if(!this.__dispatcher.videoConfigReady){Log.warn('plugin','You are tring to set attribute on video before video inited. Please wait until the inited event has benn trigger');return args[2];}if(this.__dispatcher.videoConfig._realDomAttr.indexOf(args[1])>-1){var key=args[1],val=args[2];this.__dispatcher.videoConfig[key]=val;return val;}}return(_dispatcher$dom2=this.__dispatcher.dom)[method+'Attr'].apply(_dispatcher$dom2,args);}},{key:'__throwError',value:function __throwError(error){if(isString(error))error=new Error(error);var errorHandler=this.config.errorHandler||Chimee.config.errorHandler;if(isFunction(errorHandler))return errorHandler(error);if(Chimee.config.silent)return;throw error;}}]);return Chimee;}(VideoWrapper),_class3.plugin=Plugin,_class3.config=new GlobalConfig(),_class3.install=Dispatcher.install,_class3.uninstall=Dispatcher.uninstall,_class3.hasInstalled=Dispatcher.hasInstalled,_class3.getPluginConfig=Dispatcher.getPluginConfig,_temp),(_descriptor=_applyDecoratedDescriptor(_class2.prototype,'__id',[frozen],{enumerable:true,initializer:function initializer(){return'_vm';}}),_descriptor2=_applyDecoratedDescriptor(_class2.prototype,'version',[frozen],{enumerable:true,initializer:function initializer(){return'0.1.3';}}),_descriptor3=_applyDecoratedDescriptor(_class2.prototype,'config',[frozen],{enumerable:true,initializer:function initializer(){return{errorHandler:undefined};}}),_applyDecoratedDescriptor(_class2,'plugin',[frozen],(_init=_Object$getOwnPropertyDescriptor(_class2,'plugin'),_init=_init?_init.value:undefined,{enumerable:true,configurable:true,writable:true,initializer:function initializer(){return _init;}}),_class2),_applyDecoratedDescriptor(_class2,'config',[frozen],(_init2=_Object$getOwnPropertyDescriptor(_class2,'config'),_init2=_init2?_init2.value:undefined,{enumerable:true,configurable:true,writable:true,initializer:function initializer(){return _init2;}}),_class2),_applyDecoratedDescriptor(_class2,'install',[frozen],(_init3=_Object$getOwnPropertyDescriptor(_class2,'install'),_init3=_init3?_init3.value:undefined,{enumerable:true,configurable:true,writable:true,initializer:function initializer(){return _init3;}}),_class2),_applyDecoratedDescriptor(_class2,'uninstall',[frozen],(_init4=_Object$getOwnPropertyDescriptor(_class2,'uninstall'),_init4=_init4?_init4.value:undefined,{enumerable:true,configurable:true,writable:true,initializer:function initializer(){return _init4;}}),_class2),_applyDecoratedDescriptor(_class2,'hasInstalled',[frozen],(_init5=_Object$getOwnPropertyDescriptor(_class2,'hasInstalled'),_init5=_init5?_init5.value:undefined,{enumerable:true,configurable:true,writable:true,initializer:function initializer(){return _init5;}}),_class2),_applyDecoratedDescriptor(_class2,'getPluginConfig',[frozen],(_init6=_Object$getOwnPropertyDescriptor(_class2,'getPluginConfig'),_init6=_init6?_init6.value:undefined,{enumerable:true,configurable:true,writable:true,initializer:function initializer(){return _init6;}}),_class2),_applyDecoratedDescriptor(_class2.prototype,'on',[_dec2,_dec3],_Object$getOwnPropertyDescriptor(_class2.prototype,'on'),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,'off',[_dec4,_dec5],_Object$getOwnPropertyDescriptor(_class2.prototype,'off'),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,'once',[_dec6],_Object$getOwnPropertyDescriptor(_class2.prototype,'once'),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,'css',[_dec7],_Object$getOwnPropertyDescriptor(_class2.prototype,'css'),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,'attr',[_dec8],_Object$getOwnPropertyDescriptor(_class2.prototype,'attr'),_class2.prototype)),_class2))||_class);return Chimee;});

/***/ })

},[154]);